# Интеллектуальный роутер моделей - Реализация

## Основано на мировых практиках 2024

### Исследованные подходы:
1. **RouterBench** - стандартизированная оценка роутинга (405k+ inference outcomes)
2. **Cross-Attention Routing** - до 6.6% улучшение качества через query-model compatibility
3. **BEST-Route** - cost-aware routing с оптимизацией sampling (до 60% экономии)
4. **Eagle** - training-free routing (23.52% улучшение AUC)

## Реализация

### Файлы:
- `knowledge_os/app/intelligent_model_router.py` - основной роутер
- `knowledge_os/app/extended_thinking.py` - интеграция роутера

### Характеристики моделей (из PLAN.md):

| Модель | Категория | Качество | Скорость | Стоимость | Предзагрузка |
|--------|-----------|----------|----------|-----------|--------------|
| command-r-plus:104b | enterprise | 0.95 | 0.10 | 0.95 | ❌ |
| deepseek-r1-distill-llama:70b | reasoning | 0.90 | 0.30 | 0.70 | ❌ |
| llama3.3:70b | complex | 0.92 | 0.25 | 0.70 | ❌ |
| qwen2.5-coder:32b | coding | 0.85 | 0.60 | 0.40 | ✅ |
| phi3.5:3.8b | fast | 0.70 | 0.85 | 0.15 | ✅ |
| phi3:mini-4k | fast | 0.60 | 0.90 | 0.10 | ❌ |
| qwen2.5:3b | fast | 0.65 | 0.88 | 0.10 | ❌ |
| tinyllama:1.1b-chat | fast | 0.50 | 0.95 | 0.05 | ✅ |

### Алгоритм выбора:

1. **Классификация задачи:**
   - По ключевым словам (код, reasoning, fast)
   - По длине промпта (< 300 = fast, > 2000 = complex)
   - По явной категории (если указана)

2. **Расчет score модели:**
   - Соответствие категории (40%)
   - Качество модели (30%)
   - Скорость (20%)
   - Стоимость (обратная, 10%)
   - Бонус за предзагрузку (+0.1)
   - Анализ длины промпта

3. **Выбор оптимальной модели:**
   - Сортировка по score
   - Fallback на следующие в списке

### Интеграция:

ExtendedThinkingEngine автоматически использует роутер:
- Анализирует промпт
- Выбирает оптимальную модель
- Использует fallback если модель недоступна

## Дата реализации

2026-01-27

## Статус

✅ Реализовано и готово к тестированию
