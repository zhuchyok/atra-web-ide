#!/bin/bash
# –ë—ã—Å—Ç—Ä–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker - —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ –ª–∏—à–Ω–µ–µ
# –ë–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

set -e

echo "üßπ –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker..."
echo ""

# 1. –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ë–î (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
echo "[1/4] –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ë–î..."
docker rm knowledge_os_db knowledge-os-db 2>/dev/null && echo "   ‚úÖ –£–¥–∞–ª–µ–Ω–æ" || echo "   ‚è≠Ô∏è  –£–∂–µ —É–¥–∞–ª–µ–Ω—ã"
echo ""

# 2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã –∞–≥–µ–Ω—Ç–æ–≤ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
echo "[2/4] –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤..."
docker rmi knowledge_os-victoria-agent:latest knowledge_os-veronica-agent:latest 2>/dev/null && echo "   ‚úÖ –£–¥–∞–ª–µ–Ω–æ (~2.3GB –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ)" || echo "   ‚è≠Ô∏è  –£–∂–µ —É–¥–∞–ª–µ–Ω—ã"
echo ""

# 3. –û—á–∏—Å—Ç–∏—Ç—å build cache (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
echo "[3/4] –û—á–∏—Å—Ç–∫–∞ build cache..."
docker builder prune -f >/dev/null 2>&1
CACHE_FREED=$(docker system df | grep "Build Cache" | awk '{print $4}')
echo "   ‚úÖ Build cache –æ—á–∏—â–µ–Ω (–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ: $CACHE_FREED)"
echo ""

# 4. –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ç–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
echo "[4/4] –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–µ—Ç–µ–π..."
docker network prune -f >/dev/null 2>&1
echo "   ‚úÖ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ç–∏ —É–¥–∞–ª–µ–Ω—ã"
echo ""

# –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
echo "=============================================="
echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢"
echo "=============================================="
docker system df
echo ""

echo "‚úÖ –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
