# Почему задача «выполнена», но корпорация по факту не выполнила

## Как устроено выполнение задач

1. **Дашборд «Поставить задачу»**  
   Вы создаёте задачу → в таблицу `tasks` пишется строка со статусом `pending`.  
   Поле `assignee_expert_id` может быть **NULL** (если выбрано «Автоназначение»).

2. **Кто выполняет**  
   Задачи из БД забирает **Smart Worker** (контейнер `knowledge_os_worker`, скрипт `smart_worker_autonomous.py`).  
   Он в цикле делает:
   - `SELECT ... FROM tasks WHERE status = 'pending'`
   - для каждой задачи вызывает LLM (Ollama/MLX) от имени эксперта (при NULL в БД подставляется «Виктория»)
   - при успехе пишет результат и ставит `status = 'completed'`
   - при трёх подряд неудачах вызывает **автозавершение**: ставит `status = 'completed'` и пишет в `result` шаблонный текст вроде:  
     *«Завершена автоматически после 3 неудачных попыток обработки AI агентом. AI агент был недоступен.»*

3. **Почему в карточке «Не назначен»**  
   Smart Worker **не обновляет** `assignee_expert_id` в БД.  
   Он только в своём запросе подставляет исполнителя через `COALESCE(e.name, 'Виктория')`.  
   Если задача создана с «Автоназначение», в БД так и остаётся `assignee_expert_id = NULL` → в дашборде отображается «Не назначен».

## Почему по факту «ничего не сделали»

Наиболее вероятные варианты:

- **Smart Worker сработал, но LLM не ответил**  
  Воркер три раза пытался вызвать агента (Ollama/MLX), получил ошибку или пустой ответ → сработало **автозавершение**: задача помечена `completed`, в `result` — шаблонное сообщение об автоматическом завершении после 3 попыток.  
  Содержательного отчёта нет, потому что агент по сути не выполнил задачу.

- **Воркер не запущен**  
  Если контейнер `knowledge_os_worker` не поднят или упал, задачи так и остаются `pending`.  
  Тогда статус `completed` мог появиться только из другого места (см. ниже).

- **Другой код пометил задачу выполненной**  
  Статус `completed` также выставляют:
  - `auto_fixer.py` (при «исправлении»),
  - `process_expert_task.py` (при ручной обработке экспертом).  
  Если задачу закрыли оттуда без реального выполнения — будет «выполнена» без нормального отчёта.

## Что проверить

1. **В карточке задачи поле «Результат» / result**  
   - Если там текст вроде «Завершена автоматически после 3 неудачных попыток…» — это автозавершение Smart Worker’а из‑за недоступности/ошибок LLM.  
   - Если result пустой или общий — возможно, задачу закрыл другой процесс (auto_fixer, process_expert_task и т.д.).

2. **Работает ли Smart Worker**  
   ```bash
   docker compose -f knowledge_os/docker-compose.yml ps knowledge_os_worker
   docker compose -f knowledge_os/docker-compose.yml logs knowledge_os_worker --tail 100
   ```  
   Должны быть логи вроде «Found N pending tasks», «Task … COMPLETED» / «AUTO-COMPLETED».

3. **Доступность Ollama/MLX**  
   Воркер вызывает их по адресам из окружения (в т.ч. `host.docker.internal` в Docker).  
   Если сервисы не отвечают, все попытки падают → срабатывает автозавершение после 3 попыток.

## Что можно улучшить в коде

- **При автозавершении проставлять исполнителя**  
  В `smart_worker_autonomous.py` при установке `status = 'completed'` и записи шаблонного `result` (автозавершение после 3 попыток) дополнительно делать `UPDATE tasks SET assignee_expert_id = ... WHERE id = $1`, подставляя id эксперта, от имени которого воркер пытался выполнить задачу (например, Виктория).  
  Тогда в дашборде будет видно «Исполнитель: Виктория», а не «Не назначен».

- **Не считать автозавершение «нормальным» выполнением**  
  Имеет смысл в `metadata` или отдельном поле помечать такие задачи (например, `metadata->>'auto_completed' = 'true'`) и в дашборде/отчётах показывать их отдельно (например, «Завершена автоматически (агент недоступен)»).

- **Проверка перед созданием задачи**  
  Опционально: при отправке задачи с дашборда проверять, что воркер и LLM доступны, и показывать предупреждение, если нет — чтобы не копить «пустые» автозавершения.

---

**Итог:** чаще всего задача оказывается «выполненной» без реального отчёта из‑за **автозавершения Smart Worker’а после 3 неудачных вызовов LLM**. Исполнитель в БД не проставляется → в интерфейсе «Не назначен». Нужно проверить логи воркера и доступность Ollama/MLX и при необходимости доработать воркер (assignee + метка автозавершения), как выше.
