# Статус выполнения задач — мировые практики

## Проблема

Пользователь ставит задачу Victoria, получает ответ, но не видит:
- **статус выполнения** (что выполняется, в процессе/выполнено);
- **что именно выполнилось** (шаги, делегирование);
- **итоговый результат** (если задача делегирована или долгая).

## Что сделано

### 1. Асинхронный режим (202 + polling) — для долгих процессов

- **POST /run?async_mode=true** → **202 Accepted** + `task_id` и `status_url: /run/status/{task_id}`.
- Задача выполняется **в фоне** (asyncio.create_task). Соединение не держится.
- **GET /run/status/{task_id}** возвращает: `queued` | `running` | `completed` | `failed`, при `completed` — `output`, `knowledge`.
- Чат по умолчанию использует async: отправляет запрос с `async_mode=1`, опрашивает статус каждые 2.5 с, при `completed` выводит результат в чат. Ожидание до 1 часа.

Так долгий процесс не упирается в таймаут HTTP, а результат по завершении попадает в чат.

### 2. В ответе всегда статус + результат (в т.ч. при делегировании)

- При делегировании Victoria возвращает блок: «Статус: задача выполнена через Veronica (task_id: …)», этапы координации, затем «Результат: …».
- В чате отображаются: метод, «Выполнено через: Veronica», результат.

## Мировые практики для длинных задач (на будущее)

Если появятся задачи, которые не укладываются в один HTTP-запрос:

### 1. **202 Accepted + Polling** (REST)

- `POST /run` → **202 Accepted** + заголовок `Location: /run/status/{task_id}`.
- Клиент периодически опрашивает `GET /run/status/{task_id}`:
  - `queued` → в очереди;
  - `in_progress` → в работе, опционально `progress`, `current_step`;
  - `completed` → готово, в теле или по ссылке возвращается результат.
- По завершении: `GET /run/result/{task_id}` — отдать результат.

Источники: [Restalk Long-Running Operation](https://restalk-patterns.org/long-running-operation-polling.html), [Azure LRO](https://deepwiki.com/microsoft/api-guidelines/2.3-azure-long-running-operations).

### 2. **Streaming (SSE / WebSocket)**

- Во время выполнения — поток событий: `status`, `step`, `progress`, `result`.
- Пользователь видит прогресс в реальном времени без опроса.

### 3. **Callback URL**

- Клиент при постановке задачи передаёт `callback_url`.
- Сервер по завершении делает `POST callback_url` с результатом (или статусом + ссылкой на результат).

---

**Итог:** для текущего синхронного сценария достаточно того, что в одном ответе всегда есть статус выполнения, этапы и результат. Для очень долгих задач позже можно ввести 202 + polling или streaming по этому документу.
