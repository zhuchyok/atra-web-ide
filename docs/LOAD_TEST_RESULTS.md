# Результаты стресс-тестирования (Фаза 3, День 6–7)

## Порты (избежание конфликтов)

- **Knowledge OS:** Prometheus на хосте **9092** (если 9090 занят). Grafana Knowledge OS: 3001.
- **Web IDE:** Prometheus 9091, Grafana **3002** (чтобы не конфликтовать с Grafana Knowledge OS на 3001).

## Как запустить

```bash
# Установить Locust (один раз). На macOS не используйте системный pip (externally-managed-environment).
# Вариант A — venv для тестов (рекомендуется):
./scripts/load_test/setup_venv.sh

# Вариант B — pipx: brew install pipx && pipx install locust

# Вариант 1: Только стресс-тест (backend уже запущен). Копируйте только следующую строку:
./scripts/run_load_test.sh

# Вариант 2: Стресс-тест 1 мин, 30 пользователей — одна строка, без скобок:
RUN_TIME=1m USERS=30 SPAWN_RATE=5 ./scripts/run_load_test.sh

# Вариант 3: Полный прогон с поднятием Docker — одна строка:
START_DOCKER=1 RUN_TIME=1m USERS=30 SPAWN_RATE=5 ./scripts/run_full_load_test.sh

# С другими параметрами
HOST=http://localhost:8080 USERS=100 RUN_TIME=5m ./scripts/run_load_test.sh

# Интерактивный режим (веб-интерфейс Locust на :8089)
locust -f scripts/load_test/locustfile.py --host=http://localhost:8080
# Открыть http://localhost:8089
```

## Тестовая среда

- **Дата:** заполнить после прогона
- **Длительность:** по умолчанию 2 мин (RUN_TIME=5m для 5 мин)
- **Пользователи:** 50 (ChatUser) по умолчанию
- **Целевой RPS:** 30–50

## Результаты производительности (шаблон)

| Метрика                 | Результат | Целевое значение |
|-------------------------|-----------|------------------|
| **RPS (запросов в сек)**| —         | 30–50            |
| **Среднее время ответа**| — ms      | < 500 ms         |
| **95-й перцентиль**     | — ms      | < 1000 ms        |
| **Ошибок**              | — %       | < 1%             |
| **Успешных запросов**   | — %       | > 99%            |

## Прогон до ограничения параллелизма (до concurrency limiter)

- **Запросов:** 6251 (stream: 6079, plan: 172)
- **Ошибок:** 6001 (в основном 500 Internal Server Error при перегрузке)
- **RPS (сред):** ~21
- **Вывод:** при нагрузке backend перегружался и возвращал 500. После внедрения семафора лишние запросы должны получать **503 Service Unavailable** с `Retry-After`, а не 500.

## Распределение по режимам

- **Ask (чат):** основная доля запросов
- **Plan (план):** доля из locustfile (task weights)

## Ожидания после внедрения concurrency limiter

При перегрузке вместо **500 Internal Server Error** клиенты должны получать **503 Service Unavailable** с заголовком `Retry-After`. Это означает, что бэкенд не падает, а явно отказывает в обслуживании с возможностью повтора. После повторного прогона стресс-теста проверьте в отчёте: доля 503 при высокой нагрузке допустима; доля 500 должна быть минимальной или нулевой.

## Ограничение одновременных запросов к Victoria

При нагрузке бэкенд ограничивает число одновременных запросов к Victoria (семафор). Лишние запросы получают **503 Service Unavailable** с заголовком `Retry-After: 60` вместо 500.

**Переменные окружения (.env):**

- `MAX_CONCURRENT_VICTORIA=50` — макс. одновременных запросов к Victoria (chat/plan); по умолчанию 50.
- `VICTORIA_CONCURRENT_WAIT_SEC=45` — сколько секунд ждать свободный слот перед 503.

Для стресс-теста можно увеличить лимит (например, 50) или время ожидания.

## Узкие места и рекомендации

1. После прогона проверить Grafana: RPS, latency, errors.
2. При необходимости увеличить кэш эмбеддингов, индексы БД, лимиты пулов.
3. При большом числе 503 — увеличить `MAX_CONCURRENT_VICTORIA` или мощность Victoria.

## A/B тестирование

Статистика экспериментов: `GET /api/ab-testing/experiments/{name}/stats`.

Варианты пользователя: `GET /api/ab-testing/user/{user_id}/variants`.
