# Проверка корпорации: пошагово, правильно ли делают, исправлять до правильного

**Назначение:** пошагово проверить, что корпорация (документы, код, процессы) делает всё **как нужно** по нашему подходу ([THINKING_AND_APPROACH.md](THINKING_AND_APPROACH.md)). Если что-то не так — указать **причину**, **как нужно**, и переделывать, пока не начнут делать правильно.

**Обновлено:** 2026-02-09

---

## Как пользоваться этим документом

- **Проверяющий (человек или агент):** проходите шаги по порядку. Если пункт «Сделано правильно» — ок. Если «Было не так» — исправьте по разделу «Как нужно» и причине; затем проверьте снова.
- **После исправления:** обновите этот документ (статус пункта, дату проверки) и при необходимости MASTER_REFERENCE / CHANGES.

---

## 1. Источник истины: эксперты

| Проверка | Сделано правильно? | Было не так / Как нужно |
|----------|--------------------|-------------------------|
| **Добавление нового эксперта** только через `configs/experts/employees.json`, затем `python scripts/sync_employees.py` | ✅ | **Не так:** добавлять в seed или БД вручную, не запускать sync. **Причина:** дублирование, рассинхрон. **Как нужно:** один источник — employees.json; после правки — обязательно `python scripts/sync_employees.py` (или pre-commit при установленных хуках). См. [EXPERT_CONNECTION_ARCHITECTURE.md](EXPERT_CONNECTION_ARCHITECTURE.md) §4. |
| **Комментарий в employees.json** отражает порядок: сначала JSON, потом sync_employees.py | ✅ (исправлено 2026-02-09) | **Было не так:** комментарий упоминал только sync_employees_from_db.py, не основной поток «добавить в JSON → sync_employees». **Как нужно:** в _comment указать: добавление новых — запись в JSON, затем `python scripts/sync_employees.py`; обратная синхронизация из БД — sync_employees_from_db.py. |

---

## 2. Тесты и скрипт «всё тестировать»

| Проверка | Сделано правильно? | Было не так / Как нужно |
|----------|--------------------|-------------------------|
| **Backend-тесты** (в т.ч. test_task_detector_chain, test_veronica_delegate) собираются и проходят при запуске из корня репо | ✅ (исправлено 2026-02-09) | **Было не так:** в тестах использовался `parents[2]` для корня репо → получалась папка `backend/`, модуль `src` не находился (ModuleNotFoundError). **Причина:** корень репо для файла `backend/app/tests/...` — это `parents[3]`. **Как нужно:** в тестах, импортирующих `src.agents.bridge`, задавать `_REPO_ROOT = Path(__file__).resolve().parents[3]` и добавлять в sys.path. Перезапустить тесты после правки. |
| **run_all_system_tests.sh** запускает backend-тесты из корня репо | ✅ | **Не так:** запускать backend pytest из каталога backend без корня в PYTHONPATH. **Как нужно:** из корня репо: `pytest backend/app/tests/ -q --tb=short`; тесты сами добавляют корень в path (parents[3]). |
| **Количество тестов:** backend 58, Knowledge OS (быстрый набор) 41 | ✅ | При расхождении — проверить, не отключены ли тесты и не изменилась ли структура; обновить docs/TESTING_FULL_SYSTEM.md и этот чек-лист. |

---

## 3. Документация и библия

| Проверка | Сделано правильно? | Было не так / Как нужно |
|----------|--------------------|-------------------------|
| **После изменений** обновляются MASTER_REFERENCE («Последние изменения» или соответствующий §) и при необходимости CHANGES_FROM_OTHER_CHATS | По процессу | **Не так:** менять код/процесс и не трогать библию. **Причина:** следующий человек или агент не видит актуального состояния. **Как нужно:** по [THINKING_AND_APPROACH.md](THINKING_AND_APPROACH.md) шаг 6 — зафиксировать в MASTER_REFERENCE и CHANGES. |
| **HOW_TO_INDEX** содержит все основные темы (эксперты, куратор, тесты, восстановление, подход и логика и т.д.) | ✅ | При появлении нового runbook или процесса — добавить строку в таблицу HOW_TO_INDEX и при необходимости в MASTER_REFERENCE §8. |
| **Решение «план = подсказка»** зафиксировано в NEXT_STEPS_CORPORATION §5, не «висит» без решения | ✅ | **Не так:** оставлять открытый вопрос без записи «принято: оставить как есть до доработки». **Как нужно:** явный параграф в NEXT_STEPS с решением и ссылкой на VICTORIA_TASK_CHAIN_FULL. |

---

## 4. Victoria: решение задачи, шаги, разная сложность

| Проверка | Сделано правильно? | Было не так / Как нужно |
|----------|--------------------|-------------------------|
| **Получили решение задачи, а не только status: success** | По проверке | **Не так:** смотреть только на `status: success`. **Как нужно:** проверять, что в `output` есть **ответ на вопрос** (решение). Пустой или посторонний output при success — не засчитывать. |
| **Каждый шаг прошёл** | По проверке | Смотреть `knowledge.execution_trace` (если есть): шаги должны завершаться без ошибок. При verbose: true — пошаговые thought/tool/tool_input. |
| **Тестировать разную сложность** | По проверке | **Простая:** приветствие, «что умеешь» (быстрый путь). **Средняя:** вопрос, требующий данных (БД, RAG). **Сложнее:** действие с инструментом (list_directory, read_file и т.д.). Скрипт: `bash scripts/test_victoria_tasks_complete.sh` (три задачи, проверка output и шагов). Для задач 3–4 при таймаутах sync: `bash scripts/run_victoria_tasks_3_and_4_async.sh` (async_mode + опрос статуса). См. VICTORIA_RESTARTS_CAUSE §4. |

---

## 5. Запуск и границы кода

| Проверка | Сделано правильно? | Было не так / Как нужно |
|----------|--------------------|-------------------------|
| **Порядок запуска:** сначала Knowledge OS (`docker compose -f knowledge_os/docker-compose.yml up -d`), затем Web IDE (`docker compose up -d`) | По доке | **Не так:** поднимать только Web IDE без агентов. **Причина:** чат и план зависят от Victoria (8010). **Как нужно:** см. MASTER_REFERENCE §9, HOW_TO_INDEX «Деплой / запуск». |
| **Правки в коде** сверяются с SRC_AND_KNOWLEDGE_OS_BOUNDARIES: корпорация — knowledge_os/app и src/agents/bridge; торговля — остальное src/ | По процессу | **Не так:** править логику корпорации в src/ (не bridge) или дублировать её в двух местах. **Как нужно:** перед правкой открыть границы; общую логику выносить в один модуль и ссылаться оттуда. |

---

## 6. Что переделывать, пока не станет правильно

1. **Если эксперт добавлен не через employees.json + sync_employees** — откатить лишние правки в seed/БД, внести запись в employees.json, запустить `python scripts/sync_employees.py`, при необходимости применить seed в БД. Повторять проверку: после sync должны обновиться seed_experts.json, _known_names_generated.py, employees.md.
2. **Если backend-тесты падают с ModuleNotFoundError: src** — в тестах, импортирующих `src.agents.bridge`, выставить корень репо как `Path(__file__).resolve().parents[3]`, перезапустить `pytest backend/app/tests/ -q`.
3. **Если изменили код/процесс и не обновили библию** — добавить запись в «Последние изменения» MASTER_REFERENCE и при значимом изменении — параграф в CHANGES_FROM_OTHER_CHATS; обновить этот чек-лист при изменении шагов проверки.
4. **Если в документации противоречие** (например, в одном месте «источник — БД», в другом «источник — employees.json») — привести к одному согласованному формулированию по EXPERT_CONNECTION_ARCHITECTURE и обновить все упоминания.

---

## 7. Связь с другими документами

- **Подход и логика:** [THINKING_AND_APPROACH.md](THINKING_AND_APPROACH.md) — по этой логике выполняем шаги и исправления.
- **Что делать по темам:** [HOW_TO_INDEX.md](HOW_TO_INDEX.md).
- **Актуальное состояние:** [MASTER_REFERENCE.md](MASTER_REFERENCE.md) §8.
- **Что не сделано:** [WHATS_NOT_DONE.md](WHATS_NOT_DONE.md).

Проверки проводить регулярно (например после больших изменений или по запросу); при каждом проходе исправлять найденное по разделу «Как нужно» и перепроверять, пока не станет правильно.
