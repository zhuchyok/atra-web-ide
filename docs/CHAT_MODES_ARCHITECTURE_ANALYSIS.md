# Анализ архитектуры режимов чата и план оптимизации

**Дата:** 2026-01-30

## Согласие с тезисами анализа

### 1. Ask (Чат) не использует RAG+

**Факт:** В текущем коде запросы в режиме Ask идут только в MLX → Ollama → Victoria. Контекст из БЗ (Knowledge OS) в Ask не подмешивается: вызов `knowledge_os.get_expert_by_name` есть только для отображения шага «Эксперт найден», но не для RAG-поиска по запросу.

**Итог:** Ask — быстрый, но без доступа к базе знаний. Для фактуальных вопросов по корпоративным данным это недостаточно.

### 2. Victoria перегружена и без градации

**Факт:** Victoria используется как fallback для Ask, основной бэкенд для Agent и единственный для Plan. В Web IDE мы не различаем «простой» и «сложный» запрос при вызове Victoria: всегда один и тот же `run()` / `plan()`.

**Итог:** В Victoria уже есть RAG+ и параллель (см. `docs/RAG_PLUS_ROCKET_SPEED.md`), но со стороны Web IDE градации (fast / RAG+ / full) нет — её можно вводить внутри Victoria или через отдельные эндпоинты (fast_rag, full).

### 3. Нет «горячего пути» для простых запросов

**Факт:** В коде есть `is_simple_message()` и списки `SIMPLE_PATTERNS` / `VICTORIA_PATTERNS`, но в актуальном `sse_generator` они **не используются**: все запросы в Ask идут в MLX/Ollama без проверки на приветствие или шаблонный ответ.

**Итог:** Простые запросы («привет», «как дела») проходят полную цепочку (шаги + MLX/Ollama), что даёт лишнюю латентность и нагрузку.

---

## Текущая vs целевая архитектура

| Режим | Сейчас | Целевой вариант |
|-------|--------|------------------|
| **Ask** | Все запросы → MLX → Ollama → Victoria | 1. Простые/приветствия → шаблон (5 ms) 2. Фактуальные → RAG-light (Victoria быстрый путь) 3. Сложные → подсказка перейти в Agent |
| **Agent** | Все запросы → Victoria.run() | 1. Semantic cache 2. RAG+ (один эмбеддинг, мало чанков) 3. Full (расширенный контекст) — по сложности |
| **Plan** | Всегда Victoria.plan() | 1. Кэш планов по хэшу цели 2. Stream первого шага, пока генерируется остальное |

---

## Что внедряем по фазам

### Фаза 1 (день 1) — сделано

- **QueryClassifier** — классификация запроса: `simple` (приветствие, благодарность, прощание), `factual`, `complex`.
- **Шаблонные ответы для Ask** — при `simple` возвращаем ответ из `TEMPLATE_RESPONSES` (варианты для привет/как дела/спасибо/пока/понятно) без вызова MLX/Ollama/Victoria (горячий путь ~5–50 ms).
- **GET /api/chat/mode/health** — доступность бэкендов по режимам; поля `_available` (bool) для ask/agent/plan.
- **GET /api/chat/classify?q=...** — проверка классификатора и шаблона для запроса.
- **Логирование** — при горячем пути: `[Ask] Hot path: simple query '...' -> template (no LLM)`.
- **Agent fallback** — при ошибке Victoria в режиме Agent вызывается `_generate_via_mlx_or_ollama` (MLX → Ollama); сообщение пользователю: «Victoria недоступна — проверяю MLX и Ollama».

**Проверка Фазы 1:**
1. `python scripts/test_paths.py` — локальная проверка классификатора и (при запущенном бэкенде) API и горячего пути.
2. `curl -s "http://localhost:8080/api/chat/classify?q=привет" | jq .`
3. `curl -s http://localhost:8080/api/chat/mode/health | jq .`
4. В режиме Чат (Ask) отправить «привет» — должен прийти шаблонный ответ без шага «Проверяю MLX и Ollama».

---

## Фаза 1: ГОТОВО

### Проверенные компоненты

| Компонент | Статус |
|-----------|--------|
| **QueryClassifier** | 8/8 тестовых запросов (simple/factual/complex) |
| **Горячий путь в Ask** | Шаблонный ответ без вызова LLM (~5–50 ms) |
| **Шаблонные ответы** | Варианты для приветствий, благодарностей, прощаний |
| **GET /api/chat/mode/health** | Доступность ask/agent/plan, поля `_available` |
| **Fallback Agent** | При недоступности Victoria → MLX → Ollama |
| **GET /api/chat/classify?q=...** | Отладка классификации и шаблона |

### Команды для проверки бэкенда

```bash
# Тесты (бэкенд на 8080)
BACKEND_URL=http://localhost:8080 python3 scripts/test_paths.py

# Эндпоинты
curl -s "http://localhost:8080/api/chat/classify?q=привет" | jq .
curl -s http://localhost:8080/api/chat/mode/health | jq .

# Веб: http://localhost:3000 → Чат → «привет» → шаблонный ответ сразу
```

---

## Фаза 2: План реализации (7 дней)

Детальный план: **`docs/PHASE2_PLAN.md`**.

### День 1–2: RAG-light для фактуальных запросов

- **Цель:** Ответы на фактуальные вопросы из БЗ за &lt;200 ms.
- **Компоненты:** `RAGLightService` (поиск 1 чанка по вектору, порог 0.75), интеграция в `sse_generator` для `classification["type"] == "factual"`.
- **Конфиг:** `RAG_LIGHT_ENABLED`, `RAG_LIGHT_CHUNK_LIMIT=1`, `RAG_LIGHT_THRESHOLD=0.75`, `RAG_LIGHT_TIMEOUT_MS=200`.

### День 3–4: Подсказка перехода в Agent

- **Цель:** Для сложных запросов показывать рекомендацию «перейти в режим Агент», но давать быстрый ответ (MLX/Ollama).
- **Компоненты:** расширение классификатора (анализ сложности, ключевые слова: проанализируй, сравни, план, стратегия и т.д.), шаг SSE «Рекомендация» перед ответом.
- **Конфиг:** `AGENT_SUGGESTION_ENABLED`, `AGENT_SUGGESTION_MIN_COMPLEXITY=0.6`, задержка показа 500 ms.

### День 5–6: Кэш планов

- **Цель:** Повторные запросы планов из кэша (локальный TTL 30 мин, опционально Redis 1 ч).
- **Компоненты:** `PlanCache` (ключ по хэшу нормализованной цели + эксперт), интеграция в `Victoria.plan()` или в backend перед вызовом Victoria.
- **Конфиг:** `PLAN_CACHE_ENABLED`, `PLAN_CACHE_TTL=1800`, `PLAN_CACHE_MIN_GENERATION_TIME=1.0`.

### День 7: Мониторинг и метрики

- **Цель:** Распределение запросов по путям (template / rag_light / llm_direct / cached) и время ответа.
- **Компоненты:** `PathMetricsCollector`, эндпоинт `GET /api/metrics/paths` (или `/api/chat/metrics`).
- **Метрики:** по режиму (ask/agent/plan), по пути (template, rag_light, rag_full, llm_direct, cached), среднее/p95 времени.

### Критерии успеха Фазы 2

1. **Скорость:** фактуальные запросы в Ask &lt;200 ms при попадании в RAG-light.
2. **Качество:** RAG-light даёт точные ответы по фактам из БЗ.
3. **UX:** рекомендация перейти в Agent не мешает, быстрый ответ всё равно приходит.
4. **Эффективность:** повторные планы из кэша без вызова Victoria.
5. **Мониторинг:** видно распределение по путям и время по путям.

### Чек-лист начала Фазы 2

- [ ] Фаза 1 работает в окружении (тесты + веб).
- [ ] Зафиксировать базовые метрики скорости (опционально).
- [ ] День 1–2: создать `RAGLightService`, интегрировать в Ask для factual.
- [ ] День 3–4: расширить классификатор, добавить шаг «Рекомендация» для complex.
- [ ] День 5–6: реализовать `PlanCache`, подключить к планам.
- [ ] День 7: сбор метрик, эндпоинт метрик.

---

### Фаза 3 (после Фазы 2)

- **Victoria:** градация fast / RAG+ / full (внутри Victoria или отдельные методы).
- **Semantic cache ответов** — общий слой по эмбеддингу запроса (порог 0.92).
- **Метрики и A/B** — пороги переключения, качество vs скорость.

---

## Конфигурация (рекомендуемая)

```env
# Пороги и лимиты
ASK_FAST_THRESHOLD=0.8
AGENT_RAG_LIMIT=3
RAG_CONTEXT_LIMIT=3
SEMANTIC_CACHE_TTL=3600
PLAN_CACHE_ENABLED=true
TEMPLATE_CACHE_ENABLED=true

# Таймауты (ms)
FAST_PATH_TIMEOUT=100
RAG_PATH_TIMEOUT=300
FULL_PATH_TIMEOUT=2000
```

---

## Итог

- Анализ корректен: архитектура была линейной, без градации по сложности и без горячего пути для простых запросов.
- **Фаза 1** — сделана: классификатор, шаблонные ответы, health по режимам, fallback Agent, эндпоинт `/classify`.
- **Фаза 2** — план в `docs/PHASE2_PLAN.md`: RAG-light, подсказка Agent, кэш планов, метрики (7 дней).
- **Фаза 3** — градация Victoria (fast/RAG+/full), семантический кэш ответов, A/B.

### Действия сейчас

1. Проверить Фазу 1 в окружении: `BACKEND_URL=http://localhost:8080 python3 scripts/test_paths.py`, веб — «привет» в Чат.
2. Открыть план Фазы 2: `docs/PHASE2_PLAN.md`.
3. Начать с RAG-light (день 1–2) — максимальный эффект при минимальных рисках.
