# Анализ недостатков проекта ATRA Web IDE (Виктория и команда)

**Дата:** 2026-02-05  
**Источники:** VERIFICATION_CHECKLIST_OPTIMIZATIONS, MASTER_REFERENCE, CHANGES_FROM_OTHER_CHATS, структура репозитория, чеклист §3 «Причины сбоев», §5 «При следующих изменениях».

---

## Резюме

Ниже — недостатки и риски, сгруппированные по зонам ответственности экспертов. Часть уже покрыта чеклистом и решениями; часть остаётся точками роста (документация, тесты, CI, дублирование, операционные риски).

---

## 1. Backend и инфраструктура (Игорь, Роман)

| Недостаток | Описание | Рекомендация |
|------------|----------|--------------|
| **Дублирование кода src/ и knowledge_os/** | В `src/` и `knowledge_os/app/` есть параллельные зоны: telegram (bot, handlers), signals, execution, filters, config, data, utils. Риск расхождения логики и двойных правок. | **Частично (2026-02-05):** задокументировано в [SRC_AND_KNOWLEDGE_OS_BOUNDARIES.md](SRC_AND_KNOWLEDGE_OS_BOUNDARIES.md) и MASTER_REFERENCE §1г: knowledge_os/app — продакшен для корпорации; src/agents/bridge — Victoria Server/Bot; src/ (остальное) — домен торговли, для Web IDE не используется. При правках — сверять границы и при необходимости выносить общую логику в единый модуль. См. CHANGES_FROM_OTHER_CHATS §0.3u. |
| **employees.json (58) vs БД (86)** | В репозитории 58 записей в employees.json; в БД (Docker) 86 экспертов. Реестр в коде не совпадает с runtime. | Уже учтено: источник истины — БД; employees.json — для sync. Держать актуальным sync_employees и проверку (experts_check_report). При добавлении сотрудника — JSON + sync. |
| **Много TODO/FIXME в коде** | Десятки TODO в knowledge_os (orchestrator, extended_thinking, agent_protocol и др.), в src (signals, execution). | **Частично (2026-02-05):** создан [TODO_FIXME_BACKLOG.md](TODO_FIXME_BACKLOG.md) — приоритизация по критичности (высокий/средний/низкий). При правках — закрывать или обновлять backlog. |
| **Зависимость от одного пула/клиента** | Пул БД и HTTP-клиент — единые точки отказа. При падении пула страдает весь процесс. | Уже смягчено (fallback, лимиты). Рекомендация: мониторинг здоровья пула и алерты (Елена). |

---

## 2. Тесты и качество (Анна)

| Недостаток | Описание | Рекомендация |
|------------|----------|--------------|
| **CI не гонял основной pytest-набор** | Было: только Quality Validation (RAG, latency). | **Принято (2026-02-05):** добавлен workflow `pytest-knowledge-os.yml` — при push/PR в main: pytest-no-db (test_json_fast_http_client), pytest-with-db (test_rest_api, test_victoria_chat_and_request) с Postgres. См. CHANGES_FROM_OTHER_CHATS §0.3r. |
| **Покрытие не зафиксировано** | Нет целевого coverage (например >80% для критичных модулей) и отчёта в CI. | **Принято (2026-02-05):** в CI добавлены pytest-cov, артефакты coverage-no-db и coverage-with-db; порог **--cov-fail-under** задан через env COVERAGE_FAIL_UNDER (по умолчанию 0). После замера базовой линии поднять значение в workflow (например 5 или 10). См. CHANGES_FROM_OTHER_CHATS §0.3t, §0.3w. |
| **Frontend без автотестов** | В frontend/ не было тестов (Jest/Vitest/Playwright). | **Частично (2026-02-05):** добавлены Vitest, jsdom, @testing-library/svelte; скрипты `npm run test`, `npm run test:watch`; smoke-тесты чат-стора (chat.spec.js — 4 теста). E2E (чат, health) — Playwright по возможности позже. См. CHANGES_FROM_OTHER_CHATS §0.3y. |
| **Эндпоинты и контракты** | Часть API (chat, Victoria, board/consult) описана в доке; не все контракты покрыты автотестами. | **Частично (2026-02-05):** test_rest_api — board/consult без X-API-Key → 401, GET /metrics содержит deferred_to_human_total; backend test_strategic_classifier — is_strategic_question, get_risk_level. Полный e2e «стратегический вопрос → board → Victoria» — по возможности позже. См. CHANGES_FROM_OTHER_CHATS §0.4a. |

---

## 3. SRE и мониторинг (Елена)

| Недостаток | Описание | Рекомендация |
|------------|----------|--------------|
| **Много известных причин сбоев** | В чеклисте §3 перечислено >25 причин (Metal OOM, Ollama от другого пользователя, таймауты, Redis/порт, эхо, делегирование и т.д.). Каждая уже имела место. | Продолжать фиксировать новые причины в §3 и «При следующих изменениях» §5; при инциденте — обновлять таблицу. |
| **Очередь на ручную проверку** | Задачи с deferred_to_human растут при таймаутах, пустых ответах, провале валидации. last_error и next_retry_after уже внедрены, но нагрузка на LLM/Metal остаётся фактором. | **Частично (2026-02-05):** метрики в /metrics; дашборд; **алерт provisioned** — grafana/provisioning/alerting/deferred_to_human.yaml (value > 10, for 5m). См. CHANGES_FROM_OTHER_CHATS §0.3v, §0.4a, §0.4d. |
| **MLX/Ollama на одном Mac** | Конкуренция за Metal; после sleep/wake контекст может инвалидироваться. | **Принято (2026-02-05):** system_auto_recovery проверяет и перезапускает Ollama (блок 4.5); MLX уже был; оба в проверке здоровья и в блоке «без интернета». См. CHANGES_FROM_OTHER_CHATS §0.4d. |
| **Один workflow в CI** | Раньше только quality-validation. | **Частично (2026-02-05):** pytest-knowledge-os.yml запускается при push/PR в main; quality-validation — по расписанию. Линтер по изменённым путям — по возможности позже. |

---

## 4. Безопасность (Алексей)

| Недостаток | Описание | Рекомендация / Статус |
|------------|----------|------------------------|
| **Секреты в env и compose** | Пароли БД (POSTGRES_PASSWORD, secret), API_KEY для board/consult — в .env и docker-compose. Риск утечки при клонировании и передаче репо. | Использовать .env.example без секретов; в проде — секрет-менеджер (Vault, облачные секреты); не коммитить .env с реальными ключами. Закреплено в VERIFICATION_CHECKLIST §5. |
| **download_from_server46.sh** | Скрипт использовал sshpass и дефолтный пароль в коде. | **Принято (2026-02-05):** дефолтный пароль убран; приоритет SSH-ключей (BatchMode=yes); SERVER_46_PASS только из окружения (.env не коммитить). См. CHANGES_FROM_OTHER_CHATS §0.3s, VERIFICATION_CHECKLIST §5. |
| **Health и метрики без аутентификации** | Часть эндпоинтов (/health, /metrics) может быть доступна без auth. | **Принято (2026-02-05):** решение задокументировано в VERIFICATION_CHECKLIST §5 — внутренняя сеть = принять риск; иначе auth или network policy. См. CHANGES §0.4f. |

---

## 5. Документация и согласованность (Татьяна)

| Недостаток | Описание | Рекомендация |
|------------|----------|--------------|
| **Очень много файлов в docs/** | 715+ файлов в docs/ (710+ .md). Трудно поддерживать актуальность всех; риск устаревания. | Библия (MASTER_REFERENCE + таблица §8) — единая точка входа. Остальное — по ссылкам. При изменении логики обновлять в первую очередь MASTER_REFERENCE и CHANGES_FROM_OTHER_CHATS. |
| **Архив и устаревшие цифры** | В archive/ и ряде отчётов встречаются старые цифры (58 экспертов, 85 экспертов, сервер 46 как источник данных). | Мы уже привели ключевые доки к 86 экспертам и «БД — источник истины». При обращении к архивным докам — явно указывать «исторический контекст». |
| **Разрозненные планы и отчёты** | Планы в .cursor/plans/, отчёты в docs/archive, learning_programs, ai_insights. Нет единого индекса «что где искать». | **Принято (2026-02-05):** создан [PLANS_AND_REPORTS_INDEX.md](PLANS_AND_REPORTS_INDEX.md) — индекс планов (.cursor/plans/), архива (docs/archive/), программ обучения (learning_programs/), AI insights (ai_insights/). Ссылка в MASTER_REFERENCE §8. См. CHANGES_FROM_OTHER_CHATS §0.3x. |

---

## 6. Производительность и архитектура (Ольга, Дмитрий)

| Недостаток | Описание | Рекомендация |
|------------|----------|--------------|
| **Один воркер на окружение** | При двух экземплярах воркера — двойная нагрузка на LLM и «20 задач в работе» при лимите 10. Чеклист это фиксирует. | Строго один воркер на окружение; в compose не дублировать сервис; при деплое проверять docker ps на дубликаты. |
| **Тяжёлые модели и таймауты** | Загрузка 70b/104b — десятки секунд; при коротком таймауте запросы падают. MODEL_TIME_ESTIMATES и MLX_QUEUE_WAIT_TIMEOUT уже введены. | Следить за метриками таймаутов и 503; при необходимости увеличить лимиты по моделям. |
| **Эмбеддинги не у всех узлов** | Часть записей в knowledge_nodes без embedding — семантический поиск работает по подмножеству. | При записи в knowledge_nodes по возможности сохранять embedding (smart_worker уже пишет для отчётов); постепенно дополнять существующие узлы. |

---

## 7. Методология и золотые стандарты

- **UTC и идемпотентность** — закреплены; при новом коде в скриптах/модулях проверять datetime и дубликаты.
- **Метод экспертов** — при изменениях в зоне ответственности (чат, воркер, оркестратор, Совет, RAG, MLX/Ollama) сверяться с VERIFICATION_CHECKLIST §5 «При следующих изменениях».
- **Библия** — перед правками читать MASTER_REFERENCE; после — обновлять MASTER_REFERENCE и при необходимости CHANGES_FROM_OTHER_CHATS.

---

## 8. Приоритеты (кратко)

1. **Высокий:** CI с прогоном pytest (json_fast, rest_api, victoria_chat_and_request); не хранить пароли в репо; один воркер на окружение.
2. **Средний:** Сократить дублирование src/ и knowledge_os/ или явно задокументировать; покрытие тестами и порог в CI; мониторинг deferred_to_human и last_error.
3. **Низкий:** Единый индекс планов/отчётов; фронтовые тесты; аутентификация метрик по необходимости.

---

*Отчёт подготовлен по методологии проекта: чеклист верификации, причины сбоев, рекомендации специалистов. При следующих изменениях учитывать §5 VERIFICATION_CHECKLIST_OPTIMIZATIONS и обновлять библию.*
