# Чеклист мировых практик (Knowledge OS / ATRA)

**Дата:** 2026-01-28  
**Статус:** применяется в коде и при ревью.

---

## 1. Безопасность

| Практика | Статус | Где |
|----------|--------|-----|
| Секреты только из переменных окружения | ✅ | `TG_TOKEN`, `TG_ALLOWED_USER_ID` — из `os.getenv("TG_TOKEN")`, без хардкода в коде. |
| Пароли/ключи БД из env | ✅ | `DATABASE_URL` — fallback только для dev; в проде задавать `DATABASE_URL`. |
| Нет логирования секретов | ✅ | В логах не пишем токены, пароли, API keys. |
| SQL: только параметризованные запросы | ✅ | psycopg2: `%s` и кортеж параметров; никогда не подставлять пользовательский ввод в строку SQL. |
| Внешний ввод не в f-строках SQL | ✅ | В dashboard и app — запросы с `%s` и `params`. |

**Действия:** В проде задавать `TG_TOKEN`, `DATABASE_URL`, при необходимости `SECRET_MASTER_KEY` в env (не в коде).

---

## 2. Обработка ошибок

| Практика | Статус | Где |
|----------|--------|-----|
| Не использовать голый `except:` | ✅ | Заменено на `except Exception as e:` или конкретные исключения с логированием в ai_core, local_router, enhanced_scout_researcher. |
| Логировать сбой с контекстом | ✅ | `logger.warning(...)`, `logger.debug(...)` с сообщением или исключением. |
| Не глотать критические ошибки | ✅ | Критичные пути (БД, API) логируют и при необходимости пробрасывают или возвращают явный результат. |
| Таймауты на внешние вызовы | ✅ | httpx/aiohttp: `timeout=...`; subprocess: `timeout=...`. |

**Действия:** При добавлении нового кода — не использовать `except: pass` без указания типа исключения и без лога в отладочных путях.

---

## 3. База данных

| Практика | Статус | Где |
|----------|--------|-----|
| Плейсхолдеры: psycopg2 — `%s` | ✅ | dashboard, app — везде `%s` и кортеж/список параметров. |
| asyncpg — `$1, $2` | ✅ | В модулях с asyncpg используются нумерованные плейсхолдеры и передача параметров. |
| Транзакции где нужно | ✅ | Критичные изменения (несколько записей) в транзакциях. |
| Закрытие/возврат соединений в пул | ✅ | `conn.commit()`, `pool.release()` / context manager. |

**Действия:** Не смешивать стили (в одном файле с psycopg2 не использовать `$1`).

---

## 4. Асинхронность и сеть

| Практика | Статус | Где |
|----------|--------|-----|
| Не блокировать event loop | ✅ | Долгие операции — через `asyncio.run_in_executor` или отдельные процессы при необходимости. |
| Таймауты на HTTP | ✅ | httpx: `timeout=30.0` и т.п.; Ollama/MLX — разумные таймауты. |
| Повторы с ограничением | ✅ | Circuit breaker для локальных моделей; ограниченные retry в роутере. |

---

## 5. Конфигурация и код

| Практика | Статус | Где |
|----------|--------|-----|
| Один источник правды для списка моделей | ✅ | `docs/CURRENT_MODELS_LIST.md` + синхронизация с local_router, ai_core, enhanced_scout. |
| Модели по env где уместно | ✅ | `USE_LOCAL_LLM`, `MODEL_CODING`, `MODEL_REASONING`, `DATABASE_URL`, `MLX_API_URL`, `OLLAMA_URL`. |
| Нормализация metadata (JSON из БД) | ✅ | Dashboard: `_normalize_metadata()` для полей из JSON/JSONB. |

---

## 6. UX и надёжность (Dashboard)

| Практика | Статус | Где |
|----------|--------|-----|
| Валидация и проверка перед действием | ✅ | Проверка `sim_id`, `task_row`, пустых списков перед записью/удалением. |
| Понятные сообщения об ошибках | ✅ | `st.error(...)` с текстом; не сырой traceback без пояснения. |
| Fallback при недоступности сервиса | ✅ | Симулятор: fallback в задачу при недоступности Docker; маркетинг: fallback в задачу при ошибке скрипта; разведка: fallback моделей в enhanced_scout. |

---

## 7. Логирование и наблюдаемость

| Практика | Статус | Где |
|----------|--------|-----|
| Выбор маршрута (local/cloud) в логах | ✅ | ai_core: `[ROUTE]`, `[LOCAL FIRST]`, `[FALLBACK]`. |
| Уровни: debug для шума, info/warning для решений | ✅ | Роутинг, выбор модели — info; сбои — warning; отладка — debug. |

---

## Кратко по файлам

- **telegram_gateway.py, telegram_simple.py:** секреты из env, проверка `TG_TOKEN` перед вызовом API.
- **ai_core.py:** голый `except` заменён на `except Exception` с логом; приоритет локальных моделей и логирование маршрута.
- **local_router.py:** `should_use_local` расширен категориями; голый `except` заменён на конкретные исключения.
- **enhanced_scout_researcher.py:** голый `except` заменён на `(ValueError, AttributeError, IndexError)`; fallback цепочка моделей для анализа.
- **dashboard/app.py:** SQL с `%s`; нормализация metadata; fallback при ошибках симулятора/маркетинга/ревизии.

При ревью и добавлении фич сверяться с этим чеклистом.
