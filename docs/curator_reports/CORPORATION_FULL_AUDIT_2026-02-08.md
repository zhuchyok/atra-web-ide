# Полный аудит связки и логики корпорации — 2026-02-08

**Запрос:** тестировать всю работу, связку, логику корпорации; искать ошибки, баги и варианты улучшения быстродействия и правильности решений/ответов (по библии и знаниям).

**Источники:** docs/MASTER_REFERENCE.md, VERIFICATION_CHECKLIST_OPTIMIZATIONS.md, код backend, knowledge_os, src/agents/bridge, curator-отчёты.

---

## 1. Выполненные проверки

### 1.1. Тесты

| Набор | Результат |
|-------|-----------|
| Backend `pytest backend/app/tests/` | 37 passed |
| Knowledge OS (json_fast, service_monitor, skill_registry, skill_loader, security, rest_api и др.) | 23 passed |
| Frontend `npm run test` | 4 passed (chat.spec.js) |

### 1.2. Критические цепочки (по библии)

- **Чат → Victoria:** `goal`/`current_prompt`, `project_context`, `session_id`, `chat_history`, `correlation_id` передаются в `victoria.run()`; при перегрузке — 503 + Retry-After; слот освобождается в `finally` в `with_victoria_slot(sse_generator(...))`.
- **Совет Директоров:** стратегический классификатор → `POST /api/board/consult`; при ошибке — сообщение пользователю «Продолжаю с Victoria», `board_decision_text = None`, ответ формирует Victoria.
- **RAG в Victoria:** ключ кэша `md5(goal.strip().lower())`; TTL и макс. 500 записей; вытеснение устаревших ограничено 50 за вызов (см. §3).
- **Слот Victoria:** `acquire_victoria_slot()` перед потоком; `with_victoria_slot` в `finally` вызывает `release_victoria_slot()` — утечки слота при исключении нет.
- **Быстрый путь «что ты умеешь»:** константа `VICTORIA_CAPABILITIES_RESPONSE`, без вызова LLM; в `_check_ambiguity` добавлены фразы «что ты умеешь», «кто ты» и др. — уточнение не запрашивается.
- **Куратор:** проверка существования и непустоты файла при `--file`; отчёт с `output`/`knowledge`/`correlation_id`.

---

## 2. Ошибки и баги (исправлено / выявлено)

### 2.1. Исправлено ранее (в этой серии)

- Уточняющие вопросы на «что ты умеешь» / «кто ты» — добавлены в `simple_phrases` в `_check_ambiguity()`.
- Дублирование текста возможностей — единая константа `VICTORIA_CAPABILITIES_RESPONSE` в victoria_server.
- Куратор `--file`: проверка существования файла и ошибка при пустом файле.

### 2.2. Исправлено в этом аудите

- **RAG-кэш: O(n) при каждом запросе.** При большом кэше (до 500 записей) на каждый вызов `_get_knowledge_context` выполнялся полный проход по всем ключам для удаления устаревших. **Изменение:** ленивое вытеснение — не более 50 устаревших записей за один вызов; при следующих вызовах остальные подчищаются. Файл: `src/agents/bridge/victoria_server.py`.

### 2.3. Критических багов не найдено

- `board_decision_text` инициализируется как `None` до блока `is_strategic` — обращение к переменной безопасно.
- При таймауте Victoria пользователю возвращается понятное сообщение; слот освобождается в `finally`.
- Оркестратор: при недоступности Ollama/MLX — один вызов recovery webhook, без дублирования.

---

## 3. Улучшения быстродействия

| Место | Рекомендация | Статус |
|-------|--------------|--------|
| RAG-кэш Victoria | Ограничить число удаляемых устаревших записей за вызов (50) | **Сделано** |
| Эмбеддинг в Victoria | Один эмбеддинг на запрос, передача в RAG и эксперт — уже реализовано (MASTER_REFERENCE §0.4p) | — |
| Предзагрузка RAG | Типовые запросы в кэш при старте (RAG_PRELOAD_TYPICAL_QUERIES) — уже есть | — |
| Батч эмбеддингов | _get_embeddings_batch при предзагрузке — уже есть | — |
| Константа «что умеешь» | Единый источник в victoria_server — без вызова LLM для информационных фраз | **Сделано** ранее |

**Дополнительно (на будущее):** при росте нагрузки рассмотреть вынос RAG-кэша в Redis с TTL вместо in-memory (единый источник истины для нескольких инстансов Victoria).

---

## 4. Правильность решений и ответов

| Аспект | Проверка | Результат |
|--------|----------|-----------|
| Ответ «что ты умеешь» | Один и тот же структурированный текст, без «воды» от LLM | Ок (константа + быстрый путь) |
| Совет при ошибке | Пользователь видит сообщение об ошибке и «Продолжаю с Victoria»; ответ даёт Victoria | Ок |
| Стратегический классификатор | NON_STRATEGIC_KEYWORDS включают «что умеешь», «привет» и др.; короткие (<15 символов) — не стратегические | Ок |
| Цель в Victoria | В payload уходит `goal` (current_prompt), а не сырой message — учтён контекст Совета | Ок |
| project_context | Передаётся в chat и в Victoria; изоляция по проектам | Ок |

**Рекомендация:** сохранять единый источник текста возможностей (VICTORIA_CAPABILITIES_RESPONSE) и при изменении синхронизировать дубликат в victoria_enhanced (или вынести в общий модуль).

---

## 5. Связь с библией и чеклистом

- **MASTER_REFERENCE:** §3 (чат/задачи), §4 (worker/LLM), §5 (восстановление), RAG+ и кэш (§0.4o–§0.4u) — учтены при проверке цепочек.
- **VERIFICATION_CHECKLIST_OPTIMIZATIONS:** §3 (причины сбоев), §5 (при следующих изменениях) — без противоречий; при правках в RAG/Victoria/чат — сверяться с чеклистом.
- **CHANGES_FROM_OTHER_CHATS:** будет дополнен записью об аудите и оптимизации RAG-кэша (§0.4ab или аналог).

---

## 6. Итог

- **Тесты:** backend, Knowledge OS, frontend — пройдены.
- **Цепочки:** чат → Victoria, Совет, RAG, слот — проверены; логических ошибок не найдено.
- **Исправления:** RAG-кэш — ограничение вытеснения устаревших (50 за вызов).
- **Быстродействие:** константа «что умеешь», один эмбеддинг на запрос, предзагрузка RAG — уже внедрены; RAG-кэш оптимизирован.
- **Правильность:** ответы на информационные запросы и fallback при ошибке Совета работают корректно.

Полный аудит завершён. Рекомендации на будущее зафиксированы в §3–§4 и в VERIFICATION_2026-02-08.md.
