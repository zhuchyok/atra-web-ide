# Сбои задачи «покажи список файлов» в кураторе

**Назначение:** зафиксировать причину и действия «при следующих» сбоях.

---

## Что наблюдается

- В полных прогонах куратора задача **«покажи список файлов в корне проекта»** иногда завершается с **error** и текстом **Connection reset by peer** (или похожим).
- Время до ошибки — порядка 50–60 секунд (задача успевает запуститься, идёт опрос статуса, затем один из запросов получает обрыв соединения).

---

## Причина (диагноз)

1. **Цепочка:** куратор → POST /run (async) → Victoria → делегирует в **Veronica** (POST /run) → Veronica выполняет «список файлов» (LLM + `ls -la` и т.п.). Victoria ждёт ответ Veronica до **DELEGATE_VERONICA_TIMEOUT** (по умолчанию 60 с).

2. **Почему «connection reset»:** обрыв видит **клиент куратора** при вызове **GET /run/status/{task_id}**. То есть соединение закрывает **сервер** (Victoria или среда до неё). Возможные причины:
   - **Перезапуск/падение Victoria** во время длительной работы (OOM, падение процесса) — тогда следующий GET получает reset или connection refused.
   - **Долгое выполнение у Veronica** (холодный старт модели, большой каталог) — задача тянется близко к 60 с; при нагрузке или нехватке памяти Victoria может упасть в этот момент.
   - **Сетевой обрыв** между куратором и Victoria (редко при локальном запуске).

3. **Почему именно «список файлов»:** эта задача часто идёт в Veronica (простой запрос), выполнение может быть долгим (LLM + команда), и совпадает по времени с пиком нагрузки или нехватки памяти.

---

## Что сделано для устойчивости

- В кураторе при ошибке с **connection/reset/aborted** делается до **двух повторов** всей задачи (всего до 3 попыток).
- В цикле опроса **GET /run/status** при обрыве соединения делается несколько повторов запроса **по тому же task_id**, прежде чем вернуть error (см. `scripts/curator_send_tasks_to_victoria.py`).
- **DELEGATE_VERONICA_TIMEOUT** увеличен до 90 с по умолчанию, чтобы дать Veronica больше времени на «список файлов» без обрыва по таймауту.
- Режим **лёгкого старта** Victoria при OOM описан в **docs/VICTORIA_RESTARTS_CAUSE.md**.

---

## При следующих сбоях

1. **Проверить логи Victoria и Docker:** не было ли OOM (exit 137), перезапуска контейнера, падения процесса.
2. **Проверить Veronica:** доступна ли по `VERONICA_URL`, отвечает ли на POST /run за разумное время (например, curl с таймаутом 90 с).
3. **Запустить куратор в спокойный момент:** когда нет других тяжёлых задач на Victoria/Veronica.
4. **При стабильных OOM:** включить лёгкий старт Victoria (см. VICTORIA_RESTARTS_CAUSE) или увеличить память контейнера.
5. **Увеличить таймаут делегирования:** в окружении Victoria задать `DELEGATE_VERONICA_TIMEOUT=120` (или больше), если «список файлов» стабильно укладывается дольше 90 с.
6. **Проверить сеть:** при доступе к Victoria не с localhost — нет ли обрывов/таймаутов на стороне proxy или балансировщика.

---

## Связанные документы

- **docs/CURATOR_RUNBOOK.md** — как запускать прогоны и разбирать отчёты.
- **docs/VICTORIA_RESTARTS_CAUSE.md** — вылеты Victoria, OOM, лёгкий старт.
- **docs/curator_reports/FINDINGS_2026-02-08_full_run.md** — выводы по полным прогонам.
