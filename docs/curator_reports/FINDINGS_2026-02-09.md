# Выводы куратора по прогонам 2026-02-09

**Последний отчёт:** [curator_2026-02-09_21-53-54.json](curator_2026-02-09_21-53-54.json) (после повторного прогона «подними и ещё раз»).

---

## Решение внедрено (2026-02-09)

Чтобы Victoria в Docker стабильно отвечала (в т.ч. «какой статус проекта?»), сделано:

1. **В Docker сначала пробуем Ollama, потом MLX**  
   В `knowledge_os/app/victoria_enhanced.py` при `is_docker` и наличии обоих URL порядок сменён на `[ollama_url, mlx_url]`. Из контейнера Ollama (11434) доступен, MLX часто таймаут или вылет — запросы идут в Ollama и не упираются в «не могу подключиться к моделям».

2. **Таймаут сканирования MLX из Docker увеличен**  
   В `available_models_scanner.py` добавлен `MLX_SCAN_TIMEOUT` (по умолчанию 5 с). В `knowledge_os/docker-compose.yml` для victoria-agent задано `MLX_SCAN_TIMEOUT=12`, чтобы опрос host.docker.internal:11435 успевал при медленном ответе.

3. **MLX может вылетать после нагрузки**  
   После прогонов куратора или длинных запросов MLX API Server иногда падает (Metal OOM / SIGABRT, см. [MLX_PYTHON_CRASH_CAUSE.md](../MLX_PYTHON_CRASH_CAUSE.md)). Рекомендации:  
   - Запускать MLX через **wrapper с автоперезапуском:** `./scripts/start_mlx_server.sh` (вместо только `start_mlx_api_server.sh`).  
   - Либо при приоритете стабильности использовать только Ollama: Victoria теперь в Docker сначала обращается к Ollama, так что при вылете MLX ответы всё равно идут через Ollama.

**После изменений:** перезапустить Victoria:  
`docker compose -f knowledge_os/docker-compose.yml restart victoria-agent`  
Затем при необходимости прогнать куратора снова.

---

## Прогон 21-53-54 (2 задачи, quick)

| Задача                | Статус  | Время   | По содержанию |
|-----------------------|---------|---------|----------------|
| привет                | success | 0.01 с  | ✅ Эталонно    |
| какой статус проекта? | success | 179.4 с | ⚠️ Снова ответ «не могу подключиться к моделям» |

На хосте (Mac Studio) порты 11434 и 11435 были заняты; `curl` с хоста к Ollama дал 200, к MLX — 429. Куратор прогнан при работающих сервисах на хосте, но **Victoria в Docker** снова вернула сообщение о недоступности моделей.

---

## Проверка из контейнера Victoria

Выполнена проверка из `victoria-agent`:

- **Ollama (host.docker.internal:11434)** — ответ 200, доступен.
- **MLX (host.docker.internal:11435)** — таймаут (из контейнера запрос не успевает за 5 с).

Итог: для Victoria в Docker **Ollama с хоста доступен**, **MLX из контейнера не достигается** (таймаут). Возможные причины: MLX слушает только `127.0.0.1` и не принимает подключения с `host.docker.internal`, или MLX долго отвечает и срабатывает таймаут. В коде Victoria при неудаче подключения к моделям возвращается общее сообщение «не могу подключиться к MLX или Ollama», поэтому в ответе «статус проекта» снова текст об ошибке.

---

## Рекомендации

1. **Сделать MLX доступным из Docker:** запускать MLX API Server с привязкой к `0.0.0.0` (а не только к localhost), чтобы `host.docker.internal:11435` отвечал из контейнера. Либо поднять MLX в той же Docker-сети и передать в Victoria URL внутреннего сервиса.
2. **Или опираться на Ollama:** если Victoria при сканировании находит Ollama (11434) и выбирает его, то запросы «статус проекта» могут уйти в Ollama; проверить логи Victoria (какая модель выбрана при старте, есть ли ошибки при вызове 11435).
3. **Перезапуск Victoria после поднятия моделей:** после запуска Ollama/MLX на хосте перезапустить контейнер Victoria, чтобы повторное сканирование подхватило модели:  
   `docker compose -f knowledge_os/docker-compose.yml restart victoria-agent`
4. **Эталон «привет»:** по-прежнему выполняется корректно, доработок не требуется.

---

## Ранее (прогон 21-42-37)

Тот же результат: привет — ок; «статус проекта» — сообщение о недоступности моделей. См. историю в git.

---

## Сравнение с эталоном (2026-02-09, отчёт 22-04-12)

По отчёту `curator_2026-02-09_22-04-12.json` (2 задачи: привет, какой статус проекта?):

| Эталон        | Задача                 | Совпадений | Комментарий |
|---------------|------------------------|------------|-------------|
| greeting       | привет                 | 5/5        | ✅ Эталонно |
| status_project | какой статус проекта?  | 0/3        | Ответ обрезан/искажён («небольшизую при необходимости пересмотра»); доучить эталон в RAG или проверить контекст enhanced |

**Рекомендация:** при следующем прогоне полного набора (5 задач) повторить сравнение по эталонам what_can_you_do, list_files, one_line_code. Эталоны в RAG: `DATABASE_URL=... python3 scripts/curator_add_standard_to_knowledge.py` (идемпотентно).

---

## Сравнение по отчёту 5 задач (curator_2026-02-08_23-16-02, 2026-02-10)

| Задача | Эталон | Совпадений | Комментарий |
|--------|--------|------------|-------------|
| привет | greeting | 5/5 | Эталонно |
| что ты умеешь? | what_can_you_do | 8/9 | Почти эталонно |
| какой статус проекта? | status_project | 0/3 | В том прогоне — галлюцинация (enhanced path); эталон в RAG и в standards/ усилен явным **Эталонный ответ** |
| список файлов / одна строка кода | list_files, one_line_code | по контексту | Ответы есть (ls, код); ключевые фразы эталона не во всех ответах |

В **standards/status_project.md** добавлен явный блок **Эталонный ответ** с формулировкой для сравнения и для подтягивания из RAG. При следующем полном прогоне (Victoria + полный режим) повторить сравнение.

---

## Почему вылетела Victoria (2026-02-09)

**Проверка:** `docker inspect victoria-agent --format 'RestartCount: {{.RestartCount}} OOMKilled: {{.State.OOMKilled}}'`  
**Результат:** RestartCount: 6, **OOMKilled: true**

**Причина:** контейнер Victoria был убит ядром/Docker из‑за **нехватки памяти (OOM)**. При старте загружаются 51 skill, ReAct, Event Bus, Service Monitor, RAG preload с эмбеддингами — пик потребления в момент старта; при лимите Docker Memory ниже потребности контейнер получает SIGKILL (exit 137).

**Почему куратор видел «Victoria недоступна»:** в момент запуска куратора (22:50) Victoria либо только что упала (OOM), либо перезапускалась — на хосте :8010 не отвечал.

**Что делать (см. [VICTORIA_RESTARTS_CAUSE](../VICTORIA_RESTARTS_CAUSE.md) §2, [MAC_STUDIO_LOAD_AND_VICTORIA](../MAC_STUDIO_LOAD_AND_VICTORIA.md) §2.1):**
1. **Увеличить память Docker:** Docker Desktop → Settings → Resources → Memory → **10–14 GB** для Mac Studio (при 64–128 GB RAM хоста).
2. **Проверка после падения:** `docker inspect victoria-agent --format '{{.State.OOMKilled}}'` (true = OOM).
3. **Временно снизить нагрузку при старте** (если не хотите поднимать лимит): в `knowledge_os/docker-compose.yml` для `victoria-agent` задать `RAG_PRELOAD_TYPICAL_QUERIES: "false"`, `SERVICE_MONITOR_ENABLED: "false"` или `ENABLE_EVENT_MONITORING: "false"`, затем `docker compose -f knowledge_os/docker-compose.yml up -d victoria-agent --force-recreate`.
