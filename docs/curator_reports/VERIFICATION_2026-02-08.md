# Проверка, тесты и выявленные недочёты — 2026-02-08

**Запрос:** проверяй, тестируй, выявляй недостатки логики, ищи недочёты.

---

## 1. Тесты

| Набор | Результат |
|-------|-----------|
| Backend `backend/app/tests/` | 37 passed |
| Knowledge OS `test_json_fast_http_client` + `test_service_monitor` | 11 passed |
| Frontend `npm run test` | 4 passed (chat.spec.js) |

---

## 2. Исправленные недочёты логики

### 2.1. Уточняющие вопросы на «что ты умеешь» / «кто ты»

- **Проблема:** В `_check_ambiguity()` список `simple_phrases` не включал информационные фразы. При неблагоприятном сочетании (короткая строка + другие маркеры неоднозначности) для «что ты умеешь?» мог запрашиваться уточняющий вопрос вместо быстрого ответа.
- **Исправление:** В `simple_phrases` добавлены: `"что ты умеешь"`, `"что умеешь"`, `"кто ты"`, `"твои возможности"`, `"чем можешь помочь"`. Для таких запросов уточнение больше не запрашивается.

### 2.2. Дублирование текста «что умеешь»

- **Проблема:** Один и тот же текст возможностей был в двух местах (`victoria_server.run()` и `victoria_enhanced._execute_method()`), риск расхождения при правках.
- **Исправление:** В `victoria_server` введена константа **`VICTORIA_CAPABILITIES_RESPONSE`** (единый источник для быстрого пути). В `victoria_enhanced` оставлен дубликат с комментарием «Текст синхронизировать с victoria_server.VICTORIA_CAPABILITIES_RESPONSE».

### 2.3. Куратор: отсутствие проверки файла задач

- **Проблема:** При `--file <path>` при отсутствии файла возникал `FileNotFoundError` без понятного сообщения.
- **Исправление:** Перед чтением проверяется `path.exists()`; при отсутствии файла выводится сообщение и выход с кодом 1.

---

## 3. Проверенная логика (без изменений)

- **Оркестратор:** При недоступности Ollama вызывается `trigger_recovery_webhook(ollama_down=True, mlx_down=not mlx_ok)`; при недоступности только MLX — один вызов с `ollama_down=False, mlx_down=True`. Двойного вызова при обоих недоступных нет.
- **Куратор (async):** При `status == "failed"` в отчёт попадают `knowledge` и `correlation_id` из ответа статуса; при успехе — `output`, `knowledge`, `correlation_id`. Формат единообразен.
- **Быстрый путь «что ты умеешь»:** Проверка `any(p in goal_lower for p in (...))` корректно обрабатывает «что ты умеешь?» (подстрока «что ты умеешь» есть).

---

## 4. Рекомендации на будущее

- **Единый источник текста «что умеешь»:** При изменении текста возможностей править `VICTORIA_CAPABILITIES_RESPONSE` в `victoria_server.py` и вручную синхронизировать тот же текст в `victoria_enhanced._execute_method()` (или вынести в общий модуль, если появится общий код).
- **Куратор:** При `--file` с пустым файлом (нет непустых строк) скрипт выводит «В файле нет непустых строк с задачами» и выходит с кодом 1 (реализовано).
- **Интеграционные тесты:** Часть тестов Knowledge OS (e2e, rest_api с БД, knowledge_graph, performance_optimizer) требует поднятых сервисов; при изменении этих зон проверять в CI или локально с полным стеком.

---

## 5. Полный аудит корпорации

- Отчёт по связке, логике, багам и улучшениям: [CORPORATION_FULL_AUDIT_2026-02-08.md](CORPORATION_FULL_AUDIT_2026-02-08.md)
- В нём: тесты, критические цепочки (чат→Victoria, Совет, RAG, слот), исправление RAG-кэша (ленивое вытеснение до 50 устаревших за вызов), рекомендации по быстродействию и правильности.

## 6. Ссылки

- Выводы куратора: [FINDINGS_2026-02-08.md](FINDINGS_2026-02-08.md)
- Чеклист: docs/VERIFICATION_CHECKLIST_OPTIMIZATIONS.md §1, §3, §5
