# Куратор и наставник: причины неправильной работы с экспертами и мировыми практиками

**Назначение:** общий разбор для куратора (прогоны, эталоны, отчёты) и наставника (обучение Victoria/корпорации, эксперты, мировые практики). Ищем причины вместе — чтобы исправлять цепочку и контекст.

**Обновлено:** 2026-02-10

---

## 1. Цепочка запроса: кто решает и где теряются эксперты и практики

| Этап | Где | Что может пойти не так |
|------|-----|-------------------------|
| **POST /run** | `victoria_server.py` | Задача попадает в фоновый поток; выбор: Veronica → Enhanced → agent.run. |
| **Маршрутизация** | `task_detector`, `should_use_enhanced`, `_orchestrator_recommends_veronica` | Запрос «какой статус проекта?» может уйти в **Veronica** (оркестратор рекомендует) или в **agent.run** (ReAct, инструменты). Тогда **Enhanced.solve(simple)** с RAG и эталонами не вызывается. |
| **Enhanced.solve** | `victoria_enhanced.py` | Только если запрос не отдан Veronica и `victoria_enhanced_instance` создан. Внутри: выбор метода (simple / extended_thinking / swarm / consensus). Для «статус» нужен **simple** и вызов `_get_curator_rag_context(goal)`. |
| **Simple + RAG** | `victoria_enhanced.py` (simple, универсальный промпт) | RAG (домен `curator_standards`) подтягивается только в этой ветке. Если запрос обработан через Veronica или agent.run — **эталоны и база знаний не подмешиваются**. |
| **Мировые практики** | `victoria_enhanced.py` | Контекст `WORLD_PRACTICES_CONTEXT` подмешивается только в **extended_thinking** при ключевых словах «мировые практики», «best practices», «world practices». В **simple** мировые практики в промпт не попадают. |
| **Эксперты** | Department Heads, Swarm, Consensus, expert_services | Вызов экспертов (Игорь, Анна, Дмитрий и др.) происходит в Enhanced при методах swarm/consensus/department_heads. Для коротких запросов («статус», «привет») выбирается **simple** — один вызов LLM **без** привлечения экспертов по ролям. |

---

## 2. Конкретные причины (по фактам из прогонов и кода)

### 2.1. Эталон «какой статус проекта?» 0/3

- **Причина 1 (уже исправлена):** В методе **simple** не было запроса к RAG (knowledge_nodes, домен curator_standards). Промпт собирался только из роли и запроса → модель отвечала из весов → галлюцинация.  
  **Решение:** добавлен `_get_curator_rag_context(goal)`, подмешивание эталона в промпт, fallback-эталон из кода при пустом RAG. См. FINDINGS_2026-02-10, CHANGES §0.4ce, §0.4cj.

- **Причина 2 (найдена 2026-02-10):** Запрос может **не попадать в simple** по двум причинам: (а) контейнер victoria-agent работает со **старым образом** (после правок в коде делали только `restart`, не `build` → в образе старый task_detector/victoria_server/victoria_enhanced); (б) в **victoria_enhanced.py** была синтаксическая ошибка (стр. 618: лишняя скобка в `if not row or not (...).strip():`), из‑за чего в части окружений модуль не загружался и Enhanced не создавался → запрос шёл в agent.run (ReAct).  
  **Решение:** (1) Исправлена скобка в `victoria_enhanced.py`. (2) После любых изменений в bridge или Enhanced — **пересобрать образ** и поднять контейнер: `docker compose -f knowledge_os/docker-compose.yml build victoria-agent && docker compose -f knowledge_os/docker-compose.yml up -d victoria-agent`. (3) Трассировка: `python3 scripts/trace_status_project_route.py` — проверяет task_type=enhanced, category=status_query, method=simple для «какой статус проекта?».

### 2.2. Эксперты не участвуют в ответе

- В **simple** и в **extended_thinking** (без swarm/consensus) ответ даёт одна модель по промпту. Роли экспертов (Игорь, Анна, Дмитрий и др.) подмешиваются в промпты только при:
  - Department Heads (определение отдела, координация);
  - Swarm / Consensus (много агентов);
  - явном запросе вида «что бы сказали эксперты…».
- Для задач из куратора («привет», «статус», «что умеешь», «список файлов», «одна строка кода») по умолчанию выбирается быстрый путь (simple или делегирование Veronica), **без** вызова экспертов по ролям.  
  **Итог:** «неправильная работа с экспертами» отчасти заложена дизайном: для коротких эталонных запросов эксперты не привлекаются. Если наставник хочет, чтобы ответы опирались на мнения экспертов, нужно либо расширить промпт simple (краткий блок «как бы ответили эксперты» из БД/конфига), либо маршрутизировать часть запросов в swarm/consensus.

### 2.3. Мировые практики не в контексте

- **WORLD_PRACTICES_CONTEXT** (OpenAI, Anthropic, Meta, Microsoft, LangGraph и т.д.) подставляется в **extended_thinking** только при наличии в запросе слов «мировые практики», «best practices», «world practices». В **simple** этот блок не добавляется.  
  **Действие:** если куратор/наставник хотят, чтобы ответы по умолчанию учитывали мировые практики, можно: (1) добавить в simple короткий блок «мировые практики» в промпт для категорий general/status_query, или (2) явно помечать в списке задач куратора запросы, для которых нужен extended_thinking с этим контекстом.

### 2.4. Сбои «список файлов», таймауты, «не могу подключиться к моделям»

- Описаны в CURATOR_LIST_FILES_FAILURES.md (connection reset, долгий ответ Veronica, OOM Victoria).  
- «Не могу подключиться к моделям» в ответе — часто таймаут или недоступность Ollama/MLX при вызове из Enhanced. Увеличены таймауты в Docker; при необходимости смотреть логи Victoria и доступность :11434/:11435.

---

## 3. Что делать вместе (куратор + наставник)

| Действие | Кто | Где |
|----------|-----|-----|
| Прогон куратора, сравнение с эталонами | Куратор | run_curator_scheduled.sh, curator_compare_to_standard.py, FINDINGS_*.md |
| Проверка маршрута для «статус проекта» | Оба | Логи Victoria: routed_to, method; при agent_run — правка task_detector / enhanced_router |
| Добавление эталонов в RAG | Куратор | curator_add_standard_to_knowledge.py, standards/, --update-status |
| Решение: привлекать экспертов для коротких ответов | Наставник | Промпт simple или маршрутизация в swarm/consensus для выбранных типов запросов |
| Подмешивание мировых практик в simple | Наставник | victoria_enhanced.py: блок WORLD_PRACTICES или короткая выжимка в универсальном промпте |
| Фиксация новых причин | Оба | Этот файл, FINDINGS_*.md, CHANGES_FROM_OTHER_CHATS |

---

## 4. Ссылки

- **Выводы куратора:** [FINDINGS_2026-02-10.md](FINDINGS_2026-02-10.md)
- **Runbook куратора:** [../CURATOR_RUNBOOK.md](../CURATOR_RUNBOOK.md)
- **План куратора и наставника:** [../VICTORIA_CURATOR_PLAN.md](../VICTORIA_CURATOR_PLAN.md)
- **Цепочка задачи Victoria:** [../VICTORIA_TASK_CHAIN_FULL.md](../VICTORIA_TASK_CHAIN_FULL.md)
- **Сбои «список файлов»:** [CURATOR_LIST_FILES_FAILURES.md](CURATOR_LIST_FILES_FAILURES.md)
- **Эталоны:** [standards/](standards/)

При обнаружении новой причины неправильной работы с экспертами или мировыми практиками — дополнять этот документ и связанные FINDINGS.

**Куратор как регрессия (постоянное совершенствование):** после изменений в коде Victoria/Enhanced — прогнать куратора и сравнение с эталоном (`curator_compare_to_standard.py`). Если ответ стабильно хорош и его хотят зафиксировать как эталон — **candidate for standard**: добавить в `standards/` новый файл (или обновить существующий), затем `curator_add_standard_to_knowledge.py` (при необходимости с флагом обновления). Обратная связь «принять»: при ручной проверке «это правильный ответ» — зафиксировать в эталоне и RAG.

---

## 5. Варианты решений и гипотезы (2026-02-10)

### Внедрённые решения

| Проблема | Решение | Где |
|----------|---------|-----|
| **Эталон «статус проекта» уходил в Veronica или без RAG** | Запросы кураторских эталонов (статус проекта, что умеешь, дашборд) не делегировать в Veronica и направлять в Enhanced (simple + RAG). | `task_detector.py`: `is_curator_standard_goal()`; `detect_task_type` для таких целей возвращает `enhanced`. `victoria_server.py`: `prefer_veronica = False` при `is_curator_standard_goal(goal)` (sync и background). |
| **Мировые практики только в extended_thinking** | В ветку **simple** добавлена одна строка в промпт: «Учитывай лучшие практики: один источник истины (документация), проверяемый результат, актуальная библия (MASTER_REFERENCE)». | `victoria_enhanced.py`: блок универсального промпта (simple), пункт 6. |
| **RAG не запрашивался в simple** | Уже исправлено ранее: `_get_curator_rag_context(goal)`, fallback-эталон при пустом RAG для «статус проекта». | FINDINGS_2026-02-10, §0.4ce/0.4cj. |

### Гипотезы и альтернативы (на будущее)

| Гипотеза | Описание | Когда применять |
|----------|----------|------------------|
| **«Список файлов» в Enhanced для стабильности** | Маршрутизировать «покажи список файлов» в Enhanced (simple или быстрый ответ), а не в Veronica, чтобы снизить риск connection reset при долгом ответе Veronica. | При стабильных сбоях «список файлов» (CURATOR_LIST_FILES_FAILURES); можно флагом `CURATOR_LIST_FILES_VIA_ENHANCED=true`. |
| **Приветствие через Enhanced для эталона** | Сейчас «привет» → simple_chat → agent.run (эталон greeting 5/5). Если понадобится жёстко следовать RAG-эталону приветствия — добавить «привет» в `is_curator_standard_goal` и возвращать `enhanced`. | Если сравнение с эталоном greeting начнёт падать. |
| **Краткий блок экспертов в simple** | Для статус/что умеешь подмешивать в промпт одну фразу вида «Ответ в духе команды: дашборд, MASTER_REFERENCE» из team.md или expert_services (без вызова Swarm). | Если наставник захочет, чтобы короткие ответы «звучали» от лица экспертов без полного swarm. |
| **Расширенный WORLD_PRACTICES в simple** | Подставлять в simple не одну строку, а сокращённый абзац из `WORLD_PRACTICES_CONTEXT` для категорий general/status_query. | При запросах «как вы организуете работу?», «какие практики используете?». |

### Накопившиеся пункты (закрыты или отложены)

- **Эталон status_project 0/3:** RAG + fallback внедрены; маршрутизация кураторских целей в Enhanced без Veronica — внедрена.
- **Эксперты не в коротких ответах:** по дизайну; при необходимости — гипотеза «краткий блок экспертов в simple».
- **Connection reset / список файлов:** ретраи и таймаут 90 с; при повторениях — гипотеза «список файлов через Enhanced».
- **План оркестратора не ведёт к исполнению:** решение зафиксировано (план = подсказка), см. WHATS_NOT_DONE §1.
