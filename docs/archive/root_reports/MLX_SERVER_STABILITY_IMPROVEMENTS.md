# üîß –£–ª—É—á—à–µ–Ω–∏—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ MLX API Server

## ‚ùå –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ—Ä—Ç–æ–≤**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–ª—Å—è –Ω–∞ –ø–æ—Ä—Ç—É `11434`, –∞ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–∞–ª–∏—Å—å –∫ `11435`
- **–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—Ç –Ω–∞ `11435` (–º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ `MLX_API_PORT`)

### 2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω –ª–∏–º–∏—Ç `_max_concurrent_requests = 5`

### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥–ª–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
- **–†–µ—à–µ–Ω–∏–µ**: Rate limiting: `30 –∑–∞–ø—Ä–æ—Å–æ–≤/60 —Å–µ–∫—É–Ω–¥` –Ω–∞ IP

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–º—è—Ç–∏**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π –≤–æ–∑–º–æ–∂–µ–Ω OOM
- **–†–µ—à–µ–Ω–∏–µ**: 
  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ `>85%` –ø–∞–º—è—Ç–∏
  - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ `>95%` –ø–∞–º—è—Ç–∏

### 5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ graceful error handling**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ä–≤–µ—Ä –º–æ–≥ —É–ø–∞—Å—Ç—å
- **–†–µ—à–µ–Ω–∏–µ**: 
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ `MemoryError` –∏ `RuntimeError`
  - –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (5 –º–∏–Ω—É—Ç)
  - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

### 6. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ connection pooling**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–≤–∞–ª –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- **–†–µ—à–µ–Ω–∏–µ**: `timeout_keep_alive=120` –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞**
```python
PORT = int(os.getenv("MLX_API_PORT", 11435))  # –ë—ã–ª–æ: 11434
```

### 2. **Rate Limiting Middleware**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: `30 –∑–∞–ø—Ä–æ—Å–æ–≤/60 —Å–µ–∫—É–Ω–¥` –Ω–∞ IP
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
- HTTP 429 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

### 3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏**
- –õ–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: `5`
- HTTP 503 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏**
```python
def check_memory() -> Dict[str, float]:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏"""
    memory = psutil.virtual_memory()
    return {
        "used_percent": memory.percent / 100,
        "available_gb": memory.available / (1024**3)
    }
```

### 5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –º–æ–¥–µ–ª–µ–π**
- –ü—Ä–∏ `>85%` –ø–∞–º—è—Ç–∏: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- –ü—Ä–∏ `>95%` –ø–∞–º—è—Ç–∏: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π
- –û—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å

### 6. **Graceful Error Handling**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `MemoryError` ‚Üí HTTP 503
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `TimeoutError` ‚Üí HTTP 504
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

### 7. **Connection Pooling**
```python
uvicorn.run(
    app,
    timeout_keep_alive=120,  # Keep-alive –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    limit_concurrency=_max_concurrent_requests + 5
)
```

### 8. **–£–ª—É—á—à–µ–Ω–Ω—ã–π Health Check**
```json
{
    "status": "healthy",
    "active_requests": 2,
    "max_concurrent": 5,
    "memory": {
        "used_percent": 45.2,
        "available_gb": 32.1,
        "status": "ok"
    }
}
```

## üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
- `MLX_API_PORT` - –ø–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 11435)
- `MLX_API_WORKERS` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ workers (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1, —Ç.–∫. MLX –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç multiprocessing)

### –õ–∏–º–∏—Ç—ã:
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: 5
- **Rate limit**: 30 –∑–∞–ø—Ä–æ—Å–æ–≤/60 —Å–µ–∫—É–Ω–¥ –Ω–∞ IP
- **–¢–∞–π–º–∞—É—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**: 5 –º–∏–Ω—É—Ç
- **Memory warning**: 85%
- **Memory critical**: 95%

## üöÄ –ó–∞–ø—É—Å–∫

```bash
# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫
python3 knowledge_os/app/mlx_api_server.py

# –° –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø–æ—Ä—Ç–æ–º
MLX_API_PORT=11435 python3 knowledge_os/app/mlx_api_server.py
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health Check:
```bash
curl http://localhost:11435/health
```

### –°—Ç–∞—Ç—É—Å:
```bash
curl http://localhost:11435/
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç: `lsof -i :11435`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞–º—è—Ç—å: `curl http://localhost:11435/health | jq .memory`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –ø–∞–º—è—Ç–∏

### –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω rate limit:
- –ü–æ–¥–æ–∂–¥–∞—Ç—å 60 —Å–µ–∫—É–Ω–¥
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞

### –ï—Å–ª–∏ –Ω–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏:
- –°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≥—Ä—É–∑–∏—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏
- –ú–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å:
- ‚úÖ –£—Å—Ç–æ–π—á–∏–≤ –∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ
- ‚úÖ –ó–∞—â–∏—â–µ–Ω –æ—Ç OOM
- ‚úÖ –ò–º–µ–µ—Ç rate limiting
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –ø–∞–º—è—Ç—å
- ‚úÖ Graceful error handling
- ‚úÖ Connection pooling
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ
