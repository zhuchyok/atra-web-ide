# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò "TOO MANY CLIENTS ALREADY"

**–î–∞—Ç–∞:** 2026-01-28  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

---

## üîç –ü–†–û–ë–õ–ï–ú–ê

**–û—à–∏–±–∫–∞:** `psql: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL: sorry, too many clients already`

**–ü—Ä–∏—á–∏–Ω–∞:**
- –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ PostgreSQL
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- Connection pools –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- Idle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è

---

## ‚úÖ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### **1. Smart Worker Autonomous** ‚úÖ

**–§–∞–π–ª:** `knowledge_os/app/smart_worker_autonomous.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ singleton –ø—É–ª–∞ –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ `pool.acquire()` –∏ `async with`
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—É–ª–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω `max_size` –¥–æ 10 —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π `max_inactive_connection_lifetime`

**–ö–æ–¥:**
```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (singleton)
_pool = None

async def get_pool():
    global _pool
    if _pool is None:
        _pool = await asyncpg.create_pool(
            DB_URL, 
            min_size=1, 
            max_size=10,
            max_inactive_connection_lifetime=300,  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
            command_timeout=60
        )
    return _pool

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
async with pool.acquire() as conn:
    async with conn.transaction():
        # –†–∞–±–æ—Ç–∞ —Å –ë–î
        ...
```

---

### **2. Auto-fix DB Connections** ‚úÖ

**–§–∞–π–ª:** `knowledge_os/app/auto_fix_db_connections.py` (–Ω–æ–≤—ã–π)

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö idle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (>5 –º–∏–Ω—É—Ç)
- ‚úÖ –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 80% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "too many clients"

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
2. –ï—Å–ª–∏ > 80% ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ—Ç idle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç
3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "too many clients" ‚Üí —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

---

## üéØ –ü–†–ï–í–ï–ù–¢–ò–í–ù–´–ï –ú–ï–†–´

### **1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ–º acquire –∏ async with
async with pool.acquire() as conn:
    async with conn.transaction():
        result = await conn.fetch("SELECT ...")
    # –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
conn = await pool.acquire()
result = await conn.fetch("SELECT ...")
# –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º!
```

### **2. –¢–∞–π–º–∞—É—Ç—ã –∏ –ª–∏–º–∏—Ç—ã:**

- `max_inactive_connection_lifetime=300` - –∑–∞–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
- `command_timeout=60` - —Ç–∞–π–º–∞—É—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
- `max_size=10` - –º–∞–∫—Å–∏–º—É–º 10 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –ø—É–ª–µ

### **3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:**

- Auto-fix —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ idle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**
```sql
SELECT 
    count(*) as total,
    count(*) FILTER (WHERE state = 'idle') as idle,
    count(*) FILTER (WHERE state = 'active') as active
FROM pg_stat_activity 
WHERE datname = 'knowledge_os';
```

**–ó–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**
```sql
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE datname = 'knowledge_os' 
AND state = 'idle' 
AND state_change < NOW() - INTERVAL '5 minutes';
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢

- ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ idle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "too many clients"
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Smart Worker
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω Auto-fix —Å–∫—Ä–∏–ø—Ç
3. üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ –Ω–∞ —É—Ç–µ—á–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
4. üîÑ –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ Enhanced Orchestrator

---

## üìù –£–†–û–ö–ò

**–ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –ë–î:**
1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `async with pool.acquire()` –∏–ª–∏ `async with conn.transaction()`
2. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Å—Ç–∞–≤–ª—è–π—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç—ã–º–∏
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ singleton –¥–ª—è connection pools
4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã –∏ –ª–∏–º–∏—Ç—ã
5. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–≠—Ç–æ –º–∏–Ω–∏-—Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã:**
- ‚úÖ –û–±–Ω–∞—Ä—É–∂–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É
- ‚úÖ –ù–∞—à–ª–∏ –ø—Ä–∏—á–∏–Ω—É
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–¥
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
