# üîß –†–µ–∑—é–º–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π MLX API Server

## ‚ùå –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø–∞–¥–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞

### 1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ—Ä—Ç–æ–≤**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–ª—Å—è –Ω–∞ `11434`, –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–∞–ª–∏—Å—å –∫ `11435`
- **–ü—Ä–∏—á–∏–Ω–∞**: –û–ø–µ—á–∞—Ç–∫–∞ –≤ –∫–æ–¥–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª –ø–æ—Ä—Ç –Ω–∞ 11434, –Ω–æ –∫–ª–∏–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç 11435)
- **–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—Ç –Ω–∞ `11435` (–º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ `MLX_API_PORT`)

### 2. **–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–∞–ª—Å—è
- **–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- **–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –õ–∏–º–∏—Ç `5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤` + HTTP 503 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

### 3. **–ù–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏ (OOM)**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π –≤–æ–∑–º–æ–∂–µ–Ω Out of Memory
- **–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–º—è—Ç–∏, –º–æ–¥–µ–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ –∫—ç—à–µ
- **–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ `>95%` –ø–∞–º—è—Ç–∏

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –±—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–≥—Ä—É–∂–∞–ª–∏ —Å–µ—Ä–≤–µ—Ä
- **–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç DDoS/–ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
- **–†–µ—à–µ–Ω–∏–µ**: ‚úÖ Rate limiting: `30 –∑–∞–ø—Ä–æ—Å–æ–≤/60 —Å–µ–∫—É–Ω–¥` –Ω–∞ IP

### 5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –î–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥–ª–∏ "–≤–∏—Å–µ—Ç—å" –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- **–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- **–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –¢–∞–π–º–∞—É—Ç `5 –º–∏–Ω—É—Ç` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

### 6. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ graceful error handling**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ä–≤–µ—Ä –ø–∞–¥–∞–ª –±–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- **–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ `MemoryError`, `TimeoutError`, `RuntimeError`

### 7. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ connection pooling**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–≤–∞–ª –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- **–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Ç keep-alive
- **–†–µ—à–µ–Ω–∏–µ**: ‚úÖ `timeout_keep_alive=120` –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞
```python
PORT = int(os.getenv("MLX_API_PORT", 11435))  # –ë—ã–ª–æ: 11434
```

### 2. Rate Limiting
- Middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- `30 –∑–∞–ø—Ä–æ—Å–æ–≤/60 —Å–µ–∫—É–Ω–¥` –Ω–∞ IP
- HTTP 429 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

### 3. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
- –õ–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: `5`
- HTTP 503 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ `>95%`
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–µ—Ö–≤–∞—Ç–∫–µ

### 5. Graceful Error Handling
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `MemoryError` ‚Üí HTTP 503
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `TimeoutError` ‚Üí HTTP 504
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 6. Connection Pooling
- `timeout_keep_alive=120`
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### 7. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
- Wrapper —Å–∫—Ä–∏–ø—Ç `scripts/start_mlx_server.sh`
- –î–æ 10 –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
- –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏

## üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
MLX_API_PORT=11435          # –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞
MLX_API_WORKERS=1           # Workers (MLX –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç multiprocessing)
```

### –õ–∏–º–∏—Ç—ã:
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: 5
- **Rate limit**: 30 –∑–∞–ø—Ä–æ—Å–æ–≤/60 —Å–µ–∫—É–Ω–¥ –Ω–∞ IP
- **–¢–∞–π–º–∞—É—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**: 5 –º–∏–Ω—É—Ç
- **Memory warning**: 85%
- **Memory critical**: 95%

## üöÄ –ó–∞–ø—É—Å–∫

### –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π:
```bash
python3 knowledge_os/app/mlx_api_server.py
```

### –° –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º:
```bash
./scripts/start_mlx_server.sh
```

### –í —Ñ–æ–Ω–µ:
```bash
nohup ./scripts/start_mlx_server.sh > logs/mlx_server.log 2>&1 &
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health Check:
```bash
curl http://localhost:11435/health | jq
```

### –°—Ç–∞—Ç—É—Å:
```bash
curl http://localhost:11435/ | jq
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç: `lsof -i :11435`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞–º—è—Ç—å: `curl http://localhost:11435/health | jq .memory`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `tail -f logs/mlx_server_wrapper.log`

### –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω rate limit:
- –ü–æ–¥–æ–∂–¥–∞—Ç—å 60 —Å–µ–∫—É–Ω–¥
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞

### –ï—Å–ª–∏ –Ω–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏:
- –°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≥—Ä—É–∑–∏—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏
- –ú–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å: `./scripts/start_mlx_server.sh`

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ:
- `fastapi`
- `uvicorn`
- `mlx_lm`

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ (–¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–º—è—Ç–∏):
- `psutil` (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: `pip install psutil`)

–ï—Å–ª–∏ `psutil` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏ –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω, –Ω–æ —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å:
- ‚úÖ –£—Å—Ç–æ–π—á–∏–≤ –∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ
- ‚úÖ –ó–∞—â–∏—â–µ–Ω –æ—Ç OOM
- ‚úÖ –ò–º–µ–µ—Ç rate limiting
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –ø–∞–º—è—Ç—å
- ‚úÖ Graceful error handling
- ‚úÖ Connection pooling
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–∞–¥–∞—Ç—å!** üéâ

## üîÑ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

1. **–ü–æ—Ä—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω**: 11435 –≤–º–µ—Å—Ç–æ 11434
2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏**: –ª–∏–º–∏—Ç—ã –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
3. **–î–æ–±–∞–≤–ª–µ–Ω rate limiting**: –∑–∞—â–∏—Ç–∞ –æ—Ç DDoS
4. **–î–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ
5. **–î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã**: –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è
6. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: graceful degradation
7. **–î–æ–±–∞–≤–ª–µ–Ω connection pooling**: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
8. **–î–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫**: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
