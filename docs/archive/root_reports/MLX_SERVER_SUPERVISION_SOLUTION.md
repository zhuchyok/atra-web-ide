# üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–∞–¥–µ–Ω–∏—è MLX Server: Supervision Pattern

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

MLX API Server –ø–∞–¥–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏:
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- –°–∏–Ω—Ç–µ–∑–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Victoria
- –í—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ fallback Ollama (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
- –ü–æ—Ç–µ—Ä—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: Supervision Pattern (–º–∏—Ä–æ–≤—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏)

### 1. **Elixir-Style Supervision Tree**

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ —Å rate limiting.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `MLXServerSupervisor` - supervisor –¥–ª—è MLX API Server
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–∞–¥–µ–Ω–∏—è
- Rate limiting: –º–∞–∫—Å–∏–º—É–º 5 –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –∑–∞ 5 –º–∏–Ω—É—Ç
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞

### 2. **Exponential Backoff**

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 2 —Å–µ–∫—É–Ω–¥—ã
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 60 —Å–µ–∫—É–Ω–¥
- –§–æ—Ä–º—É–ª–∞: `delay = min(2 * 2^n, 60)` –≥–¥–µ n - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ü–∏–∫–ª—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- –î–∞–µ—Ç –≤—Ä–µ–º—è —Å–∏—Å—Ç–µ–º–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
- –°–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–∏—Å—Ç–µ–º—É

### 3. **Circuit Breaker Pattern**

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `CircuitBreaker` –∏–∑ `circuit_breaker.py`
- –ü–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ ‚Üí Circuit OPEN
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ HALF_OPEN –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- **CLOSED**: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
- **OPEN**: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
- **HALF_OPEN**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### 4. **Health Monitoring**

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–µ—Ä–∞.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- Health check –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `/health` endpoint
- –ü–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ ‚Üí —Å–µ—Ä–≤–µ—Ä —Å—á–∏—Ç–∞–µ—Ç—Å—è —É–ø–∞–≤—à–∏–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–∞–¥–µ–Ω–∏—è

### 5. **Graceful Shutdown**

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ SIGTERM –¥–ª—è graceful shutdown
- –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–¥–æ 10 —Å–µ–∫—É–Ω–¥)
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (SIGKILL) –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ
- –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ (–º–æ–¥–µ–ª–∏, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
MLXServerSupervisor
‚îú‚îÄ‚îÄ Process Management
‚îÇ   ‚îú‚îÄ‚îÄ Start Server
‚îÇ   ‚îú‚îÄ‚îÄ Stop Server (graceful)
‚îÇ   ‚îî‚îÄ‚îÄ Monitor Process
‚îú‚îÄ‚îÄ Health Monitoring
‚îÇ   ‚îú‚îÄ‚îÄ Health Check Loop (10s)
‚îÇ   ‚îú‚îÄ‚îÄ Failure Detection (3 failures)
‚îÇ   ‚îî‚îÄ‚îÄ Status Tracking
‚îú‚îÄ‚îÄ Restart Logic
‚îÇ   ‚îú‚îÄ‚îÄ Rate Limiting (5 restarts / 5min)
‚îÇ   ‚îú‚îÄ‚îÄ Exponential Backoff (2s ‚Üí 60s)
‚îÇ   ‚îî‚îÄ‚îÄ State Management
‚îî‚îÄ‚îÄ Circuit Breaker
    ‚îú‚îÄ‚îÄ Failure Tracking
    ‚îú‚îÄ‚îÄ State Transitions
    ‚îî‚îÄ‚îÄ Recovery Testing
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Å Supervisor:

```bash
# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫ (—Å supervisor)
python3 scripts/start_mlx_with_supervisor.py

# –ò–ª–∏ —á–µ—Ä–µ–∑ wrapper —Å–∫—Ä–∏–ø—Ç
./scripts/start_mlx_server.sh
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ServiceMonitor:

```python
from app.service_monitor import ServiceMonitor, Service
from app.mlx_server_supervisor import get_mlx_supervisor

# ServiceMonitor —É–∂–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç MLX Server
# Supervisor –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
```

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```python
from app.mlx_server_supervisor import get_mlx_supervisor

supervisor = get_mlx_supervisor()

# –ó–∞–ø—É—Å–∫
await supervisor.start()

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
status = supervisor.get_status()
print(f"State: {status['state']}, Restarts: {status['restart_count']}")

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
await supervisor.stop()
```

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** - —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. **–ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤** - Circuit Breaker –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤** - Exponential backoff —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
5. **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç—É—Å supervisor:

```python
status = supervisor.get_status()
# {
#   "state": "running",
#   "process_pid": 12345,
#   "restart_count": 0,
#   "health_check_failures": 0,
#   "circuit_breaker_state": "closed"
# }
```

### –õ–æ–≥–∏:

```
‚úÖ [SUPERVISOR] MLX API Server –∑–∞–ø—É—â–µ–Ω –∏ –∑–¥–æ—Ä–æ–≤ (PID: 12345)
üîç [SUPERVISOR] –ó–∞–ø—É—â–µ–Ω —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚ö†Ô∏è [SUPERVISOR] Health check failed (1/3)
‚ùå [SUPERVISOR] –°–µ—Ä–≤–µ—Ä —É–ø–∞–ª (–∫–æ–¥: 1)
üîÑ [SUPERVISOR] –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...
‚è≥ [SUPERVISOR] –û–∂–∏–¥–∞–Ω–∏–µ 2.0—Å –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º (exponential backoff)
‚úÖ [SUPERVISOR] MLX API Server –∑–∞–ø—É—â–µ–Ω –∏ –∑–¥–æ—Ä–æ–≤ (PID: 12346)
```

## üåç –ú–∏—Ä–æ–≤—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. **Elixir/OTP Supervision Trees**
- –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
- –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (one-for-one, one-for-all)

### 2. **Akka Supervision (Scala)**
- Actor-based supervision
- Restart strategies
- Backoff supervisors

### 3. **Kubernetes Pod Restart Policies**
- Always, OnFailure, Never
- Restart limits
- Exponential backoff

### 4. **Systemd Service Management**
- Restart policies
- Restart limits
- Restart delays

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

MLX API Server —Ç–µ–ø–µ—Ä—å:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
- ‚úÖ –ó–∞—â–∏—â–µ–Ω –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤ (Circuit Breaker)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç exponential backoff –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—Å—è –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è (graceful shutdown)

**–°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ
