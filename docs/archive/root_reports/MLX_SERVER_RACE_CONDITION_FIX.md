# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Race Condition –≤ MLX Server

## üîç –ü—Ä–æ–±–ª–µ–º–∞

**–ú–æ–º–µ–Ω—Ç –ø–∞–¥–µ–Ω–∏—è:** 20:05:26 - 20:05:31  
**–ü—Ä–∏—á–∏–Ω–∞:** SIGABRT (-6) - –∞–≤–∞—Ä–∏–π–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ  
**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** Race condition –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ú–æ–¥–µ–ª—å –Ω–µ —Ç—è–∂–µ–ª–∞—è?**
   - `deepseek-r1-distill-llama:70b` - —ç—Ç–æ ~40GB –º–æ–¥–µ–ª—å (distilled –≤–µ—Ä—Å–∏—è)
   - –î–ª—è Mac Studio M4 Max —Å 128GB RAM —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π
   - **–ù–û:** –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ —Ä–∞–∑–º–µ—Ä–µ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏!

2. **–†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: Race Condition**
   ```
   –ó–∞–ø—Ä–æ—Å 1 ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—ç—à ‚Üí –Ω–µ—Ç ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É (40GB)
   –ó–∞–ø—Ä–æ—Å 2 ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—ç—à ‚Üí –Ω–µ—Ç ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É (40GB)
   –†–µ–∑—É–ª—å—Ç–∞—Ç: 80GB –≤ –ø–∞–º—è—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí OOM ‚Üí SIGABRT
   ```

3. **–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**
   - –î–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏
   - –û–±–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É `if model_key in _models_cache` –î–û –∑–∞–≥—Ä—É–∑–∫–∏
   - –û–±–∞ –Ω–∞—á–∏–Ω–∞—é—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –º–æ–¥–µ–ª—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ `model_lock` –∑–∞—â–∏—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –î–û –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–≤–æ–π–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ = 80GB –≤–º–µ—Å—Ç–æ 40GB

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `get_model()`:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –ü–ï–†–ï–î –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤ `_loading_models`**
   - –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–æ–¥–µ–ª—å –≤ –∫—ç—à–µ
   - –ï—Å–ª–∏ –µ—Å—Ç—å - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–∑—É

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ `_loading_models` –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π**
   - –ï—Å–ª–∏ –º–æ–¥–µ–ª—å —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –∑–∞–ø—Ä–æ—Å–æ–º - –∂–¥–µ–º
   - –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
   - –ú–∞–∫—Å–∏–º—É–º 60 —Å–µ–∫—É–Ω–¥ –æ–∂–∏–¥–∞–Ω–∏—è

3. **–î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è**
   - –ü–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è —Å–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
   - –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ –∫—ç—à–∞
   - –ï—Å–ª–∏ –Ω–µ—Ç - –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∞–º–∏

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:

```python
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –ü–ï–†–í–û–ô (–±—ã—Å—Ç—Ä–æ)
if model_key in _models_cache:
    return _models_cache[model_key]

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ
if model_key in _loading_models:
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–≥–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
    wait_for_loading_to_complete()
    if model_key in _models_cache:
        return _models_cache[model_key]

# 3. –¢–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
_loading_models.add(model_key)
load_model()
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ –ù–µ—Ç –¥–≤–æ–π–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏: 40GB –≤–º–µ—Å—Ç–æ 80GB
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç OOM –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

## üîÑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω watchdog** –¥–ª—è hot-reload skills
2. **–£–ª—É—á—à–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç race condition** –≤ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–µ–π
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º
