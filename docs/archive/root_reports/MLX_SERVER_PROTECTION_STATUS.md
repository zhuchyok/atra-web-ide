# üõ°Ô∏è –°—Ç–∞—Ç—É—Å –∑–∞—â–∏—Ç—ã MLX Server –æ—Ç –ø–∞–¥–µ–Ω–∏–π

## ‚úÖ –ó–ê–©–ò–¢–ê 1: –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

### –ü—Ä–æ–±–ª–µ–º–∞:
- 2+ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –°–∏–Ω—Ç–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Victoria –¥–æ–±–∞–≤–ª—è–µ—Ç –µ—â–µ –∑–∞–ø—Ä–æ—Å—ã
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (5)

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—â–∏—Ç—ã:

1. **–õ–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: 5**
   - Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `_active_requests >= _max_concurrent_requests`
   - –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 503 "Server overloaded"
   - –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞

2. **Rate Limiting: 30 –∑–∞–ø—Ä–æ—Å–æ–≤/60 —Å–µ–∫—É–Ω–¥ –Ω–∞ IP**
   - Middleware –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –∫–∞–∂–¥–æ–≥–æ IP
   - –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 429 "Rate limit exceeded"
   - –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç DDoS –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

3. **Connection Pooling**
   - `timeout_keep_alive=120` –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - `limit_concurrency=_max_concurrent_requests + 5` –≤ uvicorn
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### üìä –ö–æ–¥ –∑–∞—â–∏—Ç—ã:
```python
# mlx_api_server.py:332-337
if _active_requests >= _max_concurrent_requests:
    return JSONResponse(
        status_code=503,
        content={"error": f"Server overloaded. Max {_max_concurrent_requests} concurrent requests"}
    )
```

### ‚úÖ –°—Ç–∞—Ç—É—Å: **–ó–ê–©–ò–©–ï–ù–û**

---

## ‚úÖ –ó–ê–©–ò–¢–ê 2: –ù–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏ (OOM)

### –ü—Ä–æ–±–ª–µ–º–∞:
- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π: ~30GB RAM
- –ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –≤–æ–∑–º–æ–∂–Ω–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—â–∏—Ç—ã:

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏**
   - –§—É–Ω–∫—Ü–∏—è `check_memory()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ health check endpoint

2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –º–æ–¥–µ–ª–µ–π (LRU)**
   - –§—É–Ω–∫—Ü–∏—è `cleanup_unused_models()` —Å LRU —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π
   - –ü—Ä–∏ >85% –ø–∞–º—è—Ç–∏: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
   - –ü—Ä–∏ >95% –ø–∞–º—è—Ç–∏: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
   - –ü—Ä–∏ >98% –ø–∞–º—è—Ç–∏: —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

3. **–ó–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π**
   - `_active_model_requests` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π
   - `_loading_models` - –∑–∞—â–∏—Ç–∞ –º–æ–¥–µ–ª–µ–π –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
   - –ù–ï –≤—ã–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å

4. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–µ—Ö–≤–∞—Ç–∫–µ**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ >95% –ø–∞–º—è—Ç–∏
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ `MemoryError` —Å —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π

### üìä –ö–æ–¥ –∑–∞—â–∏—Ç—ã:
```python
# mlx_api_server.py:160-230
def cleanup_unused_models(aggressive: bool = False, keep_count: int = 1):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –º–æ–¥–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
    active_models = {k for k, v in _active_model_requests.items() if v > 0}
    protected_models = active_models | loading_models
    
    # LRU –æ—á–∏—Å—Ç–∫–∞: –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–∞–º—ã–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ + –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ
    # –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ >98% –ø–∞–º—è—Ç–∏
```

### ‚úÖ –°—Ç–∞—Ç—É—Å: **–ó–ê–©–ò–©–ï–ù–û**

---

## ‚úÖ –ó–ê–©–ò–¢–ê 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ supervision

### –ü—Ä–æ–±–ª–µ–º–∞:
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—â–∏—Ç—ã:

1. **MLXServerSupervisor - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–∞–¥–µ–Ω–∏—è
   - Rate limiting: –º–∞–∫—Å–∏–º—É–º 5 –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –∑–∞ 5 –º–∏–Ω—É—Ç

2. **Health Monitoring**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `/health` endpoint
   - –ü–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ ‚Üí —Å–µ—Ä–≤–µ—Ä —Å—á–∏—Ç–∞–µ—Ç—Å—è —É–ø–∞–≤—à–∏–º

3. **Circuit Breaker Pattern**
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `CircuitBreaker`
   - –ü–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ ‚Üí Circuit OPEN
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ HALF_OPEN –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

4. **Exponential Backoff**
   - –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 2 —Å–µ–∫—É–Ω–¥—ã
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 60 —Å–µ–∫—É–Ω–¥
   - –§–æ—Ä–º—É–ª–∞: `delay = min(2 * 2^n, 60)`

5. **Graceful Shutdown**
   - –û—Ç–ø—Ä–∞–≤–∫–∞ SIGTERM –¥–ª—è graceful shutdown
   - –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–¥–æ 10 —Å–µ–∫—É–Ω–¥)
   - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ

6. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ServiceMonitor**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ Supervisor –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–∞–¥–µ–Ω–∏—è
   - –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –≤ Event Bus
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Victoria –¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

### üìä –ö–æ–¥ –∑–∞—â–∏—Ç—ã:
```python
# mlx_server_supervisor.py
class MLXServerSupervisor:
    async def _monitoring_loop(self):
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
        # Exponential backoff
        # Circuit Breaker
```

### ‚úÖ –°—Ç–∞—Ç—É—Å: **–ó–ê–©–ò–©–ï–ù–û**

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞—â–∏—Ç

| –ü—Ä–∏—á–∏–Ω–∞ –ø–∞–¥–µ–Ω–∏—è | –ó–∞—â–∏—Ç–∞ | –°—Ç–∞—Ç—É—Å | –î–µ—Ç–∞–ª–∏ |
|----------------|--------|--------|--------|
| **–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö** | –õ–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (5) | ‚úÖ | Middleware –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 503 |
| | Rate Limiting (30/60—Å) | ‚úÖ | Middleware –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 429 |
| | Connection Pooling | ‚úÖ | Keep-alive 120—Å |
| **–ù–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏ (OOM)** | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏ | ‚úÖ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10—Å |
| | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (LRU) | ‚úÖ | –ü—Ä–∏ >95% –ø–∞–º—è—Ç–∏ |
| | –ó–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π | ‚úÖ | –ù–µ –≤—ã–≥—Ä—É–∂–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ |
| | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ | ‚úÖ | –ü—Ä–∏ >95% –ø–∞–º—è—Ç–∏ |
| **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ supervision** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ | ‚úÖ | MLXServerSupervisor |
| | Health Monitoring | ‚úÖ | –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ |
| | Circuit Breaker | ‚úÖ | –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤ |
| | Exponential Backoff | ‚úÖ | 2—Å ‚Üí 60—Å |
| | Graceful Shutdown | ‚úÖ | SIGTERM ‚Üí SIGKILL |

## ‚úÖ –í–´–í–û–î

**–í–°–ï –ó–ê–©–ò–¢–´ –†–ï–ê–õ–ò–ó–û–í–ê–ù–´ –ò –†–ê–ë–û–¢–ê–Æ–¢!**

MLX Server —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω –æ—Ç:
- ‚úÖ –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- ‚úÖ –ù–µ—Ö–≤–∞—Ç–∫–∏ –ø–∞–º—è—Ç–∏ (OOM)
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è supervision

**–°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ
