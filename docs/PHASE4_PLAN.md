# Фаза 4: Оптимизация качества ответов RAG (28 дней)

**Цель:** повысить качество ответов RAG по метрикам faithfulness, relevance, coherence; контекстуализация диалога; оценка качества; мультимодальность.

**Связь с предыдущими фазами:** Фазы 1–3 дали производительность (<50ms простые, 100–200ms фактуальные) и надёжность (rate limiter, кэш, метрики). Фаза 4 фокусируется на **качестве** без деградации латентности.

---

## Обзор по неделям

| Неделя | Фокус | Компоненты | Критерии готовности |
|--------|-------|------------|---------------------|
| **1** | RAG релевантность | Реранкинг, переписывание запросов, гибридный поиск | Реранкинг в пайплайне, validation set |
| **2** | Контекстуализация | История диалога, персонализация, domain adaptation | Multi-turn >80% success |
| **3** | Оценка качества | Векторные метрики, авто-оценка, человеческая оценка | Ежедневная оценка в CI |
| **4** | Мультимодальность | Изображения, документы, таблицы | 10+ форматов файлов |

---

## Неделя 1: Улучшение RAG релевантности

### Задачи
1. **Validation set:** 100–200 запросов с эталонными ответами (или контекстом) для оценки.
2. **Реранкинг:** сервис `RerankingService` (cross-encoder / текстовое сходство / гибрид).
3. **Переписывание запросов:** `QueryRewriter` для улучшения поиска (например, «как настроить?» → «инструкция по настройке»).
4. **Интеграция в RAG-light:** опциональный реранкинг и переписывание (feature flag / A/B).

### Файлы
- `backend/app/services/reranking.py` — реранкинг чанков.
- `backend/app/services/query_rewriter.py` — переписывание запроса для RAG.
- `data/validation_queries.json` — validation set.
- `scripts/evaluate_rag_quality.py` — скрипт оценки качества.

### Быстрый старт
```bash
pip install sentence-transformers rank-bm25  # при необходимости
python scripts/evaluate_rag_quality.py --dataset data/validation_queries.json
```

---

## Неделя 2: Контекстуализация ответов

### Задачи
1. **ConversationContextManager:** хранение истории диалога (session_id → сообщения).
2. **Окно контекста:** последние N сообщений + суммаризация старых (max_tokens).
3. **Персонализация:** учёт предпочтений/домена пользователя.
4. **Интеграция в chat:** передача контекста в RAG и в Victoria.

### Файлы
- `backend/app/services/conversation_context.py` — управление контекстом диалога.
- Хранилище: Redis или in-memory с TTL (по конфигу).

---

## Неделя 3: Оценка качества

### Задачи
1. **RAGEvaluator:** faithfulness, relevance, coherence, BLEU/ROUGE (при наличии reference).
2. **Авто-оценка:** скрипт + пороги (faithfulness ≥ 0.8, relevance ≥ 0.85).
3. **CI:** запуск оценки на validation set при push/PR.
4. **Человеческая оценка:** сбор Human Preference Score (1–5) для калибровки.

### Файлы
- `backend/app/evaluation/rag_evaluator.py` — оценка ответов.
- `scripts/evaluate_rag_quality.py` — запуск на датасете.
- `.github/workflows/quality-checks.yml` — CI (опционально).

---

## Неделя 4: Мультимодальность

### Задачи
1. **Обработка изображений:** Vision-модели (Ollama/MLX), эндпоинт или шаг в пайплайне.
2. **Обработка документов:** PDF, DOCX → текст → RAG/ответ.
3. **Интеграция в основной пайплайн:** маршрутизация по типу контента.

### Файлы
- `backend/app/services/multimodal_processor.py` — изображения и документы.
- `docs/MULTIMODAL_SETUP.md` — настройка моделей и форматов.

---

## Метрики качества (цели Фазы 4)

| Метрика | Текущее | Цель |
|---------|---------|------|
| Faithfulness (верность контексту) | ~75% | >90% |
| Relevance (релевантность запросу) | ~80% | >95% |
| Coherence (связность ответа) | ~85% | >95% |
| Human Preference Score | — | >4.0/5.0 |
| Multi-turn Success Rate | — | >80% |

---

## Инфраструктура

- **Канареечные развёртывания:** middleware или feature flag для новой модели/конфига (например, 10% трафика).
- **Обратная связь:** `FeedbackCollector` — сохранение рейтинга/комментария по ответу для последующего анализа и ретрайнинга.
- **Откат:** автоматический откат при падении метрик качества ниже порога.

---

## Документация

- **План:** `docs/PHASE4_PLAN.md` (этот файл).
- **Метрики качества:** `docs/QUALITY_METRICS.md`.
- **Мультимодальность:** `docs/MULTIMODAL_SETUP.md`.
- **Непрерывное улучшение:** `docs/CONTINUOUS_IMPROVEMENT.md`.

---

## Приоритеты на ближайшую неделю

1. Создать validation set из 100–200 запросов (с эталонами или контекстом).
2. Реализовать базовый реранкинг (cross-encoder или текстовое сходство).
3. Настроить ежедневную/при-PR оценку качества (скрипт + CI).
4. Собирать обратную связь от пользователей (рейтинг ответа).
