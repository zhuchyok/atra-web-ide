# Как обработать очередь задач «Ожидает» (pending)

Когда в дашборде много задач в статусе **⏳ Ожидает** (pending), они обрабатываются в два шага: **назначение исполнителя** и **выполнение воркером**.

---

## 1. Почему задачи висят в «Ожидает»

- **Без исполнителя** (`assignee_expert_id = NULL`): такие задачи не забирает Smart Worker. Сначала их должен назначить **Enhanced Orchestrator** (Фаза 2) — подобрать эксперта по домену/роли и проставить `assignee_expert_id`.
- **С исполнителем**: воркер забирает их по очереди (лимит параллелизма `SMART_WORKER_MAX_CONCURRENT`, по умолчанию 15). Если воркер не запущен или медленный — очередь копится.

---

## 2. Что сделать

### Шаг A: Назначить исполнителей всем pending без assignee (разово)

Если часть задач без исполнителя — один раз запустите скрипт назначения (аналог Фазы 2 оркестратора):

```bash
cd knowledge_os
.venv/bin/python scripts/assign_pending_tasks.py
```

Скрипт выведет: сколько pending всего, сколько без исполнителя (их назначит), сколько уже с исполнителем. После назначения эти задачи смогут забираться воркером.

**Если «без исполнителя: 0»** — всем pending уже назначены эксперты; узкое место в пропускной способности воркера (параллелизм, скорость LLM). См. шаг B и раздел 3.

### Шаг B: Убедиться, что Smart Worker запущен

Воркер забирает только задачи **с уже назначенным** исполнителем и переводит их в «В работе» → «Завершено».

**Docker:**

```bash
docker compose -f knowledge_os/docker-compose.yml up -d knowledge_os_worker
# Проверка логов
docker compose -f knowledge_os/docker-compose.yml logs -f knowledge_os_worker
```

**Локально** (если воркер не в Docker):

```bash
cd knowledge_os
.venv/bin/python -m app.smart_worker_autonomous
```

### Шаг C: Держать оркестратор включённым (чтобы новые задачи сразу назначались)

Чтобы новые pending не копились без исполнителя, оркестратор должен периодически крутиться (назначает экспертов и создаёт задачи):

```bash
docker compose -f knowledge_os/docker-compose.yml up -d enhanced_orchestrator
```

---

## 3. Настройки пропускной способности (по желанию)

- **SMART_WORKER_MAX_CONCURRENT** (по умолчанию 15) — сколько задач одновременно в работе. Можно поднять (осторожно с памятью и LLM).
- **SMART_WORKER_ADAPTIVE_CONCURRENCY=true** — воркер сам подстраивает число параллельных задач по CPU/RAM и загрузке MLX/Ollama.
- **ADAPTIVE_MLX_SAFE_MAX** (по умолчанию 2) — потолок одновременных запросов к MLX со стороны воркера. MLX нестабилен при высоком параллелизме (вылеты), поэтому даже при большом MAX_CONCURRENT воркер не отправит к MLX больше этого числа; остальные задачи пойдут на Ollama или в очередь.

См. MASTER_REFERENCE §7 (конфигурация), WORKER_THROUGHPUT_AND_STUCK_TASKS.md.

---

## 4. Краткий чеклист при 405 «Ожидает»

1. Запустить **assign_pending_tasks.py** — назначить экспертов всем pending без assignee.
2. Проверить, что **knowledge_os_worker** запущен (Docker или `smart_worker_autonomous`).
3. При необходимости проверить, что **enhanced_orchestrator** запущен (для новых задач).
4. Подождать: воркер обрабатывает задачи по очереди (лимит параллелизма и время LLM).
