# Реальная роль Вероники: не «решатель», а «руки»

**Дата:** 2026-02-01  
**Проблема:** Victoria и оркестратор скидывают целые задачи на Veronica. Она не предназначена для принятия решений и решения задач — она помощница-исполнитель.

---

## Кто такая Вероника по задумке

| Аспект | Реальная роль |
|--------|----------------|
| **Роль** | Local Developer (агент) — **исполнитель конкретных действий** |
| **Что умеет** | Только инструменты: `read_file`, `list_directory`, `run_terminal_cmd`, `apply_patch`, `web_search`, `grep_search`, `ssh_run` |
| **Чего НЕ умеет** | Не выбирает экспертов, не планирует стратегию, не синтезирует решения из 85 экспертов |
| **Кто решает** | **Виктория** и **эксперты из БД** (85) — они планируют и принимают решения |

То есть Вероника — это **«руки»**: выполняет только те шаги (чтение файла, команда в терминале, патч), которые уже решили Виктория или эксперты.

---

## Где сейчас ошибка

Сейчас часто делается так:

1. **Victoria / оркестратор** по типу задачи (veronica / execution) отправляют **целиком задачу** в Veronica: «создай API», «исправь баг», «напиши тесты».
2. **Veronica** получает цель и сама пытается всё решить: одна LLM + инструменты, без делегирования экспертам.
3. Итог: на Веронику вешают **и решение, и исполнение**. У неё нет доступа к 85 экспертам, она не делегирует — она не для этого.

Правильная схема по документации (`HOW_ORCHESTRATION_WORKS.md`):

- **Victoria** — оркестратор: анализирует задачу, выбирает **отдел и экспертов** (из 85 в БД), собирает ответы, синтезирует результат.
- **Veronica** — только исполняет **конкретные шаги** (файлы, команды), которые уже определены планом/экспертами.

---

## Реальное применение Вероники

### 1. Исполнение шагов плана (предпочтительно)

- **Виктория** (или оркестратор) строит план с экспертами: кто что решает, какие шаги выполнить.
- **Эксперты** (через `run_smart_agent_async`) дают решение и **конкретные шаги**: «создать файл X с содержимым Y», «выполнить команду Z».
- **Вероника** получает уже готовые шаги и только выполняет инструменты: `read_file`, `run_terminal_cmd`, `apply_patch` и т.д.

То есть делегировать Веронике нужно **не задачу**, а **список действий** (tool calls).

### 2. Узкие запросы «сделай одно действие»

- «Покажи содержимое файла `src/main.py`» → Вероника: `read_file`.
- «Выведи список файлов в `backend/`» → Вероника: `list_directory`.
- «Выполни команду `pytest tests/ -v`» → Вероника: `run_terminal_cmd`.

Здесь запрос уже по сути является одним шагом, без стратегии и выбора экспертов.

### 3. Чего лучше избегать

- «Напиши микросервис для X» → это к Виктории и экспертам (архитектура, код, решение), не «скидывать целиком» на Веронику.
- «Исправь все баги в проекте» → опять планирование и эксперты; Вероника — только выполнение выданных шагов (патчи, команды).

---

## Что сделано в коде

1. **Маршрутизация (task_detector + PREFER_EXPERTS_FIRST)**  
   - При `PREFER_EXPERTS_FIRST=true` (по умолчанию): в Veronica идут **только** простые одношаговые запросы («покажи файлы», «выведи список файлов», «прочитай файл X»).  
   - Запросы типа «сделай», «напиши код», «создай API», «исправь» теперь маршрутизируются в **enhanced** — Victoria задействует экспертов (85 в БД), затем при необходимости может передать Веронике шаги.  
   - Переменная: `PREFER_EXPERTS_FIRST` (true/false). В docker-compose для victoria-agent по умолчанию `true`.

2. **Исправлен баг в task_delegation.select_best_agent**  
   - Блок «если нет required_capabilities — классифицировать и вернуть Виктория/Вероника» был с неправильным отступом; код подсчёта agent_scores был недостижим. Отступ исправлен.

3. **Документация**  
   - `VERONICA.md` — явно указана реальная роль («руки»).  
   - Этот файл и `task_detector.py` — описание логики PREFER_EXPERTS_FIRST.

## Дальнейшие шаги (направление)

1. **API Veronica**  
   - Целевой вариант: возможность вызывать Veronica с **набором шагов** (tool calls), а не только с `goal`. Тогда «делегирование Веронике» = «выполни эти шаги».

2. **Контракт**  
   - Veronica = исполнитель шагов и узких действий; решение и делегирование по экспертам — только Victoria и оркестратор.

---

## Краткий вывод

- **Почему Victoria/оркестратор «скидывают» на Veronica:** исторически Veronica была единственным агентом с инструментами (файлы, терминал), поэтому на неё повесили и «все execution-задачи».
- **Почему так плохо:** Veronica не умеет делегировать экспертам и не должна принимать решения за всю корпорацию; у неё нет ролей 85 экспертов.
- **Реальное применение Вероники:** выполнять **конкретные шаги** (инструменты), определённые Викторией и экспертами, или очень простые одношаговые запросы. Решения и делегирование — только у Victoria и экспертов из БД.
