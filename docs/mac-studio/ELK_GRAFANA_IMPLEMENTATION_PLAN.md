# üìä –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ELK —Å—Ç–µ–∫–∞ –∏ Grafana

**–î–∞—Ç–∞:** 2026-01-25  
**–°—Ç–∞—Ç—É—Å:** –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –ø–ª–∞–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üîç –ê–ù–ê–õ–ò–ó: –î–õ–Ø –ß–ï–ì–û –°–û–ó–î–ê–í–ê–õ–ò–°–¨

### 1. **ELK —Å—Ç–µ–∫ (Elasticsearch + Kibana)**

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
- ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –≤—Å–µ –ª–æ–≥–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ **–ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º** ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ª–æ–≥–∞–º —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ **–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤** ‚Äî –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤, –æ—à–∏–±–æ–∫, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏** ‚Äî JSON —Ñ–æ—Ä–º–∞—Ç —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ **Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

#### –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:
- ‚ùå –õ–æ–≥–∏ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ —Ñ–∞–π–ª–∞–º (`logs/*.log`)
- ‚ùå –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚ùå –°–ª–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- ‚ùå –ù–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö
- ‚ùå –ù–µ—Ç –∞–ª–µ—Ä—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–æ–≥–æ–≤

#### –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:
- ‚úÖ Structured logging (structlog) ‚Äî JSON —Ñ–æ—Ä–º–∞—Ç –≥–æ—Ç–æ–≤
- ‚úÖ –§–∞–π–ª–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Elasticsearch

---

### 2. **Grafana**

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
- ‚úÖ **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫** ‚Äî –≥—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ **–î–∞—à–±–æ—Ä–¥—ã** ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ **–ê–ª–µ—Ä—Ç—ã** ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- ‚úÖ **–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ** ‚Äî –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤

#### –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:
- ‚ùå –ú–µ—Ç—Ä–∏–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è
- ‚ùå –ù–µ—Ç –¥–∞—à–±–æ—Ä–¥–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚ùå –ù–µ—Ç –∞–ª–µ—Ä—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫
- ‚ùå –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

#### –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:
- ‚úÖ `metrics_exporter.py` ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫ –≤ Prometheus —Ñ–æ—Ä–º–∞—Ç–µ
- ‚úÖ `grafana_dashboard.json` ‚Äî –≥–æ—Ç–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥
- ‚úÖ `setup_grafana.sh` ‚Äî —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ `prometheus.yml` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prometheus
- ‚úÖ Prometheus –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è
- ‚ùå –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ Grafana
- ‚ùå –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ Prometheus
- ‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Prometheus

---

## üéØ –í–´–í–û–î: –≠–¢–û –ù–£–ñ–ù–û –î–û–î–ï–õ–ê–¢–¨!

### –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:

1. **–î–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏ ATRA:**
   - –ú–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (Victoria, Veronica, Worker, Orchestrator, Nightly Learner)
   - –ù—É–∂–µ–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   - –ù—É–∂–µ–Ω –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –ù—É–∂–Ω—ã –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

2. **–î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:**
   - –ü—Ä–∏ —Ä–æ—Å—Ç–µ —Å–∏—Å—Ç–µ–º—ã —Ñ–∞–π–ª–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º–æ–π
   - –ù—É–∂–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
   - –ù—É–∂–µ–Ω –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö

3. **–î–ª—è –æ—Ç–ª–∞–¥–∫–∏:**
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º —É—Å–∫–æ—Ä–∏—Ç –æ—Ç–ª–∞–¥–∫—É
   - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –ø–æ–∫–∞–∂–µ—Ç —É–∑–∫–∏–µ –º–µ—Å—Ç–∞
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–µ–¥—É–ø—Ä–µ–¥—è—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö

---

## üìã –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –≠—Ç–∞–ø 1: Grafana + Prometheus (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô)

**–ü–æ—á–µ–º—É —Å–Ω–∞—á–∞–ª–∞ Grafana:**
- –ú–µ—Ç—Ä–∏–∫–∏ —É–∂–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è
- –î–∞—à–±–æ—Ä–¥ —É–∂–µ –≥–æ—Ç–æ–≤
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prometheus —É–∂–µ –µ—Å—Ç—å
- –ë—ã—Å—Ç—Ä–æ –¥–∞—Å—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

---

### –≠—Ç–∞–ø 2: ELK —Å—Ç–µ–∫ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–†–ï–î–ù–ò–ô)

**–ü–æ—á–µ–º—É –ø–æ—Ç–æ–º ELK:**
- –¢—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –ù—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–¥
- –ù–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

**–í—Ä–µ–º—è:** 4-6 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è

---

## üöÄ –ö–û–ù–ö–†–ï–¢–ù–´–ô –ü–õ–ê–ù: GRAFANA + PROMETHEUS

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å docker-compose.yml

–î–æ–±–∞–≤–∏—Ç—å –≤ `knowledge_os/docker-compose.yml`:

```yaml
services:
  # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã ...

  prometheus:
    image: prom/prometheus:latest
    container_name: atra-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ../infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - atra-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: atra-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=atra2025
      - GF_INSTALL_PLUGINS=
      - GF_SERVER_ROOT_URL=http://localhost:3000
    volumes:
      - grafana_data:/var/lib/grafana
      - ../knowledge_os/dashboard/grafana_dashboard.json:/etc/grafana/provisioning/dashboards/dashboard.json
    networks:
      - atra-network
    depends_on:
      - prometheus
    restart: unless-stopped

volumes:
  # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ volumes ...
  prometheus_data:
  grafana_data:
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å prometheus.yml

–û–±–Ω–æ–≤–∏—Ç—å `infrastructure/monitoring/prometheus.yml`:

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s

scrape_configs:
  # Knowledge OS API (–º–µ—Ç—Ä–∏–∫–∏ –∏–∑ metrics_exporter)
  - job_name: 'knowledge_os_api'
    static_configs:
      - targets: ['knowledge_os_api:8000']
    metrics_path: '/metrics'  # –ï—Å–ª–∏ –µ—Å—Ç—å endpoint /metrics
    scrape_interval: 30s

  # Victoria Agent
  - job_name: 'victoria-agent'
    static_configs:
      - targets: ['atra-victoria-agent:8010']
    metrics_path: '/health'
    scrape_interval: 30s

  # Veronica Agent
  - job_name: 'veronica-agent'
    static_configs:
      - targets: ['atra-veronica-agent:8011']
    metrics_path: '/health'
    scrape_interval: 30s

  # Prometheus —Å–∞–º —Å–µ–±—è
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å /metrics endpoint –≤ Knowledge OS API

–ï—Å–ª–∏ –µ—â–µ –Ω–µ—Ç, –¥–æ–±–∞–≤–∏—Ç—å –≤ `knowledge_os/app/main.py`:

```python
from metrics_exporter import get_metrics_exporter

@app.get("/metrics")
async def metrics():
    """Prometheus metrics endpoint"""
    exporter = get_metrics_exporter()
    metrics_text = await exporter.export_prometheus_metrics()
    return Response(content=metrics_text, media_type="text/plain")
```

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å

```bash
docker-compose -f knowledge_os/docker-compose.yml up -d prometheus grafana
```

### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grafana

1. –û—Ç–∫—Ä—ã—Ç—å http://localhost:3000
2. –õ–æ–≥–∏–Ω: `admin`, –ø–∞—Ä–æ–ª—å: `atra2025`
3. –î–æ–±–∞–≤–∏—Ç—å Prometheus datasource:
   - Settings ‚Üí Data Sources ‚Üí Add data source
   - –í—ã–±—Ä–∞—Ç—å Prometheus
   - URL: `http://prometheus:9090`
   - Save & Test
4. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—à–±–æ—Ä–¥:
   - Dashboards ‚Üí Import
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å `knowledge_os/dashboard/grafana_dashboard.json`

---

## üîß –ö–û–ù–ö–†–ï–¢–ù–´–ô –ü–õ–ê–ù: ELK –°–¢–ï–ö

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –≤ docker-compose.yml

```yaml
services:
  # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã ...

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: atra-elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - atra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: atra-kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=
      - xpack.security.enabled=false
    networks:
      - atra-network
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped

volumes:
  # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ volumes ...
  elasticsearch_data:
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å ELKHandler

–°–æ–∑–¥–∞—Ç—å `knowledge_os/app/elk_handler.py`:

```python
"""
ELK Handler –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤ –≤ Elasticsearch
"""
import asyncio
import httpx
import json
import logging
from datetime import datetime
from typing import Optional

class ELKHandler(logging.Handler):
    """Handler –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤ –≤ Elasticsearch"""
    
    def __init__(self, elasticsearch_url: str = "http://atra-elasticsearch:9200"):
        super().__init__()
        self.elasticsearch_url = elasticsearch_url
        self.index_prefix = "atra-logs"
        self.client: Optional[httpx.AsyncClient] = None
        self._init_client()
    
    def _init_client(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HTTP –∫–ª–∏–µ–Ω—Ç–∞"""
        try:
            self.client = httpx.AsyncClient(timeout=5.0)
        except Exception as e:
            logging.error(f"Failed to init ELK client: {e}")
    
    def emit(self, record):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–∞ –≤ Elasticsearch"""
        if not self.client:
            return
        
        try:
            log_data = {
                "@timestamp": datetime.utcnow().isoformat(),
                "level": record.levelname,
                "message": record.getMessage(),
                "logger": record.name,
                "module": record.module,
                "function": record.funcName,
                "line": record.lineno,
            }
            
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
            if hasattr(record, 'extra'):
                log_data.update(record.extra)
            
            # –î–æ–±–∞–≤–ª—è–µ–º exception –µ—Å–ª–∏ –µ—Å—Ç—å
            if record.exc_info:
                log_data["exception"] = self.format(record)
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Elasticsearch (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
            try:
                loop = asyncio.get_event_loop()
                if loop.is_running():
                    asyncio.create_task(self._send_to_elasticsearch(log_data))
                else:
                    loop.run_until_complete(self._send_to_elasticsearch(log_data))
            except RuntimeError:
                # –ù–µ—Ç event loop, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                asyncio.run(self._send_to_elasticsearch(log_data))
        except Exception:
            self.handleError(record)
    
    async def _send_to_elasticsearch(self, log_data: dict):
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Elasticsearch"""
        if not self.client:
            return
        
        try:
            index_name = f"{self.index_prefix}-{datetime.utcnow().strftime('%Y.%m.%d')}"
            url = f"{self.elasticsearch_url}/{index_name}/_doc"
            response = await self.client.post(url, json=log_data)
            response.raise_for_status()
        except Exception as e:
            # Fallback –Ω–∞ —Ñ–∞–π–ª–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            logging.debug(f"Failed to send log to Elasticsearch: {e}")
    
    def close(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∏–µ–Ω—Ç–∞"""
        if self.client:
            asyncio.run(self.client.aclose())
        super().close()
```

### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–û–±–Ω–æ–≤–∏—Ç—å `knowledge_os/src/shared/utils/logger.py`:

```python
def setup_logging(
    level: str = "INFO", 
    use_structlog: bool = True, 
    use_elk: bool = False,
    elk_url: Optional[str] = None
):
    """Setup structured logging with optional ELK integration"""
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ structlog ...
    
    if use_elk:
        try:
            import sys
            sys.path.insert(0, '/app')  # –ü—É—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            from app.elk_handler import ELKHandler
            
            elk_handler = ELKHandler(elk_url or "http://atra-elasticsearch:9200")
            elk_handler.setLevel(getattr(logging, level.upper()))
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫ root logger
            root_logger = logging.getLogger()
            root_logger.addHandler(elk_handler)
            
            logging.info("‚úÖ ELK handler enabled")
        except ImportError as e:
            logging.warning(f"ELK handler not available: {e}")
        except Exception as e:
            logging.warning(f"Failed to setup ELK handler: {e}")
```

### –®–∞–≥ 4: –í–∫–ª—é—á–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `docker-compose.yml`:

```yaml
victoria-agent:
  environment:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ...
    - USE_ELK=true
    - ELASTICSEARCH_URL=http://atra-elasticsearch:9200

veronica-agent:
  environment:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ...
    - USE_ELK=true
    - ELASTICSEARCH_URL=http://atra-elasticsearch:9200

knowledge_os_api:
  environment:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ...
    - USE_ELK=true
    - ELASTICSEARCH_URL=http://atra-elasticsearch:9200
```

### –®–∞–≥ 5: –ó–∞–ø—É—Å—Ç–∏—Ç—å

```bash
docker-compose -f knowledge_os/docker-compose.yml up -d elasticsearch kibana
```

### –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Kibana

1. –û—Ç–∫—Ä—ã—Ç—å http://localhost:5601
2. –°–æ–∑–¥–∞—Ç—å index pattern: `atra-logs-*`
3. Time field: `@timestamp`
4. –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤

---

## ‚úÖ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –ü–û–°–õ–ï –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### Grafana:
- üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- üìà –î–∞—à–±–æ—Ä–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏
- üö® –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- üìâ –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### ELK —Å—Ç–µ–∫:
- üîç –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö
- üö® –ê–ª–µ—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–æ–≥–æ–≤
- üìà –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ª–æ–≥–∏

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–ù–∞—á–∞—Ç—å —Å Grafana + Prometheus** ‚Äî –±—ã—Å—Ç—Ä–æ –¥–∞—Å—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –º–µ—Ç—Ä–∏–∫, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è.

**–ó–∞—Ç–µ–º ELK —Å—Ç–µ–∫** ‚Äî –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞.

**–û–±–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏ ATRA!**

---

*–ü–ª–∞–Ω —Å–æ–∑–¥–∞–Ω 2026-01-25*
