# ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è ELK —Å—Ç–µ–∫–∞ –∏ Grafana –∑–∞–≤–µ—Ä—à–µ–Ω–∞

**–î–∞—Ç–∞:** 2026-01-25  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ó–ê–í–ï–†–®–ï–ù–û**

---

## üéØ –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û

### 1. ‚úÖ Prometheus –∏ Grafana

#### –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `docker-compose.yml`:
- ‚úÖ Prometheus –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–ø–æ—Ä—Ç 9090)
- ‚úÖ Grafana –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–ø–æ—Ä—Ç 3000)
- ‚úÖ Volumes –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ `atra-network`

#### –û–±–Ω–æ–≤–ª–µ–Ω–æ:
- ‚úÖ `prometheus.yml` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö targets:
  - Victoria Agent (atra-victoria-agent:8010)
  - Veronica Agent (atra-veronica-agent:8011)
  - Knowledge OS API (knowledge_os_api:8000/metrics)
  - Prometheus —Å–∞–º —Å–µ–±—è

#### –î–æ–±–∞–≤–ª–µ–Ω–æ:
- ‚úÖ `/metrics` endpoint –≤ `knowledge_os/app/main.py` –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–µ—Ç—Ä–∏–∫ Prometheus

---

### 2. ‚úÖ ELK —Å—Ç–µ–∫ (Elasticsearch + Kibana)

#### –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `docker-compose.yml`:
- ‚úÖ Elasticsearch –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–ø–æ—Ä—Ç 9200)
- ‚úÖ Kibana –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–ø–æ—Ä—Ç 5601)
- ‚úÖ Healthcheck –¥–ª—è Elasticsearch
- ‚úÖ Volumes –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ `atra-network`

#### –°–æ–∑–¥–∞–Ω–æ:
- ‚úÖ `knowledge_os/app/elk_handler.py` ‚Äî –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π ELK handler:
  - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤
  - –ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π flush –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ fallback
  - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

#### –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ:
- ‚úÖ `knowledge_os/src/shared/utils/logger.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ELK:
  - –ü–∞—Ä–∞–º–µ—Ç—Ä `use_elk` –≤ `setup_logging()`
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ ELK handler
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `USE_ELK`
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `ELASTICSEARCH_URL`

---

## üìã –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è ELK –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ –≤ `docker-compose.yml`:

```yaml
victoria-agent:
  environment:
    - USE_ELK=true
    - ELASTICSEARCH_URL=http://atra-elasticsearch:9200

veronica-agent:
  environment:
    - USE_ELK=true
    - ELASTICSEARCH_URL=http://atra-elasticsearch:9200

knowledge_os_api:
  environment:
    - USE_ELK=true
    - ELASTICSEARCH_URL=http://atra-elasticsearch:9200
```

---

## üöÄ –ó–ê–ü–£–°–ö

### 1. –ó–∞–ø—É—Å–∫ Prometheus –∏ Grafana:

```bash
docker-compose -f knowledge_os/docker-compose.yml up -d prometheus grafana
```

### 2. –ó–∞–ø—É—Å–∫ ELK —Å—Ç–µ–∫–∞:

```bash
docker-compose -f knowledge_os/docker-compose.yml up -d elasticsearch kibana
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:

```bash
docker ps | grep -E "(prometheus|grafana|elastic|kibana)"
```

---

## üîß –ù–ê–°–¢–†–û–ô–ö–ê

### Grafana:

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –õ–æ–≥–∏–Ω: `admin`, –ø–∞—Ä–æ–ª—å: `atra2025`
3. –î–æ–±–∞–≤—å—Ç–µ Prometheus datasource:
   - Settings ‚Üí Data Sources ‚Üí Add data source
   - –í—ã–±–µ—Ä–∏—Ç–µ Prometheus
   - URL: `http://atra-prometheus:9090`
   - Save & Test
4. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞—à–±–æ—Ä–¥:
   - Dashboards ‚Üí Import
   - –ó–∞–≥—Ä—É–∑–∏—Ç–µ `knowledge_os/dashboard/grafana_dashboard.json`

### Kibana:

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:5601
2. –°–æ–∑–¥–∞–π—Ç–µ index pattern:
   - Management ‚Üí Stack Management ‚Üí Index Patterns
   - Pattern: `atra-logs-*`
   - Time field: `@timestamp`
3. –°–æ–∑–¥–∞–π—Ç–µ –¥–∞—à–±–æ—Ä–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤

---

## ‚úÖ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

### Grafana:
- üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- üìà –î–∞—à–±–æ—Ä–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏
- üö® –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- üìâ –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤

### ELK —Å—Ç–µ–∫:
- üîç –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö
- üö® –ê–ª–µ—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–æ–≥–æ–≤
- üìà –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ª–æ–≥–∏

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞–∑–æ–≤)
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grafana datasource –∏ –¥–∞—à–±–æ—Ä–¥—ã
3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Kibana index patterns
4. ‚úÖ –í–∫–ª—é—á–∏—Ç—å `USE_ELK=true` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
5. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è ELK –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

---

*–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ 2026-01-25*
