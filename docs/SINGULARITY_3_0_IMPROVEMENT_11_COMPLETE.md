# ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï #11: –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ó–ê–í–ï–†–®–ï–ù–û

**–î–∞—Ç–∞:** 2025-12-14  
**–í–µ—Ä—Å–∏—è:** Singularity 4.1  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ó–ê–í–ï–†–®–ï–ù–û**

---

## üéØ –ß–¢–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

### **–°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- ‚úÖ **JWT —Ç–æ–∫–µ–Ω—ã** - –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ API
- ‚úÖ **–†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞** - 4 —Ä–æ–ª–∏ —Å –º–∞—Ç—Ä–∏—Ü–µ–π –ø—Ä–∞–≤
- ‚úÖ **–ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (email)

---

## üì¶ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´

### **1. `knowledge_os/db/migrations/add_security_tables.sql`** (100+ —Å—Ç—Ä–æ–∫)

**–ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**

1. **users** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
   - `username` - —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `password_hash` - —Ö–µ—à –ø–∞—Ä–æ–ª—è (SHA256)
   - `role` - —Ä–æ–ª—å (admin, user, readonly, api)
   - `email` - –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π email
   - `is_active` - –∞–∫—Ç–∏–≤–µ–Ω/–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
   - `last_login` - –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥

2. **audit_logs** - –ª–æ–≥–∏ –∞—É–¥–∏—Ç–∞
   - `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `action` - –¥–µ–π—Å—Ç–≤–∏–µ (authentication, create_knowledge, etc.)
   - `status` - —Å—Ç–∞—Ç—É—Å (success, failure, error)
   - `details` - –¥–µ—Ç–∞–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è (JSONB)
   - `ip_address` - IP –∞–¥—Ä–µ—Å
   - `user_agent` - User Agent

3. **revoked_tokens** - –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã–µ JWT —Ç–æ–∫–µ–Ω—ã
   - `token_hash` - —Ö–µ—à —Ç–æ–∫–µ–Ω–∞
   - `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `revoked_at` - –≤—Ä–µ–º—è –æ—Ç–∑—ã–≤–∞
   - `reason` - –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–∑—ã–≤–∞

### **2. `knowledge_os/app/security.py`** (300+ —Å—Ç—Ä–æ–∫)

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã:**

1. **Role** - Enum —Ä–æ–ª–µ–π
   - ADMIN - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
   - USER - —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –∑–Ω–∞–Ω–∏–π, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
   - READONLY - —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
   - API - –¥–ª—è API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

2. **Permission** - Enum –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
   - READ_KNOWLEDGE
   - WRITE_KNOWLEDGE
   - DELETE_KNOWLEDGE
   - MANAGE_EXPERTS
   - MANAGE_TASKS
   - VIEW_ANALYTICS
   - MANAGE_WEBHOOKS
   - ADMIN_ACCESS

3. **SecurityManager** - –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - `generate_jwt_token()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞
   - `verify_jwt_token()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞
   - `hash_password()` - —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è
   - `verify_password()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
   - `encrypt_sensitive_data()` - —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
   - `decrypt_sensitive_data()` - —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
   - `has_permission()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
   - `create_user()` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `authenticate_user()` - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - `log_audit_event()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏—Ç–∞
   - `get_audit_logs()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤

**–ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:**

```python
ROLE_PERMISSIONS = {
    Role.ADMIN: [–≤—Å–µ –ø—Ä–∞–≤–∞],
    Role.USER: [READ_KNOWLEDGE, WRITE_KNOWLEDGE, VIEW_ANALYTICS],
    Role.READONLY: [READ_KNOWLEDGE, VIEW_ANALYTICS],
    Role.API: [READ_KNOWLEDGE, WRITE_KNOWLEDGE]
}
```

### **3. –û–±–Ω–æ–≤–ª–µ–Ω `knowledge_os/app/rest_api.py`**

**–ù–æ–≤—ã–µ endpoints:**

1. **POST /auth/login** - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: username, password
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: JWT token, user info

2. **POST /auth/register** - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: username, password, email, role
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: user_id, username, role

3. **GET /auth/audit** - –õ–æ–≥–∏ –∞—É–¥–∏—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
   - –¢—Ä–µ–±—É–µ—Ç: JWT token —Å —Ä–æ–ª—å—é admin
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: —Å–ø–∏—Å–æ–∫ –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞

**–û–±–Ω–æ–≤–ª–µ–Ω—ã endpoints:**
- –í—Å–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç JWT –≤–º–µ—Å—Ç–æ API key
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

---

## üîê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### **1. JWT –¢–æ–∫–µ–Ω—ã:**

- –ê–ª–≥–æ—Ä–∏—Ç–º: HS256
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 24 —á–∞—Å–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á: –∏–∑ environment variable `JWT_SECRET`

### **2. –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π:**

- –ê–ª–≥–æ—Ä–∏—Ç–º: SHA256
- –°–æ–ª—å: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å bcrypt)

### **3. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:**

- –ê–ª–≥–æ—Ä–∏—Ç–º: Fernet (symmetric encryption)
- –ö–ª—é—á: –∏–∑ environment variable `ENCRYPTION_KEY`

### **4. –ê—É–¥–∏—Ç:**

- –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è: user_id, action, status, details, ip_address, user_agent
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π

---

## üöÄ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï

### **1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

```bash
curl -X POST "http://localhost:8002/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "securepassword",
    "email": "user@example.com",
    "role": "user"
  }'
```

### **2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**

```bash
curl -X POST "http://localhost:8002/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "securepassword"
  }'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer",
  "user": {
    "user_id": "uuid-123",
    "username": "newuser",
    "role": "user"
  }
}
```

### **3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞:**

```bash
curl -X GET "http://localhost:8002/stats" \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..."
```

### **4. –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤):**

```bash
curl -X GET "http://localhost:8002/auth/audit?limit=50" \
  -H "Authorization: Bearer <admin_token>"
```

---

## üìà –û–ñ–ò–î–ê–ï–ú–´–ô –≠–§–§–ï–ö–¢

- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** +100%
- ‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞:** –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞
- ‚úÖ **–ê—É–¥–∏—Ç:** –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
- ‚úÖ **–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:** –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üîÑ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–£–ª—É—á—à–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª–µ–π:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å bcrypt –≤–º–µ—Å—Ç–æ SHA256
   - –î–æ–±–∞–≤–∏—Ç—å —Å–æ–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–æ–ª—è
   - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è

2. **–†–∞—Å—à–∏—Ä–∏—Ç—å –∞—É–¥–∏—Ç:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ IP –∞–¥—Ä–µ—Å–æ–≤
   - –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ IP
   - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

3. **–î–æ–±–∞–≤–∏—Ç—å 2FA:**
   - –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - SMS/Email –∫–æ–¥—ã
   - TOTP (Time-based One-Time Password)

4. **Rate Limiting:**
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ IP
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - –ó–∞—â–∏—Ç–∞ –æ—Ç brute force

---

## ‚úÖ –ì–û–¢–û–í–û!

–°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ Singularity 4.1!

**–ê–≤—Ç–æ—Ä:** –í–∏–∫—Ç–æ—Ä–∏—è (Team Lead)  
**–î–∞—Ç–∞:** 2025-12-14

