# План: «Логика мысли» Victoria — стратегия, память, рефлексия, неопределённость

**Назначение:** закрыть разрыв между текущим поведением Victoria и «единой, гибкой линией рассуждения»: выбор глубины ответа, связность и память между диалогами, самокритика и итерация плана, явное выражение неопределённости.

**Источники:** запрос пользователя; библия (MASTER_REFERENCE, THINKING_AND_APPROACH); команда экспертов (configs/experts/team.md, TEAM_PERSONALITIES); база знаний (session_context_manager, query_classifier, task_detector, victoria_enhanced, recap_framework, collective_memory); мировые практики (MAR, ReCAP, LoCoMo, anticipatory reflection, ограничения self-verification).

**Обновлено:** 2026-02-11

---

## 1. Цель и контекст

### 1.1 Чего не хватает до «логики мысли»

| Направление | Сейчас | Цель |
|-------------|--------|------|
| **Выбор стратегии** | Классификаторы по правилам (query_classifier, task_detector, _categorize_task). Решение «быстрый ответ / глубокий разбор / уточнить / отказать» разбросано по эвристикам. | Одна сквозная «логика рассуждения»: система сама выбирает глубину, необходимость уточнений и границы (отказ/перенаправление). |
| **Связность и память** | Контекст ограничен сессией/задачей: ConversationContextManager (backend), SessionContextManager (session_context в БД), get_session_memory_summary. Нет единой «нити» через много диалогов. | Единая нить рассуждений: долгосрочная память по пользователю/проекту, суммаризация, подтягивание релевантного прошлого. |
| **Самокритика и итерация** | План выполняется до конца; _check_ambiguity только на входе. ReCAP/hierarchical есть, но без явных чекпоинтов «пересмотреть план». | Возможность «подожди, пересмотрю»: чекпоинты по ходу выполнения, переоценка плана при противоречии или провале шага. |
| **Неопределённость** | anti_hallucination проверяет «не знаю/не уверен»; уточняющие вопросы через _check_ambiguity и шаблоны. Не как часть общей логики. | Неопределённость первого класса: явная уверенность (confidence) в выборе стратегии и в ответе, честные границы («здесь не уверен», «нужны данные»). |

### 1.2 Связь с библией

- **THINKING_AND_APPROACH:** понять → контекст → план → выполнить → проверить → зафиксировать; при неясности — уточнять. План расширяет это до механизмов выбора стратегии, памяти, рефлексии и уверенности.
- **MASTER_REFERENCE §8:** после внедрения пунктов — обновить этот документ и CHANGES_FROM_OTHER_CHATS.

---

## 2. Вклад команды экспертов

| Эксперт | Роль | Рекомендация по плану |
|---------|------|------------------------|
| **Виктория** | Team Lead | Единая точка принятия решения о стратегии (глубина, уточнить, отказать); не дублировать логику в backend и в Victoria. |
| **Игорь** | Backend | Один слой «стратегия» перед маршрутизацией; контракт API (confidence, strategy_reason) не ломать обратную совместимость. |
| **Дмитрий** | ML | Уверенность и рефлексия: по возможности использовать отдельную лёгкую модель или один вызов planner для strategy + confidence; учитывать ограничения self-verification (внешняя проверка лучше самооценки). |
| **Роман** | БД | Память: таблицы session_context, tasks уже есть; для долгосрочной памяти — отдельная сущность (user_memory / project_memory) с TTL и лимитами размера. |
| **Анна** | QA | Тесты на граничные случаи: «уточнить» vs «ответить», отказ при вне scope; регрессия куратора после изменений. |
| **Елена** | SRE | Метрики: strategy_selected (quick/deep/clarify/decline), memory_hits, reflection_checkpoints, confidence_below_threshold. |
| **Татьяна** | Technical Writer | Документировать новый поток (стратегия → память → план → рефлексия) в VICTORIA_TASK_CHAIN_FULL и PROMPTS_VICTORIA. |
| **Арина** | Prompt Engineer | Промпты для «стратегия + уверенность» и для рефлексии (краткие, русский, без перегрузки контекста). |

---

## 3. Мировые практики (кратко)

- **Multi-Agent Reflexion (MAR):** несколько персон рассуждения + судья дают лучший результат, чем одна модель с самооценкой; снижается confirmation bias (источник: arxiv 2512.20845). **У нас:** эксперты и оркестратор уже есть; добавить «стратегический» шаг и при рефлексии опираться на внешние критерии (эталоны куратора, чеклист), а не только на self-critique.
- **Self-critique ограничения (ICLR 2025):** при самопроверке ответов LLM качество может падать; внешняя верификация часто лучше. **У нас:** не заменять текущие проверки одной «самокритикой»; рефлексия — чекпоинты + при необходимости внешний runbook/эталон.
- **Intrinsic self-critique + итерация:** структурированная самокритика с итеративным уточнением улучшает планирование (Blocksworld, Logistics). **У нас:** ReCAP и hierarchical уже дают декомпозицию; добавить явные точки «пересмотреть план» при провале шага или противоречии.
- **Anticipatory reflection:** разбивка на подзадачи + рефлексия до действия, после действия (с откатом при несоответствии) и после завершения. **У нас:** до действия — understand_goal + _check_ambiguity; после шага — пока нет; после завершения — куратор. План предлагает «после шага» и «при провале шага».
- **Long-term conversational memory (LoCoMo, 2024):** контекст 35 сессий, 300 реплик; RAG и длинный контекст всё ещё отстают от человека. **У нас:** session_context и summary по сессии; для «нити» — суммаризация и выборка по релевантности, без загрузки всего в контекст.

---

## 4. Текущее состояние (база знаний)

### 4.1 Выбор стратегии / глубины

- **backend:** `query_classifier.classify_query` → simple / factual / complex; `task_detector.detect_task_type` → simple_chat, veronica, department_heads, enhanced. Правила и ключевые слова.
- **Victoria:** `victoria_enhanced._categorize_task` → status_query, reasoning, simple_keywords и т.д.; выбор модели и режима (simple vs ReAct/extended thinking).
- **Уточнение:** `_check_ambiguity(goal, category, restated)` — эвристика (длина, местоимения, «что-то», category); `_generate_clarification_questions` — LLM. Срабатывает только при understand_goal; нет явного «отказа» или «перенаправить».

### 4.2 Память и контекст

- **Backend:** `ConversationContextManager` — in-memory (и опционально Redis), TTL, max_messages_per_session, max_context_chars; `get_recent`, `build_context_prefix`.
- **Knowledge OS:** `SessionContextManager` — таблица `session_context` (session_id, query_text, response_text, created_at); `get_session_context`, `get_session_memory_summary`; TTL 24 ч, лимит запросов.
- **Victoria:** при `session_id` подмешивается контекст сессии; `task_memory` / «По этой сессии уже делали» в enhanced; «как вчера» — recent_tasks_context из БД.
- **CollectiveMemorySystem:** environmental traces по location, stigmergy; не привязано к пользователю/диалогу как «нить».

### 4.3 Рефлексия и итерация

- **ReCAP:** план по уровням (high/mid/low), контекст реинъекция, results в _build_context (зависимости подставляются).
- **HierarchicalOrchestrator:** _decompose_goals (LLM), _align_goals, _assign_tasks; без явного «пересмотреть план».
- **Victoria Enhanced:** при пустых результатах экспертов/Swarm — fallback «рекомендуется уточнить задачу»; нет шага «пересмотреть план и выбрать другой путь».

### 4.4 Неопределённость

- **anti_hallucination:** проверка «не знаю»/«не уверен» в ответе при высоком confidence контекста → снижение confidence.
- **extended_thinking:** _calculate_confidence(thinking_steps) (по TODO_FIXME_BACKLOG закрыто).
- Нет единого поля confidence/uncertainty в контракте ответа (strategy + final answer).

---

## 5. План внедрения (фазы)

### Фаза 0. Подготовка (документация и контракт)

| Задача | Описание | Критерий | Ответственный |
|--------|----------|----------|---------------|
| 0.1 | Зафиксировать в документации целевой контракт: стратегия (quick / deep / clarify / decline), confidence (0–1), опционально strategy_reason. | Описание в VICTORIA_TASK_CHAIN_FULL или отдельном §; обратная совместимость: старые клиенты не ломаются. | Татьяна |
| 0.2 | Добавить в PROMPTS_VICTORIA таблицу: откуда берётся выбор стратегии и уверенность (промпт planner / отдельный вызов). | Строка в таблице промптов. | Арина |

### Фаза 1. Единый слой выбора стратегии

| Задача | Описание | Критерий | Ответственный |
|--------|----------|----------|---------------|
| 1.1 | Ввести единый шаг «strategy selection» в начале цепочки Victoria (после приёма goal, до understand_goal или параллельно): один вызов LLM (planner) с промптом «по цели определи: quick_answer / deep_analysis / need_clarification / decline_or_redirect» + краткая причина + confidence. | Решение strategy + confidence доступно в контексте для всех последующих шагов; fallback на текущую эвристику при ошибке/таймауте LLM. | Виктория, Дмитрий |
| 1.2 | Подключить результат стратегии: при need_clarification — использовать существующие _generate_clarification_questions и вернуть вопросы без выполнения плана; при decline_or_redirect — короткий ответ с причиной и рекомендацией (куда перенаправить или что уточнить). | Чат и API возвращают уточняющие вопросы или отказ без полного прогона плана. | Игорь |
| 1.3 | При quick_answer — идти по быстрому пути (simple, шаблон или один вызов LLM без ReAct); при deep_analysis — текущий Enhanced с ReAct/extended thinking. | Маршрутизация по strategy без дублирования правил в backend и Victoria. | Игорь |
| 1.4 | Метрики: strategy_selected{strategy=quick|deep|clarify|decline}, strategy_confidence. | В Prometheus / Grafana (Victoria или backend). | Елена |

### Фаза 2. Память и связность между диалогами

| Задача | Описание | Критерий | Ответственный | Статус |
|--------|----------|----------|---------------|--------|
| 2.1 | Проектирование хранилища «долгосрочной памяти» по пользователю/проекту: вариант A — расширение session_context (user_id, project_context, summary полем); вариант B — отдельная таблица user_memory / project_memory (ключ user_id + project_context, последние N суммаризованных «нитей», TTL). Выбор с учётом объёма и лимитов. | Документ с решением (таблица, поля, индексы, TTL) и миграция при необходимости. | Роман | ✅ Реализовано вариант B: таблица long_term_memory (user_key, project_context, goal_summary, outcome_summary), миграция add_long_term_memory.sql, менеджер long_term_memory.py. |
| 2.2 | После завершения успешного ответа Victoria: сохранять краткое резюме обмена (goal + ключевой вывод) в выбранное хранилище; при новом запросе — подмешивать до K последних релевантных «нитей» (по сходству цели или по времени). | В промпте Victoria появляется блок «Ранее по этому проекту/пользователю» без перегрузки контекста. | Виктория, Роман | ✅ _save_long_term_memory во всех путях ответа; _get_long_term_memory_context подмешивается в context; блок в victoria_enhanced. |
| 2.3 | Использовать существующий get_session_memory_summary и session_context: убедиться, что они вызываются при session_id; при наличии долгосрочной памяти — объединять «сессия» + «долгосрочное» в один блок контекста. | Нет регрессии текущего поведения; при включённой долгосрочной памяти — больше связности. | Игорь | ✅ task_memory и long_term_memory в context_with_history; один блок в Enhanced. |
| 2.4 | Метрики: memory_context_injected (count), memory_hit_rate (если есть поиск по сходству). | Опционально в Prometheus. | Елена | Отложено (можно добавить позже). |

### Фаза 3. Самокритика и итерация плана

| Задача | Описание | Критерий | Ответственный | Статус |
|--------|----------|----------|---------------|--------|
| 3.1 | Ввести чекпоинты рефлексии: (A) после каждого шага плана при статусе failed или пустом результате; (B) после N шагов (например 3 или 5) — опционально «стоит ли пересмотреть план». Вызов лёгкой модели или planner: «результат шага X: …; план: …; пересмотреть план? да/нет; если да — краткая причина». | При «да» — пересборка плана (replan) или откат к уточняющим вопросам; при «нет» — продолжение. Ограничить число пересмотров (например 1–2 за задачу). | Дмитрий, Виктория | ✅ Реализовано в ReCAP: после failed/пустого low-level шага _should_revise_plan; лимит VICTORIA_MAX_PLAN_REVISIONS (1). |
| 3.2 | При пересмотре плана: сохранять старый план в контексте как «предыдущая попытка»; новый план учитывает причину провала. ReCAP/hierarchical при необходимости вызывать заново с обновлённым контекстом. | В логах и при verbose=true видна смена плана и причина. | Игорь | ✅ previous_plan_failure в контексте, _decompose_goal с блоком «ПРЕДЫДУЩАЯ ПОПЫТКА НЕ УДАЛАСЬ». |
| 3.3 | Не полагаться только на self-verification: при рефлексии подмешивать критерии из runbook/эталонов (если задача попадает под эталон куратора — сравнение с ключевыми фразами). | Снижение риска «самоуспокоения» модели (по мировым практикам). | Анна, Арина | Отложено (при касании куратора/эталонов). |
| 3.4 | Метрики: reflection_triggered_total, plan_revised_total. | Prometheus. | Елена | Отложено (можно добавить позже). |

### Фаза 4. Неопределённость как часть логики

| Задача | Описание | Критерий | Ответственный | Статус |
|--------|----------|----------|---------------|--------|
| 4.1 | В контракт ответа Victoria (и чата) добавить поле confidence (0.0–1.0) и опционально uncertainty_reason (строка: «нет данных по X», «противоречивые источники» и т.д.). Заполнять: из слоя стратегии (1.1); из финального шага (planner или executor оценивает уверенность ответа). | Клиенты могут показывать «уверенность» или предупреждать при низкой. | Игорь | ✅ confidence из стратегии; при confidence < 0.7 в knowledge добавляется uncertainty_reason (из planner или reason). В _select_strategy добавлено опциональное поле uncertainty_reason в JSON. |
| 4.2 | В промптах ответа явно просить при низкой уверенности добавлять формулировки типа «здесь я не уверен», «нужны данные …», «рекомендую проверить». Не заменять anti_hallucination — дополнить. | В ответах реже «уверенные» формулировки при недостатке данных. | Арина | ✅ PROMPT_UNCERTAINTY_LINE в victoria_common, пункт 7 в build_simple_prompt. |
| 4.3 | Метрики: confidence_below_threshold_total (например confidence < 0.6). | Grafana/алерт при желании. | Елена | Отложено. |
| 4.4 | Куратор: при сравнении с эталонами учитывать confidence; при низкой уверенности не штрафовать за «не знаю» если эталон допускает неопределённость. | Эталоны при необходимости расширить (например статус «допустима неопределённость»). | Анна | Отложено. |

### Фаза 5. Интеграция и верификация

| Задача | Описание | Критерий | Ответственный | Статус |
|--------|----------|----------|---------------|--------|
| 5.1 | Сквозные тесты: запрос с неоднозначностью → strategy=need_clarification, ответ — вопросы; запрос вне scope → decline; запрос «как вчера» с памятью → в контексте прошлый обмен; провал шага → рефлексия и при необходимости replan. | Автотесты в backend или knowledge_os; не регрессия куратора (быстрый прогон). | Анна | ✅ test_reasoning_logic_recap.py (ReCAP), test_reasoning_logic_contract.py (контракт Victoria). |
| 5.2 | Обновить VICTORIA_TASK_CHAIN_FULL и THINKING_AND_APPROACH: новая схема «стратегия → память → план → выполнение → рефлексия (чекпоинты) → ответ с confidence». | Документ актуален. | Татьяна | ✅ Схема в §1 VICTORIA_TASK_CHAIN_FULL, §6 THINKING_AND_APPROACH. |
| 5.3 | Обновить MASTER_REFERENCE (§ «Последние изменения») и CHANGES_FROM_OTHER_CHATS после каждой фазы. | Библия актуальна. | Виктория | ✅ CHANGES §0.4eo, MASTER_REFERENCE. |

---

## 6. Порядок и зависимости

- **Фаза 0** — параллельно с остальным, можно начать сразу.
- **Фаза 1** — основа для 2–4 (стратегия и confidence в одном месте).
- **Фаза 2** — можно вести параллельно с 1 после 0; зависит от 2.1 (решение по БД).
- **Фаза 3** — зависит от 1.1 (контекст плана и шагов доступен).
- **Фаза 4** — частично зависит от 1.1 (confidence из стратегии); финальный confidence ответа можно добавить независимо.
- **Фаза 5** — после 1–4 по мере готовности; регрессия и куратор — после каждой фазы по возможности.

Рекомендуемая последовательность: **0 → 1 → 4.1, 4.2 → 2 → 3 → 4.3, 4.4 → 5.**

---

## 7. Риски и митигации

| Риск | Митигация |
|------|-----------|
| Дополнительная задержка из‑за шага «стратегия» | Один короткий вызов planner; fallback на эвристику при таймауте; кэш по goal hash для повторных похожих запросов. |
| Перегрузка контекста памятью | Жёсткий лимит K записей и символов; суммаризация; только релевантные по сходству или по времени. |
| Рефлексия увеличивает число вызовов LLM | Чекпоинты только при failed/пустом шаге; лимит пересмотров плана (1–2). |
| Self-verification ухудшает результат | Рефлексия с опорой на внешние критерии (runbook, эталоны); не заменять текущие проверки одной «самокритикой». |

---

## 8. Связь с другими документами

- **MASTER_REFERENCE** — после внедрения обновить § «Последние изменения» и при необходимости §8.
- **CHANGES_FROM_OTHER_CHATS** — запись по завершении фаз.
- **VICTORIA_TASK_CHAIN_FULL** — новая схема от запроса до ответа (стратегия, память, рефлексия, confidence).
- **THINKING_AND_APPROACH** — расширение раздела «как обрабатываю задачу» (выбор стратегии, чекпоинты, неопределённость).
- **PROMPTS_VICTORIA** — таблица промптов (стратегия, рефлексия, уверенность).
- **VERIFICATION_CHECKLIST** — пункт «После изменений Victoria/оркестрации: run_all_system_tests, при необходимости куратор».
- **TODO_FIXME_BACKLOG** — при появлении новых TODO в коде по этому плану — ссылка на этот документ.

---

## 9. Что ещё учесть (ничего не забыто)

Чтобы всё, что уже есть, работало вместе с новым поведением, учесть следующее.

### Асинхронный режим (202 + GET /run/status)

- Сейчас при `async_mode=true` ветка возвращает 202 и запускает `_run_task_background` **без** вызова `_understand_goal_with_clarification`. Уточняющие вопросы в async-режиме не возвращаются.
- **Нужно:** стратегию и понимание цели выполнять в `run_task` **до** проверки `if async_mode`. Если результат — `need_clarification` или `decline_or_redirect`, сразу вернуть 200 с телом (questions или отказ), а не 202. В фоновую задачу уходить только когда стратегия = quick/deep и уточнение не требуется.
- В `_run_task_background` передавать уже посчитанные `restated_goal` и `strategy_result`, чтобы не вызывать understand_goal и strategy повторно. Сигнатура: добавить аргументы `restated_goal`, `strategy_result`; внутри использовать их, если переданы.
- Во всех путях завершения фоновой задачи (Veronica, Enhanced, agent.run) в `src/agents/bridge/victoria_server.py` **добавить** вызов `_save_session_exchange(session_id, goal_or_restated, output)` (сейчас в async-пути сессия не сохраняется). При Фазе 2 — вызывать `_save_long_term_memory(...)` при успешном завершении.
- При записи результата в `store` в `_run_task_background` добавлять в `store["knowledge"]` поля `strategy`, `strategy_reason`, `confidence` из переданного `strategy_result`, чтобы GET /run/status возвращал тот же контракт, что и синхронный ответ.

### Быстрый путь corporation_data (quick_data)

- Ранний выход `_try_corporation_data_quick_response` выполняется до understand_goal и до стратегии. Чтобы контракт ответа был единым: в ответе quick_data в поле `knowledge` подставлять хотя бы `strategy: "quick_answer"` и при желании `confidence: 0.9`.

### Конфигурация и env

- Добавить переменные и описать в `.env.example` и в `knowledge_os/docker-compose.yml` (секция victoria-agent):
  - `VICTORIA_STRATEGY_ENABLED` (default `true`) — включать/выключать слой стратегии.
  - `VICTORIA_MAX_PLAN_REVISIONS` (default `1`) — макс. число пересмотров плана за задачу (Фаза 3).
  - `STRATEGY_CACHE_TTL_SEC` (default `120`) и макс. размер кэша (например 200) для кэша по goal.
  - `LONG_TERM_MEMORY_ENABLED` (default `false` до внедрения Фазы 2) — использовать ли долгосрочную память.
- При `VICTORIA_STRATEGY_ENABLED=false` не вызывать `_select_strategy`, вести себя как сейчас (эвристика + understand_goal).

### Обработка ошибок

- `_select_strategy`: обернуть вызов LLM в try/except; при исключении или таймауте возвращать fallback `{"strategy": None, "reason": "fallback", "confidence": 0.5}` и продолжать текущую логику.
- `_get_long_term_memory_context`: при ошибке БД или импорта возвращать `""`, не падать.

### Клиенты Victoria (всё продолжит работать)

- **Backend чат** (`backend/app/routers/chat.py`): уже обрабатывает `needs_clarification` и показывает вопросы; при желании пробросить `strategy`, `confidence` в SSE.
- **Backend VictoriaClient** (`backend/app/services/victoria.py`): ответ уже содержит `knowledge` — новые поля попадут в ответ без изменений кода.
- **Telegram-бот** (`src/agents/bridge/victoria_telegram_bot.py`): уже обрабатывает `needs_clarification` и выводит вопросы.
- **Прокси Anthropic** (`proxy/main.py`), **куратор** (`scripts/curator_send_tasks_to_victoria.py`), **MCP, victoria_chat.py**: работают с тем же контрактом /run; обратная совместимость сохраняется.

### Промпты и идентификация пользователя

- В [PROMPTS_VICTORIA.md](PROMPTS_VICTORIA.md) добавить строки для Strategy selection, Reflection checkpoint, Final confidence.
- Тексты промптов стратегии и рефлексии хранить в коде (`victoria_server.py`) или в `configs/` (по аналогии с corporation_thinking.txt).
- Для долгосрочной памяти: ключ = (session_id, project_context), где user_id := session_id, пока в TaskRequest не появится отдельное поле user_id (как в `session_context_manager`).

### Тесты и регрессия

- После изменений в `victoria_server.py` запускать `./scripts/run_all_system_tests.sh` и при необходимости быстрый прогон куратора (таймаут ≥10 мин), как в VERIFICATION_CHECKLIST_OPTIMIZATIONS §5.

---

*План согласован с командой экспертов и опирается на базу знаний и мировые практики. Следующий шаг: утвердить приоритет фаз и приступить к Фазе 0 и Фазе 1.*
