# Метрики качества RAG (Фаза 4)

Описание метрик качества ответов RAG и способов их измерения.

---

## Основные метрики

### 1. Faithfulness (верность контексту)

**Определение:** ответ не противоречит извлечённому контексту (чанкам) и не привносит фактов «из головы».

**Измерение:**
- Автоматически: NLI-модель (entailment) между утверждениями в ответе и контекстом; доля утверждений, поддерживаемых контекстом.
- Порог: **≥ 0.9** (90% утверждений faithful).

**Использование:** при падении ниже порога — откат или алерт.

---

### 2. Relevance (релевантность запросу)

**Определение:** ответ по существу запроса и не уходит в сторону.

**Измерение:**
- Автоматически: эмбеддинги запроса и ответа; cosine similarity или релевантность по LLM-суждению (query–response relevance).
- Порог: **≥ 0.85**.

---

### 3. Coherence (связность ответа)

**Определение:** ответ логичен, структурирован, без противоречий внутри себя.

**Измерение:**
- Автоматически: метрики связности текста или LLM-as-judge по шкале 1–5.
- Порог: **≥ 0.9** (или средний балл ≥ 4).

---

### 4. BLEU / ROUGE

**Когда использовать:** при наличии эталонного ответа (reference) в validation set.

- **BLEU:** n-gram совпадение с эталоном.
- **ROUGE:** recall по n-gram (ROUGE-1, ROUGE-L).

Используются как дополнительные метрики к faithfulness/relevance.

---

### 5. Human Preference Score

**Определение:** средняя оценка пользователей (1–5) за «полезность/качество ответа».

**Цель:** **> 4.0 / 5.0**.

**Сбор:** через UI (звёзды/лайк) или форму обратной связи; сохранение в БД/аналитику.

---

### 6. Multi-turn Success Rate

**Определение:** доля диалогов из нескольких реплик, в которых система даёт уместный ответ в последнем turn.

**Цель:** **> 80%**.

**Измерение:** на тестовом наборе многоходовых диалогов; критерий успеха — релевантность и связность последнего ответа.

---

## Пороги для CI / алертов

| Метрика | Порог | Действие при нарушении |
|---------|--------|--------------------------|
| Faithfulness | ≥ 0.8 | Предупреждение в CI; при < 0.7 — не мержить без ревью |
| Relevance | ≥ 0.85 | То же |
| Coherence | ≥ 0.85 | То же |
| Human Preference (если есть данные) | ≥ 3.8 | Алерт в мониторинг |

---

## Скрипты и интеграция

- **Оценка на validation set:** `python scripts/evaluate_rag_quality.py --dataset data/validation_queries.json --threshold faithfulness:0.8,relevance:0.85`
- **Экспорт метрик:** в Prometheus/ Grafana (например, `rag_quality_faithfulness`, `rag_quality_relevance`) для дашбордов Фазы 4.

Подробнее план внедрения — в `docs/PHASE4_PLAN.md` и `docs/CONTINUOUS_IMPROVEMENT.md`.
