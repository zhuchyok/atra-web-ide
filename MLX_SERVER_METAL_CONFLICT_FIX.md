# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ Metal –≤ MLX Server

## üîç –ü—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞:** `-[_MTLCommandBuffer addCompletedHandler:]:1011: failed assertion 'Completed handler provided after commit call'`

**–ü—Ä–∏—á–∏–Ω–∞:** Metal (Apple GPU framework) –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥—Ä—É–≥–æ–π.

### –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –ø–∞–¥–µ–Ω–∏—è:

1. **20:52:53** - `deepseek-r1-distill-llama:70b` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç (104.85—Å)
2. **20:53:49** - –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ `phi3:mini-4k` (–¥—Ä—É–≥–∞—è –º–æ–¥–µ–ª—å)
3. **20:54:24** - MLX Server –ø–∞–¥–∞–µ—Ç —Å SIGABRT (-6)
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ExtendedThinking –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ fallback, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ Metal:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π**
   - –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥—Ä—É–≥–∏—Ö –º–æ–¥–µ–ª–µ–π ‚Üí –æ—Ç–ª–æ–∂–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
   - –ñ–¥–∞—Ç—å –¥–æ 2 –º–∏–Ω—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
   - –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞—á–∏–Ω–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏

2. **–õ–æ–≥–∏–∫–∞:**
   ```python
   # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
   active_generations = sum(_active_model_requests.values())
   if active_generations > 0:
       # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
       wait_for_generations_to_complete()
   
   # –¢–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å
   load_model()
   ```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ Metal –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SIGABRT –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏

## üîÑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω race condition –≤ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–µ–π
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ Metal
3. ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
