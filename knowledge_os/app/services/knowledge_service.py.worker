import os
import logging
from typing import List, Dict, Optional
import asyncpg
try:
    from semantic_cache import get_embedding
    from db_pool import get_pool
except ImportError:
    from app.semantic_cache import get_embedding
    from app.db_pool import get_pool

logger = logging.getLogger(__name__)

class KnowledgeService:
    """
    –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π (RAG, —ç–º–±–µ–¥–¥–∏–Ω–≥–∏).
    –ò–∑–æ–ª–∏—Ä—É–µ—Ç —Ç—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –∏ –≤–µ–∫—Ç–æ—Ä–∞–º–∏.
    """
    def __init__(self):
        self.db_url = os.getenv("DATABASE_URL")

    async def get_rag_context(self, query: str, limit: int = 5) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫."""
        embedding = await get_embedding(query)
        if not embedding:
            return ""

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Å—Ç—Ä–æ–∫—É —Ñ–æ—Ä–º–∞—Ç–∞ '[1.2, 3.4, ...]' –¥–ª—è pgvector
        if isinstance(embedding, list):
            embedding_str = "[" + ",".join(map(str, embedding)) + "]"
        else:
            embedding_str = embedding

        pool = await get_pool()
        async with pool.acquire() as conn:
            rows = await conn.fetch("""
                SELECT content, confidence_score
                FROM knowledge_nodes
                WHERE is_verified = TRUE
                ORDER BY embedding <=> $1::vector
                LIMIT $2
            """, embedding_str, limit)
            
            if not rows:
                return ""
                
            context = "\n### –ó–ù–ê–ù–ò–Ø –ò–ó –ë–ê–ó–´:\n"
            for row in rows:
                context += f"- {row['content']}\n"
            return context

    async def save_insight(self, content: str, expert_name: str, metadata: Dict = None):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π –∏–Ω—Å–∞–π—Ç –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π."""
        embedding = await get_embedding(content[:1000])
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Å—Ç—Ä–æ–∫—É —Ñ–æ—Ä–º–∞—Ç–∞ '[1.2, 3.4, ...]' –¥–ª—è pgvector, –µ—Å–ª–∏ —ç—Ç–æ —Å–ø–∏—Å–æ–∫
        if isinstance(embedding, list):
            embedding_str = "[" + ",".join(map(str, embedding)) + "]"
        else:
            embedding_str = embedding

        pool = await get_pool()
        async with pool.acquire() as conn:
            await conn.execute("""
                INSERT INTO knowledge_nodes (content, domain_id, confidence_score, embedding, is_verified, metadata)
                VALUES ($1, (SELECT id FROM domains WHERE name = 'victoria_tasks' LIMIT 1), 0.9, $2, TRUE, $3::jsonb)
            """, content, embedding_str, metadata or {})
            logger.info(f"üìö [KNOWLEDGE SERVICE] –°–æ—Ö—Ä–∞–Ω–µ–Ω –∏–Ω—Å–∞–π—Ç –æ—Ç {expert_name}")

knowledge_service = KnowledgeService()
