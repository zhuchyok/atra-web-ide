import asyncio
import os
import asyncpg
import json
import httpx
import logging

logger = logging.getLogger(__name__)

# URL Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹
MLX_API_URL = os.getenv("MLX_API_URL", "http://host.docker.internal:11435")
DB_URL = os.getenv("DATABASE_URL", "postgresql://admin:secret@localhost:5432/knowledge_os")

async def run_simulation(simulation_id: int):
    """Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸ÑŽ Ð±Ð¸Ð·Ð½ÐµÑ-Ð¸Ð´ÐµÐ¸ Ñ‡ÐµÑ€ÐµÐ· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¼Ð¾Ð´ÐµÐ»Ð¸"""
    pool = await asyncpg.create_pool(DB_URL, min_size=1, max_size=5)
    
    async with pool.acquire() as conn:
        idea = await conn.fetchval("SELECT idea FROM simulations WHERE id = $1", simulation_id)
        if not idea:
            logger.error(f"Ð¡Ð¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ {simulation_id} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
            await pool.close()
            return
            
        logger.info(f"ðŸš€ Simulating Idea: {idea}")
        
        # Ð¨Ð°Ð³ 1: Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹
        context_nodes = await conn.fetch("""
            SELECT content FROM knowledge_nodes 
            WHERE content ILIKE $1 OR content ILIKE $2
            ORDER BY confidence_score DESC LIMIT 10
        """, f"%{idea.split()[0] if idea.split() else ''}%", f"%{idea}%")
        
        context = "\n---\n".join([r['content'] for r in context_nodes]) if context_nodes else "ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        
        # Ð¨Ð°Ð³ 2: Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ñ Ð¼Ð¸Ñ€Ð¾Ð²Ñ‹Ð¼Ð¸ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ°Ð¼Ð¸ Ð±Ð¸Ð·Ð½ÐµÑ-Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
        prompt = f"""Ð¢Ð« - Ð­ÐšÐ¡ÐŸÐ•Ð Ð¢ ÐŸÐž Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð§Ð•Ð¡ÐšÐžÐœÐ£ ÐŸÐ›ÐÐÐ˜Ð ÐžÐ’ÐÐÐ˜Ð® Ð˜ Ð‘Ð˜Ð—ÐÐ•Ð¡-ÐÐÐÐ›Ð˜Ð—Ð£. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð’Ð¡Ð• Ð¼Ð¸Ñ€Ð¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð±Ð¸Ð·Ð½ÐµÑ-Ð¸Ð´ÐµÐ¸.

Ð˜Ð”Ð•Ð¯: {idea}

ÐšÐžÐÐ¢Ð•ÐšÐ¡Ð¢ Ð˜Ð— Ð‘ÐÐ—Ð« Ð—ÐÐÐÐ˜Ð™:
{context}

Ð—ÐÐ”ÐÐ§Ð: ÐŸÑ€Ð¾Ð²ÐµÐ´Ð¸ ÐœÐÐšÐ¡Ð˜ÐœÐÐ›Ð¬ÐÐž Ð”Ð•Ð¢ÐÐ›Ð¬ÐÐ«Ð™ Ð°Ð½Ð°Ð»Ð¸Ð·, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ¸:

---

## 1. BUSINESS MODEL CANVAS (9 Ð±Ð»Ð¾ÐºÐ¾Ð²)

**1.1 Customer Segments (Ð¦ÐµÐ»ÐµÐ²Ñ‹Ðµ ÑÐµÐ³Ð¼ÐµÐ½Ñ‚Ñ‹):**
- ÐšÑ‚Ð¾ Ð²Ð°ÑˆÐ¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹?
- ÐšÐ°ÐºÐ¸Ðµ ÑÐµÐ³Ð¼ÐµÐ½Ñ‚Ñ‹ Ñ€Ñ‹Ð½ÐºÐ°?

**1.2 Value Propositions (Ð¦ÐµÐ½Ð½Ð¾ÑÑ‚Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ):**
- ÐšÐ°ÐºÑƒÑŽ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð²Ñ‹ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚Ðµ?
- ÐšÐ°ÐºÐ¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ€ÐµÑˆÐ°ÐµÑ‚Ðµ?

**1.3 Channels (ÐšÐ°Ð½Ð°Ð»Ñ‹):**
- ÐšÐ°Ðº Ð²Ñ‹ Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚Ðµ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ?
- ÐšÐ°ÐºÐ¸Ðµ ÐºÐ°Ð½Ð°Ð»Ñ‹ Ð¿Ñ€Ð¾Ð´Ð°Ð¶?

**1.4 Customer Relationships (ÐžÑ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ñ Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸):**
- ÐšÐ°Ðº Ð²Ñ‹ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚Ðµ Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸?
- Ð¢Ð¸Ð¿ Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ð¹?

**1.5 Revenue Streams (ÐŸÐ¾Ñ‚Ð¾ÐºÐ¸ Ð´Ð¾Ñ…Ð¾Ð´Ð¾Ð²):**
- ÐšÐ°Ðº Ð²Ñ‹ Ð·Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚Ðµ?
- ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð¼Ð¾Ð½ÐµÑ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸?

**1.6 Key Resources (ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ñ€ÐµÑÑƒÑ€ÑÑ‹):**
- ÐšÐ°ÐºÐ¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÑ‹ Ð½ÑƒÐ¶Ð½Ñ‹?
- Ð§Ñ‚Ð¾ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹?

**1.7 Key Activities (ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸):**
- Ð§Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ?
- ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹?

**1.8 Key Partners (ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€Ñ‹):**
- ÐšÑ‚Ð¾ Ð²Ð°ÑˆÐ¸ Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€Ñ‹?
- ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð°Ð»ÑŒÑÐ½ÑÑ‹?

**1.9 Cost Structure (Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð·Ð°Ñ‚Ñ€Ð°Ñ‚):**
- ÐšÐ°ÐºÐ¸Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ñ‚Ñ€Ð°Ñ‚Ñ‹?
- Ð¤Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ vs Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ?

---

## 2. SWOT-ÐÐÐÐ›Ð˜Ð— (Strengths, Weaknesses, Opportunities, Threats)

**Strengths (Ð¡Ð¸Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹):**
- Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ Ð¿Ñ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð°
- ÐšÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ñ‹Ðµ Ð¿Ñ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð°

**Weaknesses (Ð¡Ð»Ð°Ð±Ñ‹Ðµ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹):**
- Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¸
- ÐžÐ±Ð»Ð°ÑÑ‚Ð¸ Ð´Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ

**Opportunities (Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸):**
- Ð’Ð½ÐµÑˆÐ½Ð¸Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸
- Ð Ñ‹Ð½Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ½Ð´Ñ‹

**Threats (Ð£Ð³Ñ€Ð¾Ð·Ñ‹):**
- Ð’Ð½ÐµÑˆÐ½Ð¸Ðµ ÑƒÐ³Ñ€Ð¾Ð·Ñ‹
- ÐšÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ñ‹Ðµ Ñ€Ð¸ÑÐºÐ¸

---

## 3. PORTER'S FIVE FORCES (ÐšÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·)

**3.1 Rivalry Among Existing Competitors (ÐšÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ†Ð¸Ñ Ð² Ð¾Ñ‚Ñ€Ð°ÑÐ»Ð¸):**
- Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ†Ð¸Ð¸
- Ð˜Ð½Ñ‚ÐµÐ½ÑÐ¸Ð²Ð½Ð¾ÑÑ‚ÑŒ ÑÐ¾Ð¿ÐµÑ€Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð°

**3.2 Threat of New Entrants (Ð£Ð³Ñ€Ð¾Ð·Ð° Ð½Ð¾Ð²Ñ‹Ñ… Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²):**
- Ð‘Ð°Ñ€ÑŒÐµÑ€Ñ‹ Ð²Ñ…Ð¾Ð´Ð°
- Ð›ÐµÐ³ÐºÐ¾ÑÑ‚ÑŒ Ð²Ñ…Ð¾Ð´Ð° Ð½Ð° Ñ€Ñ‹Ð½Ð¾Ðº

**3.3 Threat of Substitute Products (Ð£Ð³Ñ€Ð¾Ð·Ð° Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²-Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÐµÐ»ÐµÐ¹):**
- ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ
- Ð Ð¸ÑÐº Ð·Ð°Ð¼ÐµÐ½Ñ‹

**3.4 Bargaining Power of Suppliers (Ð’Ð»Ð°ÑÑ‚ÑŒ Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸ÐºÐ¾Ð²):**
- Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚ Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸ÐºÐ¾Ð²
- ÐŸÐµÑ€ÐµÐ³Ð¾Ð²Ð¾Ñ€Ð½Ð°Ñ ÑÐ¸Ð»Ð°

**3.5 Bargaining Power of Buyers (Ð’Ð»Ð°ÑÑ‚ÑŒ Ð¿Ð¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»ÐµÐ¹):**
- Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²
- ÐŸÐµÑ€ÐµÐ³Ð¾Ð²Ð¾Ñ€Ð½Ð°Ñ ÑÐ¸Ð»Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²

---

## 4. PEST/PESTLE-ÐÐÐÐ›Ð˜Ð— (ÐœÐ°ÐºÑ€Ð¾-Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ)

**Political (ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ñ‹):**
- Ð ÐµÐ³ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

**Economic (Ð­ÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ñ‹):**
- Ð­ÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ€Ð¾ÑÑ‚
- Ð˜Ð½Ñ„Ð»ÑÑ†Ð¸Ñ, Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½Ñ‹Ðµ ÑÑ‚Ð°Ð²ÐºÐ¸

**Social (Ð¡Ð¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ñ‹):**
- Ð”ÐµÐ¼Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ
- Ð¡Ð¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ½Ð´Ñ‹

**Technological (Ð¢ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ñ‹):**
- Ð¢ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¸Ð½Ð½Ð¾Ð²Ð°Ñ†Ð¸Ð¸
- R&D Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ

**Legal (ÐŸÑ€Ð°Ð²Ð¾Ð²Ñ‹Ðµ Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ñ‹) - Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾:**
- Ð—Ð°ÐºÐ¾Ð½Ñ‹ Ð¸ Ñ€ÐµÐ³ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
- ÐŸÑ€Ð°Ð²Ð¾Ð²Ñ‹Ðµ Ñ€Ð¸ÑÐºÐ¸

**Environmental (Ð­ÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ñ‹) - Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾:**
- Ð­ÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ
- Ð£ÑÑ‚Ð¾Ð¹Ñ‡Ð¸Ð²Ð¾Ðµ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ

---

## 5. RISK ASSESSMENT (ÐžÑ†ÐµÐ½ÐºÐ° Ñ€Ð¸ÑÐºÐ¾Ð²)

**Risk Matrix (ÐœÐ°Ñ‚Ñ€Ð¸Ñ†Ð° Ñ€Ð¸ÑÐºÐ¾Ð²):**
- Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº (Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ã— Ð²Ð»Ð¸ÑÐ½Ð¸Ðµ)
- Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ñ€Ð¸ÑÐº
- ÐÐ¸Ð·ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº

**ÐšÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ñ€Ð¸ÑÐºÐ¸:**
- Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€Ð¸ÑÐºÐ¸
- Ð Ñ‹Ð½Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ€Ð¸ÑÐºÐ¸
- Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ðµ Ñ€Ð¸ÑÐºÐ¸
- ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ€Ð¸ÑÐºÐ¸

**ÐžÐ±Ñ‰Ð°Ñ Ð¾Ñ†ÐµÐ½ÐºÐ° Ñ€Ð¸ÑÐºÐ°:** X% (0-100%)

---

## 6. LEAN STARTUP VALIDATION (Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‚Ð°Ð¿Ð¾Ð²)

**Problem-Solution Fit:**
- Ð ÐµÑˆÐ°ÐµÑ‚ Ð»Ð¸ Ð¸Ð´ÐµÑ Ñ€ÐµÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ?
- Ð•ÑÑ‚ÑŒ Ð»Ð¸ ÑÐ¿Ñ€Ð¾Ñ?

**Product-Market Fit:**
- Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚ Ñ€Ñ‹Ð½ÐºÑƒ?
- Ð“Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ Ñ€Ñ‹Ð½ÐºÐ°?

**Key Metrics (ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸):**
- MVP Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸
- ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ñ€Ð¾ÑÑ‚Ð°

---

## 7. VALUE PROPOSITION CANVAS (Ð¥Ð¾Ð»ÑÑ‚ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ)

**Customer Jobs (Ð—Ð°Ð´Ð°Ñ‡Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°):**
- Ð§Ñ‚Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ñ‹Ñ‚Ð°ÐµÑ‚ÑÑ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ?
- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ/ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸

**Customer Pains (Ð‘Ð¾Ð»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°):**
- ÐšÐ°ÐºÐ¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°?
- Ð§Ñ‚Ð¾ ÐµÐ³Ð¾ Ð±ÐµÑÐ¿Ð¾ÐºÐ¾Ð¸Ñ‚?

**Customer Gains (Ð’Ñ‹Ð³Ð¾Ð´Ñ‹ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°):**
- Ð§Ñ‚Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ñ…Ð¾Ñ‡ÐµÑ‚ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ?
- Ð–ÐµÐ»Ð°ÐµÐ¼Ñ‹Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹

**Value Proposition:**
- ÐšÐ°Ðº Ð²Ð°ÑˆÐµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ñ€ÐµÑˆÐ°ÐµÑ‚ Ð±Ð¾Ð»Ð¸ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ Ð²Ñ‹Ð³Ð¾Ð´Ñ‹?

---

## 8. MARKET ANALYSIS (ÐÐ½Ð°Ð»Ð¸Ð· Ñ€Ñ‹Ð½ÐºÐ°)

**Market Size (Ð Ð°Ð·Ð¼ÐµÑ€ Ñ€Ñ‹Ð½ÐºÐ°):**
- TAM (Total Addressable Market)
- SAM (Serviceable Addressable Market)
- SOM (Serviceable Obtainable Market)

**Market Trends (Ð Ñ‹Ð½Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ½Ð´Ñ‹):**
- Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ñ‚Ñ€ÐµÐ½Ð´Ñ‹
- Ð‘ÑƒÐ´ÑƒÑ‰Ð¸Ðµ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ñ‹

**Competitive Landscape (ÐšÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ñ‹Ð¹ Ð»Ð°Ð½Ð´ÑˆÐ°Ñ„Ñ‚):**
- ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ñ‹
- ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

---

## 9. FINANCIAL FEASIBILITY (Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð°Ñ Ð¾ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¸Ð¼Ð¾ÑÑ‚ÑŒ)

**Revenue Projections (ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· Ð´Ð¾Ñ…Ð¾Ð´Ð¾Ð²):**
- ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· Ð½Ð° 1-3 Ð³Ð¾Ð´Ð°
- ÐœÐ¾Ð´ÐµÐ»ÑŒ Ñ€Ð¾ÑÑ‚Ð°

**Cost Structure (Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð·Ð°Ñ‚Ñ€Ð°Ñ‚):**
- ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ð¸
- ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ð·Ð°Ñ‚Ñ€Ð°Ñ‚Ñ‹

**Break-Even Analysis (ÐÐ½Ð°Ð»Ð¸Ð· Ð±ÐµÐ·ÑƒÐ±Ñ‹Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ð¸):**
- Ð¢Ð¾Ñ‡ÐºÐ° Ð±ÐµÐ·ÑƒÐ±Ñ‹Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ð¸
- Ð¡Ñ€Ð¾Ðº Ð¾ÐºÑƒÐ¿Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸

---

## 10. IMPLEMENTATION ROADMAP (Ð”Ð¾Ñ€Ð¾Ð¶Ð½Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð° Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸)

**Phase 1: MVP (Minimum Viable Product) - 0-3 Ð¼ÐµÑÑÑ†Ð°:**
- ÐŸÐµÑ€Ð²Ñ‹Ðµ ÑˆÐ°Ð³Ð¸
- ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸

**Phase 2: Market Entry - 3-6 Ð¼ÐµÑÑÑ†ÐµÐ²:**
- Ð’Ñ‹Ñ…Ð¾Ð´ Ð½Ð° Ñ€Ñ‹Ð½Ð¾Ðº
- ÐŸÐµÑ€Ð²Ñ‹Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹

**Phase 3: Growth - 6-12 Ð¼ÐµÑÑÑ†ÐµÐ²:**
- ÐœÐ°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ

---

## 11. FINAL VERDICT (Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²ÐµÑ€Ð´Ð¸ÐºÑ‚)

**Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ:**
- [Ð—ÐÐŸÐ£Ð¡ÐšÐÐ¢Ð¬] - Ð˜Ð´ÐµÑ Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
- [Ð”ÐžÐ ÐÐ‘ÐžÐ¢ÐÐ¢Ð¬] - ÐÑƒÐ¶Ð½Ñ‹ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ (ÑƒÐºÐ°Ð¶Ð¸ Ñ‡Ñ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð½Ð¾)
- [ÐžÐ¢ÐšÐ›ÐžÐÐ˜Ð¢Ð¬] - Ð˜Ð´ÐµÑ Ð½ÐµÐ¶Ð¸Ð·Ð½ÐµÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð° (Ð¾Ð±ÑŠÑÑÐ½Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ)

**Confidence Score (Ð£Ð²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ):** X% (0-100%)

**Priority (ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚):** [HIGH/MEDIUM/LOW]

---

Ð¤ÐžÐ ÐœÐÐ¢ ÐžÐ¢Ð’Ð•Ð¢Ð: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ markdown Ñ Ñ‡ÐµÑ‚ÐºÐ¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹. Ð‘ÑƒÐ´ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð¸ Ñ„Ð°ÐºÑ‚Ñ‹ Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°. ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ð¸ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¼."""

        # Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñ‡ÐµÑ€ÐµÐ· MLX API
        try:
            async with httpx.AsyncClient(timeout=180.0) as client:
                response = await client.post(
                    f"{MLX_API_URL}/api/generate",
                    json={
                        "model": "phi3.5:3.8b",
                        "prompt": prompt,
                        "stream": False,
                        "options": {
                            "temperature": 0.7,
                            "top_p": 0.9,
                            "num_predict": 4000  # Ð£Ð²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¾ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ñ Ð¼Ð¸Ñ€Ð¾Ð²Ñ‹Ð¼Ð¸ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ°Ð¼Ð¸
                        }
                    }
                )
                
                if response.status_code == 200:
                    result = response.json()
                    analysis = result.get('response', 'ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½')
                    await conn.execute("UPDATE simulations SET result = $1 WHERE id = $2", analysis, simulation_id)
                    logger.info(f"âœ… Simulation {simulation_id} completed and saved.")
                else:
                    error_msg = f"MLX API Error: {response.status_code} - {response.text}"
                    await conn.execute("UPDATE simulations SET result = $1 WHERE id = $2", error_msg, simulation_id)
                    logger.error(f"âŒ Simulation {simulation_id} failed: {error_msg}")
                    
        except httpx.TimeoutException:
            error_msg = "ÐžÑˆÐ¸Ð±ÐºÐ°: ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¾Ñ‚ Ð¼Ð¾Ð´ÐµÐ»Ð¸ (180 ÑÐµÐº)"
            await conn.execute("UPDATE simulations SET result = $1 WHERE id = $2", error_msg, simulation_id)
            logger.error(f"âŒ Simulation {simulation_id} timed out")
        except Exception as e:
            error_msg = f"Internal Error: {str(e)}"
            await conn.execute("UPDATE simulations SET result = $1 WHERE id = $2", error_msg, simulation_id)
            logger.error(f"âŒ Simulation {simulation_id} failed: {e}")

    await pool.close()

if __name__ == "__main__":
    import sys
    if len(sys.argv) > 1:
        asyncio.run(run_simulation(int(sys.argv[1])))

