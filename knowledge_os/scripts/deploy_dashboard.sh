#!/bin/bash

# ะกะบัะธะฟั ะดะปั ัะฐะทะฒะตัััะฒะฐะฝะธั ะดะฐัะฑะพัะดะฐ ะฝะฐ ัะตัะฒะตัะต
echo "๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต ATRA Dashboard ะฝะฐ ัะตัะฒะตัะต..."

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฝะฐ ัะตัะฒะตัะต
if [ ! -d "/root/atra" ]; then
    echo "โ ะะฐะฟะบะฐ /root/atra ะฝะต ะฝะฐะนะดะตะฝะฐ"
    echo "ะกะพะทะดะฐะตะผ ััััะบัััั ะฟะฐะฟะพะบ..."
    mkdir -p /root/atra
fi

cd /root/atra

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต Python
if ! command -v python3 &> /dev/null; then
    echo "โ Python3 ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
    exit 1
fi

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
pip3 install flask flask-cors

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะฟัะพัะตััั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะฟัะพัะตััั..."
pkill -f "dashboard.py" 2>/dev/null || true
pkill -f "rest_api.py" 2>/dev/null || true

# ะะฐะฟััะบะฐะตะผ ะดะฐัะฑะพัะด
echo "๐ ะะฐะฟััะบะฐะตะผ Dashboard ะฝะฐ ะฟะพััั 5002..."
nohup python3 web/dashboard.py --host 0.0.0.0 --port 5002 > dashboard.log 2>&1 &

# ะะฐะฟััะบะฐะตะผ REST API
echo "๐ ะะฐะฟััะบะฐะตะผ REST API ะฝะฐ ะฟะพััั 8080..."
nohup python3 rest_api.py --host 0.0.0.0 --port 8080 > rest_api.log 2>&1 &

# ะะดะตะผ ะทะฐะฟััะบะฐ
sleep 5

# ะัะพะฒะตััะตะผ ััะฐััั
echo "โ ะัะพะฒะตััะตะผ ััะฐััั ัะตัะฒะธัะพะฒ..."
netstat -tlnp | grep -E "(5002|8080)"

echo "๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
echo "๐ Dashboard: http://185.177.216.15:5002"
echo "๐ REST API: http://185.177.216.15:8080"
