#!/bin/bash
# –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –±—ç–∫–∞–ø–æ–≤ –¥–ª—è Knowledge OS

set -e

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –±—ç–∫–∞–ø–æ–≤ –¥–ª—è Knowledge OS"
echo ""

# 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤
echo "üì¶ –®–ê–ì 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤..."
bash "$(dirname "$0")/setup_automated_backups.sh"
echo ""

# 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
echo "üîç –®–ê–ì 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
bash "$(dirname "$0")/setup_monitoring.sh"
echo ""

# 3. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo "üìÅ –®–ê–ì 3: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
mkdir -p /root/knowledge_os/backups
mkdir -p /root/knowledge_os/logs
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if ! python3 -c "import psutil" 2>/dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ psutil..."
    pip3 install psutil
fi
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
echo ""

# 5. –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
echo "üß™ –®–ê–ì 5: –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫..."
echo ""
echo "–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±—ç–∫–∞–ø–∞:"
bash "$(dirname "$0")/backup_db.sh" || echo "‚ö†Ô∏è  –ë—ç–∫–∞–ø —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Telegram —Ç–æ–∫–µ–Ω –∏ —Ç.–¥.)"
echo ""
echo "–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
cd /root/knowledge_os && python3 app/enhanced_monitor.py || echo "‚ö†Ô∏è  –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)"
echo ""

# 6. –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo "======================================================================"
echo "‚úÖ –ù–ê–°–¢–†–û–ô–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "======================================================================"
echo ""
echo "üìã –ß–¢–û –ù–ê–°–¢–†–û–ï–ù–û:"
echo ""
echo "1. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00)"
echo "   - –°–∫—Ä–∏–ø—Ç: /root/knowledge_os/scripts/backup_db.sh"
echo "   - –õ–æ–≥–∏: /root/knowledge_os/logs/cron_backup.log"
echo "   - –ë—ç–∫–∞–ø—ã: /root/knowledge_os/backups/"
echo ""
echo "2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)"
echo "   - –°–∫—Ä–∏–ø—Ç: /root/knowledge_os/app/enhanced_monitor.py"
echo "   - –õ–æ–≥–∏: /root/knowledge_os/logs/monitor.log"
echo "   - –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ system_metrics)"
echo ""
echo "3. ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞"
echo "   - –°–∫—Ä–∏–ø—Ç: /root/knowledge_os/scripts/restore_from_backup.sh"
echo ""
echo "üìä –ú–ï–¢–†–ò–ö–ò –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê:"
echo "   - CPU –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ"
echo "   - RAM –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ"
echo "   - Disk –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ"
echo "   - Database connections"
echo "   - API response time"
echo "   - Knowledge nodes count"
echo "   - Experts count"
echo ""
echo "üö® –ê–õ–ï–†–¢–´:"
echo "   - –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Telegram –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–æ–≤"
echo "   - –ü–æ—Ä–æ–≥–∏: CPU > 85%, RAM > 85%, Disk > 90%"
echo ""
echo "üìù –ü–†–û–í–ï–†–ö–ê:"
echo "   - –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á: crontab -l"
echo "   - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f /root/knowledge_os/logs/*.log"
echo ""
echo "======================================================================"

