#!/bin/bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ nightly_learner –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤

set -e

SERVER="root@185.177.216.15"
SERVER_PASSWORD="u44Ww9NmtQj,XG"
SERVER_PATH="/root/knowledge_os"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SSH –∫–æ–º–∞–Ω–¥ —Å –ø–∞—Ä–æ–ª–µ–º
ssh_with_password() {
    expect << EOF
set timeout 30
spawn ssh -o StrictHostKeyChecking=no $SERVER "$1"
expect {
    "password:" {
        send "$SERVER_PASSWORD\r"
        exp_continue
    }
    "Password:" {
        send "$SERVER_PASSWORD\r"
        exp_continue
    }
    "yes/no" {
        send "yes\r"
        exp_continue
    }
    eof
}
EOF
}

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤..."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è expect
if ! command -v expect &> /dev/null; then
    echo "‚ùå expect –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
if ssh_with_password "echo 'Connected'" 2>&1 | grep -q "Connected"; then
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    exit 1
fi
echo ""

# –ó–∞–¥–∞—á–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00)
echo "======================================================================"
echo "üìö –ù–ê–°–¢–†–û–ô–ö–ê –ï–ñ–ï–î–ù–ï–í–ù–û–ì–û –û–ë–£–ß–ï–ù–ò–Ø –≠–ö–°–ü–ï–†–¢–û–í"
echo "======================================================================"
echo ""

NIGHTLY_LEARNER_SCRIPT="$SERVER_PATH/app/nightly_learner.py"
CRON_NIGHTLY_LEARNER="0 3 * * * cd $SERVER_PATH && python3 app/nightly_learner.py >> logs/nightly_learner.log 2>&1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É
RESULT=$(ssh_with_password "crontab -l 2>/dev/null | grep -q 'nightly_learner.py' && echo 'EXISTS' || echo 'NOT_FOUND'" 2>&1)

if echo "$RESULT" | grep -q "EXISTS"; then
    echo "‚úÖ –ó–∞–¥–∞—á–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
else
    ssh_with_password "(crontab -l 2>/dev/null; echo '$CRON_NIGHTLY_LEARNER') | crontab -" 2>&1 > /dev/null
    echo "‚úÖ –ó–∞–¥–∞—á–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00)"
    echo "   üìö –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–∫—Å–ø–µ—Ä—Ç—ã –±—É–¥—É—Ç –æ–±—É—á–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"
fi
echo ""

# –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo "======================================================================"
echo "‚úÖ –ù–ê–°–¢–†–û–ô–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "======================================================================"
echo ""
echo "üìö –ï–ñ–ï–î–ù–ï–í–ù–û–ï –û–ë–£–ß–ï–ù–ò–ï:"
echo "   - –í—Ä–µ–º—è: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00 UTC"
echo "   - –°–∫—Ä–∏–ø—Ç: nightly_learner.py"
echo "   - –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:"
echo "     ‚úÖ –û–±—É—á–∞–µ—Ç –í–°–ï–• –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤"
echo "     ‚úÖ –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—É—á–∞–ª–∏—Å—å < 24 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥"
echo "     ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã –≤ –∑–Ω–∞–Ω–∏—è—Ö –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞"
echo "     ‚úÖ –ò—Å—Å–ª–µ–¥—É–µ—Ç –Ω–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ —Ç—Ä–µ–Ω–¥—ã"
echo "     ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–Ω–∞–Ω–∏—è –≤ –ë–î"
echo "     ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç –°–æ–≤–µ—Ç –≠–∫—Å–ø–µ—Ä—Ç–æ–≤ –¥–ª—è –≤–∞–∂–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π"
echo "     ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç last_learned_at –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞"
echo ""
echo "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:"
echo "   - –í—Å–µ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –≤ –ë–î: (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
echo "   - –ê–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤: (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
echo "   - –û–±—É—á–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å: –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ (–∫—Ç–æ –Ω–µ –æ–±—É—á–∞–ª—Å—è < 24—á)"
echo ""
echo "üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫:"
echo "   ssh $SERVER"
echo "   cd $SERVER_PATH && python3 app/nightly_learner.py"
echo ""
echo "üìù –õ–æ–≥–∏:"
echo "   - $SERVER_PATH/logs/nightly_learner.log"
echo ""
echo "======================================================================"

