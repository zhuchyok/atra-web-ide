#!/usr/bin/expect -f
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

set timeout 120
set server "185.177.216.15"
set user "root"
set password "u44Ww9NmtQj,XG"

spawn ssh -o StrictHostKeyChecking=no $user@$server

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "yes/no" {
        send "yes\r"
        exp_continue
    }
    "# " {
        send "cd /root/atra\r"
        expect "# "
        
        send "echo '=================================================================================='\r"
        expect "# "
        send "echo 'üîÑ –ü–ï–†–ï–ó–ê–ü–£–°–ö –ë–û–¢–ê –ò –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–´'\r"
        expect "# "
        send "echo '=================================================================================='\r"
        expect "# "
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
        send "echo ''\r"
        expect "# "
        send "echo 'üìã –®–ê–ì 1: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞'\r"
        expect "# "
        send "systemctl stop myproject.service 2>/dev/null || true\r"
        expect "# "
        send "pkill -f 'signal_live.py' 2>/dev/null || true\r"
        expect "# "
        send "pkill -f 'main.py' 2>/dev/null || true\r"
        expect "# "
        send "sleep 3\r"
        expect "# "
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        send "ps aux | grep -E '(signal_live|main\\.py)' | grep -v grep || echo '‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'\r"
        expect "# "
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        send "echo ''\r"
        expect "# "
        send "echo 'üìã –®–ê–ì 2: –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞'\r"
        expect "# "
        send "cd /root/atra && nohup python3 signal_live.py > signal_live.log 2>&1 &\r"
        expect "# "
        send "sleep 5\r"
        expect "# "
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
        send "echo ''\r"
        expect "# "
        send "echo 'üìã –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤'\r"
        expect "# "
        send "ps aux | grep -E '(signal_live|main\\.py)' | grep -v grep || echo '‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω'\r"
        expect "# "
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ (–ø–µ—Ä–≤—ã–µ 30 —Å—Ç—Ä–æ–∫)
        send "echo ''\r"
        expect "# "
        send "echo 'üìã –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫)'\r"
        expect "# "
        send "tail -30 /root/atra/signal_live.log 2>/dev/null | tail -20\r"
        expect "# "
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        send "echo ''\r"
        expect "# "
        send "echo 'üìã –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤'\r"
        expect "# "
        send "python3 << 'PYEOF'\r"
        expect "# "
        send "import sys\r"
        expect "# "
        send "sys.path.insert(0, '/root/atra')\r"
        expect "# "
        send "try:\r"
        expect "# "
        send "    from config import (\r"
        expect "# "
        send "        USE_VP_FILTER, USE_VWAP_FILTER, USE_ORDER_FLOW_FILTER,\r"
        expect "# "
        send "        USE_MICROSTRUCTURE_FILTER, USE_MOMENTUM_FILTER, USE_TREND_STRENGTH_FILTER,\r"
        expect "# "
        send "        USE_AMT_FILTER, USE_MARKET_PROFILE_FILTER, USE_INSTITUTIONAL_PATTERNS_FILTER\r"
        expect "# "
        send "    )\r"
        expect "# "
        send "    print('‚úÖ –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã')\r"
        expect "# "
        send "    print(f'VP Filter: {\"‚úÖ\" if USE_VP_FILTER else \"‚ùå\"}')\r"
        expect "# "
        send "    print(f'VWAP Filter: {\"‚úÖ\" if USE_VWAP_FILTER else \"‚ùå\"}')\r"
        expect "# "
        send "    print(f'Order Flow: {\"‚úÖ\" if USE_ORDER_FLOW_FILTER else \"‚ùå\"}')\r"
        expect "# "
        send "    print(f'Microstructure: {\"‚úÖ\" if USE_MICROSTRUCTURE_FILTER else \"‚ùå\"}')\r"
        expect "# "
        send "    print(f'Momentum: {\"‚úÖ\" if USE_MOMENTUM_FILTER else \"‚ùå\"}')\r"
        expect "# "
        send "    print(f'Trend Strength: {\"‚úÖ\" if USE_TREND_STRENGTH_FILTER else \"‚ùå\"}')\r"
        expect "# "
        send "    print(f'AMT: {\"‚úÖ\" if USE_AMT_FILTER else \"‚ùå\"}')\r"
        expect "# "
        send "    print(f'Market Profile: {\"‚úÖ\" if USE_MARKET_PROFILE_FILTER else \"‚ùå\"}')\r"
        expect "# "
        send "    print(f'Institutional Patterns: {\"‚úÖ\" if USE_INSTITUTIONAL_PATTERNS_FILTER else \"‚ùå\"}')\r"
        expect "# "
        send "except Exception as e:\r"
        expect "# "
        send "    print(f'‚ùå –û—à–∏–±–∫–∞: {e}')\r"
        expect "# "
        send "PYEOF\r"
        expect "# "
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–±–æ—Ä –º–æ–Ω–µ—Ç
        send "echo ''\r"
        expect "# "
        send "echo 'üìã –®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–±–æ—Ä–∞ –º–æ–Ω–µ—Ç'\r"
        expect "# "
        send "python3 << 'PYEOF'\r"
        expect "# "
        send "import sys\r"
        expect "# "
        send "sys.path.insert(0, '/root/atra')\r"
        expect "# "
        send "try:\r"
        expect "# "
        send "    from src.execution.exchange_api import get_filtered_top_usdt_pairs_fast\r"
        expect "# "
        send "    pairs = get_filtered_top_usdt_pairs_fast(limit=10)\r"
        expect "# "
        send "    if pairs:\r"
        expect "# "
        send "        print(f'‚úÖ –ù–∞–π–¥–µ–Ω–æ –º–æ–Ω–µ—Ç: {len(pairs)}')\r"
        expect "# "
        send "        print(f'–¢–æ–ø-10: {pairs[:10]}')\r"
        expect "# "
        send "    else:\r"
        expect "# "
        send "        print('‚ö†Ô∏è  –°–ø–∏—Å–æ–∫ –º–æ–Ω–µ—Ç –ø—É—Å—Ç')\r"
        expect "# "
        send "except Exception as e:\r"
        expect "# "
        send "    print(f'‚ùå –û—à–∏–±–∫–∞: {e}')\r"
        expect "# "
        send "PYEOF\r"
        expect "# "
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        send "echo ''\r"
        expect "# "
        send "echo 'üìã –®–ê–ì 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö'\r"
        expect "# "
        send "python3 << 'PYEOF'\r"
        expect "# "
        send "import sqlite3\r"
        expect "# "
        send "import os\r"
        expect "# "
        send "db_path = '/root/atra/trading.db'\r"
        expect "# "
        send "if os.path.exists(db_path):\r"
        expect "# "
        send "    conn = sqlite3.connect(db_path)\r"
        expect "# "
        send "    cursor = conn.cursor()\r"
        expect "# "
        send "    cursor.execute('SELECT COUNT(*) FROM signals WHERE datetime(ts) > datetime(\\\"now\\\", \\\"-24 hours\\\")')\r"
        expect "# "
        send "    signals_24h = cursor.fetchone()[0]\r"
        expect "# "
        send "    print(f'–°–∏–≥–Ω–∞–ª–æ–≤ –∑–∞ 24—á: {signals_24h}')\r"
        expect "# "
        send "    cursor.execute('SELECT COUNT(*) FROM active_signals WHERE status = \\\"active\\\"')\r"
        expect "# "
        send "    active = cursor.fetchone()[0]\r"
        expect "# "
        send "    print(f'–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤: {active}')\r"
        expect "# "
        send "    cursor.execute('SELECT symbol, side, ts FROM signals ORDER BY ts DESC LIMIT 5')\r"
        expect "# "
        send "    recent = cursor.fetchall()\r"
        expect "# "
        send "    if recent:\r"
        expect "# "
        send "        print('–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–∏–≥–Ω–∞–ª–æ–≤:')\r"
        expect "# "
        send "        for symbol, side, ts in recent:\r"
        expect "# "
        send "            print(f'  - {symbol} {side} ({ts})')\r"
        expect "# "
        send "    conn.close()\r"
        expect "# "
        send "else:\r"
        expect "# "
        send "    print('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')\r"
        expect "# "
        send "PYEOF\r"
        expect "# "
        
        send "echo ''\r"
        expect "# "
        send "echo '=================================================================================='\r"
        expect "# "
        send "echo '‚úÖ –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê'\r"
        expect "# "
        send "echo '=================================================================================='\r"
        expect "# "
        
        send "exit\r"
        expect eof
    }
    timeout {
        puts "Timeout"
        exit 1
    }
}

wait

