#!/bin/bash
# üîí –ë–ï–ó–û–ü–ê–°–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./safe_update.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üîí –ë–ï–ó–û–ü–ê–°–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï ATRA"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
if ! git diff-index --quiet HEAD --; then
    echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
    echo ""
    git status --short
    echo ""
    read -p "üíæ –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è? (y/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üí¨ –í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:"
        read commit_msg
        git add .
        git commit -m "$commit_msg"
        echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã"
    else
        echo "üì¶ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash..."
        git stash push -m "Auto stash: $(date +%Y-%m-%d_%H:%M:%S)"
        STASHED=true
        echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ"
    fi
else
    echo "‚úÖ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —á–∏—Å—Ç–∞"
fi

echo ""

# 2. –°–æ–∑–¥–∞–Ω–∏–µ backup –≤–µ—Ç–∫–∏
BACKUP_BRANCH="backup-$(date +%Y%m%d-%H%M%S)"
echo "üíæ –°–æ–∑–¥–∞–µ–º backup –≤–µ—Ç–∫—É: $BACKUP_BRANCH"
git branch "$BACKUP_BRANCH"
echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω"
echo ""

# 3. –¢—è–Ω–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "‚¨áÔ∏è  –¢—è–Ω–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å GitHub..."
CURRENT_BRANCH=$(git branch --show-current)
if git pull origin "$CURRENT_BRANCH"; then
    echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ pull!"
    echo "üîß –í–æ–∑–º–æ–∂–Ω–æ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã. –í–∞—Ä–∏–∞–Ω—Ç—ã:"
    echo "   1. –†–µ—à–∏—Ç—å –≤—Ä—É—á–Ω—É—é: git status -> –∏—Å–ø—Ä–∞–≤–∏—Ç—å -> git add . -> git commit"
    echo "   2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è: git checkout --ours <—Ñ–∞–π–ª>"
    echo "   3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å remote –∏–∑–º–µ–Ω–µ–Ω–∏—è: git checkout --theirs <—Ñ–∞–π–ª>"
    echo "   4. –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ backup: git reset --hard $BACKUP_BRANCH"
    exit 1
fi

echo ""

# 4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ stash –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ "$STASHED" = true ]; then
    echo "üì¶ –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    if git stash pop; then
        echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    else
        echo "‚ö†Ô∏è  –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ stash!"
        echo "üîß –†–µ—à–∏—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤—Ä—É—á–Ω—É—é –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
        echo "   git add . && git commit -m 'Merged stash'"
        exit 1
    fi
fi

echo ""

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
if [ -f "verify_all_fixes.py" ]; then
    python3 verify_all_fixes.py
    if [ $? -eq 0 ]; then
        echo "‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–µ—Å—Ç–µ!"
    else
        echo "‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!"
        echo "üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –æ—Ç–∫–∞—Ç–∏—Ç–µ—Å—å:"
        echo "   git reset --hard $BACKUP_BRANCH"
        exit 1
    fi
else
    echo "‚ö†Ô∏è  verify_all_fixes.py –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É"
fi

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üéâ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo "üìù Backup –≤–µ—Ç–∫–∞: $BACKUP_BRANCH"
echo "   (–ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é: git branch -D $BACKUP_BRANCH)"
echo ""
echo "üîÑ –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:"
echo "   pkill -9 -f main.py && nohup python3 main.py > main.log 2>&1 &"
echo ""

