#!/usr/bin/expect -f

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/update_restart_check_signals_new.exp

set timeout 300
set server "185.177.216.15"
set user "root"
set password "u44Ww9NmtQj,XG"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
set green "\033\[32m"
set red "\033\[31m"
set yellow "\033\[33m"
set reset "\033\[0m"

spawn ssh ${user}@${server}

expect {
    "password:" {
        send "${password}\r"
    }
    "yes/no" {
        send "yes\r"
        expect "password:"
        send "${password}\r"
    }
    timeout {
        puts "${red}Timeout –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏${reset}"
        exit 1
    }
}

expect "# "
puts "\n${green}‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É${reset}\n"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
send "cd /root/atra\r"
expect "# "

# 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (stash)
puts "\n${yellow}üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (stash)...${reset}\n"
send "git stash\r"
expect {
    "Saved working directory" {
        puts "${green}‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã${reset}\n"
    }
    "No local changes" {
        puts "${green}‚úÖ –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π${reset}\n"
    }
    "# " {
        puts "${green}‚úÖ Stash –≤—ã–ø–æ–ª–Ω–µ–Ω${reset}\n"
    }
    timeout {
        puts "${yellow}‚ö†Ô∏è Timeout –ø—Ä–∏ stash${reset}\n"
    }
}

# 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ git
puts "\n${yellow}üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ git...${reset}\n"
send "git pull origin main\r"
expect {
    "Already up to date" {
        puts "${green}‚úÖ –ö–æ–¥ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω${reset}\n"
    }
    "Updating" {
        puts "${green}‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...${reset}\n"
        expect "# "
        puts "${green}‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω${reset}\n"
    }
    "# " {
        puts "${green}‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω${reset}\n"
    }
    timeout {
        puts "${yellow}‚ö†Ô∏è Timeout –ø—Ä–∏ git pull${reset}\n"
    }
}

# 4. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
puts "${yellow}üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞...${reset}\n"
send "pkill -f 'python3 main.py' || true\r"
expect "# "
send "sleep 2\r"
expect "# "

# –£–¥–∞–ª–µ–Ω–∏–µ lock —Ñ–∞–π–ª–æ–≤
send "rm -f /root/atra/bot.pid /root/atra/*.lock || true\r"
expect "# "

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
puts "${yellow}üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...${reset}\n"
send "cd /root/atra && export ATRA_ENV=prod\r"
expect "# "
send "export TELEGRAM_TOKEN=PROD_TOKEN_REDACTED\r"
expect "# "

# 5. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
puts "${yellow}üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...${reset}\n"
send "cd /root/atra && nohup python3 main.py > /dev/null 2>&1 &\r"
expect "# "

send "sleep 5\r"
expect "# "

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω
puts "${yellow}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞...${reset}\n"
send "ps aux | grep 'python3 main.py' | grep -v grep\r"
expect "# "

# 7. –û–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ü–∏–∫–ª–∞
puts "${yellow}‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ü–∏–∫–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤...${reset}\n"
send "sleep 30\r"
expect "# "

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
puts "\n${yellow}üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤...${reset}\n"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–æ–≥–æ–≤ system.log
send "echo '=== –ü–û–°–õ–ï–î–ù–ò–ï 50 –°–¢–†–û–ö SYSTEM.LOG ===' && tail -50 logs/system.log 2>/dev/null | grep -E '–¶–∏–∫–ª|SIGNAL|NO SIGNAL|FILTER BLOCK|SEND SUCCESS|SEND FAILED' | tail -20 || echo '–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ signals.log
send "echo '' && echo '=== –ü–û–°–õ–ï–î–ù–ò–ï 30 –°–¢–†–û–ö SIGNALS.LOG ===' && tail -30 logs/signals.log 2>/dev/null | tail -15 || echo '–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤
send "echo '' && echo '=== –ë–õ–û–ö–ò–†–û–í–ö–ò –§–ò–õ–¨–¢–†–û–í (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10) ===' && tail -200 logs/system.log 2>/dev/null | grep 'FILTER BLOCK' | tail -10 || echo '–ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
send "echo '' && echo '=== –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ï –°–ò–ì–ù–ê–õ–´ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5) ===' && tail -200 logs/system.log 2>/dev/null | grep -E 'SIGNAL GENERATED|SEND SUCCESS' | tail -5 || echo '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫
send "echo '' && echo '=== –û–®–ò–ë–ö–ò (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5) ===' && tail -100 logs/errors.log 2>/dev/null | tail -5 || echo '–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'\r"
expect "# "

# 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
puts "\n${yellow}üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –Ω–∞ –Ω–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã...${reset}\n"
send "cd /root/atra && python3 -c \"
import sqlite3
from datetime import datetime, timedelta

conn = sqlite3.connect('trading.db')
cursor = conn.cursor()

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–∏–≥–Ω–∞–ª–æ–≤
cursor.execute('SELECT symbol, direction, entry_price, signal_time FROM accepted_signals ORDER BY signal_time DESC LIMIT 5')
recent = cursor.fetchall()

print('=== –ü–û–°–õ–ï–î–ù–ò–ï 5 –°–ò–ì–ù–ê–õ–û–í –í –ë–î ===')
if recent:
    for sig in recent:
        print(f'{sig[3]} | {sig[0]} | {sig[1]} | {sig[2]}')
else:
    print('–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ –ë–î')

# –°–∏–≥–Ω–∞–ª—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
cursor.execute('SELECT COUNT(*) FROM accepted_signals WHERE datetime(signal_time) > datetime(\\\"now\\\", \\\"-1 hour\\\")')
last_hour = cursor.fetchone()[0]

print(f'\\n=== –°–ò–ì–ù–ê–õ–´ –ó–ê –ü–û–°–õ–ï–î–ù–ò–ô –ß–ê–° ===')
print(f'–í—Å–µ–≥–æ: {last_hour}')

# –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª
cursor.execute('SELECT MAX(signal_time) FROM accepted_signals')
last_time = cursor.fetchone()[0]
print(f'\\n–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª: {last_time}')

conn.close()
\"\r"
expect "# "

# 10. –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞
puts "\n${yellow}üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã...${reset}\n"
send "ps aux | grep 'python3 main.py' | grep -v grep | wc -l\r"
expect "# "

send "echo '–ü—Ä–æ—Ü–µ—Å—Å–æ–≤ main.py –∑–∞–ø—É—â–µ–Ω–æ:' && cat\r"
expect "# "

# –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞
puts "\n${green}‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${reset}\n"
puts "${yellow}üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${reset}"
puts "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ 'SIGNAL GENERATED' –∏–ª–∏ 'FILTER BLOCK'"
puts "2. –ï—Å–ª–∏ –µ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∏—á–∏–Ω—ã –≤ –ª–æ–≥–∞—Ö"
puts "3. –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä—ã–Ω–æ—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è"

send "exit\r"
expect eof

puts "\n${green}‚úÖ –ì–æ—Ç–æ–≤–æ!${reset}\n"

