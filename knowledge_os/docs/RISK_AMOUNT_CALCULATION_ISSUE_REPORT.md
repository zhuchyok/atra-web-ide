# ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê –° –†–ê–°–ß–ï–¢–û–ú "–ó–ê–ù–Ø–¢–û –†–ò–°–ö–ê–ú–ò" - –û–¢–ß–ï–¢

## üéØ **–ü–†–û–ë–õ–ï–ú–ê:**

–í –∫–æ–º–∞–Ω–¥–µ `/myreport` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–ó–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏: 0.00 USDT", —Ö–æ—Ç—è —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

---

## üîç **–ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´:**

### **‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `recalculate_balance_and_risks`:**

```python
def recalculate_balance_and_risks(user_data):
    # ...
    for pos in open_positions:
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º risk_amount –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
        pos_qty = pos.get("qty", 0)
        pos_entry_price = pos.get("entry_price", 0)
        pos_risk_pct = pos.get("risk_pct", 2.0)
        pos_leverage = pos.get("leverage", 1)

        # –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏
        position_value = pos_qty * pos_entry_price

        # Risk amount —Å —É—á–µ—Ç–æ–º –ø–ª–µ—á–∞
        if pos_leverage > 1:
            risk_amount = position_value / pos_leverage * pos_risk_pct / 100
        else:
            risk_amount = position_value * pos_risk_pct / 100

        pos["risk_amount"] = risk_amount  # ‚Üê –ü–†–û–ë–õ–ï–ú–ê: –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
        total_risk_amount += risk_amount
```

### **‚ùå –ü—Ä–æ–±–ª–µ–º—ã:**

1. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ `risk_amount`** –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø–æ–∑–∏—Ü–∏–∏
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞** - —Ä–∏—Å–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏
3. **–ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫** - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç–µ, –∞ –Ω–µ –Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏

---

## üìä **–°–¢–†–£–ö–¢–£–†–ê –ü–û–ó–ò–¶–ò–ò:**

### **‚úÖ –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
{
    "symbol": symbol,
    "entry_prices": [entry_price],
    "qtys": [qty_new],
    "qty": qty_new,
    "entry_price": entry_price,
    "tp1": tp1,
    "tp2": tp2,
    "n_dca": 0,
    "leverage": leverage if trade_mode == "futures" else None,
    "stage": "open",
    "side": side,
    "risk_pct": risk_pct,
    # –ù–ï–¢ –ø–æ–ª—è "risk_amount"!
}
```

---

## ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê:**

### **üéØ –ß—Ç–æ —Ç–∞–∫–æ–µ "–ó–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏":**

**"–ó–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏"** = —Å—É–º–º–∞ –≤—Å–µ—Ö —Ä–∏—Å–∫–æ–≤ –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –ø–æ–∑–∏—Ü–∏—è–º

### **üìà –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç:**

```python
# –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏:
risk_amount = deposit * risk_pct / 100

# –û–±—â–∏–π —Ä–∏—Å–∫:
total_risk_amount = sum(risk_amount for all positions)
```

### **üí° –ü—Ä–∏–º–µ—Ä:**
- **–î–µ–ø–æ–∑–∏—Ç:** 200 USDT
- **–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É:** 2%
- **–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π:** 2
- **–ó–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏:** 200 √ó 2% √ó 2 = 8 USDT

---

## üîß **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:**

### **üìù –ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `recalculate_balance_and_risks`:**

```python
def recalculate_balance_and_risks(user_data):
    try:
        deposit = user_data.get("deposit", 0)
        open_positions = user_data.get("open_positions", [])

        # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∏—Å–∫–∞
        total_risk_amount = 0
        for pos in open_positions:
            risk_pct = pos.get("risk_pct", 2.0)
            # –†–∏—Å–∫ = –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞
            risk_amount = deposit * risk_pct / 100
            total_risk_amount += risk_amount

        # –°–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
        free_deposit = max(deposit - total_risk_amount, 0)

        return {
            "updated_deposit": deposit,
            "total_risk_amount": total_risk_amount,
            "free_deposit": free_deposit,
            "total_profit": 0,  # –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
            "open_positions_count": len(open_positions)
        }
    except Exception as e:
        print(f"[recalculate_balance_and_risks] –û—à–∏–±–∫–∞: {e}")
        return None
```

---

## üìä **–ü–†–ò–ú–ï–† –†–ê–°–ß–ï–¢–ê:**

### **üîç –í–∞—à —Å–ª—É—á–∞–π:**
- **–î–µ–ø–æ–∑–∏—Ç:** 200 USDT
- **–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π:** 0
- **–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É:** 2%

### **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üíµ –î–µ–ø–æ–∑–∏—Ç: 200.00 USDT
‚ö†Ô∏è –ó–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏: 0.00 USDT  ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û!
üÜì –°–≤–æ–±–æ–¥–Ω–æ: 200.00 USDT
```

### **‚úÖ –ï—Å–ª–∏ –±—ã –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏:**
```
üíµ –î–µ–ø–æ–∑–∏—Ç: 200.00 USDT
‚ö†Ô∏è –ó–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏: 8.00 USDT  ‚Üê 2 –ø–æ–∑–∏—Ü–∏–∏ √ó 2% √ó 200
üÜì –°–≤–æ–±–æ–¥–Ω–æ: 192.00 USDT
```

---

## üöÄ **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**

### **üìã –î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ –≤ `recalculate_balance_and_risks`
2. –£–±—Ä–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è `risk_amount` –≤ –ø–æ–∑–∏—Ü–∏—é
3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ä–∏—Å–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ–ø–æ–∑–∏—Ç–∞, –∞ –Ω–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏

### **üìã –î–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è:**
- "–ó–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏" = —Å—É–º–º–∞ –≤—Å–µ—Ö —Ä–∏—Å–∫–æ–≤ –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –ø–æ–∑–∏—Ü–∏—è–º
- –†–∏—Å–∫ = –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ (–Ω–µ –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏)
- –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π ‚Üí –∑–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏ = 0

---

## üéØ **–ò–¢–û–ì:**

**–í –≤–∞—à–µ–º —Å–ª—É—á–∞–µ "–ó–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏: 0.00 USDT" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —É –≤–∞—Å –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π. –ù–æ –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –≤ –∫–æ–¥–µ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏.** ‚úÖ