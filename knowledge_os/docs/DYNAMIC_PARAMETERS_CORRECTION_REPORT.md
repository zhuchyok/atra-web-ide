# üîÑ –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´ - –ö–û–†–†–ï–ö–¢–ù–ê–Ø –†–ê–ë–û–¢–ê

## üéØ **–ö–ê–ö –†–ê–ë–û–¢–ê–Æ–¢ –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:**

### **üìä –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ (`get_dynamic_risk_pct`):**
```python
def get_dynamic_risk_pct(df, i):
    """
    –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Ä–∏—Å–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥–∞
    """
    if i < 21:
        return 2.0  # —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Ä–∏—Å–∫, –µ—Å–ª–∏ –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö

    try:
        closes = df["close"].iloc[i - 20 : i]
        volatility = closes.std() / closes.mean()
        trend = (sma20_now - sma20_prev) / sma20_prev if sma20_prev != 0 else 0
        base_risk = 2.0
        dynamic_risk = base_risk * (1 + 2 * trend) / (1 + 5 * volatility)
        dynamic_risk = max(1.0, min(dynamic_risk, 5.0))  # –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ—Ç 1% –¥–æ 5%
        return dynamic_risk
    except Exception as e:
        return 2.0  # –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

### **üìà –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ (`get_dynamic_leverage`):**
```python
def get_dynamic_leverage(df, i, base_leverage=1):
    """
    –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ø–ª–µ—á–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥–∞
    """
    if i < 21:
        return base_leverage  # –±–∞–∑–æ–≤–æ–µ –ø–ª–µ—á–æ, –µ—Å–ª–∏ –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö

    try:
        closes = df["close"].iloc[i - 20 : i]
        volatility = closes.std() / closes.mean()
        trend = (sma20_now - sma20_prev) / sma20_prev if sma20_prev != 0 else 0

        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ–Ω–¥–∞ –∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
        trend_factor = 1 + abs(trend) * 2  # –¥–æ 3x –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º —Ç—Ä–µ–Ω–¥–µ
        volatility_factor = 1 / (1 + volatility * 3)  # —É–º–µ–Ω—å—à–∞–µ–º –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏

        dynamic_leverage = base_leverage * trend_factor * volatility_factor
        dynamic_leverage = max(1, min(dynamic_leverage, 20))  # –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ—Ç 1 –¥–æ 20

        return round(dynamic_leverage, 1)
    except Exception as e:
        return base_leverage  # –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

---

## ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´:**

### **üìä –í –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤:**
```python
# –í signal_live.py —Å—Ç—Ä–æ–∫–∞ 2328
risk_pct = get_dynamic_risk_pct(df, current_index)

# –í signal_live.py —Å—Ç—Ä–æ–∫–∞ 2358
base_leverage = user_data.get('leverage', 1) if user_data.get('trade_mode', 'spot') == 'futures' else 1
leverage = get_dynamic_leverage(df, current_index, base_leverage)
```

### **üìä –í –ø—Ä–∏–Ω—è—Ç–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤:**
```python
# –í telegram_bot.py —Å—Ç—Ä–æ–∫–∞ 3940
risk_pct = float(args[5]) if len(args) > 5 else user_data.get("risk_pct", 2.0)
leverage = user_data.get("leverage", 1) if trade_mode == "futures" else 1
```

---

## ‚ùå **–ü–†–û–ë–õ–ï–ú–ê –í –ú–û–ï–ú –ü–†–ï–î–´–î–£–©–ï–ú –û–¢–ß–ï–¢–ï:**

### **üö® –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
–Ø —Å–∫–∞–∑–∞–ª, —á—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `risk_pct` –∏ `leverage` –≤ `user_data.json` –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤.

### **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å:**
**–≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ù–ï –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤, –ø–æ—Ç–æ–º—É —á—Ç–æ:**

1. **`risk_pct`** - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ—É–Ω–∫—Ü–∏–µ–π `get_dynamic_risk_pct()`
2. **`leverage`** - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ—É–Ω–∫—Ü–∏–µ–π `get_dynamic_leverage()`
3. **–ó–Ω–∞—á–µ–Ω–∏—è –∏–∑ `user_data.json`** –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

---

## üîß **–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –°–ò–°–¢–ï–ú–ê:**

### **üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤:**
```python
# 1. –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ user_data (–µ—Å–ª–∏ –µ—Å—Ç—å)
base_risk = user_data.get('risk_pct', 2.0)  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 2%
base_leverage = user_data.get('leverage', 1)  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1x

# 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
risk_pct = get_dynamic_risk_pct(df, current_index)  # 1.5% - 5%
leverage = get_dynamic_leverage(df, current_index, base_leverage)  # 1x - 20x

# 3. –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
base_qty = deposit * risk_pct / 100 * leverage / price
```

### **üìä –ü—Ä–∏–Ω—è—Ç–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤:**
```python
# 1. –ü–æ–ª—É—á–∞–µ–º —Ä–∏—Å–∫ –∏–∑ –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ user_data
risk_pct = float(args[5]) if len(args) > 5 else user_data.get("risk_pct", 2.0)

# 2. –ü–æ–ª—É—á–∞–µ–º –ø–ª–µ—á–æ –∏–∑ user_data
leverage = user_data.get("leverage", 1) if trade_mode == "futures" else 1

# 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
new_qty, avg_price_new, tp1, tp2, limit_reached = dca_calculate_next_qty_and_tp(
    entry_prices, qtys, entry_price, dca_count, deposit, risk_pct, leverage, side
)
```

---

## üéØ **–ß–¢–û –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–û –ö–†–ò–¢–ò–ß–ù–û:**

### **‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```json
{
  "deposit": 1000.0,           // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û - –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
  "trade_mode": "spot",        // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û - –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ SHORT —Å–∏–≥–Ω–∞–ª–æ–≤
  "filter_mode": "balanced",   // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û - –¥–ª—è –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  "news_filter_mode": "conservative" // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û - –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π
}
```

### **‚ö†Ô∏è –ù–ï –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```json
{
  "risk_pct": 2.0,            // ‚ö†Ô∏è –ù–ï –∫—Ä–∏—Ç–∏—á–Ω–æ - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
  "leverage": 1,               // ‚ö†Ô∏è –ù–ï –∫—Ä–∏—Ç–∏—á–Ω–æ - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
  "open_positions": [],        // ‚ö†Ô∏è –ù–ï –∫—Ä–∏—Ç–∏—á–Ω–æ - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—É—Å—Ç—ã–º
  "accepted_signals": [],      // ‚ö†Ô∏è –ù–ï –∫—Ä–∏—Ç–∏—á–Ω–æ - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—É—Å—Ç—ã–º
  "total_risk_amount": 0,      // ‚ö†Ô∏è –ù–ï –∫—Ä–∏—Ç–∏—á–Ω–æ - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  "free_deposit": 1000.0,      // ‚ö†Ô∏è –ù–ï –∫—Ä–∏—Ç–∏—á–Ω–æ - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  "total_profit": 0            // ‚ö†Ô∏è –ù–ï –∫—Ä–∏—Ç–∏—á–Ω–æ - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
}
```

---

## üîß **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –õ–û–ì–ò–ö–ò:**

### **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö:**
```python
def ensure_user_data_completeness(user_data):
    """–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω–æ—Ç—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    critical_defaults = {
        'deposit': 1000.0,           # –ö–†–ò–¢–ò–ß–ù–û
        'trade_mode': 'spot',        # –ö–†–ò–¢–ò–ß–ù–û
        'filter_mode': 'balanced',   # –ö–†–ò–¢–ò–ß–ù–û
        'news_filter_mode': 'conservative'  # –ö–†–ò–¢–ò–ß–ù–û
    }

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    for key, default_value in critical_defaults.items():
        if key not in user_data:
            user_data[key] = default_value
            print(f"–î–æ–±–∞–≤–ª–µ–Ω –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä {key} = {default_value}")

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    if 'open_positions' not in user_data:
        user_data['open_positions'] = []
    if 'accepted_signals' not in user_data:
        user_data['accepted_signals'] = []

    return user_data
```

---

## üìä **–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ú–ï–†–´:**

### **–ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ `risk_pct` –∏ `leverage`**
```json
// user_data.json
"958930260": {
  "deposit": 200.0,
  "trade_mode": "futures",
  "filter_mode": "soft",
  "news_filter_mode": "aggressive"
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–∞
risk_pct = get_dynamic_risk_pct(df, current_index)  // –ù–∞–ø—Ä–∏–º–µ—Ä: 2.3%
leverage = get_dynamic_leverage(df, current_index, 1)  // –ù–∞–ø—Ä–∏–º–µ—Ä: 1.5x
// ‚úÖ –°–∏–≥–Ω–∞–ª –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
```

### **–ü—Ä–∏–º–µ—Ä 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å `risk_pct` –∏ `leverage`**
```json
// user_data.json
"556251171": {
  "deposit": 10200.0,
  "trade_mode": "spot",
  "filter_mode": "soft",
  "risk_pct": 2.0,
  "leverage": 1,
  "news_filter_mode": "aggressive"
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–∞
risk_pct = get_dynamic_risk_pct(df, current_index)  // –ù–∞–ø—Ä–∏–º–µ—Ä: 1.8%
leverage = get_dynamic_leverage(df, current_index, 1)  // –ù–∞–ø—Ä–∏–º–µ—Ä: 1.0x
// ‚úÖ –°–∏–≥–Ω–∞–ª –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
```

---

## üéØ **–ò–¢–û–ì:**

### **üîë –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
1. **`risk_pct` –∏ `leverage`** —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏ –ù–ï –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
2. **–ö—Ä–∏—Ç–∏—á–Ω—ã —Ç–æ–ª—å–∫–æ:** `deposit`, `trade_mode`, `filter_mode`, `news_filter_mode`
3. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** –∞–¥–∞–ø—Ç–∏—Ä—É—é—Ç—Å—è –∫ —Ä—ã–Ω–æ—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. **–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –¥–∞–∂–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### **üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 556251171** - –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–Ω—ã–µ
- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 958930260** - –¥–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏ –ø–æ–ª–Ω—ã–µ
- ‚úÖ **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### **üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:**
**–°–∏—Å—Ç–µ–º–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Ä—ã–Ω–æ—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º!** üöÄ