# ‚úÖ –û–¢–ß–ï–¢: –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –ö–û–ù–¢–†–ê–ö–¢–û–í –í –ö–†–ò–¢–ò–ß–ù–´–ï –§–£–ù–ö–¶–ò–ò

## üéØ –°—Ç–∞—Ç—É—Å: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞

**–î–∞—Ç–∞:** 2025-01-XX  
**–í–µ—Ä—Å–∏—è:** 2.1

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**1. `get_dynamic_tp_levels()` –≤ `src/signals/risk.py`:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@precondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@postcondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@profile` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: df –Ω–µ –ø—É—Å—Ç–æ–π, i >= 0, side –≤ ("long", "short")
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: TP1 –≤ [0.5, 10.0]%, TP2 –≤ [1.0, 15.0]%, TP2 > TP1

**2. `calculate_position_size()` –≤ `src/signals/risk.py`:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@precondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@postcondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@profile` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: deposit > 0, risk_pct –≤ [0.1, 10.0]%, —Ü–µ–Ω—ã > 0, leverage –≤ [1.0, 20.0]x
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ >= 0

**3. `RiskCalculator.calculate_position_size()` –≤ `src/domain/services/risk_calculator.py`:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@precondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@postcondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@profile` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: account_balance > 0, risk_percentage –≤ [0.1, 10.0]%, —Ü–µ–Ω—ã > 0
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ >= 0 –∏ —Ä–∞–∑—É–º–Ω—ã–π

**4. `RiskCalculator.calculate_portfolio_risk()` –≤ `src/domain/services/risk_calculator.py`:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@precondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@postcondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: positions –Ω–µ None
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: —Ä–∏—Å–∫ –≤ [0%, 100%]

**5. `PositionSizeValidator.validate_order_size()` –≤ `src/execution/position_validator.py`:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@precondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@postcondition` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ —Å—É–º–º—ã >= 0
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: –≤–∞–ª–∏–¥–Ω—ã–π dict —Å 'allowed', 'adjusted_amount', 'reason'

---

### ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Self-Validation

**1. `TradeSignal.__init__()` –≤ `src/types.py`:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
- ‚úÖ Fail-soft –ø–æ–¥—Ö–æ–¥: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö 12 –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è TradeSignal

---

### ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Performance Profiling

**–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –∫—Ä–∏—Ç–∏—á–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º:**
- ‚úÖ `get_dynamic_tp_levels()` - –ø–æ—Ä–æ–≥ 10ms
- ‚úÖ `calculate_position_size()` - –ø–æ—Ä–æ–≥ 5ms
- ‚úÖ `RiskCalculator.calculate_position_size()` - –ø–æ—Ä–æ–≥ 5ms

**–ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- Latency –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É–∑–∫–∏—Ö –º–µ—Å—Ç
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º —á–µ—Ä–µ–∑ `get_profiler().get_latency_stats()`

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –§—É–Ω–∫—Ü–∏–∏ —Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏:
- ‚úÖ 5 —Ñ—É–Ω–∫—Ü–∏–π –∑–∞—â–∏—â–µ–Ω—ã –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏
- ‚úÖ 10 preconditions –¥–æ–±–∞–≤–ª–µ–Ω–æ
- ‚úÖ 10 postconditions –¥–æ–±–∞–≤–ª–µ–Ω–æ

### –§—É–Ω–∫—Ü–∏–∏ —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
- ‚úÖ 3 —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –û–±—ä–µ–∫—Ç—ã —Å self-validation:
- ‚úÖ 1 –∫–ª–∞—Å—Å (TradeSignal) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

---

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –≤ –¥–µ–π—Å—Ç–≤–∏–∏:

```python
from src.signals.risk import get_dynamic_tp_levels

# ‚úÖ –í–∞–ª–∏–¥–Ω—ã–π –≤—ã–∑–æ–≤
tp1, tp2 = get_dynamic_tp_levels(df, 100, "long", "spot", True)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: (2.5, 5.0) - –≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

# ‚ùå –ù–∞—Ä—É—à–µ–Ω–∏–µ precondition
try:
    tp1, tp2 = get_dynamic_tp_levels(None, -1, "invalid", "spot", True)
except ContractViolationError as e:
    print(f"–û—à–∏–±–∫–∞: {e.violation.message}")
    # "Invalid input: df must be non-empty DataFrame..."

# ‚ùå –ù–∞—Ä—É—à–µ–Ω–∏–µ postcondition (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—ë—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ
```

### Self-Validation –≤ –¥–µ–π—Å—Ç–≤–∏–∏:

```python
from src.types import TradeSignal

# ‚úÖ –í–∞–ª–∏–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª
signal = TradeSignal(
    symbol="BTCUSDT",
    signal_type="LONG",
    entry_price=50000.0,
    stop_loss_price=49000.0,
    take_profit_1=51000.0,
    take_profit_2=52000.0,
    risk_pct=2.0,
    leverage=2.0,
    recommended_qty_coins=0.1,
    recommended_qty_usdt=5000.0,
    risk_amount_usdt=100.0
)
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤—Å–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã
# –ù–∞—Ä—É—à–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç —Å–æ–∑–¥–∞–Ω–∏–µ

# ‚ùå –°–∏–≥–Ω–∞–ª —Å –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞
signal = TradeSignal(
    symbol="BTCUSDT",
    signal_type="LONG",
    entry_price=50000.0,
    stop_loss_price=51000.0,  # SL –≤—ã—à–µ entry –¥–ª—è LONG - –Ω–∞—Ä—É—à–µ–Ω–∏–µ!
    # ...
)
# –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: "TradeSignal invariant violated: For LONG signals, stop loss must be below entry price"
```

### –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –¥–µ–π—Å—Ç–≤–∏–∏:

```python
from src.core.profiling import get_profiler

# –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä—É—é—Ç—Å—è
tp1, tp2 = get_dynamic_tp_levels(df, 100, "long")

# –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
profiler = get_profiler()
stats = profiler.get_latency_stats("get_dynamic_tp_levels")
print(f"–°—Ä–µ–¥–Ω—è—è latency: {stats['avg_ms']:.2f}ms")
print(f"P95 latency: {stats['p95_ms']:.2f}ms")

# –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ–º —É–∑–∫–∏–µ –º–µ—Å—Ç–∞
bottlenecks = profiler.detect_bottlenecks(threshold_ms=10.0)
for bottleneck in bottlenecks:
    print(f"–£–∑–∫–æ–µ –º–µ—Å—Ç–æ: {bottleneck.function_name} - {bottleneck.duration_ms:.2f}ms")
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

- [x] –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ –∫—Ä–∏—Ç–∏—á–Ω—ã–º —Ç–æ—Ä–≥–æ–≤—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º
- [x] Self-validation –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ TradeSignal
- [x] –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∫ –∫—Ä–∏—Ç–∏—á–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º
- [x] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [x] –õ–∏–Ω—Ç–µ—Ä –æ—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

---

## üìö –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –∫ `_generate_signal_impl()`:**
   - Precondition: –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (symbol, df, user_data)
   - Postcondition: –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (signal_type, signal_price)

2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ CI/CD:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ anti-pattern detector
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

3. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ self-validation:**
   - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ Position.__init__()
   - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ Order.__init__()

---

**–ê–≤—Ç–æ—Ä:** –ö–æ–º–∞–Ω–¥–∞ ATRA  
**–î–∞—Ç–∞:** 2025-01-XX  
**–í–µ—Ä—Å–∏—è:** 2.1

