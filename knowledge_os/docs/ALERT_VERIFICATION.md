# ‚úÖ –ü–†–û–í–ï–†–ö–ê: –≠—Ç–æ —Ç–æ—á–Ω–æ –∞–ª–µ—Ä—Ç –æ –∑–∞–∫—Ä—ã—Ç–∏–∏, –Ω–µ –æ–± –æ—Ç–∫—Ä—ã—Ç–∏–∏

## üîç –ê–ù–ê–õ–ò–ó –ö–û–î–ê

### 1. –§—É–Ω–∫—Ü–∏—è –∞–ª–µ—Ä—Ç–∞

**–§–∞–π–ª:** `alert_notifications.py` (—Å—Ç—Ä–æ–∫–∏ 55-58)
```python
async def alert_position_closed_by_exchange(self, user_id: int, symbol: str):
    """–ê–ª–µ—Ä—Ç –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ."""
    msg = f"‚úÖ <b>–ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞</b>\n‚îú –°–∏–º–≤–æ–ª: {symbol}\n‚îî –ó–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ (–∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)"
    await self.send_alert(user_id, 'position_closed', msg)
```

**–í—ã–≤–æ–¥:** –§—É–Ω–∫—Ü–∏—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `alert_position_closed_by_exchange` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞".

---

### 2. –ì–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è

**–§–∞–π–ª:** `main.py` (—Å—Ç—Ä–æ–∫–∞ 1275)

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
```python
# –°—Ç—Ä–æ–∫–∞ 1240: –ó–∞–∫—Ä—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Ç–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª–µ–µ –Ω–µ —á–∏—Å–ª—è—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –Ω–∞ –±–∏—Ä–∂–µ
try:
    local_open = set(await adb_local.get_user_active_symbols(uid))
    to_close = local_open - open_symbols_remote  # –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –Ω–∞ –±–∏—Ä–∂–µ
    
    for sym in to_close:
        # –î–ª—è auto —Ä–µ–∂–∏–º–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ –±–∏—Ä–∂–µ
        await adb_local.close_active_position_by_symbol(uid, sym)  # ‚Üê –ó–ê–ö–†–´–¢–ò–ï
        # ...
        # –ê–ª–µ—Ä—Ç –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
        await alert_svc.alert_position_closed_by_exchange(uid, sym)  # ‚Üê –ê–õ–ï–†–¢
```

**–í—ã–≤–æ–¥:** –ê–ª–µ—Ä—Ç –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–ü–û–°–õ–ï** –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (`close_active_position_by_symbol`).

---

### 3. –ì–¥–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ–∑–∏—Ü–∏–∏

**–§–∞–π–ª:** `main.py` (—Å—Ç—Ä–æ–∫–∏ 470-490)

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
```python
# –°—Ç—Ä–æ–∫–∞ 470: –°–æ–±–∏—Ä–∞–µ–º –Ω–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±–∏—Ä–∂–∞ —Å—á–∏—Ç–∞–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã–º–∏
open_symbols_remote = set()
for p in (positions or []):
    symbol = p.get('symbol')
    contracts = float(p.get('contracts') or 0)
    
    if contracts and abs(contracts) > 0:
        # ...
        await adb_local.upsert_active_position(  # ‚Üê –û–¢–ö–†–´–¢–ò–ï/–û–ë–ù–û–í–õ–ï–ù–ò–ï
            uid, symbol, direction, entry_price, 'open'
        )
        open_symbols_remote.add(symbol)
        # –ù–ï–¢ –í–´–ó–û–í–ê –ê–õ–ï–†–¢–ê!
```

**–í—ã–≤–æ–¥:** –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ (`upsert_active_position`) **–ù–ï–¢** –≤—ã–∑–æ–≤–∞ –∞–ª–µ—Ä—Ç–∞.

---

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç

**–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É:**
- ‚ùå –ù–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ `alert_position_opened_by_exchange`
- ‚ùå –ù–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ `alert_position_created`
- ‚ùå –ù–µ—Ç –≤—ã–∑–æ–≤–æ–≤ –∞–ª–µ—Ä—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π

**–í—ã–≤–æ–¥:** –ê–ª–µ—Ä—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–¢–û–õ–¨–ö–û** –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏.

---

## üìä –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ

1. **–õ–æ–∫–∞–ª—å–Ω–æ:** `ETHFIUSDT` –æ—Ç–∫—Ä—ã—Ç–∞
2. **–ù–∞ –±–∏—Ä–∂–µ:** –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ (–≤—Ä—É—á–Ω—É—é, –ø–æ SL/TP)
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**
   - `local_open = {'ETHFIUSDT'}`
   - `open_symbols_remote = {}` (–ø—É—Å—Ç–æ, –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ—Ç –Ω–∞ –±–∏—Ä–∂–µ)
   - `to_close = {'ETHFIUSDT'}`
4. **–î–µ–π—Å—Ç–≤–∏–µ:** 
   - `close_active_position_by_symbol(uid, 'ETHFIUSDT')` ‚Üê –ó–ê–ö–†–´–¢–ò–ï
   - `alert_position_closed_by_exchange(uid, 'ETHFIUSDT')` ‚Üê –ê–õ–ï–†–¢
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ê–ª–µ—Ä—Ç "–ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞"

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ

1. **–õ–æ–∫–∞–ª—å–Ω–æ:** –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ—Ç
2. **–ù–∞ –±–∏—Ä–∂–µ:** `ETHFIUSDT` –æ—Ç–∫—Ä—ã—Ç–∞
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**
   - `local_open = {}` (–ø—É—Å—Ç–æ)
   - `open_symbols_remote = {'ETHFIUSDT'}`
   - `to_close = {}` (–ø—É—Å—Ç–æ, –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è)
4. **–î–µ–π—Å—Ç–≤–∏–µ:**
   - `upsert_active_position(uid, 'ETHFIUSDT', ...)` ‚Üê –û–¢–ö–†–´–¢–ò–ï
   - **–ù–ï–¢ –í–´–ó–û–í–ê –ê–õ–ï–†–¢–ê**
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚ùå –ê–ª–µ—Ä—Ç –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

---

## ‚úÖ –í–´–í–û–î

**–≠—Ç–æ —Ç–æ—á–Ω–æ –∞–ª–µ—Ä—Ç –æ –∑–∞–∫—Ä—ã—Ç–∏–∏, –Ω–µ –æ–± –æ—Ç–∫—Ä—ã—Ç–∏–∏:**

1. ‚úÖ –§—É–Ω–∫—Ü–∏—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `alert_position_closed_by_exchange`
2. ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è **–ü–û–°–õ–ï** `close_active_position_by_symbol`
3. ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è **–¢–û–õ–¨–ö–û** –∫–æ–≥–¥–∞ –ø–æ–∑–∏—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ –±–∏—Ä–∂–µ (–∑–∞–∫—Ä—ã—Ç–∞)
4. ‚úÖ –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ (`upsert_active_position`) –∞–ª–µ—Ä—Ç **–ù–ï** –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
5. ‚úÖ –í –∫–æ–¥–µ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∞–ª–µ—Ä—Ç–∞ –æ–± –æ—Ç–∫—Ä—ã—Ç–∏–∏

---

## üîç –í–û–ó–ú–û–ñ–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞ —Å–∏–º–≤–æ–ª–∞:**
- `ETHFIUSDT`
- `ETHFI/USDT:USDT`

–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π —Å–∏–º–≤–æ–ª–∞, –Ω–æ **—ç—Ç–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –∞–ª–µ—Ä—Ç –æ –∑–∞–∫—Ä—ã—Ç–∏–∏**, –ø—Ä–æ—Å—Ç–æ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ —Å–∏–º–≤–æ–ª–∞.

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —ç—Ç–æ—Ç –∞–ª–µ—Ä—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏, —ç—Ç–æ –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å:

1. **–ü–æ–∑–∏—Ü–∏—è –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞, –Ω–æ –±—ã—Å—Ç—Ä–æ –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ** (SL/TP —Å—Ä–∞–±–æ—Ç–∞–ª)
2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π** (—Å–∏—Å—Ç–µ–º–∞ –Ω–µ –≤–∏–¥–∏—Ç –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –±–∏—Ä–∂–µ —Å—Ä–∞–∑—É)
3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç–æ–º —Å–∏–º–≤–æ–ª–∞** (—Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: `ETHFIUSDT` vs `ETHFI/USDT:USDT`)

**–ù–æ —ç—Ç–æ —Ç–æ—á–Ω–æ –∞–ª–µ—Ä—Ç –æ –∑–∞–∫—Ä—ã—Ç–∏–∏, –Ω–µ –æ–± –æ—Ç–∫—Ä—ã—Ç–∏–∏!**

