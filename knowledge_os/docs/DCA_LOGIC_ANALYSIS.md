# üìä –õ–û–ì–ò–ö–ê –§–û–†–ú–ò–†–û–í–ê–ù–ò–Ø DCA –°–ò–ì–ù–ê–õ–û–í

## üîÑ **–û–ë–©–ò–ô –ü–†–ò–ù–¶–ò–ü DCA (Dollar-Cost Averaging)**

DCA (—É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ) - —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∫—É–ø–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü –∞–∫—Ç–∏–≤–∞ –ø–æ –±–æ–ª–µ–µ –Ω–∏–∑–∫–æ–π —Ü–µ–Ω–µ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ –≤ –ø–æ–∑–∏—Ü–∏—é.

---

## üßÆ **–û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ê–°–ß–ï–¢–ê DCA**

### **–§—É–Ω–∫—Ü–∏—è:** `dca_calculate_next_qty_and_tp()`

```python
def dca_calculate_next_qty_and_tp(
    entry_prices, qtys, price, dca_count, deposit, risk_pct,
    leverage=1, side="long", df=None, current_index=None,
    anomaly_circles_count=0
):
```

### **–í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `entry_prices` - —Å–ø–∏—Å–æ–∫ —Ü–µ–Ω –≤—Ö–æ–¥–∞ –≤ –ø–æ–∑–∏—Ü–∏—é
- `qtys` - —Å–ø–∏—Å–æ–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤ –ø–æ –∫–∞–∂–¥–æ–π —Ü–µ–Ω–µ
- `price` - —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
- `dca_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö DCA
- `deposit` - –¥–µ–ø–æ–∑–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `risk_pct` - –ø—Ä–æ—Ü–µ–Ω—Ç —Ä–∏—Å–∫–∞ –Ω–∞ —Å–¥–µ–ª–∫—É
- `leverage` - –ø–ª–µ—á–æ
- `side` - —Å—Ç–æ—Ä–æ–Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ (long/short)
- `df` - DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö TP
- `current_index` - —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –≤ –¥–∞–Ω–Ω—ã—Ö
- `anomaly_circles_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –∫—Ä—É–≥–æ–≤

---

## üìà **–õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê –ö–û–õ–ò–ß–ï–°–¢–í–ê DCA**

### **1. –ë–∞–∑–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:**
```python
base_qty = deposit * risk_pct / 100 * leverage / price
```

### **2. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–æ–º–∞–ª–∏–∏:**
```python
if anomaly_circles_count > 0:
    adjusted_volume, volume_multiplier, recommendation = calculate_anomaly_based_volume(
        base_qty * price, anomaly_circles_count, deposit
    )
    base_qty = adjusted_volume / price
    adjusted_risk, risk_multiplier = calculate_anomaly_based_risk(risk_pct, anomaly_circles_count)
    risk_pct = adjusted_risk
```

### **3. –†–∞—Å—á–µ—Ç —Å —É—á–µ—Ç–æ–º –ø—Ä–æ—Å–∞–¥–∫–∏:**
```python
avg_price = sum(p * q for p, q in zip(entry_prices, qtys)) / sum(qtys)
drawdown = abs((avg_price - price) / avg_price)
new_qty = base_qty * (1 + ALPHA * drawdown) / (1 + dca_count)
```

**–ì–¥–µ:**
- `ALPHA` - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏—è –æ–±—ä–µ–º–∞ –ø—Ä–∏ –ø—Ä–æ—Å–∞–¥–∫–µ
- `drawdown` - –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Å–∞–¥–∫–∏ –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
- `dca_count` - —É–º–µ–Ω—å—à–∞–µ—Ç –æ–±—ä–µ–º —Å –∫–∞–∂–¥—ã–º DCA

---

## üõ°Ô∏è **–ü–†–û–í–ï–†–ö–ò –õ–ò–ú–ò–¢–û–í**

### **1. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫:**
```python
used_risk = sum(q * p for q, p in zip(qtys, entry_prices)) + new_qty * price
max_risk = deposit * MAX_RISK_PCT / 100 * leverage
if used_risk > max_risk or dca_count >= MAX_DCA:
    return 0, avg_price, None, None, True
```

### **2. –õ–∏–º–∏—Ç—ã:**
- `MAX_RISK_PCT` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Ä–∏—Å–∫–∞ (–æ–±—ã—á–Ω–æ 30%)
- `MAX_DCA` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ DCA (–æ–±—ã—á–Ω–æ 5)

---

## üéØ **–†–ê–°–ß–ï–¢ –ù–û–í–û–ô –°–†–ï–î–ù–ï–ô –¶–ï–ù–´**

```python
total_qty = sum(qtys) + new_qty
total_cost = sum(q * p for q, p in zip(qtys, entry_prices)) + new_qty * price
avg_price_new = total_cost / total_qty
```

---

## üìä **–î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –¢–ï–ô–ö-–ü–†–û–§–ò–¢–´**

### **1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö TP:**
```python
if df is not None and current_index is not None:
    dynamic_tp1_pct, dynamic_tp2_pct = get_dynamic_tp_levels(df, current_index, side)
else:
    dynamic_tp1_pct, dynamic_tp2_pct = 1.0, 2.0
```

### **2. –†–∞—Å—á–µ—Ç TP –¥–ª—è LONG:**
```python
if side == "long":
    if dca_count + 1 >= 3:
        # –î–ª—è –ø–æ–∑–¥–Ω–∏—Ö —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π - –±–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ TP
        tp1 = avg_price_new * (1 + dynamic_tp1_pct * 0.7 / 100)
        tp2 = avg_price_new * (1 + dynamic_tp2_pct * 0.7 / 100)
    else:
        tp1 = avg_price_new * (1 + dynamic_tp1_pct / 100)
        tp2 = avg_price_new * (1 + dynamic_tp2_pct / 100)
```

### **3. –†–∞—Å—á–µ—Ç TP –¥–ª—è SHORT:**
```python
else:  # short
    if dca_count + 1 >= 3:
        # –î–ª—è –ø–æ–∑–¥–Ω–∏—Ö —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π - –±–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ TP
        tp1 = avg_price_new * (1 - dynamic_tp1_pct * 0.7 / 100)
        tp2 = avg_price_new * (1 - dynamic_tp2_pct * 0.7 / 100)
    else:
        tp1 = avg_price_new * (1 - dynamic_tp1_pct / 100)
        tp2 = avg_price_new * (1 - dynamic_tp2_pct / 100)
```

---

## üîç **–£–°–õ–û–í–ò–Ø –ê–ö–¢–ò–í–ê–¶–ò–ò DCA**

### **–§—É–Ω–∫—Ü–∏—è:** `should_dca()`
```python
def should_dca(side, last_close, stop_loss, dca_pct):
    if side == "long":
        return last_close <= stop_loss * (1 - dca_pct / 100)
    else:
        return last_close >= stop_loss * (1 + dca_pct / 100)
```

**–õ–æ–≥–∏–∫–∞:**
- **LONG:** DCA –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç –Ω–∏–∂–µ `stop_loss * (1 - dca_pct/100)`
- **SHORT:** DCA –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç –≤—ã—à–µ `stop_loss * (1 + dca_pct/100)`

---

## üìã **–ü–†–û–¶–ï–°–° –§–û–†–ú–ò–†–û–í–ê–ù–ò–Ø DCA –°–ò–ì–ù–ê–õ–ê**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π:**
```python
user_positions = user_data.get('open_positions', [])
has_user_long = any(
    pos["symbol"] == symbol and pos.get("side", "long") == "long"
    for pos in user_positions
)
```

### **2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–∏:**
```python
if has_user_long:
    pos = next((p for p in user_positions if p['symbol'] == symbol and p.get('side', 'long') == 'long'), None)
    if pos:
        entry_prices = pos.get('entry_prices', [pos.get('entry_price', last['close'])])
        qtys = pos.get('qtys', [pos.get('qty', 1)])
        dca_count = pos.get('n_dca', 0)
```

### **3. –†–∞—Å—á–µ—Ç –Ω–æ–≤–æ–≥–æ DCA:**
```python
new_qty, avg_price_new, tp1, tp2, limit_reached = dca_calculate_next_qty_and_tp(
    entry_prices, qtys, last['close'], dca_count, deposit, risk_pct,
    leverage, side='long', df=df, current_index=len(df)-1
)
```

### **4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤:**
```python
if limit_reached or new_qty <= 0:
    continue  # –ª–∏–º–∏—Ç —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π –∏–ª–∏ —Ä–∏—Å–∫–∞
```

---

## üìä **–ò–ù–§–û–†–ú–ê–¶–ò–Ø –í DCA –°–ò–ì–ù–ê–õ–ï**

### **–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- **–°–∏–º–≤–æ–ª** –∏ **—Å—Ç–æ—Ä–æ–Ω–∞** –ø–æ–∑–∏—Ü–∏–∏
- **–¶–µ–Ω–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è** (—Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞)
- **–ù–æ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞** –ø–æ—Å–ª–µ DCA
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏** (new_qty)
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ TP1 –∏ TP2**
- **–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ TP

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**
- RSI, MACD, –û–±—ä–µ–º, EMA, Bollinger Bands
- BTC —Ç—Ä–µ–Ω–¥ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)
- –î–∞–Ω–Ω—ã–µ –æ –∫–∏—Ç–∞—Ö (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã)
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–Ω–æ–º–∞–ª–∏–π

### **–†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç:**
- **–¢–µ–∫—É—â–∏–π —Ä–∏—Å–∫** –≤ –ø–æ–∑–∏—Ü–∏–∏
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫** (–ª–∏–º–∏—Ç)
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ DCA** (n_dca)
- **–û–±—â–∏–π –æ–±—ä–µ–º** –ø–æ–∑–∏—Ü–∏–∏

---

## üîÑ **–û–°–û–ë–ï–ù–ù–û–°–¢–ò DCA –î–õ–Ø SHORT**

### **–õ–æ–≥–∏–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è:**
- **LONG:** —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –≤–Ω–∏–∑ (–ø–æ–∫—É–ø–∞–µ–º –¥–µ—à–µ–≤–ª–µ)
- **SHORT:** —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö (–ø—Ä–æ–¥–∞–µ–º –¥–æ—Ä–æ–∂–µ)

### **–†–∞—Å—á–µ—Ç TP –¥–ª—è SHORT:**
```python
profit_pct_tp1 = ((avg_price_new - tp1) / avg_price_new) * 100
profit_pct_tp2 = ((avg_price_new - tp2) / avg_price_new) * 100
```

---

## ‚ö†Ô∏è **–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ò –ó–ê–©–ò–¢–´**

### **1. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫:**
- –ù–µ –±–æ–ª–µ–µ 30% –¥–µ–ø–æ–∑–∏—Ç–∞ –≤ –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤—Ö–æ–¥—ã

### **2. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ DCA:**
- –û–±—ã—á–Ω–æ 5 DCA –Ω–∞ –ø–æ–∑–∏—Ü–∏—é
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —á—Ä–µ–∑–º–µ—Ä–Ω–æ–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ

### **3. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:**
- –ï—Å–ª–∏ `new_qty <= 0`, DCA –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

### **4. –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ TP –¥–ª—è –ø–æ–∑–¥–Ω–∏—Ö DCA:**
- –ü–æ—Å–ª–µ 3-–≥–æ DCA TP —É–º–µ–Ω—å—à–∞—é—Ç—Å—è –Ω–∞ 30%
- –°–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –ø—Ä–∏ –≥–ª—É–±–æ–∫–æ–π –ø—Ä–æ—Å–∞–¥–∫–µ

---

## üéØ **–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –°–ò–°–¢–ï–ú–´ DCA**

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ** –ø—Ä–∏ –ø—Ä–æ—Å–∞–¥–∫–µ
2. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ TP** –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
3. **–ó–∞—â–∏—Ç–∞ –æ—Ç —á—Ä–µ–∑–º–µ—Ä–Ω–æ–≥–æ —Ä–∏—Å–∫–∞**
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º**
5. **–£—á–µ—Ç –∞–Ω–æ–º–∞–ª–∏–π —Ä—ã–Ω–∫–∞**
6. **–ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Ä—ã–Ω–æ—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º**

---

## üìà **–ü–†–ò–ú–ï–† –†–ê–ë–û–¢–´ DCA**

### **–°—Ü–µ–Ω–∞—Ä–∏–π LONG –ø–æ–∑–∏—Ü–∏–∏:**
1. **–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥:** 100 USDT –ø–æ —Ü–µ–Ω–µ 50,000
2. **–¶–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç –¥–æ 45,000** ‚Üí –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è DCA
3. **DCA —Ä–∞—Å—á–µ—Ç:** –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ 120 USDT –ø–æ 45,000
4. **–ù–æ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞:** 47,273
5. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ TP:** +4.7% –∏ +9.3% –æ—Ç –Ω–æ–≤–æ–π —Å—Ä–µ–¥–Ω–µ–π
6. **–û–±—â–∏–π —Ä–∏—Å–∫:** 220 USDT (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞)

### **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- **–°–Ω–∏–∂–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã** —Å 50,000 –¥–æ 47,273
- **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞** –ø–æ–∑–∏—Ü–∏–∏
- **–ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–π –≤—ã—Ö–æ–¥ –≤ –ø—Ä–∏–±—ã–ª—å** –ø—Ä–∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç–µ
