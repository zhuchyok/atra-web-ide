# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∏–ª –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º–µ:
- **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP1 –∏ TP2** —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –Ω–æ **–ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏** –≤ —Å–∏—Å—Ç–µ–º–µ
- **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP2** –ø–æ–∑–∏—Ü–∏—è –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- **–í –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö", –Ω–æ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ —Ç–æ–π –∂–µ –º–æ–Ω–µ—Ç—ã –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É: **"‚ùå –£–∂–µ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ —ç—Ç–æ–º—É —Å–∏–º–≤–æ–ª—É. –ó–∞–∫—Ä–æ–π—Ç–µ —Ç–µ–∫—É—â—É—é –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –Ω–æ–≤–æ–π."**
- –°–∏—Å—Ç–µ–º–∞ **–≤—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä—ã—Ç–Ω–æ** (–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞), –ø–æ—Å–ª–µ —á–µ–≥–æ —Å–Ω–æ–≤–∞ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ TP1 –∏ TP2

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `check_take_profits()`
–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `check_take_profits()` –≤ —Ñ–∞–π–ª–µ `signal_live.py`:

1. **–ü–æ–∑–∏—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–º–µ—á–∞–ª–∏—Å—å –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç—ã–µ** (`status: "closed"`, `qty: 0`)
2. **–ù–û —Å–ø–∏—Å–æ–∫ `open_positions` –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è** —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–ø–∏—Å–∫–æ–º `positions`
3. **–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö** –≤ `handle_accept_button()` —Å–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–ª–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ

### –ü—Ä–æ–±–ª–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
```python
# –ü–†–û–ë–õ–ï–ú–ê: –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ TP2
pos["status"] = "closed"
pos["qty"] = 0.0

# –ù–û open_positions –ù–ï –æ–±–Ω–æ–≤–ª—è–ª—Å—è!
user_data["open_positions"] = [
    p for p in (user_data.get("positions") or [])
    if p.get("status", "open") == "open" and float(p.get("qty", 0)) > 0
]
```

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ `check_take_profits()`

**–§–∞–π–ª:** `signal_live.py`

#### TP1 (—á–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ):
```python
# –î–û–ë–ê–í–õ–ï–ù–û: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è open_positions —Å positions
try:
    user_data["open_positions"] = [
        p for p in (user_data.get("positions") or [])
        if p.get("status", "open") == "open" and float(p.get("qty", 0)) > 0
    ]
    logging.info("üîÑ TP1: –û–±–Ω–æ–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ open_positions –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %s, –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ–∑–∏—Ü–∏–π: %d", 
               user_id, len(user_data["open_positions"]))
except (TypeError, ValueError, KeyError):
    pass
```

#### TP2 (–ø–æ–ª–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ):
```python
# –î–û–ë–ê–í–õ–ï–ù–û: –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è open_positions —Å positions
try:
    user_data["open_positions"] = [
        p for p in (user_data.get("positions") or [])
        if p.get("status", "open") == "open" and float(p.get("qty", 0)) > 0
    ]
    logging.info("üîÑ TP2: –û–±–Ω–æ–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ open_positions –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %s, –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ–∑–∏—Ü–∏–π: %d", 
               user_id, len(user_data["open_positions"]))
except (TypeError, ValueError, KeyError):
    pass
```

#### SL/BE (–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –±–µ–∑—É–±—ã—Ç–∫—É):
```python
# –î–û–ë–ê–í–õ–ï–ù–û: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –±–µ–∑—É–±—ã—Ç–∫–∞
try:
    user_data["open_positions"] = [
        p for p in (user_data.get("positions") or [])
        if p.get("status", "open") == "open" and float(p.get("qty", 0)) > 0
    ]
    logging.info("üîÑ SL_BE: –û–±–Ω–æ–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ open_positions –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %s, –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ–∑–∏—Ü–∏–π: %d", 
               user_id, len(user_data["open_positions"]))
except (TypeError, ValueError, KeyError):
    pass
```

### 2. –£–ª—É—á—à–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ `handle_accept_button()`

**–§–∞–π–ª:** `telegram_handlers.py`

#### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ë–î:
```python
# –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º user_data –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
latest = db.get_user_data(user_id)
if latest:
    user_data.update(latest)
    logging.info("üîÑ handle_accept_button: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %s —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –ë–î", user_id)
```

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π:
```python
# –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ open_positions –∏ positions
if user_data.get('positions'):
    correct_open_positions = [
        p for p in user_data.get('positions', [])
        if p.get('status', 'open') == 'open' and float(p.get('qty', 0)) > 0
    ]
    if len(correct_open_positions) != len(open_positions):
        logging.warning("‚ö†Ô∏è handle_accept_button: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ open_positions –∏ positions –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %s. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º.", user_id)
        user_data['open_positions'] = correct_open_positions
        open_positions = correct_open_positions
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP1:**
   - –ü–æ–∑–∏—Ü–∏—è —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (50%)
   - `qty` —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –¥–æ 50%
   - `open_positions` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å `positions`
   - –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î

2. **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP2:**
   - –ü–æ–∑–∏—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
   - `status` = "closed", `qty` = 0
   - `open_positions` –æ—á–∏—â–∞–µ—Ç—Å—è –æ—Ç –∑–∞–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏
   - –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î

3. **–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞:**
   - –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ë–î (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è `open_positions` –∏ `positions`
   - –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ - –Ω–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- **–ü–æ–∑–∏—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è** –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP1 –∏ TP2
- **–°–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π** —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- **–ù–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã** –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π
- **–î–∞–Ω–Ω—ã–µ –≤ –ë–î** –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã
- **–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞

### üéØ –¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. **TP1 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç** ‚Üí –ø–æ–∑–∏—Ü–∏—è —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
2. **TP2 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç** ‚Üí –ø–æ–∑–∏—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç–∞, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
3. **–ù–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª** ‚Üí —Å–∏—Å—Ç–µ–º–∞ –≤–∏–¥–∏—Ç, —á—Ç–æ –ø–æ–∑–∏—Ü–∏–π –Ω–µ—Ç, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–∏–≥–Ω–∞–ª
4. **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤** –º–µ–∂–¥—É –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –∏ –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- `üîÑ TP1/TP2/SL_BE: –û–±–Ω–æ–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ open_positions`
- `‚úÖ TP1/TP2/SL_BE: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã`
- `üîÑ handle_accept_button: –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –ë–î`
- `‚ö†Ô∏è handle_accept_button: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ open_positions –∏ positions. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º.`

## üìÖ –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
**27 —è–Ω–≤–∞—Ä—è 2025**

---
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** ‚úÖ **–ü–†–û–ô–î–ï–ù–û**
**–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:** ‚úÖ **–ì–û–¢–û–í–û –ö –ü–†–û–ò–ó–í–û–î–°–¢–í–£**
