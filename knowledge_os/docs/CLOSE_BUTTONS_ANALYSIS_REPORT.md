# üî¥ –ê–ù–ê–õ–ò–ó –ö–ù–û–ü–û–ö –ó–ê–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô - –û–¢–ß–ï–¢

## üéØ **–ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–´ –ö–ù–û–ü–û–ö –ó–ê–ö–†–´–¢–ò–Ø:**

### **‚úÖ –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò!**

---

## üîç **–ê–ù–ê–õ–ò–ó –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–ò:**

### **üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è:**

#### **1. üî¥ –ó–∞–∫—Ä—ã—Ç—å (–≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏):**
```python
callback_data=f"close_position|{symbol}|current|all"
```
- **–î–µ–π—Å—Ç–≤–∏–µ:** –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å—é –ø–æ–∑–∏—Ü–∏—é –ø–æ —Ç–µ–∫—É—â–µ–π —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ
- **–†–µ–∂–∏–º:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
- **–¶–µ–Ω–∞:** –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –±–∏—Ä–∂–∏ —á–µ—Ä–µ–∑ `get_ohlc_binance_sync`

#### **2. üí∞ –ó–∞–∫—Ä—ã—Ç—å 50%:**
```python
callback_data=f"close_position|{symbol}|current|half"
```
- **–î–µ–π—Å—Ç–≤–∏–µ:** –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–ª–æ–≤–∏–Ω—É –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Ç–µ–∫—É—â–µ–π —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ
- **–†–µ–∂–∏–º:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
- **–¶–µ–Ω–∞:** –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –±–∏—Ä–∂–∏

#### **3. üìä –î–µ—Ç–∞–ª–∏ –ø–æ–∑–∏—Ü–∏–∏:**
```python
callback_data=f"position_details|{symbol}"
```
- **–î–µ–π—Å—Ç–≤–∏–µ:** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏
- **–†–µ–∂–∏–º:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π
- **–í–∫–ª—é—á–∞–µ—Ç:** P&L, —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É, TP1, TP2

#### **4. üìà –û–±–Ω–æ–≤–∏—Ç—å P&L:**
```python
callback_data=f"refresh_position|{symbol}"
```
- **–î–µ–π—Å—Ç–≤–∏–µ:** –û–±–Ω–æ–≤–ª—è–µ—Ç P&L –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ
- **–†–µ–∂–∏–º:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
- **–¶–µ–Ω–∞:** –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –±–∏—Ä–∂–∏

---

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:**

### **üìù –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ `close_position`:**

```python
elif action == "close_position":
    symbol = data[1]
    close_price = data[2]  # "current" –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ü–µ–Ω–∞
    close_qty = data[3]    # "all", "half" –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

    # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ø–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã
    if close_price == "current":
        from exchange_api import get_ohlc_binance_sync
        ohlc = get_ohlc_binance_sync(symbol, interval="1m", limit=1)
        if not ohlc or len(ohlc) == 0:
            await query.message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è {symbol}.")
            return
        close_price = ohlc[-1]["close"]  # ‚Üê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø —Ü–µ–Ω–∞

    # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô —Ä–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏
    profit = (
        (close_price - entry_price) * actual_qty if side == "long"
        else (entry_price - close_price) * actual_qty
    )

    # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
    user_data["trade_history"].append({
        "symbol": symbol,
        "side": side,
        "entry_price": entry_price,
        "close_price": close_price,
        "qty": actual_qty,
        "profit": profit,
        "close_time": datetime.now().isoformat(),
        "trade_mode": user_data.get("trade_mode", "spot"),
        "leverage": pos.get("leverage", 1)
    })

    # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ø–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞
    balance_update = recalculate_balance_and_risks(user_data)
    save_user_data(context)
```

---

## üìä **–ü–†–û–¶–ï–°–° –ó–ê–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ò:**

### **üîÑ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –±–∏—Ä–∂–∏ —á–µ—Ä–µ–∑ API
2. **–†–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç P&L
3. **–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ `open_positions`
4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ `trade_history`
5. **–ü–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç —Ä–∏—Å–∫–æ–≤ –∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
6. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

---

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢ –ó–ê–ö–†–´–¢–ò–Ø:**

### **‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è:**

```
üü¢ –ü–û–ó–ò–¶–ò–Ø –ó–ê–ö–†–´–¢–ê

–°–ò–ú–í–û–õ: BTCUSDT
–°—Ç–æ—Ä–æ–Ω–∞: LONG
–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: 45000.000000
–¶–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è: 45150.000000
–ó–∞–∫—Ä—ã—Ç–æ: 0.0022
–ü—Ä–∏–±—ã–ª—å: 15.50 USDT
–†–µ–∂–∏–º: SPOT

üí∞ –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ë–ê–õ–ê–ù–°:
–î–µ–ø–æ–∑–∏—Ç: 10115.50 USDT
–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: 15.50 USDT
–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π: 0
–ó–∞–Ω—è—Ç–æ —Ä–∏—Å–∫–∞–º–∏: 0.00 USDT
–°–≤–æ–±–æ–¥–Ω–æ: 10115.50 USDT
```

---

## üöÄ **–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –ó–ê–ö–†–´–¢–ò–Ø:**

### **‚úÖ 1. –°–∫–æ—Ä–æ—Å—Ç—å:**
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ
- –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–≤–æ–¥–∏—Ç—å —Ü–µ–Ω—É –≤—Ä—É—á–Ω—É—é
- –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä—ã–Ω–∫–∞

### **‚úÖ 2. –¢–æ—á–Ω–æ—Å—Ç—å:**
- –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞
- –¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

### **‚úÖ 3. –£–¥–æ–±—Å—Ç–≤–æ:**
- –û–¥–∏–Ω –∫–ª–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### **‚úÖ 4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–∑–∏—Ü–∏–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## üìã **–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:**

### **üîß –†—É—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):**
- –ö–æ–º–∞–Ω–¥–∞ `/close SYMBOL PRICE` –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ü–µ–Ω–µ
- –ö–æ–º–∞–Ω–¥–∞ `/close all` –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
- –ö–æ–º–∞–Ω–¥–∞ `/close SYMBOL` –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ

### **üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∑–∏—Ü–∏–π:**
- –ö–Ω–æ–ø–∫–∞ "üìä –î–µ—Ç–∞–ª–∏" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ö–Ω–æ–ø–∫–∞ "üìà –û–±–Ω–æ–≤–∏—Ç—å P&L" –¥–ª—è –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –æ—Ç—á–µ—Ç–∞—Ö

---

## üéØ **–ò–¢–û–ì:**

### **‚úÖ –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò:**

1. **üî¥ –ó–∞–∫—Ä—ã—Ç—å** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ–π –ø–æ–∑–∏—Ü–∏–∏
2. **üí∞ –ó–∞–∫—Ä—ã—Ç—å 50%** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–æ–≤–∏–Ω—ã –ø–æ–∑–∏—Ü–∏–∏
3. **üìä –î–µ—Ç–∞–ª–∏** - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∑–∏—Ü–∏–∏
4. **üìà –û–±–Ω–æ–≤–∏—Ç—å P&L** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏

### **‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:**
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã —Å –±–∏—Ä–∂–∏
- –†–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
- –ü–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!** ‚úÖ