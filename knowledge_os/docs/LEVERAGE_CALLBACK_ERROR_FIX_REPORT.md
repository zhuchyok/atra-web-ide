# üîß –û–¢–ß–ï–¢: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò leverage_for_callback

## üìä **–ü–†–û–ë–õ–ï–ú–ê**

### **‚ùå –û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö:**
```
[DEBUG] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ –¥–ª—è XRPUSDT: 1.3 (–±–∞–∑–æ–≤–æ–µ: 1)
ERROR:root:[main_loop] –û—à–∏–±–∫–∞: local variable 'leverage_for_callback' referenced before assignment
Traceback (most recent call last):
  File "/Users/zhuchyok/Documents/GITHUB/atra/signal_live.py", line 3073, in main_loop
    signal_history = await check_and_send_signals(signal_history)
  File "/Users/zhuchyok/Documents/GITHUB/atra/signal_live.py", line 2982, in check_and_send_signals
    f"<code>/accept {symbol} {now.strftime('%Y-%m-%dT%H:%M')} {price:.2f} 1.0 {side.lower()} {risk_pct:.1f} {leverage_for_callback}</code>\n"
UnboundLocalError: local variable 'leverage_for_callback' referenced before assignment
```

### **üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã:**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `leverage_for_callback` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –≤ —Å—Ç—Ä–æ–∫–µ 2982 –¥–æ –µ—ë –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫–µ 2987.

**–õ–æ–≥–∏–∫–∞ –æ—à–∏–±–∫–∏:**
1. –í —Å—Ç—Ä–æ–∫–µ 2982 —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `leverage_for_callback`
2. –ù–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `leverage_for_callback` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å—Ç—Ä–æ–∫–µ 2987
3. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–µ `UnboundLocalError`

---

## üîß **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**

### **‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**

#### **–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
msg = (
    f"‚ö†Ô∏è –†–∏—Å–∫: <code>{risk_pct:.2f}%</code>"
    f"{f' | ‚ö° –ü–ª–µ—á–æ: <code>x{dynamic_leverage}</code>' if trade_mode == 'futures' and dynamic_leverage else ''}\n"
    f"{btc_trend_info}\n"
    f"üîß –†–µ–∂–∏–º: <code>{'–°—Ç—Ä–æ–≥–∏–π' if filter_mode == 'balanced' else '–ú—è–≥–∫–∏–π'}</code> ({trade_mode})\n"
    f"{technical_analysis}"
    f"{news_info}\n"
    f"\nüí° <b>–ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´:</b>\n"
    f"‚Ä¢ –ü—Ä–∏–Ω—è—Ç–∏–µ —Å–∏–≥–Ω–∞–ª–∞:\n"
    f"<code>/accept {symbol} {now.strftime('%Y-%m-%dT%H:%M')} {price:.2f} 1.0 {side.lower()} {risk_pct:.1f} {leverage_for_callback}</code>\n"  # ‚ùå –û–®–ò–ë–ö–ê!
    f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏: <code>/positions</code>\n"
    f"‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫: <code>/trade_history</code>"
)

# –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
# –î–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤ –ø–µ—Ä–µ–¥–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ, –¥–ª—è —Å–ø–æ—Ç–∞ - 1
leverage_for_callback = dynamic_leverage if trade_mode == 'futures' and dynamic_leverage else 1  # ‚ùå –û–ü–†–ï–î–ï–õ–ï–ù–û –ü–û–°–õ–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø!
```

#### **–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
msg = (
    f"‚ö†Ô∏è –†–∏—Å–∫: <code>{risk_pct:.2f}%</code>"
    f"{f' | ‚ö° –ü–ª–µ—á–æ: <code>x{dynamic_leverage}</code>' if trade_mode == 'futures' and dynamic_leverage else ''}\n"
    f"{btc_trend_info}\n"
    f"üîß –†–µ–∂–∏–º: <code>{'–°—Ç—Ä–æ–≥–∏–π' if filter_mode == 'balanced' else '–ú—è–≥–∫–∏–π'}</code> ({trade_mode})\n"
    f"{technical_analysis}"
    f"{news_info}\n"
    f"\nüí° <b>–ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´:</b>\n"
    f"‚Ä¢ –ü—Ä–∏–Ω—è—Ç–∏–µ —Å–∏–≥–Ω–∞–ª–∞:\n"
)

# –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
# –î–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤ –ø–µ—Ä–µ–¥–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ, –¥–ª—è —Å–ø–æ—Ç–∞ - 1
leverage_for_callback = dynamic_leverage if trade_mode == 'futures' and dynamic_leverage else 1  # ‚úÖ –û–ü–†–ï–î–ï–õ–ï–ù–û –î–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

msg += (
    f"<code>/accept {symbol} {now.strftime('%Y-%m-%dT%H:%M')} {price:.2f} 1.0 {side.lower()} {risk_pct:.1f} {leverage_for_callback}</code>\n"  # ‚úÖ –¢–ï–ü–ï–†–¨ –†–ê–ë–û–¢–ê–ï–¢!
    f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏: <code>/positions</code>\n"
    f"‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫: <code>/trade_history</code>"
)
```

---

## üéØ **–õ–û–ì–ò–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

### **üìä –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

1. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è** (–±–µ–∑ `leverage_for_callback`)
2. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `leverage_for_callback`** –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∂–∏–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±—ã—Å—Ç—Ä—ã—Ö –∫–æ–º–∞–Ω–¥** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
4. **–°–æ–∑–¥–∞–Ω–∏–µ callback_data** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–ª–µ—á–æ–º

### **üîß –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–ª–µ—á–∞:**

```python
leverage_for_callback = dynamic_leverage if trade_mode == 'futures' and dynamic_leverage else 1
```

- **–î–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ (–µ—Å–ª–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ)
- **–î–ª—è —Å–ø–æ—Ç–∞:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–ª–µ—á–æ 1
- **Fallback:** –ï—Å–ª–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 1

---

## ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

### **üéØ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**

#### **1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:**
- ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `leverage_for_callback` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ `UnboundLocalError`
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### **2. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –ø–ª–µ—á–∞:**
- ‚úÖ –í –±—ã—Å—Ç—Ä—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö `/accept` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–ª–µ—á–æ
- ‚úÖ –í callback_data –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- ‚úÖ –î–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤ - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ, –¥–ª—è —Å–ø–æ—Ç–∞ - 1

#### **3. –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã:**
- ‚úÖ –ù–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –≤ main_loop
- ‚úÖ –°–∏–≥–Ω–∞–ª—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ü–ª–µ—á–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### **üìä –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã:**

#### **–î–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤:**
```
‚ö° –ü–ª–µ—á–æ: x1.3
üí° –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´:
‚Ä¢ –ü—Ä–∏–Ω—è—Ç–∏–µ —Å–∏–≥–Ω–∞–ª–∞:
/accept XRPUSDT 2024-01-15T12:00 0.52 1.0 long 2.0 1.3
```

#### **–î–ª—è —Å–ø–æ—Ç–∞:**
```
üí° –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´:
‚Ä¢ –ü—Ä–∏–Ω—è—Ç–∏–µ —Å–∏–≥–Ω–∞–ª–∞:
/accept XRPUSDT 2024-01-15T12:00 0.52 1.0 long 2.0 1
```

---

## üõ°Ô∏è **–ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ò–ï –ü–û–í–¢–û–†–ï–ù–ò–Ø**

### **üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**

1. **–ü–æ—Ä—è–¥–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:**
   - –í—Å–µ–≥–¥–∞ –æ–ø—Ä–µ–¥–µ–ª—è–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `+=` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —Å—Ç—Ä–æ–∫–∞–º

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
   - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ IDE –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

3. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞:**
   - –†–∞–∑–¥–µ–ª—è–π—Ç–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏
   - –û–ø—Ä–µ–¥–µ–ª—è–π—Ç–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ –±–ª–æ–∫–∞

### **üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –ø–ª–µ—á–∞ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã callback_data
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ main_loop

---

## üìã **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

### **‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:**

1. **‚úÖ –û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞** - –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
2. **‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞** - –Ω–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –≤ main_loop
3. **‚úÖ –ü–ª–µ—á–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - –¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤ –∏ —Å–ø–æ—Ç–∞
4. **‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è

### **üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:**
–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç **—Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –±–µ–∑ –æ—à–∏–±–æ–∫**, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ –≤ –∫–æ–º–∞–Ω–¥—ã –∏ callback_data.