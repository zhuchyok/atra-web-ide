# üõ°Ô∏è –ó–ê–©–ò–¢–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• - –ü–û–õ–ù–û–ï –†–£–ö–û–í–û–î–°–¢–í–û

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ß–∞—Å—Ç–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –ë–î

### –°–∏–º–ø—Ç–æ–º—ã:
```
‚ùå file is not a database
‚ùå disk I/O error  
‚ùå user_data_dict –ø—É—Å—Ç
```

---

## üîç –ü–†–ò–ß–ò–ù–´ –ü–†–û–ë–õ–ï–ú–´

### 1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã Database**
```python
# main.py
Database()  # ‚Üê –≠–∫–∑–µ–º–ø–ª—è—Ä 1

# telegram_handlers.py
db = Database()  # ‚Üê –≠–∫–∑–µ–º–ø–ª—è—Ä 2

# telegram_commands.py
db = Database()  # ‚Üê –≠–∫–∑–µ–º–ø–ª—è—Ä 3

# signal_live.py
db = Database()  # ‚Üê –≠–∫–∑–µ–º–ø–ª—è—Ä 4+
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π —Å–æ–∑–¥–∞–µ—Ç —Å–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –∑–∞–ø–∏—Å–∏

### 2. **–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**
- üìä Main loop (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤)
- üí¨ Telegram handlers (–∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- üìà Price monitor (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π)
- ü§ñ AI learning (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤)
- üí± Arbitrage checker (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–±–∏—Ç—Ä–∞–∂–∞)

### 3. **–í–Ω–µ–∑–∞–ø–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:**
```bash
pkill -9 -f main.py  # ‚Üê –£–±–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ë–ï–ó graceful shutdown
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- WAL —Ñ–∞–π–ª—ã –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è
- –ë–î –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏

### 4. **SQLite –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- Timeout 30s ‚Üí –µ—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ–ª—å—à–µ ‚Üí –æ—à–∏–±–∫–∞
- WAL mode –ø–æ–º–æ–≥–∞–µ—Ç, –Ω–æ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É

---

## ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –†–ï–®–ï–ù–ò–Ø

### 1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î** ‚úÖ

**–§–∞–π–ª:** `db_health_monitor.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ `check_db_integrity()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
- ‚úÖ `auto_fix_database()` - –∞–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- ‚úÖ `restore_from_backup()` - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
- ‚úÖ `checkpoint_wal()` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è WAL
- ‚úÖ `get_db_health_status()` - –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py:**
```python
async def initialize_database_on_startup():
    # üõ°Ô∏è –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ë–î –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
    from db_health_monitor import auto_fix_database, get_db_health_status
    
    health = get_db_health_status()
    
    if not health["integrity_ok"]:
        logger.warning("‚ö†Ô∏è –ë–î –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞! –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è...")
        if auto_fix_database():
            logger.info("‚úÖ –ë–î —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!")
```

### 2. **WAL Mode –≤–∫–ª—é—á–µ–Ω** ‚úÖ

**–§–∞–π–ª:** `db.py`

```python
self.conn.execute("PRAGMA journal_mode=WAL;")
self.conn.execute("PRAGMA synchronous=NORMAL;")
self.conn.execute("PRAGMA busy_timeout=30000;")  # 30s
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ Concurrent —á–∏—Ç–∞—Ç–µ–ª–∏ –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–∏—Å–∞—Ç–µ–ª–µ–π
- ‚úÖ –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ú–µ–Ω—å—à–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### 3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã** ‚úÖ

**–ì–¥–µ:** –í `db.py` —É–∂–µ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `backup_file()`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `backups/` —Å timestamp

---

## üöÄ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. **Graceful Shutdown –≤–º–µ—Å—Ç–æ `pkill -9`**

**‚ùå –ü–õ–û–•–û:**
```bash
pkill -9 -f main.py  # –£–±–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
```

**‚úÖ –•–û–†–û–®–û:**
```bash
pkill -15 -f main.py  # SIGTERM - –¥–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏–µ
# –ò–õ–ò
kill -15 <PID>
```

**–ï—â–µ –ª—É—á—à–µ - –∏—Å–ø–æ–ª—å–∑—É–π —Å–∫—Ä–∏–ø—Ç:**
```bash
#!/bin/bash
# safe_stop.sh

echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ..."

# –ü–æ–ª—É—á–∞–µ–º PID
PID=$(ps aux | grep 'python3 main.py' | grep -v grep | awk '{print $2}')

if [ -z "$PID" ]; then
    echo "‚úÖ –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    exit 0
fi

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SIGTERM
kill -15 $PID

# –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥
echo "‚è≥ –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (10 —Å–µ–∫)..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
if ps -p $PID > /dev/null; then
    echo "‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º SIGKILL..."
    kill -9 $PID
else
    echo "‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
fi

# –î–µ–ª–∞–µ–º WAL checkpoint
echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è WAL..."
python3 -c "from db_health_monitor import checkpoint_wal; checkpoint_wal()"

echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
```

### 2. **–†–µ–≥—É–ª—è—Ä–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ë–î**

–î–æ–±–∞–≤—å –≤ cron:
```bash
# –ö–∞–∂–¥—ã–π —á–∞—Å –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ë–î
0 * * * * cd /root/atra && python3 -c "from db_health_monitor import get_db_health_status; print(get_db_health_status())"

# –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ –¥–µ–ª–∞–µ–º WAL checkpoint
0 */6 * * * cd /root/atra && python3 -c "from db_health_monitor import checkpoint_wal; checkpoint_wal()"
```

### 3. **Singleton pattern –¥–ª—è Database**

**–°–æ–∑–¥–∞–π —Ñ–∞–π–ª:** `db_singleton.py`

```python
"""
Singleton Database instance –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
"""
import threading
from db import Database

_db_instance = None
_db_lock = threading.Lock()


def get_database() -> Database:
    """
    –ü–æ–ª—É—á–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä Database
    
    Thread-safe singleton pattern
    """
    global _db_instance
    
    if _db_instance is None:
        with _db_lock:
            if _db_instance is None:
                _db_instance = Database()
    
    return _db_instance


# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
db = get_database()
```

**–ó–∞—Ç–µ–º –≤ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–∞—Ö:**

```python
# ‚ùå –ü–õ–û–•–û:
from db import Database
db = Database()  # –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ!

# ‚úÖ –•–û–†–û–®–û:
from db_singleton import db  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
```

### 4. **–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π VACUUM**

–î–æ–±–∞–≤—å –≤ cron:
```bash
# –ö–∞–∂–¥—É—é –Ω–æ—á—å –≤ 3:00
0 3 * * * cd /root/atra && python3 -c "from db_health_monitor import optimize_database; optimize_database()"
```

### 5. **Monitoring —Å–∫—Ä–∏–ø—Ç**

**–°–æ–∑–¥–∞–π:** `monitor_db_health.sh`

```bash
#!/bin/bash
# monitor_db_health.sh - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –ë–î

cd /root/atra

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ë–î..."

python3 << EOF
from db_health_monitor import get_db_health_status, auto_fix_database
import json

health = get_db_health_status()

print("üìä –°—Ç–∞—Ç—É—Å –ë–î:")
print(json.dumps(health, indent=2, ensure_ascii=False))

if not health["integrity_ok"]:
    print("\n‚ö†Ô∏è –ë–î –ü–û–í–†–ï–ñ–î–ï–ù–ê! –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è...")
    success = auto_fix_database()
    if success:
        print("‚úÖ –ë–î –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!")
    else:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î!")
        exit(1)
else:
    print("\n‚úÖ –ë–î –≤ –ø–æ—Ä—è–¥–∫–µ!")

# Checkpoint WAL –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
from db_health_monitor import checkpoint_wal
checkpoint_wal()
EOF
```

–ó–∞–ø—É—Å–∫–∞–π —Ä–∞–∑ –≤ —á–∞—Å:
```bash
chmod +x monitor_db_health.sh

# –í cron:
0 * * * * /root/atra/monitor_db_health.sh >> /root/atra/logs/db_monitor.log 2>&1
```

---

## üìä –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```bash
cd /root/atra
python3 -c "from db_health_monitor import get_db_health_status; import json; print(json.dumps(get_db_health_status(), indent=2))"
```

### –¢–µ—Å—Ç 2: –†—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
cd /root/atra
python3 -c "from db_health_monitor import auto_fix_database; auto_fix_database()"
```

### –¢–µ—Å—Ç 3: WAL Checkpoint

```bash
cd /root/atra
python3 -c "from db_health_monitor import checkpoint_wal; checkpoint_wal()"
```

---

## üéØ –ß–ï–ö–õ–ò–°–¢ –ó–ê–©–ò–¢–´

- [x] ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- [x] ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–æ–≤
- [x] ‚úÖ WAL mode –≤–∫–ª—é—á–µ–Ω
- [ ] ‚è≥ Singleton pattern –¥–ª—è Database
- [ ] ‚è≥ Graceful shutdown —Å–∫—Ä–∏–ø—Ç
- [ ] ‚è≥ Cron –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] ‚è≥ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π VACUUM

---

## üìù –ò–¢–û–ì

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
2. –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–æ–≤
3. WAL mode –¥–ª—è –ª—É—á—à–µ–π concurrent —Ä–∞–±–æ—Ç—ã
4. –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –±—ç–∫–∞–ø—ã

### üîÑ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å graceful shutdown –≤–º–µ—Å—Ç–æ `pkill -9`
2. –í–Ω–µ–¥—Ä–∏—Ç—å singleton pattern –¥–ª—è Database
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
4. –î–æ–±–∞–≤–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π VACUUM

### üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ë–î –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏
- ‚úÖ –ú–µ–Ω—å—à–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ (WAL)
- ‚úÖ –í—Å–µ–≥–¥–∞ –µ—Å—Ç—å —Å–≤–µ–∂–∏–µ –±—ç–∫–∞–ø—ã
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –ë–î

**–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ–º –ë–î –¥–æ–ª–∂–Ω–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å—Å—è!** üéâ

