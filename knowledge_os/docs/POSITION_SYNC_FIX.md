# üõ°Ô∏è –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 2025-11-06  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞–ª–∏—Å—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞ –±–∏—Ä–∂–µ –∏–∑-–∑–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –≤ API

## üî¥ –ü–†–û–ë–õ–ï–ú–ê

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∏–ª, —á—Ç–æ:
1. **19:36** - –ü–æ–∑–∏—Ü–∏—è SYRUPUSDT SHORT –æ—Ç–∫—Ä—ã–ª–∞—Å—å –Ω–∞ –±–∏—Ä–∂–µ
2. **19:38:12** - –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç "–ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ (–∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)"
3. –ù–æ –ø–æ–∑–∏—Ü–∏—è –Ω–∞ –±–∏—Ä–∂–µ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∏ –∑–∞–∫—Ä—ã–ª–∞—Å—å –Ω–∞ –±–∏—Ä–∂–µ

**–ü—Ä–∏—á–∏–Ω–∞:** –°–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ –±–∏—Ä–∂–µ. –ù–æ –µ—Å—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ –∏ –µ—ë –ø–æ—è–≤–ª–µ–Ω–∏–µ–º –≤ API `fetch_positions()`.

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### 1. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏:
- **–ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏**, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã **–º–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥**
- –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –≤ API –±–∏—Ä–∂–∏
- –ü–æ–∑–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ –±–∏—Ä–∂–µ

### 2. –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å –±–∏—Ä–∂–∏
- –î–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ (symbol, contracts)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ local_open vs remote_open
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏

## üìù –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï

### `main.py` - –§—É–Ω–∫—Ü–∏—è `_sync_positions_periodically`

```python
# üõ°Ô∏è –ó–ê–©–ò–¢–ê: –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –º–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
# –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –∏–∑-–∑–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ
try:
    from datetime import datetime, timedelta
    import sqlite3
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –ë–î
    with sqlite3.connect(adb_local.db_path) as conn:
        cursor = conn.cursor()
        cursor.execute(
            """
            SELECT entry_time, created_at FROM active_positions
            WHERE symbol = ? AND accepted_by = ? 
              AND UPPER(IFNULL(status,'open')) LIKE 'OPEN%'
            ORDER BY created_at DESC LIMIT 1
            """,
            (sym, str(uid))
        )
        result = cursor.fetchone()
        
        if result:
            entry_time_str = result[0] or result[1]
            if entry_time_str:
                # –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
                if isinstance(entry_time_str, str):
                    entry_time = datetime.fromisoformat(entry_time_str.replace('Z', '+00:00'))
                else:
                    entry_time = datetime.fromtimestamp(entry_time_str)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ 5 –º–∏–Ω—É—Ç
                time_since_entry = datetime.now() - entry_time.replace(tzinfo=None) if entry_time.tzinfo else datetime.now() - entry_time
                
                if time_since_entry < timedelta(minutes=5):
                    logger.warning(
                        "‚è∏Ô∏è [SYNC] –ü–æ–∑–∏—Ü–∏—è %s –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %d —Å–ª–∏—à–∫–æ–º –Ω–æ–≤–∞—è "
                        "(–æ—Ç–∫—Ä—ã—Ç–∞ %s –Ω–∞–∑–∞–¥, —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 5 –º–∏–Ω—É—Ç). "
                        "–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ.",
                        sym, uid, time_since_entry
                    )
                    continue
except Exception as e:
    logger.debug(
        "‚ö†Ô∏è [SYNC] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ %s: %s",
        sym, e
    )
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–∑–∏—Ü–∏–π —Å –±–∏—Ä–∂–∏
logger.debug(
    "üîç [SYNC] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %d: –ø–æ–ª—É—á–µ–Ω–æ %d –ø–æ–∑–∏—Ü–∏–π —Å –±–∏—Ä–∂–∏",
    uid, len(positions or [])
)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
logger.debug(
    "üîç [SYNC] –ü–æ–∑–∏—Ü–∏—è —Å –±–∏—Ä–∂–∏: symbol=%s, contracts=%.6f",
    symbol, contracts
)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
logger.info(
    "üîç [SYNC] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %d: local_open=%s, remote_open=%s, to_close=%s",
    uid, local_open, open_symbols_remote, to_close
)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
logger.warning(
    "‚ö†Ô∏è [SYNC] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %d: –ü–æ–∑–∏—Ü–∏—è %s –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –ù–ï–¢ –Ω–∞ –±–∏—Ä–∂–µ. "
    "–†–µ–∂–∏–º: %s. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è...",
    uid, sym, user_mode
)
```

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞–ª–∏—Å—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è (—á–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ –ª–æ–∂–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π
- –ü–æ–∑–∏—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –Ω–∞ –±–∏—Ä–∂–µ, –∑–∞–∫—Ä—ã–≤–∞–ª–∏—Å—å –ª–æ–∫–∞–ª—å–Ω–æ

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã –º–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
- –ü–æ–∑–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ –±–∏—Ä–∂–µ
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üîç –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
1. **–õ–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π —Å –±–∏—Ä–∂–∏
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ local_open vs remote_open
   - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö (<5 –º–∏–Ω—É—Ç)

2. **–ê–ª–µ—Ä—Ç—ã –æ –∑–∞–∫—Ä—ã—Ç–∏–∏:**
   - –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
   - –ü–æ–∑–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç –¥–æ–ª–∂–Ω—ã –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ –±–∏—Ä–∂–µ

3. **–í—Ä–µ–º—è –ø–æ—è–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –±–∏—Ä–∂–µ:**
   - –û–±—ã—á–Ω–æ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ API —á–µ—Ä–µ–∑ 1-3 –º–∏–Ω—É—Ç—ã –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
   - –ó–∞—â–∏—Ç–∞ –≤ 5 –º–∏–Ω—É—Ç –¥–æ–ª–∂–Ω–∞ –ø–æ–∫—Ä—ã–≤–∞—Ç—å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–ª—É—á–∞–µ–≤

## üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 1-2 —á–∞—Å–∞:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

2. **–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏):**
   - –ï—Å–ª–∏ 5 –º–∏–Ω—É—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üí —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 7-10 –º–∏–Ω—É—Ç
   - –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–æ–∂–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏–π ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Å–∏–º–≤–æ–ª–æ–≤
   - –ï—Å–ª–∏ –≤—Å–µ –æ–∫ ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

---

**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-11-06 19:40 MSK  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

