# üß† –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê

## ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê!**

### **–ß–¢–û –ë–´–õ–û:**
- ‚ùå **DCA —Å–∏–≥–Ω–∞–ª—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∏—Å—å** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚ùå **–û—Ç–¥–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ DCA –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** –Ω–µ –±—ã–ª–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞
- ‚ùå **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏** –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏

### **–ß–¢–û –°–¢–ê–õ–û:**
- ‚úÖ **–ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** –¥–ª—è –≤—Å–µ—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ –ø–æ–∑–∏—Ü–∏–π
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ DCA** –ø–æ TP1/TP2
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π** –æ—Ç 15 —Å–µ–Ω—Ç—è–±—Ä—è
- ‚úÖ **"–î—ã—à–∞—â–∏–π –æ—Ä–≥–∞–Ω–∏–∑–º"** - –∂–∏–≤–∞—è, —Å–∞–º–æ–æ–±—É—á–∞—é—â–∞—è—Å—è —Å–∏—Å—Ç–µ–º–∞

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –†–ï–®–ï–ù–ò–ï:**

### **1. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í –°–£–©–ï–°–¢–í–£–Æ–©–£–Æ –°–ò–°–¢–ï–ú–£**

**–§–∞–π–ª:** `price_monitor_system.py`

#### **–î–û–ë–ê–í–õ–ï–ù–û:**
```python
async def check_all_active_signals(self):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ TP1/TP2"""

    # 1. –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –∏–∑ active_signals
    active_signals = self.db.cursor.fetchall()

    # 2. –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–∫–ª—é—á–∞—è DCA)
    active_positions = self.db.cursor.fetchall()

    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ TP1/TP2
    for signal in active_signals:
        await self.check_signal_tp_levels(...)

    for position in active_positions:
        await self.check_user_position_tp_levels(...)
```

### **2. –õ–û–ì–ò–ö–ê DCA –£–°–†–ï–î–ù–ï–ù–ò–Ø**

#### **–ü–û–ù–ò–ú–ê–ù–ò–ï –ü–†–û–¶–ï–°–°–ê:**
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –æ—Ç–∫—Ä—ã—Ç—É—é –ø–æ–∑–∏—Ü–∏—é** –ø–æ —Å–∏–º–≤–æ–ª—É
2. **DCA —Å–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è** –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
3. **–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ü–†–ò–ù–Ø–õ DCA:**
   - ‚úÖ **–ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã** –≤—Ö–æ–¥–∞
   - ‚úÖ **–ü–µ—Ä–µ—Å—á–µ—Ç TP1 –∏ TP2** –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–π —Å—Ä–µ–¥–Ω–µ–π
   - ‚úÖ **–ü–æ–∑–∏—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –û–î–ù–û–ô** —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
4. **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP1:** –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è 50% –æ—Ç –í–°–ï–ô –ø–æ–∑–∏—Ü–∏–∏
5. **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP2:** –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è 100% –æ—Ç –í–°–ï–ô –ø–æ–∑–∏—Ü–∏–∏

#### **–ú–û–ù–ò–¢–û–†–ò–ù–ì –ü–û–ó–ò–¶–ò–ô:**
```python
async def check_user_position_tp_levels(self, user_id, symbol, entry, tp1, tp2, entry_time, created_at):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è TP1/TP2 –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""

    current_price = await self.get_current_price_safe(symbol)

    # TP1: 50% –∑–∞–∫—Ä—ã—Ç–∏–µ
    if current_price >= tp1:
        await self.close_user_position_at_tp1(user_id, symbol, entry_time, current_price, tp1, created_at)

    # TP2: 100% –∑–∞–∫—Ä—ã—Ç–∏–µ
    elif current_price >= tp2:
        await self.close_user_position_at_tp2(user_id, symbol, entry_time, current_price, tp2, created_at)
```

### **3. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ó–ê–ö–†–´–¢–ò–ï**

#### **TP1 (50% –ó–ê–ö–†–´–¢–ò–ï):**
```python
async def close_user_position_at_tp1(self, user_id, symbol, entry_time, current_price, tp1, created_at):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 50% –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP1"""

    # 1. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏–±—ã–ª—å (50% –æ—Ç —Ä–∞–∑–Ω–æ—Å—Ç–∏ —Ü–µ–Ω)
    profit_50pct = (current_price - tp1) * 0.5

    # 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    self.db.cursor.execute("""
        UPDATE signals_log
        SET result = 'tp1_reached', exit_time = datetime('now'), net_profit = ?
        WHERE user_id = ? AND symbol = ? AND entry_time = ?
    """, (profit_50pct, user_id, symbol, entry_time))

    # 3. –õ–æ–≥–∏—Ä—É–µ–º –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º
    logger.info(f"‚úÖ TP1 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}, {symbol} @ {current_price} (50% –∑–∞–∫—Ä—ã—Ç–æ)")
    await self.notify_user_position_tp1_reached(user_id, symbol, current_price, tp1, profit_50pct)
```

#### **TP2 (100% –ó–ê–ö–†–´–¢–ò–ï):**
```python
async def close_user_position_at_tp2(self, user_id, symbol, entry_time, current_price, tp2, created_at):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 100% –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP2"""

    # 1. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏–±—ã–ª—å (100% –æ—Ç —Ä–∞–∑–Ω–æ—Å—Ç–∏ —Ü–µ–Ω)
    profit_100pct = (current_price - tp2) * 1.0

    # 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    self.db.cursor.execute("""
        UPDATE signals_log
        SET result = 'tp2_reached', exit_time = datetime('now'), net_profit = ?
        WHERE user_id = ? AND symbol = ? AND entry_time = ?
    """, (profit_100pct, user_id, symbol, entry_time))

    # 3. –õ–æ–≥–∏—Ä—É–µ–º –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º
    logger.info(f"üéØ TP2 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}, {symbol} @ {current_price} (100% –∑–∞–∫—Ä—ã—Ç–æ)")
    await self.notify_user_position_tp2_reached(user_id, symbol, current_price, tp2, profit_100pct)
```

### **4. –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø**

#### **TP1 –£–í–ï–î–û–ú–õ–ï–ù–ò–ï:**
```
üéØ TP1 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}
{symbol} @ {current_price}
TP1: {tp1}
‚úÖ 50% –ø–æ–∑–∏—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–æ!
üí∞ –ü—Ä–∏–±—ã–ª—å: {profit:.4f} USDT
```

#### **TP2 –£–í–ï–î–û–ú–õ–ï–ù–ò–ï:**
```
üèÜ TP2 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}
{symbol} @ {current_price}
TP2: {tp2}
‚úÖ –ü–æ–∑–∏—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞!
üí∞ –ü—Ä–∏–±—ã–ª—å: {profit:.4f} USDT
```

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢:**

### **–°–ò–°–¢–ï–ú–ê –¢–ï–ü–ï–†–¨:**
1. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏** (–æ–±—ã—á–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã + DCA)
2. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç** –ø–æ TP1/TP2
3. ‚úÖ **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
4. ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π** "–¥—ã—à–∞—â–µ–≥–æ –æ—Ä–≥–∞–Ω–∏–∑–º–∞"
5. ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ 15 —Å–µ–Ω—Ç—è–±—Ä—è** + –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### **DCA –õ–û–ì–ò–ö–ê:**
- ‚úÖ **DCA —Å–∏–≥–Ω–∞–ª—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- ‚úÖ **–ï—Å–ª–∏ –ø—Ä–∏–Ω—è—Ç—ã** - –ø–æ–∑–∏—Ü–∏—è —É—Å—Ä–µ–¥–Ω—è–µ—Ç—Å—è
- ‚úÖ **TP1/TP2 –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è** –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–π —Å—Ä–µ–¥–Ω–µ–π
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ** –ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω–µ–π
- ‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π

## üß† **"–î–´–®–ê–©–ò–ô –û–†–ì–ê–ù–ò–ó–ú" –ì–û–¢–û–í!**

**–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å:**
- üß† **–°–∞–º–æ–æ–±—É—á–∞–µ—Ç—Å—è** —á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç** –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- üéØ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç** –ø–æ TP1/TP2
- üì¢ **–£–≤–µ–¥–æ–º–ª—è–µ—Ç** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
- üîÑ **–ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è** –∫ —Ä—ã–Ω–æ—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º
- üí∞ **–£–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∏—Å–∫–∞–º–∏** –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏

**DCA —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! üöÄ**
