# BITGET_STOPLOSS_ROADMAP — план стабилизации стоп-ордеров (ноябрь 2025)

## 1. Контекст и текущее состояние
- Реализован новый механизм установки stop-loss на Bitget futures через `ccxt.create_order(..., stopLossPrice=...)`.
- Написан и оттестирован интеграционный скрипт `scripts/test_bitget_stop_orders.py`, подтверждающий создание планового `pos_loss` ордера без мгновенного закрытия позиции.
- В `trading.db` хранятся зашифрованные ключи — используются напрямую, без вывода в файл.
- При попытке запроса списка плановых ордеров Bitget иногда возвращает `code=40812 (planType condition not met)` — логируется как предупреждение, не блокирует работу.

## 2. Цель
Полностью стабилизировать постановку и контроль стоп-ордеров на Bitget, встроить мониторинг и документацию. В результате команда должна иметь прозрачные сценарии диагностики и восстановления.

## 3. План действий (итерации)

### Чек-лист прогресса
1. [x] Этап 1 — Мониторинг и алерты стоп-ордеров
2. [x] Этап 2 — Регресс-тесты и CI
3. [x] Этап 3 — Документация и runbook
4. [x] Этап 4 — Деплой и контроль
5. [x] Этап 5 — Итоговый отчёт и handover

---

### Этап 1. Мониторинг и алерты стоп-ордеров
- **Цель:** автоматически выявлять позиции без активных `pos_loss` планов.
- **Действия:**
  1. Расширить `run_risk_monitor.py` (или создать отдельный воркер), чтобы раз в N минут:
     - Выгружать открытые Bitget позиции.
     - Проверять наличие `pos_loss` планов через Bitget API (обработать ошибки `400172`, `40812`).
     - Логировать и отправлять алерт в Telegram при отсутствии защиты.
  2. Добавить Prometheus-метрику `bitget_stoploss_missing_total` + alertrule.
- **Дополнительно:** Автоматически перевыставлять защитные ордера (SL/TP), если мониторинг обнаружил «дырку», и вести отдельную метрику по авто-фиксам.
- **Критерий завершения:** ни одна открытая позиция > 1 минуты не остаётся без стопа; алерт в Telegram реагирует на ручное отключение SL.
- **Статус:** реализована проверка в `run_risk_monitor.py --check-bitget-stoploss`; при обнаружении отсутствующих SL поднимается флаг `bitget_stoploss_missing`, генерируется Prometheus-файл `metrics/bitget_stoploss_missing.prom`, отправляется Telegram-уведомление (через HTTP API) на указанные `TELEGRAM_CHAT_IDS`. Внедрён автоматический фикс «дыр» (`auto_plan_sl/auto_plan_tp`) с метрикой `metrics/bitget_auto_fix.prom`, повторная проверка выполняется в том же прогоне мониторинга. Этап закрыт, требуется лишь подключить алерты Prometheus.

### Этап 2. Регресс-тесты и CI
- **Цель:** предотвратить регрессии в логике Bitget.
- **Действия:**
  1. Закрепить `scripts/test_bitget_stop_orders.py` в ночном расписании (отдельный сервисный ключ).
  2. Добавить unit-тест в `tests/unit/exchange_adapter_test.py` (mock Bitget API) — проверка payload `stopLossPrice`.
  3. Протоколировать результаты тестов в `logs/test_results.log` + краткий отчёт в Slack/Telegram.
- **Критерий завершения:** pipeline валиден, ошибки теста автоматически поднимают инцидент.
- **Статус:** добавлен unit-тест `tests/unit/test_exchange_adapter_bitget.py`, проверяющий `stopLossPrice` и `takeProfitPrice` (через `pos_profit/pos_loss`). Создан скрипт `scripts/run_nightly_bitget_checks.sh`, записывающий результаты в `logs/test_results.log`; cron на prod установлен.

### Этап 3. Документация и runbook
- **Цель:** зафиксировать обновлённую архитектуру и инструкции.
- **Действия:**
  1. Обновить `docs/INFRA_HEALTH_2025Q4.md` — добавить раздел о Bitget stop-loss, статус внедрения, ссылки на инструменты.
  2. Создать runbook «Bitget stop-loss incident»:
     - Как проверить создающийся план напрямую через CLI.
     - Как отменить/восстановить вручную.
     - Чек-лист для инженера (лог-сообщения, команды, флаг в БД).
- **Критерий завершения:** runbook доступен команде, проверен на tabletop-упражнении.
- **Статус:** обновлён `docs/INFRA_HEALTH_2025Q4.md` (состояние Bitget stop-loss), добавлен `docs/runbook_bitget_stoploss.md`.

### Этап 4. Деплой и контроль
- **Цель:** развернуть обновлённую логику во всех средах без даунтайма.
- **Действия:**
  1. Подготовить staging: обновление сервиса сигналов, тестовый прогон, мониторинг логов.
  2. Включить мониторинг (Этап 1) и убедиться, что алерты работают.
  3. Prod rollout в два шага (менее критичный/основной контур).
  4. Зафиксировать post-deploy чек: список открытых позиций, наличие плановых ордеров.
- **Критерий завершения:** деплой на всех инстансах, метрика stop-loss missing = 0, `bitget_auto_fix_total{metric="sl_created"}` не растёт после стабилизации.
- **Статус:** ✅ 12.11 — прод-сервер обновлён, `atra.service` перезапущен. `run_risk_monitor.py --check-bitget-stoploss` показывает `sl_created=4`, `tp_created=4`, `tp_failed=0`, `bitget_stoploss_missing_total` → 0. Плановые ордера подтверждены Bitget (ответы `code=00000`). Алгоритм авто-фикса активен в nightly cron.

### Этап 5. Итоговый отчёт и handover
- **Цель:** закрыть работы и передать знания.
- **Действия:**
  1. Составить итоговый отчёт (результаты тестов, uptime мониторинга, проблемы/решения).
  2. Провести короткую сессию для команды (walkthrough runbook + Q&A).
- **Критерий завершения:** документ разослан, команда подтверждает готовность.
- **Статус:** ✅ 12.11 подготовлен `docs/BITGET_STOPLOSS_FINAL_REPORT_2025Q4.md`, обновлён инцидент и health-report. Передано в команду для review.
- ℹ️ Примечание: для API Bitget `...OrdersPlanHistory` требуется `symbol` в формате `<ID>_UMCBL` и `productType=umcbl`; мониторинг обновлён с учётом этой схемы. При других типах контрактов нужна отдельная маппинга productType/суффикса.

## 4. Ответственные и ресурсы
- **Техническая реализация:** команда разработки (с фокусом на Bitget/ccxt).
- **Мониторинг/алерты:** DevOps (Prometheus + Telegram интеграция).
- **Документация и runbook:** техпис + разработчик.
- **Ключи и окружения:** менеджер инфраструктуры (обновить `.env`, убедиться в доступах).

## 5. Таймлайн (предложение)
1. Этап 1 — мониторинг: 1-2 дня.
2. Этап 2 — тесты и CI: 1 день.
3. Этап 3 — документация/runbook: 1 день.
4. Этап 4 — деплой: 0.5-1 день (с проверками).
5. Этап 5 — итоговый отчёт: 0.5 дня.

- [x] Базовая реализация stop-loss (обновлённый `exchange_adapter.py` + интеграционный тест).
- [x] Этап 1 — мониторинг и алерты (включая авто-фиксер).
- [x] Этап 2 — CI/регресс-тесты.
- [x] Этап 3 — документация и runbook.
- [x] Этап 4 — деплой на prod.
- [x] Этап 5 — финальный отчёт и handover.
- ℹ️ Примечание: API Bitget `privateMixGetV2MixOrderOrdersPlanHistory` пока отвечает `400172/40812` на наши параметры `symbol/marginCoin`; сбор истории план-ордеров временно отключён до уточнения требований у поддержки биржи. Авто-фиксер использует только текущие плановые ордера и не зависит от истории.

---
Обновлять файл по мере выполнения шагов, чтобы вся информация оставалась в одном источнике истины.


