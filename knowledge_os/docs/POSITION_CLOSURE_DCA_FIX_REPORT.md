# Отчет об исправлении проблем с закрытием позиций и DCA сигналами

**Дата исправления:** 10 августа 2025
**Статус:** ✅ Завершено

## Проблемы

### 1. **Закрытие 50% позиции закрывало всю позицию**
- Пользователь нажимал кнопку "Закрыть 50%", но система закрывала всю позицию
- Проблема была в логике обработки кнопки `close_position` в `telegram_bot.py`

### 2. **DCA сигналы приходили после закрытия позиции**
- DCA сигналы продолжали приходить даже после полного закрытия позиции
- Проблема была в логике проверки открытых позиций в `signal_live.py`

## Диагностика

### Проблема 1: Закрытие 50% позиции
**Причина**: В функции `close_position` в `telegram_bot.py` при закрытии части позиции не обновлялась позиция в списке `open_positions`.

**Код с ошибкой**:
```python
else:
    # Закрываем часть позиции
    remaining_qty = qty - actual_qty
    pos["qty"] = remaining_qty
    print(f"[button] Закрыта часть позиции {symbol}: {actual_qty:.6f} из {qty:.6f}, осталось {remaining_qty:.6f}")
```

### Проблема 2: DCA сигналы после закрытия
**Причина**: Логика проверки открытых позиций не учитывала статус `stage` и количество `qty`.

**Код с ошибкой**:
```python
has_user_long = any(
    pos["symbol"] == symbol and pos.get("side", "long") == "long"
    for pos in user_positions
)
```

## Исправления

### 1. **Исправление закрытия части позиции**

**Файл**: `telegram_bot.py`
**Функция**: `close_position` (строка ~2010)

**Добавлено**:
```python
# Обновляем позицию в списке
for i, p in enumerate(open_positions):
    if p["symbol"] == symbol:
        open_positions[i] = pos
        break
```

**Результат**: Теперь при закрытии 50% позиции оставшаяся часть корректно сохраняется в списке открытых позиций.

### 2. **Исправление проверки открытых позиций для DCA**

**Файл**: `signal_live.py`
**Функции**: Множественные места проверки `has_user_long` и `has_user_short`

**Исправлено**:
```python
# Было:
has_user_long = any(
    pos["symbol"] == symbol and pos.get("side", "long") == "long"
    for pos in user_positions
)

# Стало:
has_user_long = any(
    pos["symbol"] == symbol and pos.get("side", "long") == "long" and
    pos.get('stage') != 'closed' and pos.get('qty', 0) > 0
    for pos in user_positions
)
```

**Добавлена дополнительная проверка в логике DCA**:
```python
# Дополнительная проверка: убеждаемся, что позиция действительно открыта
if position.get('stage') == 'closed' or position.get('qty', 0) <= 0:
    print(f"[DCA] {symbol}: Позиция закрыта или количество равно 0, пропускаем DCA")
    continue
```

## Места исправлений

### В `telegram_bot.py`:
1. **Строка ~2010**: Добавлено обновление позиции в списке при частичном закрытии

### В `signal_live.py`:
1. **Строка ~3550**: Исправлена проверка `has_user_long` для DCA LONG сигналов
2. **Строка ~3735**: Исправлена проверка `has_user_short` для DCA SHORT сигналов
3. **Строка ~3920**: Исправлена проверка `has_user_long` для вне торговых часов
4. **Строка ~3925**: Исправлена проверка `has_user_short` для вне торговых часов
5. **Строка ~3940**: Исправлена проверка `has_user_long` для основной логики
6. **Строка ~3945**: Исправлена проверка `has_user_short` для основной логики
7. **Строка ~3965**: Добавлена дополнительная проверка статуса позиции в DCA логике

## Результаты

### До исправления:
- ❌ Закрытие 50% позиции закрывало всю позицию
- ❌ DCA сигналы приходили после закрытия позиции
- ❌ Система не учитывала статус `stage` и количество `qty`

### После исправления:
- ✅ **Корректное закрытие части позиции** - при закрытии 50% остается 50%
- ✅ **DCA сигналы не приходят после закрытия** - система проверяет статус и количество
- ✅ **Правильная проверка открытых позиций** - учитывается `stage != 'closed'` и `qty > 0`
- ✅ **Дополнительная защита** - проверка статуса позиции в DCA логике

## Логика работы

### 1. **Закрытие части позиции**
1. Пользователь нажимает "Закрыть 50%"
2. Система рассчитывает количество для закрытия
3. **НОВОЕ**: Обновляет позицию в списке `open_positions`
4. Сохраняет изменения в файл и контекст

### 2. **Проверка открытых позиций для DCA**
1. Система проверяет позиции пользователя
2. **НОВОЕ**: Учитывает только позиции с `stage != 'closed'` и `qty > 0`
3. Если позиция закрыта или количество = 0, DCA сигнал не генерируется
4. Дополнительная проверка в DCA логике

## Заключение

Проблемы с закрытием позиций и DCA сигналами были успешно исправлены:

- ✅ **Закрытие 50% позиции** теперь работает корректно
- ✅ **DCA сигналы** не приходят после закрытия позиции
- ✅ **Проверка открытых позиций** учитывает статус и количество
- ✅ **Дополнительная защита** предотвращает ошибки

**Статус**: ✅ Проблемы решены - система корректно обрабатывает закрытие позиций и DCA сигналы
