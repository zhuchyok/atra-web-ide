# üìä –û–¢–ß–ï–¢: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–°–ß–ï–¢–ê –°–†–ï–î–ù–ï–ô –¶–ï–ù–´ –í DCA

## üéØ **–ü–†–û–ë–õ–ï–ú–ê**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∏–ª –æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ä–∞—Å—á–µ—Ç–µ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤ DCA –ø–æ–∑–∏—Ü–∏—è—Ö:

### **–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
```
‚úÖ –°–∏–≥–Ω–∞–ª –ø—Ä–∏–Ω—è—Ç!
üî∏ –°–∏–º–≤–æ–ª: NEARUSDT
üî∏ –°—Ç–æ—Ä–æ–Ω–∞: LONG
üî∏ –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: 3.056
üî∏ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 84.645926

üìà DCA –ø–æ–∑–∏—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!
üî∏ –°–∏–º–≤–æ–ª: NEARUSDT
üî∏ DCA #3
üî∏ –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: 3.005
üî∏ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 82.519038
üî∏ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: 3.022  ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–ª —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É 3.022, –Ω–æ –Ω–∞ –±–∏—Ä–∂–µ —Ä–µ–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ 3.039.

---

## üîç **–ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´**

### **–ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
–í —Ñ—É–Ω–∫—Ü–∏–∏ `handle_dca_button` –≤ —Ñ–∞–π–ª–µ `telegram_handlers.py` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å **—Å—Ç–∞—Ä–∞—è —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞** –≤–º–µ—Å—Ç–æ **–Ω–æ–≤–æ–π —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã** –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è DCA –ø–æ–∑–∏—Ü–∏–∏.

### **–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
# –°—Ç—Ä–æ–∫–∞ 2037 - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å —Å—Ç–∞—Ä–∞—è —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞
f"üî∏ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: <code>${safe_format_price(avg_price, symbol)}</code>\n\n"
```

**–ì–¥–µ:**
- `avg_price` - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª–∞—Å—å –Ω–∞ —Å—Ç—Ä–æ–∫–µ 1941 –∫–∞–∫ —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ **–¥–æ** –¥–æ–±–∞–≤–ª–µ–Ω–∏—è DCA
- `avg_price_new` - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª–∞—Å—å –Ω–∞ —Å—Ç—Ä–æ–∫–µ 1994 –∫–∞–∫ —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ **–ø–æ—Å–ª–µ** –¥–æ–±–∞–≤–ª–µ–Ω–∏—è DCA

---

## ‚úÖ **–†–ï–®–ï–ù–ò–ï**

### **1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏**

**–§–∞–π–ª:** `telegram_handlers.py`  
**–°—Ç—Ä–æ–∫–∏:** 2028-2038

**–ë–´–õ–û:**
```python
dca_text = (
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è ...
    f"üî∏ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: <code>${safe_format_price(avg_price, symbol)}</code>\n\n"
    # ...
)
```

**–°–¢–ê–õ–û:**
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –ø–æ—Å–ª–µ DCA
try:
    # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –≤–∫–ª—é—á–∞—è –Ω–æ–≤—É—é DCA
    positions = user_data.get('positions', []) or []
    symbol_positions = [p for p in positions if p.get('symbol') == symbol and p.get('status', 'open') == 'open']
    total_qty_new = sum(float(p.get('qty', 0)) for p in symbol_positions)
    avg_price_new = sum(float(p.get('entry_price', 0)) * float(p.get('qty', 0)) for p in symbol_positions) / max(1e-9, total_qty_new)
except (ValueError, TypeError, ZeroDivisionError):
    avg_price_new = avg_price  # Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É

dca_text = (
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è ...
    f"üî∏ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: <code>${safe_format_price(avg_price_new, symbol)}</code>\n"
    # ...
)
```

### **2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤—ã—Ö TP —É—Ä–æ–≤–Ω—è—Ö**

**–§–∞–π–ª:** `telegram_handlers.py`  
**–°—Ç—Ä–æ–∫–∏:** 2040-2075

```python
# –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ TP —É—Ä–æ–≤–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
try:
    tp1_price_new = None
    tp2_price_new = None
    for p in symbol_positions:
        if p.get('tp1') and p.get('tp2'):
            tp1_price_new = p.get('tp1')
            tp2_price_new = p.get('tp2')
            break
except (ValueError, TypeError, KeyError):
    tp1_price_new = None
    tp2_price_new = None

# –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ TP –µ—Å–ª–∏ –æ–Ω–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã
if tp1_price_new and tp2_price_new:
    tp1_pct = ((tp1_price_new - avg_price_new) / avg_price_new * 100) if avg_price_new > 0 else 0
    tp2_pct = ((tp2_price_new - avg_price_new) / avg_price_new * 100) if avg_price_new > 0 else 0
    dca_text += (
        f"üî∏ TP1: <code>${safe_format_price(tp1_price_new, symbol)}</code> (+{tp1_pct:.2f}%)\n"
        f"üî∏ TP2: <code>${safe_format_price(tp2_price_new, symbol)}</code> (+{tp2_pct:.2f}%)\n\n"
    )
```

---

## üß™ **–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï**

### **–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç:** `test_dca_calculation.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
```
üìä –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   –ü–æ–∑–∏—Ü–∏—è 1: 3.056 x 84.645926 = 258.68
   DCA #3: 3.005 x 82.519038 = 247.97
   –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 167.164964
   –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: 506.65
   –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: 3.030824

‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù: –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ 3.030824 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π 3.039000
```

**–í—ã–≤–æ–¥:** –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤ –∫–æ–¥–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ü–µ–Ω–µ.

---

## üìà **–†–ï–ó–£–õ–¨–¢–ê–¢**

### **–¢–µ–ø–µ—Ä—å DCA —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**

```
üìà DCA –ø–æ–∑–∏—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!

üî∏ –°–∏–º–≤–æ–ª: NEARUSDT
üî∏ DCA #3
üî∏ –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: $3.005
üî∏ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 82.519038
üî∏ –°—É–º–º–∞ –≤—Ö–æ–¥–∞: $248.00
üî∏ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: $3.031  ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û
üî∏ TP1: $3.055 (+0.79%)  ‚Üê –û–ë–ù–û–í–õ–ï–ù–û
üî∏ TP2: $3.057 (+0.86%)  ‚Üê –û–ë–ù–û–í–õ–ï–ù–û

‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –Ω–∞ TP1 —Ñ–∏–∫—Å–∏—Ä—É–µ–º 50% –ø–æ–∑–∏—Ü–∏–∏, –æ—Å—Ç–∞—Ç–æ–∫ –¥–µ—Ä–∂–∏–º –¥–æ TP2
```

### **–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**

1. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞** - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –≤–∫–ª—é—á–∞—è –Ω–æ–≤—É—é DCA
2. ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ TP —É—Ä–æ–≤–Ω–∏** - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ TP1 –∏ TP2 —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
3. ‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–æ–≤** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–º —Ä–∞—Å—á–µ—Ç–∞–º –Ω–∞ –±–∏—Ä–∂–µ
4. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –¥–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò**

### **–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `telegram_handlers.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤ DCA —Å–æ–æ–±—â–µ–Ω–∏–∏
- `test_dca_calculation.py` - —Å–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—á–µ—Ç–æ–≤

### **–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `handle_dca_button()` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ DCA –∫–Ω–æ–ø–æ–∫
- `test_dca_average_price_calculation()` - —Ç–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
- `test_tp_calculation()` - —Ç–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ TP —É—Ä–æ–≤–Ω–µ–π

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å fallback –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö

---

## ‚úÖ **–°–¢–ê–¢–£–°: –ó–ê–í–ï–†–®–ï–ù–û**

–ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞—Å—á–µ—Ç–æ–º —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤ DCA –ø–æ–∑–∏—Ü–∏—è—Ö **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞**. –¢–µ–ø–µ—Ä—å –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ TP —É—Ä–æ–≤–Ω–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–∞–ª—å–Ω—ã–º —Ä–∞—Å—á–µ—Ç–∞–º –Ω–∞ –±–∏—Ä–∂–µ.
