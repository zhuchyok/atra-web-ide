# üõ†Ô∏è –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤ –ø–æ —Ä–µ–∂–∏–º—É —Ç–æ—Ä–≥–æ–≤–ª–∏ (spot/futures)

**–î–∞—Ç–∞:** 2025-11-06 19:15 MSK  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

## üéØ –ü–†–û–ë–õ–ï–ú–ê

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–ª –∞–ª–µ—Ä—Ç—ã –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π –¥–ª—è **–æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤** (spot –∏ futures), –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –ü—Ä–∏—á–∏–Ω–∞:
- –°–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∞ –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–µ–π –¥–ª—è **–≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∂–∏–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
- `fetch_positions()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ **futures –ø–æ–∑–∏—Ü–∏–∏** (—Ç–∞–∫ –∫–∞–∫ Bitget - —Ñ—å—é—á–µ—Ä—Å–Ω–∞—è –±–∏—Ä–∂–∞)
- –î–ª—è **spot –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞ (spot - —ç—Ç–æ –±–∞–ª–∞–Ω—Å, –∞ –Ω–µ –ø–æ–∑–∏—Ü–∏–∏)
- –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞ –∞–ª–µ—Ä—Ç—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∂–∏–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## ‚úÖ –†–ï–®–ï–ù–ò–ï

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –ø–æ–∑–∏—Ü–∏–π:

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `main.py`:

#### 1. –ü–µ—Ä–µ–¥ –ø–æ–ª—É—á–µ–Ω–∏–µ–º –ø–æ–∑–∏—Ü–∏–π —Å –±–∏—Ä–∂–∏ (—Å—Ç—Ä–æ–∫–∏ 448-468):

**–ë—ã–ª–æ:**
```python
for uid in user_ids:
    keys = await adb_local.get_active_exchange_keys(uid, 'bitget')
    adapter = ExchangeAdapter('bitget', keys=keys or {}, sandbox=False)
    positions = await adapter.fetch_positions()
```

**–°—Ç–∞–ª–æ:**
```python
for uid in user_ids:
    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (spot/futures)
    # –í–ê–ñ–ù–û: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ futures –ø–æ–∑–∏—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ fetch_positions() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ futures
    # –î–ª—è spot –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞ (spot - —ç—Ç–æ –±–∞–ª–∞–Ω—Å, –∞ –Ω–µ –ø–æ–∑–∏—Ü–∏–∏)
    try:
        from db import Database
        db_temp = Database()
        user_data_temp = db_temp.get_user_data(str(uid)) or {}
        user_trade_mode = user_data_temp.get('trade_mode', 'spot')
    except Exception:
        user_trade_mode = 'spot'
    
    # –î–ª—è spot –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø–æ–∑–∏—Ü–∏–π
    if user_trade_mode == 'spot':
        logger.debug(
            "‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %d "
            "(spot —Ä–µ–∂–∏–º - –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è)",
            uid
        )
        continue
    
    keys = await adb_local.get_active_exchange_keys(uid, 'bitget')
    adapter = ExchangeAdapter('bitget', keys=keys or {}, sandbox=False)
    positions = await adapter.fetch_positions()
```

#### 2. –ü–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–π (—Å—Ç—Ä–æ–∫–∏ 1261-1282):

**–ë—ã–ª–æ:**
```python
try:
    local_open = set(await adb_local.get_user_active_symbols(uid))
    to_close = local_open - open_symbols_remote
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_mode = await adb_local.get_user_mode(uid)
```

**–°—Ç–∞–ª–æ:**
```python
try:
    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (spot/futures)
    try:
        from db import Database
        db_temp = Database()
        user_data_temp = db_temp.get_user_data(str(uid)) or {}
        user_trade_mode = user_data_temp.get('trade_mode', 'spot')
    except Exception:
        user_trade_mode = 'spot'
    
    # –î–ª—è spot –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
    if user_trade_mode == 'spot':
        logger.debug(
            "‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %d "
            "(spot —Ä–µ–∂–∏–º - –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è)",
            uid
        )
        continue
    
    local_open = set(await adb_local.get_user_active_symbols(uid))
    to_close = local_open - open_symbols_remote
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (manual/auto)
    user_mode = await adb_local.get_user_mode(uid)
```

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–ª—è SPOT –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- ‚úÖ **–ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è** –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–µ–π
- ‚úÖ **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è** –∞–ª–µ—Ä—Ç—ã –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π
- ‚úÖ Spot - —ç—Ç–æ –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–ø–æ—Ç–æ–≤–æ–º —Å—á–µ—Ç–µ, –∞ –Ω–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ

### –î–ª—è FUTURES –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- ‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è** —Ç–æ–ª—å–∫–æ futures –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ **–û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è** –∞–ª–µ—Ä—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è futures –ø–æ–∑–∏—Ü–∏–π
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∏—Ä–∂–µ–π)

## üîç –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ü–æ—á–µ–º—É –¥–ª—è spot –Ω–µ –Ω—É–∂–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
1. **Spot –ø–æ–∑–∏—Ü–∏–∏** - —ç—Ç–æ –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–ø–æ—Ç–æ–≤–æ–º —Å—á–µ—Ç–µ, –∞ –Ω–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ
2. **`fetch_positions()`** –Ω–∞ Bitget –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ futures –ø–æ–∑–∏—Ü–∏–∏
3. **Spot –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ (–æ–Ω–∏ –ø–æ–∫—É–ø–∞—é—Ç/–ø—Ä–æ–¥–∞—é—Ç –∞–∫—Ç–∏–≤—ã)

### –ü–æ—á–µ–º—É –¥–ª—è futures –Ω—É–∂–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
1. **Futures –ø–æ–∑–∏—Ü–∏–∏** - —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ —Ñ—å—é—á–µ—Ä—Å–Ω–æ–π –±–∏—Ä–∂–µ
2. **–ù—É–∂–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π (SL/TP, –≤—Ä—É—á–Ω—É—é)
3. **–ê–ª–µ—Ä—Ç—ã** –Ω—É–∂–Ω—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π

## üéØ –í–´–í–û–î–´

1. ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:** Spot –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ–ª—å—à–µ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –∞–ª–µ—Ä—Ç—ã –æ futures –ø–æ–∑–∏—Ü–∏—è—Ö
2. ‚úÖ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç:** –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
3. ‚úÖ **–õ–æ–≥–∏–∫–∞ –ø–æ–Ω—è—Ç–Ω–∞:** Spot = –±–∞–ª–∞–Ω—Å, Futures = –ø–æ–∑–∏—Ü–∏–∏

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

