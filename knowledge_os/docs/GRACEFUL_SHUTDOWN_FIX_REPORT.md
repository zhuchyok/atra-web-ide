# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ Graceful Shutdown

## –ü—Ä–æ–±–ª–µ–º–∞
–°–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–≥–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º—É —É–±–∏–π—Å—Ç–≤—É –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ systemd —á–µ—Ä–µ–∑ SIGKILL –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞. –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ:
```
Oct 06 21:31:36 systemd[1]: myproject.service: Killing process 1755 (python) with signal SIGKILL.
Oct 06 21:31:36 systemd[1]: myproject.service: Failed with result 'timeout'.
```

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º

### 1. –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º —Å–∏–≥–Ω–∞–ª–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞**: –î–ª—è SIGINT –ø–æ–¥–Ω–∏–º–∞–ª—Å—è `KeyboardInterrupt()`, —á—Ç–æ –º–æ–≥–ª–æ –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ asyncio –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- **–†–µ—à–µ–Ω–∏–µ**: –£–±—Ä–∞–ª `raise KeyboardInterrupt()` –∏ –∏—Å–ø–æ–ª—å–∑—É—é graceful shutdown –¥–ª—è –≤—Å–µ—Ö —Å–∏–≥–Ω–∞–ª–æ–≤

### 2. –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞–º–∏
- **–ü—Ä–æ–±–ª–µ–º–∞**: Flask —Å–µ—Ä–≤–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö, –Ω–æ –∏—Ö –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ –±—ã–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- **–†–µ—à–µ–Ω–∏–µ**: –£–ª—É—á—à–∏–ª –¥–æ—Å—Ç—É–ø –∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º `API_SERVER` –∏ `DASHBOARD_SERVER`

### 3. –ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏
- **–ü—Ä–æ–±–ª–µ–º–∞**: systemd –∂–¥–µ—Ç 90 —Å–µ–∫—É–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –Ω–æ –∫–æ–¥ –º–æ–≥ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –≤–æ–≤—Ä–µ–º—è
- **–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–∏–ª —Ç–∞–π–º–∞—É—Ç—ã graceful shutdown —Å 5 –¥–æ 10 —Å–µ–∫—É–Ω–¥

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. main.py - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤
```python
def signal_handler(signum, _frame):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è"""
    logger.info("üì° –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª %s, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...", signum)
    
    # ... –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–¥—Å–∏—Å—Ç–µ–º ...
    
    # –î–ª—è –≤—Å–µ—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º graceful shutdown
    logger.info("üõë –°–∏–≥–Ω–∞–ª %s –ø–æ–ª—É—á–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º graceful shutdown...", signum)
    shutdown_manager.request_shutdown()
    
    # –î–ª—è SIGTERM (systemd) –¥–∞–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    if signum == signal.SIGTERM:
        logger.info("üõë SIGTERM –ø–æ–ª—É—á–µ–Ω, systemd –æ–∂–∏–¥–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
    else:
        logger.info("üõë SIGINT –ø–æ–ª—É—á–µ–Ω, graceful shutdown...")
```

### 2. main.py - –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
```python
# –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
if isinstance(exception, (SystemExit, KeyboardInterrupt)):
    logger.error("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É")
    shutdown_manager.request_shutdown()  # –ò—Å–ø–æ–ª—å–∑—É–µ–º request_shutdown()

# –£–ª—É—á—à–µ–Ω–∞ –æ—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á
for task in tasks:
    if not task.done():
        task.cancel()

# –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è
await asyncio.wait_for(
    asyncio.gather(*tasks, return_exceptions=True), timeout=15.0
)
```

### 3. cleanup.py - Graceful shutdown
```python
async def graceful_shutdown(tasks, timeout: float = 10.0):
    """–ì—Ä–∞—Ü–∏–æ–∑–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º"""
    
    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º
    api_server = getattr(main, 'API_SERVER', None)
    dashboard_server = getattr(main, 'DASHBOARD_SERVER', None)
    
    # –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç —Å 5 –¥–æ 10 —Å–µ–∫—É–Ω–¥
    await asyncio.wait_for(
        asyncio.gather(*(all_tasks + other_tasks), return_exceptions=True),
        timeout=timeout
    )
```

### 4. main.py - Finally –±–ª–æ–∫
```python
finally:
    # –ì—Ä–∞—Ü–∏–æ–∑–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    try:
        tasks_to_stop = locals().get("tasks", [])
        if isinstance(tasks_to_stop, list):
            logger.info("üõë –ù–∞—á–∏–Ω–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π graceful shutdown...")
            await graceful_shutdown(tasks_to_stop, timeout=10.0)
    except Exception as e:
        logger.warning("‚ö†Ô∏è –û—à–∏–±–∫–∞ graceful shutdown: %s", e)

    # –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    try:
        logger.info("üßπ –í—ã–ø–æ–ª–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É...")
        await cleanup()
        logger.info("‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    except Exception as e:
        logger.warning("‚ö†Ô∏è –û—à–∏–±–∫–∞ cleanup: %s", e)
    
    logger.info("üèÅ –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–Ω—ã–π systemd service —Ñ–∞–π–ª
–°–æ–∑–¥–∞–Ω `myproject.service` —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:
```ini
[Service]
Type=simple
KillMode=mixed
KillSignal=SIGTERM
TimeoutStopSec=30
ExecStop=/bin/kill -TERM $MAINPID
```

### 2. –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
–°–æ–∑–¥–∞–Ω `test_graceful_shutdown.py` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è graceful shutdown.

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ**: –°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥ –±–µ–∑ SIGKILL
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ graceful shutdown
3. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: systemd –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

1. **–û–±–Ω–æ–≤–∏—Ç—å systemd service**:
   ```bash
   sudo cp myproject.service /etc/systemd/system/
   sudo systemctl daemon-reload
   ```

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å**:
   ```bash
   sudo systemctl restart myproject.service
   ```

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å graceful shutdown**:
   ```bash
   python test_graceful_shutdown.py
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏**:
   ```bash
   journalctl -u myproject.service -f
   ```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:
- `üõë –°–∏–≥–Ω–∞–ª –ø–æ–ª—É—á–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º graceful shutdown...`
- `‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ã`
- `üèÅ –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞`

–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç—Ç–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –ø–æ—è–≤–ª–µ–Ω–∏–µ `SIGKILL` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å graceful shutdown.

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ SIGKILL. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º graceful shutdown –¥–ª—è –≤—Å–µ—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.