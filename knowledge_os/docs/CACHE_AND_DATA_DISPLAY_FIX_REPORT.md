# Исправление проблемы с кэшированием и отображением данных

## Проблема
Пользователь сообщил, что система показывает неправильные данные:
- Вместо FUTURES показывается SPOT
- Неправильный депозит
- Возможное использование кэшированных данных или данных другого пользователя

## Диагностика проблем

### 1. Кэширование в функции `recalculate_balance_and_risks`
**Проблема**: Функция кэшировала результаты на 30 секунд, что могло приводить к отображению устаревших данных.

**Решение**: Добавлена очистка кэша для конкретного пользователя при настройке:
```python
# Очищаем кэш для этого пользователя при настройке
if cache_key in cache_data:
    del cache_data[cache_key]
    if cache_key in cache_ts:
        del cache_ts[cache_key]
    print(f"[recalculate_balance_and_risks] Кэш очищен для пользователя {user_id}")
```

### 2. Ошибка в функции `start`
**Проблема**: Использовалась неопределенная переменная `leverage_display` в финальном сообщении.

**Решение**: Добавлено правильное формирование отображения плеча:
```python
# Формируем правильное отображение плеча
if trade_mode == "futures":
    leverage_display = f"{leverage}x"
else:
    leverage_display = "1x"
```

### 3. Отладочная информация
**Добавлено**: Логирование данных пользователя в функции `setup_filter_mode_soft`:
```python
print(f"[setup_filter_mode_soft] Данные пользователя {user_id}: deposit={deposit}, trade_mode={trade_mode}, filter_mode={filter_mode}")
```

## Исправления

### 1. Очистка кэша
- Кэш очищается для каждого пользователя при настройке
- Предотвращает использование устаревших данных

### 2. Правильное отображение плеча
- Для FUTURES: показывается конкретное значение плеча (например, "2x")
- Для SPOT: показывается "1x"

### 3. Отладочная информация
- Добавлены логи для отслеживания данных пользователя
- Помогает диагностировать проблемы с отображением

## Результат
- Система больше не использует кэшированные данные при настройке
- Правильное отображение режима торговли и плеча
- Возможность отслеживания данных пользователя через логи

## Рекомендации
1. При возникновении проблем с отображением данных проверять логи
2. Использовать команду `/myreport` для проверки актуальных данных
3. При необходимости перезапускать бота для полной очистки кэша