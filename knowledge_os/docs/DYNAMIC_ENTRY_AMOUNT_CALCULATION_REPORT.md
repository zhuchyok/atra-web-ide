# –û—Ç—á–µ—Ç –æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–º —Ä–∞—Å—á–µ—Ç–µ —Å—É–º–º—ã –≤—Ö–æ–¥–∞

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

**–î–∞, —Å—É–º–º–∞ –≤—Ö–æ–¥–∞ —É –Ω–∞—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è!** –û–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤:

1. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫** (1-5%)
2. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–µ–ø–æ–∑–∏—Ç** (—Å —É—á–µ—Ç–æ–º –ø—Ä–∏–±—ã–ª–∏/—É–±—ã—Ç–∫–∞)
3. **–û—Ç–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏** (—É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤)
4. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ** (–¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤)

## –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—É–º–º—ã –≤—Ö–æ–¥–∞

```python
# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:
–°—É–º–º–∞ –≤—Ö–æ–¥–∞ = free_deposit * risk_pct / 100 * leverage

# –ì–¥–µ:
# - free_deposit = –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (–¥–µ–ø–æ–∑–∏—Ç - —Ä–∏—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π)
# - risk_pct = –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç —Ä–∏—Å–∫–∞ (1-5%)
# - leverage = –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ (–¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤)
```

## 1. üìä –†–∞—Å—á–µ—Ç free_deposit (—Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤)

### –§—É–Ω–∫—Ü–∏—è: `recalculate_balance_and_risks()`

```python
def recalculate_balance_and_risks(user_data, user_id=None, force_recalc=False):
    # 1. –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç
    deposit = user_data.get("deposit", 0)

    # 2. –£—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫ –æ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫
    total_profit = sum(trade.get("profit", 0) for trade in trade_history)
    updated_deposit = deposit + total_profit

    # 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∏—Å–∫–∏ –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –ø–æ–∑–∏—Ü–∏—è–º
    total_risk_amount = 0
    for pos in open_positions:
        risk_amount = pos.get("risk_amount", 0)
        if risk_amount > 0:
            total_risk_amount += risk_amount
        else:
            risk_pct = pos.get("risk_pct", 5.0)
            risk_amount = updated_deposit * risk_pct / 100
            total_risk_amount += risk_amount

    # 4. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
    free_deposit = max(updated_deposit - total_risk_amount, 0)

    return {
        "updated_deposit": updated_deposit,
        "total_risk_amount": total_risk_amount,
        "free_deposit": free_deposit,
        "total_profit": total_profit
    }
```

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞:
- **–ë–∞–∑–æ–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç**: 1000 USDT
- **–ü—Ä–∏–±—ã–ª—å –æ—Ç —Å–¥–µ–ª–æ–∫**: +50 USDT
- **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç**: 1050 USDT
- **–†–∏—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π**: 200 USDT
- **–°–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞**: 850 USDT

## 2. üéØ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Ä–∏—Å–∫–∞

### –§—É–Ω–∫—Ü–∏—è: `get_dynamic_risk_pct()`

```python
def get_dynamic_risk_pct(df, i):
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–≤–µ—á–µ–π
    closes = df["close"].iloc[i - 20 : i]

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
    volatility = closes.std() / closes.mean()

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç—Ä–µ–Ω–¥
    sma20_now = closes.mean()
    sma20_prev = df["close"].iloc[i - 30 : i - 10].mean()
    trend = (sma20_now - sma20_prev) / sma20_prev

    # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫
    base_risk = 2.0
    dynamic_risk = base_risk * (1 + 2 * trend) / (1 + 5 * volatility)
    dynamic_risk = max(1.0, min(dynamic_risk, 5.0))  # –æ—Ç 1% –¥–æ 5%

    return dynamic_risk
```

### –õ–æ–≥–∏–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–∏—Å–∫–∞:
- **–°–∏–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥** ‚Üí **–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∏—Å–∫** (–¥–æ 5%)
- **–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å** ‚Üí **–£–º–µ–Ω—å—à–∞–µ–º —Ä–∏—Å–∫** (–¥–æ 1%)
- **–°–ª–∞–±—ã–π —Ç—Ä–µ–Ω–¥** ‚Üí **–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫** (2-3%)

## 3. ‚ö° –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ (–¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤)

### –§—É–Ω–∫—Ü–∏—è: `get_dynamic_leverage()`

```python
def get_dynamic_leverage(df, i, base_leverage=1):
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–≤–µ—á–µ–π
    closes = df["close"].iloc[i - 20 : i]

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∏ —Ç—Ä–µ–Ω–¥
    volatility = closes.std() / closes.mean()
    trend = (sma20_now - sma20_prev) / sma20_prev

    # –§–∞–∫—Ç–æ—Ä—ã –ø–ª–µ—á–∞
    trend_factor = 1 + min(abs(trend) * 10, 1.0)  # –º–∞–∫—Å–∏–º—É–º 2x
    volatility_factor = max(0.5, 1 / (1 + volatility * 2))  # –º–∏–Ω–∏–º—É–º 0.5x
    base_factor = 1 + (base_leverage - 1) * 0.3

    # –ò—Ç–æ–≥–æ–≤–æ–µ –ø–ª–µ—á–æ
    dynamic_leverage = base_leverage * trend_factor * volatility_factor * base_factor
    dynamic_leverage = max(0.5, min(dynamic_leverage, 20))  # –æ—Ç 0.5x –¥–æ 20x

    return int(round(dynamic_leverage))
```

### –õ–æ–≥–∏–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–µ—á–∞:
- **–°–∏–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥** ‚Üí **–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–ª–µ—á–æ** (–¥–æ 20x)
- **–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å** ‚Üí **–£–º–µ–Ω—å—à–∞–µ–º –ø–ª–µ—á–æ** (–¥–æ 0.5x)
- **–°–ª–∞–±—ã–π —Ç—Ä–µ–Ω–¥** ‚Üí **–°—Ä–µ–¥–Ω–µ–µ –ø–ª–µ—á–æ** (1-5x)

## 4. üí∞ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç —Å—É–º–º—ã –≤—Ö–æ–¥–∞

### –í —Å–∏–≥–Ω–∞–ª–∞—Ö:

```python
# DCA —Å–∏–≥–Ω–∞–ª—ã
f"üíµ –°—É–º–º–∞ –≤—Ö–æ–¥–∞: <code>{free_deposit * risk_pct / 100 * (leverage if trade_mode == 'futures' else 1):.2f} USDT</code>\n"

# –û–±—ã—á–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
f"üíµ –°—É–º–º–∞ –≤—Ö–æ–¥–∞: <code>{free_deposit * risk_pct / 100 * (dynamic_leverage if trade_mode == 'futures' else 1):.2f} USDT</code>\n"
```

### –ü—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ —Å–∏–≥–Ω–∞–ª–∞:

```python
# –§—å—é—á–µ—Ä—Å—ã
risk_amount = free_deposit * risk_pct / 100 * leverage

# –°–ø–æ—Ç
risk_amount = free_deposit * risk_pct / 100
```

## 5. üìà –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–∞

### –ü—Ä–∏–º–µ—Ä 1: –°–ø–æ—Ç —Ç–æ—Ä–≥–æ–≤–ª—è
- **–î–µ–ø–æ–∑–∏—Ç**: 1000 USDT
- **–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏**: 200 USDT —Ä–∏—Å–∫–∞
- **–°–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞**: 800 USDT
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫**: 2.5%
- **–°—É–º–º–∞ –≤—Ö–æ–¥–∞**: 800 √ó 2.5% √ó 1 = **20 USDT**

### –ü—Ä–∏–º–µ—Ä 2: –§—å—é—á–µ—Ä—Å—ã
- **–î–µ–ø–æ–∑–∏—Ç**: 1000 USDT
- **–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏**: 200 USDT —Ä–∏—Å–∫–∞
- **–°–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞**: 800 USDT
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫**: 3.0%
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ**: 5x
- **–°—É–º–º–∞ –≤—Ö–æ–¥–∞**: 800 √ó 3% √ó 5 = **120 USDT**

### –ü—Ä–∏–º–µ—Ä 3: –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
- **–î–µ–ø–æ–∑–∏—Ç**: 1000 USDT
- **–°–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞**: 800 USDT
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫**: 1.2% (—É–º–µ–Ω—å—à–µ–Ω –∏–∑-–∑–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏)
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ**: 2x (—É–º–µ–Ω—å—à–µ–Ω–æ –∏–∑-–∑–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏)
- **–°—É–º–º–∞ –≤—Ö–æ–¥–∞**: 800 √ó 1.2% √ó 2 = **19.2 USDT**

## 6. üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:
- **–ö—ç—à –ø–µ—Ä–µ—Å—á–µ—Ç–∞**: 30 —Å–µ–∫—É–Ω–¥
- **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç**: –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–π
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç**: –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–∏–≥–Ω–∞–ª–µ

### –¢—Ä–∏–≥–≥–µ—Ä—ã –ø–µ—Ä–µ—Å—á–µ—Ç–∞:
1. **–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏**
2. **–û—Ç–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏**
3. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞**
4. **–ò—Å—Ç–µ—á–µ–Ω–∏–µ –∫—ç—à–∞** (30 —Å–µ–∫—É–Ω–¥)

## 7. üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
```python
print(f"[recalculate_balance_and_risks] –î–∞–Ω–Ω—ã–µ –¥–ª—è {user_id}: deposit={deposit}, positions={len(open_positions)}")
print(f"[recalculate_balance_and_risks] –†–∞—Å—á–µ—Ç: deposit={deposit}, profit={total_profit}, updated_deposit={updated_deposit}")
print(f"[DEBUG] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–ª–µ—á–æ –¥–ª—è {symbol}: {dynamic_leverage} (–±–∞–∑–æ–≤–æ–µ: {base_leverage})")
```

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
- `/balance` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∏ —Ä–∏—Å–∫–∏
- `/positions` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
- `/myreport` - –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø–æ–∑–∏—Ü–∏—è–º

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è:
1. **–†–∏—Å–∫ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è** –∫ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—É (1-5%)
2. **–ü–ª–µ—á–æ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è** –∫ —Ä—ã–Ω–æ—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º (0.5-20x)
3. **–î–µ–ø–æ–∑–∏—Ç —É—á–∏—Ç—ã–≤–∞–µ—Ç** –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫ –æ—Ç —Å–¥–µ–ª–æ–∫
4. **–°–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞** —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å —É—á–µ—Ç–æ–º –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
5. **–°—É–º–º–∞ –≤—Ö–æ–¥–∞** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞

**–°–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π!** üéØ
