# ‚úÖ –û–¢–ß–ï–¢: –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –°–ò–ì–ù–ê–õ–û–í –í –ë–ê–ó–£ –î–ê–ù–ù–´–•

**–î–∞—Ç–∞:** 18 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

---

## üéØ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê**

### **–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–∏–≥–Ω–∞–ª–∞ (`send_signal`):**

#### **–î–ª—è –í–°–ï–• —Ä–µ–∂–∏–º–æ–≤ (AUTO –∏ MANUAL):**
1. ‚úÖ –°–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Telegram
2. ‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `accepted_signals`** —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
3. ‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `signals_log`** —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING`
4. ‚ùå **–ù–ï –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–∑–∏—Ü–∏—è –Ω–∞ –±–∏—Ä–∂–µ** (—Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)

#### **–í AUTO —Ä–µ–∂–∏–º–µ (–ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è):**
1. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–∑–∏—Ü–∏—è –Ω–∞ –±–∏—Ä–∂–µ (—á–µ—Ä–µ–∑ `auto_exec.execute_and_open()`)
2. ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—á–µ—Ä–µ–∑ `auto_execution`)

#### **–í MANUAL —Ä–µ–∂–∏–º–µ:**
1. ‚úÖ –°–∏–≥–Ω–∞–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
2. ‚úÖ –ñ–¥–µ–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ü–†–ò–ù–Ø–¢–¨"
3. ‚úÖ –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ + –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏

---

## üîß **–í–ù–ï–°–ï–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø**

### **1. –ü–æ–ª—É—á–µ–Ω–∏–µ message_id –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏:**

```python
# Enhanced delivery
message_id_result = None
if ENHANCED_DELIVERY_AVAILABLE:
    success = await notify_user_enhanced(...)
    if success:
        if isinstance(success, dict) and "message_id" in success:
            message_id_result = success.get("message_id")

# Fallback delivery
else:
    result = await notify_user(..., _return_message=True)
    if isinstance(result, dict) and "message_id" in result:
        message_id_result = result.get("message_id")
```

### **2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ accepted_signals:**

```python
if SIGNAL_ACCEPTANCE_AVAILABLE and signal_acceptance_manager:
    signal_data_obj = SignalData(
        symbol=symbol,
        direction=signal_type,
        entry_price=signal_price,
        signal_time=datetime.now(),
        user_id=user_id_str,
        chat_id=chat_id_int,
        message_id=message_id_result,
        status="pending"  # –°—Ç–∞—Ç—É—Å pending –¥–æ –ø—Ä–∏–Ω—è—Ç–∏—è
    )
    
    if message_id_result and chat_id_int:
        await signal_acceptance_manager.register_signal(
            signal_data_obj,
            message_id_result,
            chat_id_int
        )
```

### **3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ signals_log:**

```python
from db import Database
signal_db = Database()
entry_time_str = datetime.now().isoformat()
signal_db.insert_signal_log_entry({
    "symbol": symbol,
    "entry": signal_price,
    "stop": sl_price,
    "tp1": tp1_price,
    "tp2": tp2_price,
    "entry_time": entry_time_str,
    "exit_time": None,
    "result": "PENDING",  # –°—Ç–∞—Ç—É—Å PENDING –¥–æ –ø—Ä–∏–Ω—è—Ç–∏—è
    "net_profit": None,
    "qty_added": None,
    "qty_closed": None,
    "user_id": int(user_id_str) if user_id_str and user_id_str.isdigit() else None,
})
```

---

## üìä **–ü–û–¢–û–ö –î–ê–ù–ù–´–•**

### **MANUAL —Ä–µ–∂–∏–º:**
```
1. send_signal() ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
2. ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ accepted_signals (pending)
3. ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ signals_log (PENDING)
4. ‚Üí –æ–∂–∏–¥–∞–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ü–†–ò–ù–Ø–¢–¨"
5. accept_signal() ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ (pending ‚Üí accepted, PENDING ‚Üí OPEN)
6. ‚Üí –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ
```

### **AUTO —Ä–µ–∂–∏–º:**
```
1. send_signal() ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
2. ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ accepted_signals (pending)
3. ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ signals_log (PENDING)
4. ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (auto_exec.execute_and_open())
5. ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ (—á–µ—Ä–µ–∑ auto_execution)
```

---

## ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢**

### **–î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- ‚ùå –°–∏–≥–Ω–∞–ª—ã –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ –±–∞–∑—É –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
- ‚ùå –°–∏–≥–Ω–∞–ª—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–ü–†–ò–ù–Ø–¢–¨"
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã

### **–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- ‚úÖ –°–∏–≥–Ω–∞–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ (–¥–ª—è –í–°–ï–• —Ä–µ–∂–∏–º–æ–≤)
- ‚úÖ –°—Ç–∞—Ç—É—Å `pending` / `PENDING` –¥–æ –ø—Ä–∏–Ω—è—Ç–∏—è
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏

---

## üîç **–ü–†–û–í–ï–†–ö–ê**

### **–ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**

1. **–°–∏–≥–Ω–∞–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:**
   ```sql
   SELECT * FROM accepted_signals WHERE status = 'pending' ORDER BY created_at DESC LIMIT 10;
   SELECT * FROM signals_log WHERE result = 'PENDING' ORDER BY created_at DESC LIMIT 10;
   ```

2. **–í AUTO —Ä–µ–∂–∏–º–µ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `[AUTO] —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

3. **–í MANUAL —Ä–µ–∂–∏–º–µ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏:**
   - –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü–†–ò–ù–Ø–¢–¨"
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏

---

## üìù **–ü–†–ò–ú–ï–ß–ê–ù–ò–Ø**

- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–ü–û–°–õ–ï** —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
- –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, —Å–∏–≥–Ω–∞–ª **–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**
- `message_id` –º–æ–∂–µ—Ç –±—ã—Ç—å `None`, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
- –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Å–∏–≥–Ω–∞–ª –≤—Å–µ —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `signals_log`, –Ω–æ –Ω–µ –≤ `accepted_signals`

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö.

