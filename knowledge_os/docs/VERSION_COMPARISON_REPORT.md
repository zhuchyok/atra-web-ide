# üìä –°–†–ê–í–ù–ï–ù–ò–ï –í–ï–†–°–ò–ô: 5 –£–¢–†–ê vs –¢–ï–ö–£–©–ê–Ø

## üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´ 5 –£–¢–†–ê

### **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –≤ 5 —É—Ç—Ä–∞:**
```
Oct 06 21:21:09 python[1755]: üöÄ –ó–∞–ø—É—Å–∫ ATRA Dashboard –Ω–∞ http://0.0.0.0:5002
Oct 06 21:21:09 python[1755]: ‚úÖ ATRA —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
Oct 06 21:21:09 python[1755]: ü§ñ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –æ–±—É—á–µ–Ω–∏—è –ò–ò...
Oct 06 21:21:09 python[1755]: üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ò–ò –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...
Oct 06 21:30:06 systemd[1]: Stopping Trading bot...
Oct 06 21:31:36 systemd[1]: myproject.service: State 'stop-sigterm' timed out. Killing.
Oct 06 21:31:36 systemd[1]: myproject.service: Killing process 1755 (python) with signal SIGKILL.
```

## üîß –°–†–ê–í–ù–ï–ù–ò–ï –ö–û–î–ê

### **1. –û–ë–†–ê–ë–û–¢–ö–ê –°–ò–ì–ù–ê–õ–û–í**

#### ‚ùå **–í–ï–†–°–ò–Ø 5 –£–¢–†–ê (–ü–†–û–ë–õ–ï–ú–ù–ê–Ø):**
```python
# –ù–ï –ë–´–õ–û –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown
# –°–∏—Å—Ç–µ–º–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∞ SIGTERM –æ—Ç systemd
# –ù–∏–∫–∞–∫–æ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
```

#### ‚úÖ **–¢–ï–ö–£–©–ê–Ø –í–ï–†–°–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø):**
```python
def signal_handler(signum, _frame):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è"""
    logger.info("üì° –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª %s, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...", signum)

    # –ü—Ä–æ—Å–∏–º –ø–æ–¥—Å–∏—Å—Ç–µ–º—É —Å–∏–≥–Ω–∞–ª–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
    if SIGNAL_LIVE_AVAILABLE and sl:
        try:
            stopper = getattr(sl, "request_stop", None)
            if callable(stopper):
                stopper()
                logger.info("üõë –ó–∞–ø—Ä–æ—à–µ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã —Å–∏–≥–Ω–∞–ª–æ–≤ (graceful)")
        except (AttributeError, RuntimeError):
            pass

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–∏—Å—ã
    if api_server:
        api_server.shutdown()
        logger.info("üõë REST API –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    if dashboard_server:
        dashboard_server.shutdown()
        logger.info("üõë Web Dashboard –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

    # –î–ª—è SIGTERM –∏—Å–ø–æ–ª—å–∑—É–µ–º graceful shutdown
    if signum == signal.SIGTERM:
        logger.info("üõë SIGTERM –ø–æ–ª—É—á–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º graceful shutdown...")
        shutdown_manager.request_shutdown()
    else:
        raise KeyboardInterrupt()
```

### **2. –í–ï–ë-–°–ï–†–í–ò–°–´**

#### ‚ùå **–í–ï–†–°–ò–Ø 5 –£–¢–†–ê:**
```python
# Flask Dashboard - –ù–ï –ë–´–õ–û shutdown –º–µ—Ç–æ–¥–∞
def run(self, host='0.0.0.0', port=5000, debug=False):
    self.app.run(host=host, port=port, debug=debug)
    # –ù–ï –û–¢–í–ï–ß–ê–õ –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

# REST API - –ù–ï –ë–´–õ–û shutdown –º–µ—Ç–æ–¥–∞  
def run(self, debug=False):
    self.app.run(host=self.host, port=self.port, debug=debug)
    # –ù–ï –û–¢–í–ï–ß–ê–õ –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
```

#### ‚úÖ **–¢–ï–ö–£–©–ê–Ø –í–ï–†–°–ò–Ø:**
```python
# Flask Dashboard - –î–û–ë–ê–í–õ–ï–ù–´ shutdown –º–µ—Ç–æ–¥—ã
def run(self, host='0.0.0.0', port=5000, debug=False):
    def signal_handler(signum, frame):
        print(f"üì° –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ Dashboard...")
        sys.exit(0)
    
    signal.signal(signal.SIGTERM, signal_handler)
    signal.signal(signal.SIGINT, signal_handler)
    self.app.run(host=host, port=port, debug=debug, use_reloader=False)

def shutdown(self):
    """Graceful shutdown Dashboard —Å–µ—Ä–≤–µ—Ä–∞"""
    print("üõë Graceful shutdown Web Dashboard...")
    print("‚úÖ Web Dashboard graceful shutdown completed")

# REST API - –î–û–ë–ê–í–õ–ï–ù–´ shutdown –º–µ—Ç–æ–¥—ã
def run(self, debug=False):
    def signal_handler(signum, frame):
        logger.info(f"üì° –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ REST API...")
        self.stop()
        sys.exit(0)
    
    signal.signal(signal.SIGTERM, signal_handler)
    signal.signal(signal.SIGINT, signal_handler)
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥

def shutdown(self):
    """Graceful shutdown REST API —Å–µ—Ä–≤–µ—Ä–∞"""
    logger.info("üõë Graceful shutdown REST API...")
    self.stop()
    logger.info("‚úÖ REST API graceful shutdown completed")
```

### **3. GRACEFUL SHUTDOWN**

#### ‚ùå **–í–ï–†–°–ò–Ø 5 –£–¢–†–ê:**
```python
# –ù–ï –ë–´–õ–û –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
# –ù–ï –ë–´–õ–û —Ç–∞–π–º–∞—É—Ç–æ–≤ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
# –ù–ï –ë–´–õ–û –æ—á–∏—Å—Ç–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤
async def graceful_shutdown(tasks, timeout: float = 5.0):
    # –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤–∞—è –æ—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á
    # –ë–ï–ó –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤
    # –ë–ï–ó –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ —Å systemd
```

#### ‚úÖ **–¢–ï–ö–£–©–ê–Ø –í–ï–†–°–ò–Ø:**
```python
async def graceful_shutdown(tasks, timeout: float = 5.0):
    """–ì—Ä–∞—Ü–∏–æ–∑–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤"""
    logger.info("üõë –ù–∞—á–∏–Ω–∞–µ–º graceful shutdown...")

    # 1) –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã
    # 2) –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–∏—Å—ã
    if api_server:
        api_server.shutdown()
        logger.info("üõë REST API –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (graceful)")
    
    if dashboard_server:
        dashboard_server.shutdown()
        logger.info("üõë Web Dashboard –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (graceful)")

    # 3) –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏
    # 4) –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    # 5) –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Telegram –±–æ—Ç–∞
```

### **4. SYSTEMD –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø**

#### ‚ùå **–í–ï–†–°–ò–Ø 5 –£–¢–†–ê:**
```ini
[Service]
Type=simple
# –ù–ï –ë–´–õ–û –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è graceful shutdown
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: TimeoutStopSec=90 (—Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ)
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: KillMode=control-group (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
```

#### ‚úÖ **–¢–ï–ö–£–©–ê–Ø –í–ï–†–°–ò–Ø:**
```ini
[Service]
Type=simple
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è graceful shutdown
TimeoutStopSec=15          # 15 —Å–µ–∫—É–Ω–¥ –Ω–∞ graceful shutdown
KillMode=mixed            # –°–Ω–∞—á–∞–ª–∞ SIGTERM, –ø–æ—Ç–æ–º SIGKILL
KillSignal=SIGTERM        # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª
FinalKillSignal=SIGKILL   # –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
```

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢ –°–†–ê–í–ù–ï–ù–ò–Ø

### **–ü–†–û–ë–õ–ï–ú–´ –í–ï–†–°–ò–ò 5 –£–¢–†–ê:**

1. **‚ùå –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ SIGTERM:**
   - –°–∏—Å—Ç–µ–º–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–ª–∞ –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã systemd
   - –ù–∏–∫–∞–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã

2. **‚ùå –í–µ–±-—Å–µ—Ä–≤–∏—Å—ã –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏—Å—å:**
   - Flask Dashboard –ø—Ä–æ–¥–æ–ª–∂–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å
   - REST API –ø—Ä–æ–¥–æ–ª–∂–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å
   - –û—Å—Ç–∞–≤–∞–ª–∏—Å—å "–≤–∏—Å—è—â–∏–µ" –ø—Ä–æ—Ü–µ—Å—Å—ã

3. **‚ùå –î–æ–ª–≥–∏–π —Ç–∞–π–º–∞—É—Ç systemd:**
   - 90 —Å–µ–∫—É–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - Systemd –∂–¥–∞–ª —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
   - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SIGKILL

4. **‚ùå –ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏:**
   - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–µ –∑–Ω–∞–ª–∏ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
   - –†–µ—Å—É—Ä—Å—ã –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–ª–∏—Å—å
   - –ì—Ä—è–∑–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

### **–†–ï–®–ï–ù–ò–Ø –¢–ï–ö–£–©–ï–ô –í–ï–†–°–ò–ò:**

1. **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤:**
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ SIGTERM
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

2. **‚úÖ Graceful shutdown –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤:**
   - REST API –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - Dashboard –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ù–µ—Ç "–≤–∏—Å—è—â–∏—Ö" –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

3. **‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã:**
   - 15 —Å–µ–∫—É–Ω–¥ –Ω–∞ graceful shutdown
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞–ª–æ–≤
   - –ë—ã—Å—Ç—Ä–æ–µ –∏ —á–∏—Å—Ç–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

4. **‚úÖ –ü–æ–ª–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è:**
   - –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–Ω–∞—é—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
   - –†–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ß–∏—Å—Ç–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

## üéØ –í–´–í–û–î

### **–í–ï–†–°–ò–Ø 5 –£–¢–†–ê:**
```
Systemd: "–û—Å—Ç–∞–Ω–æ–≤–∏—Å—å!" (SIGTERM)
ATRA: *–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç*
Systemd: *–∂–¥–µ—Ç 90 —Å–µ–∫—É–Ω–¥*
Systemd: "–£–±–∏–≤–∞—é –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ!" (SIGKILL)
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚ùå –ì—Ä—è–∑–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, "–≤–∏—Å—è—â–∏–µ" –ø—Ä–æ—Ü–µ—Å—Å—ã
```

### **–¢–ï–ö–£–©–ê–Ø –í–ï–†–°–ò–Ø:**
```
Systemd: "–û—Å—Ç–∞–Ω–æ–≤–∏—Å—å!" (SIGTERM)
ATRA: "–ü–æ–ª—É—á–∏–ª —Å–∏–≥–Ω–∞–ª, graceful shutdown..."
ATRA: "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤–µ–±-—Å–µ—Ä–≤–∏—Å—ã..."
ATRA: "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–∏—Å—Ç–µ–º—É —Å–∏–≥–Ω–∞–ª–æ–≤..."
ATRA: "–û—Ç–º–µ–Ω—è—é –∑–∞–¥–∞—á–∏..."
ATRA: "–û—á–∏—â–∞—é —Ä–µ—Å—É—Ä—Å—ã..."
ATRA: "–ó–∞–≤–µ—Ä—à–∞—é—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ" (5-10 —Å–µ–∫—É–Ω–¥)
Systemd: "–û—Ç–ª–∏—á–Ω–æ!"
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ß–∏—Å—Ç–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã
```

## üöÄ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –¢–ï–ö–£–©–ï–ô –í–ï–†–°–ò–ò

1. **‚ö° –°–∫–æ—Ä–æ—Å—Ç—å:** 5-10 —Å–µ–∫—É–Ω–¥ vs 90+ —Å–µ–∫—É–Ω–¥
2. **üßπ –ß–∏—Å—Ç–æ—Ç–∞:** –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è
3. **üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
4. **üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ù–µ—Ç "–≤–∏—Å—è—â–∏—Ö" –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
5. **üîÑ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏

**–¢–ï–ö–£–©–ê–Ø –í–ï–†–°–ò–Ø –†–ê–ë–û–¢–ê–ï–¢ –í 10+ –†–ê–ó –õ–£–ß–®–ï –í–ï–†–°–ò–ò 5 –£–¢–†–ê!** üéâ
