# üîç –õ–û–ì–ò–ö–ê –ê–ù–û–ú–ê–õ–ò–ô –ò –ó–ê–ö–†–ê–®–ò–í–ê–ù–ò–Ø –ö–†–£–ñ–ö–û–í

## üìä –û–ë–©–ê–Ø –°–•–ï–ú–ê –†–ê–ë–û–¢–´

### üéØ **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** `calculate_anomaly_circles_with_fallback()`

**–í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `symbol` - —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–º–≤–æ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, "BTCUSDT")
- `signal_type` - —Ç–∏–ø —Å–∏–≥–Ω–∞–ª–∞ ("LONG" –∏–ª–∏ "SHORT")

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `circles_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫—Ä–∞—à–µ–Ω–Ω—ã—Ö –∫—Ä—É–∂–∫–æ–≤ (0-5)
- `activity_description` - –æ–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- `circles_text` - –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫—Ä—É–∂–∫–æ–≤
- `data_available` - –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

---

## üîÑ –ê–õ–ì–û–†–ò–¢–ú –†–ê–ë–û–¢–´

### **1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**
```python
data = await get_anomaly_data_with_fallback(symbol)
v24 = data.get("volume_24h") or 0  # 24-—á–∞—Å–æ–≤–æ–π –æ–±—ä—ë–º
mc = data.get("market_cap") or 0   # –†—ã–Ω–æ—á–Ω–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è
```

### **2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö**
```python
if data.get("available") and v24 > 0 and mc > 0:
    # –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∞–Ω–æ–º–∞–ª–∏–∏
else:
    # –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã
    return None, "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω–æ–º–∞–ª–∏–π (fallback)", "", False
```

### **3. –†–∞—Å—á—ë—Ç —É—Ä–æ–≤–Ω—è –∞–Ω–æ–º–∞–ª–∏–∏**
```python
volume_to_cap_ratio = volume_24h / market_cap
```

**–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
- `‚â• 0.8` ‚Üí **5 –∫—Ä—É–∂–∫–æ–≤** - "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è"
- `‚â• 0.5` ‚Üí **4 –∫—Ä—É–∂–∫–∞** - "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"
- `‚â• 0.2` ‚Üí **3 –∫—Ä—É–∂–∫–∞** - "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"
- `‚â• 0.1` ‚Üí **2 –∫—Ä—É–∂–∫–∞** - "–í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"
- `‚â• 0.04` ‚Üí **1 –∫—Ä—É–∂–æ–∫** - "–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"
- `< 0.04` ‚Üí **0 –∫—Ä—É–∂–∫–æ–≤** - "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"

### **4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ü–≤–µ—Ç–∞ –∫—Ä—É–∂–∫–æ–≤)**
```python
# –ê–Ω–∞–ª–∏–∑ EMA7 vs EMA25 –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞
ema7 = ta.trend.EMAIndicator(close, window=7).ema_indicator()
ema25 = ta.trend.EMAIndicator(close, window=25).ema_indicator()

if ema7 > ema25:
    sign_dir = 1   # –ë—ã—á–∏–π —Ç—Ä–µ–Ω–¥
elif ema7 < ema25:
    sign_dir = -1  # –ú–µ–¥–≤–µ–∂–∏–π —Ç—Ä–µ–Ω–¥
else:
    sign_dir = 0   # –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π
```

### **5. –ó–∞–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ –∫—Ä—É–∂–∫–æ–≤**
```python
circle_empty = "‚ö™"  # –ü—É—Å—Ç–æ–π –∫—Ä—É–∂–æ–∫

if sign_dir > 0:
    circle_filled = "üü¢"  # –ó–µ–ª—ë–Ω—ã–π –¥–ª—è –±—ã—á—å–µ–≥–æ —Ç—Ä–µ–Ω–¥–∞
elif sign_dir < 0:
    circle_filled = "üî¥"  # –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –º–µ–¥–≤–µ–∂—å–µ–≥–æ —Ç—Ä–µ–Ω–¥–∞
else:
    circle_filled = "‚ö™"  # –°–µ—Ä—ã–π –¥–ª—è –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–≥–æ

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∫—Ä—É–∂–∫–æ–≤
circles_text = circle_filled * circles_count + circle_empty * (5 - circles_count)
```

---

## üé® –í–ò–ó–£–ê–õ–¨–ù–û–ï –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–ï

### **–ü—Ä–∏–º–µ—Ä—ã –∫—Ä—É–∂–∫–æ–≤:**

| –£—Ä–æ–≤–µ–Ω—å –∞–Ω–æ–º–∞–ª–∏–∏ | –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ V/C | –ö—Ä—É–∂–∫–∏ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------------|-----------------|--------|----------|
| 5 | ‚â• 0.8 | üü¢üü¢üü¢üü¢üü¢ | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è |
| 4 | ‚â• 0.5 | üü¢üü¢üü¢üü¢‚ö™ | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å |
| 3 | ‚â• 0.2 | üü¢üü¢üü¢‚ö™‚ö™ | –ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å |
| 2 | ‚â• 0.1 | üü¢üü¢‚ö™‚ö™‚ö™ | –í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å |
| 1 | ‚â• 0.04 | üü¢‚ö™‚ö™‚ö™‚ö™ | –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å |
| 0 | < 0.04 | ‚ö™‚ö™‚ö™‚ö™‚ö™ | –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å |

### **–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞:**
- **üü¢ –ó–µ–ª—ë–Ω—ã–µ –∫—Ä—É–∂–∫–∏** - –±—ã—á–∏–π —Ç—Ä–µ–Ω–¥ (EMA7 > EMA25)
- **üî¥ –ö—Ä–∞—Å–Ω—ã–µ –∫—Ä—É–∂–∫–∏** - –º–µ–¥–≤–µ–∂–∏–π —Ç—Ä–µ–Ω–¥ (EMA7 < EMA25)
- **‚ö™ –°–µ—Ä—ã–µ –∫—Ä—É–∂–∫–∏** - –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–Ω–æ–º–∞–ª–∏–π

---

## üîß –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –í –°–ò–ì–ù–ê–õ–ê–•

### **–í —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–∞—Ö:**
```python
circles_count, activity_description, circles_text, data_ok = await calculate_anomaly_circles_with_fallback(symbol, "LONG")

if data_ok and circles_count is not None and circles_count > 0:
    emoji = get_anomaly_emoji(circles_count / 5.0)
    anomalies_line = f"‚Ä¢ –ê–Ω–æ–º–∞–ª–∏–∏: {emoji} {circles_text}\n"
else:
    anomalies_line = "‚Ä¢ –ê–Ω–æ–º–∞–ª–∏–∏: ‚ö™ –ù–ï–¢ –ê–ù–û–ú–ê–õ–ò–ô\n"
```

### **–í DCA —Å–∏–≥–Ω–∞–ª–∞—Ö:**
```python
# –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–ª–µ—á–∞ –∏ —Ä–∏—Å–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–æ–º–∞–ª–∏–π
if data_ok and circles_count and circles_count > 0:
    add_accum_event_safe(symbol, "anomaly_long", weight=float(circles_count), ttl_sec=7200)
```

---

## üìà –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ú–ï–†–´

### **–ü—Ä–∏–º–µ—Ä 1: BTCUSDT**
- –û–±—ä—ë–º: 1,815,540,156 USDT
- –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è: 1,200,000,000,000 USDT
- –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: 0.0015 (0.15%)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚ö™‚ö™‚ö™‚ö™‚ö™ (0 –∫—Ä—É–∂–∫–æ–≤ - –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)

### **–ü—Ä–∏–º–µ—Ä 2: –ú–µ–º–∫–æ–∏–Ω —Å –∞–Ω–æ–º–∞–ª–∏–µ–π**
- –û–±—ä—ë–º: 50,000,000 USDT
- –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è: 20,000,000 USDT
- –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: 2.5 (250%)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** üü¢üü¢üü¢üü¢üü¢ (5 –∫—Ä—É–∂–∫–æ–≤ - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è)

### **–ü—Ä–∏–º–µ—Ä 3: –ê–ª—å—Ç–∫–æ–∏–Ω —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é**
- –û–±—ä—ë–º: 25,000,000 USDT
- –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è: 200,000,000 USDT
- –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: 0.125 (12.5%)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** üü¢üü¢‚ö™‚ö™‚ö™ (2 –∫—Ä—É–∂–∫–∞ - –≤—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)

---

## ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### **–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ):**
```python
ANOMALY_THRESHOLDS = {
    "max_anomaly": 0.8,      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è
    "critical": 0.5,         # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    "anomalous": 0.2,        # –ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    "high": 0.1,             # –í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    "elevated": 0.04,        # –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
}
```

### **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞:**
- **EMA7** - –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π —Ç—Ä–µ–Ω–¥
- **EMA25** - —Å—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–π —Ç—Ä–µ–Ω–¥
- **–ê–Ω–∞–ª–∏–∑:** –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–≤–µ—á–µ–π (1 —á–∞—Å)

---

## üéØ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –í –¢–û–†–ì–û–í–õ–ï

### **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤:**
- **0-1 –∫—Ä—É–∂–æ–∫** - –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è
- **2-3 –∫—Ä—É–∂–∫–∞** - –ø–æ–≤—ã—à–µ–Ω–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ
- **4-5 –∫—Ä—É–∂–∫–æ–≤** - –≤—ã—Å–æ–∫–∞—è –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å

### **–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**
- **–ü–ª–µ—á–æ** - —Å–Ω–∏–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö –∞–Ω–æ–º–∞–ª–∏—è—Ö
- **–†–∏—Å–∫** - –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ —É—Ä–æ–≤–Ω—é –∞–Ω–æ–º–∞–ª–∏–∏
- **–û–±—ä—ë–º** - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∞–Ω–æ–º–∞–ª–∏–∏

---

## üîç –û–¢–õ–ê–î–ö–ê –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì

### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
print(f"[DEBUG] {symbol}: –ê–Ω–æ–º–∞–ª–∏–∏ - {circles_count} –∫—Ä—É–∂–∫–æ–≤, {activity_description}")
```

### **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- TTL: 1800 —Å–µ–∫—É–Ω–¥ (30 –º–∏–Ω—É—Ç)
- –ò—Å—Ç–æ—á–Ω–∏–∫–∏: CoinCap, CoinLore, CoinStats, CoinCodex, Binance, CoinGecko
- Fallback: —Å–µ—Ä—ã–µ –∫—Ä—É–∂–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 30 —Å–µ–Ω—Ç—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
**–û–±–Ω–æ–≤–ª–µ–Ω–∏—è:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π fallback –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
