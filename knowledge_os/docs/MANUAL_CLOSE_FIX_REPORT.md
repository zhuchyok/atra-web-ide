# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ –∏–ª–∏ web dashboard –ø–æ–∑–∏—Ü–∏—è –ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —Å–ø–∏—Å–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π. –≠—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤.

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –≤—Ä—É—á–Ω—É—é
2. –ü–æ–∑–∏—Ü–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç–∞—è (`status = "closed"`)
3. –ü–æ–∑–∏—Ü–∏—è —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ `open_positions`
4. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
5. –°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã

### –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –≤—Ä—É—á–Ω—É—é
2. –ü–æ–∑–∏—Ü–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç–∞—è ‚ùå
3. –ü–æ–∑–∏—Ü–∏—è –ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ `open_positions` ‚ùå
4. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ ‚ùå
5. –°–∏—Å—Ç–µ–º–∞ –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã ‚ùå

## üîß –†–µ—à–µ–Ω–∏–µ

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å 50%" –∏ "–ó–∞–∫—Ä—ã—Ç—å 100%" —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `handle_close_button` –≤ —Ñ–∞–π–ª–µ `telegram_handlers.py`.

### üìù –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
2. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π

### üîç –ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```python
# –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• –ü–û–°–õ–ï –†–£–ß–ù–û–ì–û –ó–ê–ö–†–´–¢–ò–Ø
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
try:
    from user_utils import load_user_data_for_signals
    updated_user_data = load_user_data_for_signals()
    if updated_user_data:
        print(f"[DEBUG] –†–£–ß–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ {symbol}")
        logging.info("üîÑ –†–£–ß–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ %s", symbol)
except Exception as e:
    print(f"[WARNING] –†–£–ß–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
    logging.warning("‚ö†Ô∏è –†–£–ß–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: %s", e)
```

## üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏

–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤:

```
[DEBUG] {symbol}: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω–µ—Ç—ã: {symbol}
[DEBUG] {symbol}: –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {count}
[DEBUG] {symbol}: has_user_long: {bool}, has_user_short: {bool}
[DEBUG] {symbol}: –ü–æ–∑–∏—Ü–∏—è: {symbol} {side} status={status} qty={qty}
```

### 2. –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö

**–ü–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏:**
```
[DEBUG] {symbol}: –ü–æ–∑–∏—Ü–∏—è: {symbol} {side} status=closed qty=0.0
[DEBUG] {symbol}: –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: 0
```

**–ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –ù–ï –∑–∞–∫—Ä—ã—Ç–∞:**
```
[DEBUG] {symbol}: –ü–æ–∑–∏—Ü–∏—è: {symbol} {side} status=open qty={positive_number}
[DEBUG] {symbol}: –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: 1
```

### 3. –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (—Ä—É—á–Ω–æ–µ)

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã, –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:**
   ```bash
   sqlite3 trading.db
   SELECT * FROM user_data WHERE user_id = '{your_user_id}';
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ "open":**
   - –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏ —Å `status = "open"` –∏ `qty = 0`, –Ω—É–∂–Ω–æ –∏—Ö –∑–∞–∫—Ä—ã—Ç—å
   - –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏ —Å `status = "open"` –∏ `qty > 0`, –Ω–æ –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –≤—Ä—É—á–Ω—É—é, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å

3. **–í—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):**
   ```python
   # –í Python –∫–æ–Ω—Å–æ–ª–∏
   from db import Database
   from user_utils import load_user_data_for_signals
   
   db = Database()
   user_data = load_user_data_for_signals()
   
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   user_id = "YOUR_USER_ID"
   positions = user_data[user_id].get("positions", [])
   open_positions = [p for p in positions if p.get("status") == "open" and float(p.get("qty", 0)) > 0]
   
   print(f"–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏: {len(open_positions)}")
   for pos in open_positions:
       print(f"{pos.get('symbol')} {pos.get('side')} status={pos.get('status')} qty={pos.get('qty')}")
   ```

## üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ "–≤–∏—Å—è—á–∏—Ö" –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã:

```python
def cleanup_stuck_positions(user_data_dict):
    """–û—á–∏—Å—Ç–∫–∞ '–≤–∏—Å—è—á–∏—Ö' –ø–æ–∑–∏—Ü–∏–π"""
    for user_id, user_data in user_data_dict.items():
        positions = user_data.get("positions", [])
        cleaned = []
        
        for pos in positions:
            # –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç–∞—è –∏–ª–∏ qty = 0, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ open_positions
            if pos.get("status") == "closed" or float(pos.get("qty", 0)) <= 0:
                pos["status"] = "closed"
                pos["qty"] = 0.0
            cleaned.append(pos)
        
        user_data["positions"] = cleaned
        user_data["open_positions"] = [
            p for p in cleaned
            if p.get("status") == "open" and float(p.get("qty", 0)) > 0
        ]
        
        print(f"[CLEANUP] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}: {len(user_data['open_positions'])} –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π")
    
    return user_data_dict
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π:**
   - –î–æ–ª–∂–Ω–æ —É–º–µ–Ω—å—à–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
   - –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "–≤–∏—Å—è—á–∏—Ö" –ø–æ–∑–∏—Ü–∏–π

2. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤:**
   - –î–æ–ª–∂–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π
   - –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é

3. **–õ–æ–≥–∏:**
   - –î–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
   - –î–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤

## üìÖ –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞

6 –æ–∫—Ç—è–±—Ä—è 2025

## ‚úÖ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ TP2 –∏ –±–µ–∑—É–±—ã—Ç–∫–∞ (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
3. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
4. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É "–≤–∏—Å—è—á–∏—Ö" –ø–æ–∑–∏—Ü–∏–π
5. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ