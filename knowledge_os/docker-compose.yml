# Knowledge OS + Victoria + Veronica –Ω–∞ Mac Studio
# –ó–∞–ø—É—Å–∫: docker-compose -f knowledge_os/docker-compose.yml up -d
# –ö–æ–Ω—Ç–µ–∫—Å—Ç: –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ (atra –∏–ª–∏ atra-web-ide)
# –°–µ—Ç—å atra-network: —Å–∫—Ä–∏–ø—Ç start_victoria_docker.sh —Å–æ–∑–¥–∞—ë—Ç –µ—ë –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ (docker network create atra-network)

networks:
  atra-network:
    external: true

services:
  # PostgreSQL: —Å–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Mac Studio (restart: always)
  db:
    image: pgvector/pgvector:pg16
    container_name: knowledge_postgres
    restart: always
    command: ["postgres", "-c", "max_connections=300"]  # 200 –±—ã–ª–æ –º–∞–ª–æ –ø—Ä–∏ –≤–æ—Ä–∫–µ—Ä–µ+–¥–∞—à–±–æ—Ä–¥+Victoria+rest+–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä—ã (—ç–∫—Å–ø–µ—Ä—Ç—ã: docs/DB_CONNECTIONS_EXPERT_ANALYSIS.md)
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: knowledge_os
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - atra-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d knowledge_os"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis: –∫—ç—à –∏ –æ—á–µ—Ä–µ–¥–∏ (restart: always). –ò–º—è knowledge_os_redis ‚Äî —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å atra (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç)
  redis:
    image: redis:7-alpine
    container_name: knowledge_os_redis
    restart: always
    ports:
      - "6381:6379"  # 6381 –Ω–∞ —Ö–æ—Å—Ç–µ (6380 –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω—è—Ç atra –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ)
    volumes:
      - redis_data:/data
    networks:
      - atra-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  victoria-agent:
    depends_on:
      db:
        condition: service_healthy
    build:
      context: ..
      dockerfile: infrastructure/docker/agents/Dockerfile
    container_name: victoria-agent
    restart: always
    networks:
      - atra-network
    environment:
      PYTHONPATH: /app
      VICTORIA_PORT: "8000"  # –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 8000, —Å–Ω–∞—Ä—É–∂–∏ 8010
      ATRA_ENV: prod
      DATABASE_URL: postgresql://admin:secret@knowledge_postgres:5432/knowledge_os
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OLLAMA_API_URL: http://host.docker.internal:11434
      SERVER_LLM_URL: http://host.docker.internal:11434
      MLX_API_URL: http://host.docker.internal:11435
      # üîÑ –ê–í–¢–û–í–´–ë–û–† –ú–û–î–ï–õ–ï–ô: –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫–∞–Ω–∏—Ä—É—é—Ç—Å—è Ollama (11434) –∏ MLX (11435)
      # –í—ã–±–∏—Ä–∞—é—Ç—Å—è —Å–∞–º—ã–µ –º–æ—â–Ω—ã–µ –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Å–ø–∏—Å–∫–∞ –†–ê–ó–î–ï–õ–¨–ù–û:
      # - Ollama: –¥–ª—è executor/planner (qwq:32b > qwen2.5-coder:32b > phi3.5:3.8b)
      # - MLX: –¥–ª—è LocalAIRouter (command-r-plus:104b > deepseek-r1:70b > llama3.3:70b)
      # 
      # –î–ª—è –Ø–í–ù–û–ì–û —É–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ (–¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ Ollama!):
      # VICTORIA_MODEL: qwen2.5-coder:32b
      # VICTORIA_PLANNER_MODEL: phi3.5:3.8b
      #
      # –ü—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è = –∞–≤—Ç–æ–≤—ã–±–æ—Ä –ª—É—á—à–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏ –∏–∑ Ollama
      VICTORIA_MODEL: ${VICTORIA_MODEL:-}
      VICTORIA_PLANNER_MODEL: ${VICTORIA_PLANNER_MODEL:-}
      # üêõ Debug mode: set to "true" to enable verbose logging
      VICTORIA_DEBUG: ${VICTORIA_DEBUG:-"false"}
      VICTORIA_USE_LOCAL_ROUTER: "true"
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      USE_ELK: "true"
      ELASTICSEARCH_URL: http://atra-elasticsearch:9200
      USE_KNOWLEDGE_OS: "true"
      VICTORIA_USE_CACHE: "true"
      # üöÄ Victoria Enhanced - –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å—É–ø–µ—Ä-–∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏
      USE_VICTORIA_ENHANCED: "true"
      # –≠–∫—Å–ø–µ—Ä—Ç—ã –ø–µ—Ä–≤—ã–º–∏: execution-–∑–∞–¥–∞—á–∏ –∏–¥—É—Ç –≤ Victoria Enhanced (85 —ç–∫—Å–ø–µ—Ä—Ç–æ–≤), –≤ Veronica ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã–µ —à–∞–≥–∏ (docs/VERONICA_REAL_ROLE.md)
      PREFER_EXPERTS_FIRST: ${PREFER_EXPERTS_FIRST:-true}
      # üéØ Victoria Initiative - Event-Driven Architecture –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –≤ –∑–Ω–∞—á–µ–Ω–∏–∏)
      ENABLE_EVENT_MONITORING: ${ENABLE_EVENT_MONITORING:-true}
      FILE_WATCHER_ENABLED: ${FILE_WATCHER_ENABLED:-true}
      SERVICE_MONITOR_ENABLED: ${SERVICE_MONITOR_ENABLED:-true}
      DEADLINE_TRACKER_ENABLED: ${DEADLINE_TRACKER_ENABLED:-true}
      SKILLS_WATCHER_ENABLED: ${SKILLS_WATCHER_ENABLED:-true}
      # üìä OpenTelemetry –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
      ENABLE_OTEL: ${ENABLE_OTEL:-"false"}
      OTLP_ENDPOINT: ${OTLP_ENDPOINT:-""}
      OTLP_INSECURE: ${OTLP_INSECURE:-"true"}
      # üë§ Human-in-the-Loop
      USE_HITL: ${USE_HITL:-"false"}
      HITL_CONFIDENCE_THRESHOLD: ${HITL_CONFIDENCE_THRESHOLD:-"0.7"}
      # üè¢ –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏
      MAIN_PROJECT: "atra-web-ide"  # –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏ –∏ –∞–≥–µ–Ω—Ç–æ–≤
      WORKSPACE_ROOT: /app  # –ö–æ—Ä–µ–Ω—å –¥–ª—è SafeFileWriter (create_file/write_file)
      AGENT_BACKUP_ENABLED: "true"  # –ë—ç–∫–∞–ø—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é
      AGENT_APPROVAL_REQUIRED: "false"  # true = –æ—Ç–∫–∞–∑ –≤ –∑–∞–ø–∏—Å–∏ –≤ package.json, .env, Dockerfile –∏ —Ç.–ø.
      # –õ–∏–º–∏—Ç —à–∞–≥–æ–≤ –∞–≥–µ–Ω—Ç–∞ (—Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ ‚Äî –∞–Ω–∞–ª–∏–∑, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è; –±–µ–∑ —ç—Ç–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –º–æ–≥ –æ—Å—Ç–∞—Ç—å—Å—è 80)
      VICTORIA_MAX_STEPS: ${VICTORIA_MAX_STEPS:-500}
      # Veronica: –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî –ø–æ –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞ (–ø–æ—Ä—Ç 8000 –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏)
      VERONICA_URL: ${VERONICA_URL:-http://veronica-agent:8000}
      # Canary: –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è V2 (A/B –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É —Ç—Ä–∞—Ñ–∏–∫–∞)
      ORCHESTRATION_V2_ENABLED: ${ORCHESTRATION_V2_ENABLED:-true}
      ORCHESTRATION_V2_PERCENTAGE: ${ORCHESTRATION_V2_PERCENTAGE:-10}
    ports:
      - "8010:8000"  # ‚úÖ –û–ë–©–ò–ô –ø–æ—Ä—Ç –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (atra, atra-web-ide, –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã)
    volumes:
      - ../data:/app/data
      - ../logs:/app/logs
      - ../src:/app/src
      # –ü–æ–¥–∫–ª—é—á–∞–µ–º knowledge_os –¥–ª—è Victoria Enhanced
      - ../knowledge_os:/app/knowledge_os
    command: python -m src.agents.bridge.victoria_server

  veronica-agent:
    depends_on:
      db:
        condition: service_healthy
    build:
      context: ..
      dockerfile: infrastructure/docker/agents/Dockerfile
    container_name: veronica-agent
    restart: always
    networks:
      - atra-network
    environment:
      PYTHONPATH: /app
      ATRA_ENV: prod
      DATABASE_URL: postgresql://admin:secret@knowledge_postgres:5432/knowledge_os
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      USE_ELK: "true"
      ELASTICSEARCH_URL: http://atra-elasticsearch:9200
      # üöÄ Veronica Enhanced - –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å—É–ø–µ—Ä-–∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏
      USE_VERONICA_ENHANCED: "true"
      # üìä OpenTelemetry –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
      ENABLE_OTEL: ${ENABLE_OTEL:-"false"}
      OTLP_ENDPOINT: ${OTLP_ENDPOINT:-""}
      OTLP_INSECURE: ${OTLP_INSECURE:-"true"}
      # üë§ Human-in-the-Loop
      USE_HITL: ${USE_HITL:-"false"}
      HITL_CONFIDENCE_THRESHOLD: ${HITL_CONFIDENCE_THRESHOLD:-"0.7"}
      # üè¢ –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏
      MAIN_PROJECT: "atra-web-ide"  # –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏ –∏ –∞–≥–µ–Ω—Ç–æ–≤
      # üîÑ –ê–í–¢–û–í–´–ë–û–† –ú–û–î–ï–õ–ï–ô –¥–ª—è Veronica (–∫–∞–∫ –¥–ª—è Victoria)
      # –ü—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è = –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ª—É—á—à–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏ –∏–∑ Ollama
      # –î–ª—è —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è: VERONICA_MODEL=qwen2.5-coder:32b
      VERONICA_MODEL: ${VERONICA_MODEL:-}
      VERONICA_PLANNER_MODEL: ${VERONICA_PLANNER_MODEL:-}
    ports:
      - "8011:8000"  # ‚úÖ –û–ë–©–ò–ô –ø–æ—Ä—Ç –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (atra, atra-web-ide, –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã)
    volumes:
      - ../data:/app/data
      - ../logs:/app/logs
      - ../src:/app/src
      # –ü–æ–¥–∫–ª—é—á–∞–µ–º knowledge_os –¥–ª—è Veronica Enhanced
      - ../knowledge_os:/app/knowledge_os
    command: python -m src.agents.bridge.server

  prometheus:
    image: prom/prometheus:latest
    container_name: atra-prometheus
    ports:
      - "9092:9090"   # 9092 –Ω–∞ —Ö–æ—Å—Ç–µ (9090/9091 –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–Ω—è—Ç—ã –¥—Ä—É–≥–∏–º–∏ Prometheus)
    volumes:
      - ../infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
    networks:
      - atra-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: atra-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=atra2025
      - GF_INSTALL_PLUGINS=
      - GF_SERVER_ROOT_URL=http://localhost:3001
      - GF_SECURITY_DISABLE_GRAVATAR=true
    volumes:
      - grafana_data:/var/lib/grafana
      - ../infrastructure/monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      # –û–¥–∏–Ω –∫–∞—Ç–∞–ª–æ–≥ —Å–æ –≤—Å–µ–º–∏ –¥–∞—à–±–æ—Ä–¥–∞–º–∏ (dashboard.yml, atra-dashboard.json, enhanced-dashboard.json)
      - ../infrastructure/monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks:
      - atra-network
    depends_on:
      - prometheus
    restart: unless-stopped

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: atra-elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - atra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: atra-kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://atra-elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=
      - xpack.security.enabled=false
      - xpack.encryptedSavedObjects.encryptionKey=minimal32charencryptionkeyhere!!
    volumes:
      - ../infrastructure/monitoring/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    networks:
      - atra-network
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped

  # –í–æ—Ä–∫–µ—Ä: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç PENDING –∑–∞–¥–∞—á–∏ (—Å–∏–º—É–ª—è—Ü–∏–∏, —Ä–∞–∑–≤–µ–¥–∫–∞, –æ–±—ã—á–Ω—ã–µ –∑–∞–¥–∞—á–∏)
  knowledge_os_worker:
    build:
      context: ..
      dockerfile: infrastructure/docker/agents/Dockerfile
    container_name: knowledge_os_worker
    restart: unless-stopped
    networks:
      - atra-network
    environment:
      PYTHONPATH: /app/knowledge_os/app
      DATABASE_URL: postgresql://admin:secret@knowledge_postgres:5432/knowledge_os
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OLLAMA_API_URL: http://host.docker.internal:11434
      OLLAMA_EMBED_URL: http://host.docker.internal:11434/api/embeddings
      MLX_API_URL: http://host.docker.internal:11435
      SERVER_LLM_URL: http://host.docker.internal:11434
      # –ü–æ—Ç–æ–ª–æ–∫: –º–∞–∫—Å. –∑–∞–¥–∞—á ¬´–≤ —Ä–∞–±–æ—Ç–µ¬ª; –∞–¥–∞–ø—Ç–∏–≤ —Å–Ω–∏–∑–∏—Ç –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ MLX/Ollama
      SMART_WORKER_MAX_CONCURRENT: "5"
      SMART_WORKER_ADAPTIVE_CONCURRENCY: "true"
      # MLX –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–µ (–≤—ã–ª–µ—Ç—ã) ‚Äî –Ω–µ –±–æ–ª–µ–µ N –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ MLX
      ADAPTIVE_MLX_SAFE_MAX: "2"
      # –ñ—ë—Å—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç –Ω–∞ LLM –≤—ã–∑–æ–≤ (300 —Å–µ–∫ = 5 –º–∏–Ω) ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è
      SMART_WORKER_LLM_TIMEOUT: "300"
      # –ë–æ–ª—å—à–µ –ø–æ–ø—ã—Ç–æ–∫ –∏ –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º ‚Äî –º–µ–Ω—å—à–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –≤ —Ä—É—á–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏
      SMART_WORKER_MAX_ATTEMPTS: "5"
      SMART_WORKER_RETRY_DELAY_SEC: "180"
      # –ë–∞—Ç—á –ø–æ batch_group: –æ–¥–∏–Ω –≤—ã–∑–æ–≤ LLM –Ω–∞ 2‚Äì3 –∑–∞–¥–∞—á–∏ (ARCHITECTURE_IMPROVEMENTS ¬ß2.5)
      SMART_WORKER_BATCH_GROUP_LLM: "true"
    volumes:
      - ../knowledge_os:/app/knowledge_os
    working_dir: /app/knowledge_os/app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["python", "smart_worker_autonomous.py"]

  # Nightly Learner: –æ–±—É—á–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, –¥–µ–±–∞—Ç—ã, –≥–∏–ø–æ—Ç–µ–∑—ã. –¶–∏–∫–ª –∫–∞–∂–¥—ã–µ 24—á.
  # –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ knowledge_nodes, tasks ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç ¬´–ë–î: X —á –Ω–∞–∑–∞–¥¬ª –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ.
  knowledge_nightly:
    build:
      context: ..
      dockerfile: infrastructure/docker/agents/Dockerfile
    container_name: knowledge_nightly
    restart: unless-stopped
    networks:
      - atra-network
    environment:
      PYTHONPATH: /app/knowledge_os/app
      DATABASE_URL: postgresql://admin:secret@knowledge_postgres:5432/knowledge_os
      REDIS_URL: redis://redis:6379
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      MLX_API_URL: http://host.docker.internal:11435
      MAC_LLM_URL: http://host.docker.internal:11434
    volumes:
      - ../knowledge_os:/app/knowledge_os
    working_dir: /app/knowledge_os/app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["sh", "-c", "while true; do python -u nightly_learner.py; echo '‚úÖ –¶–∏–∫–ª –∑–∞–≤–µ—Ä—à—ë–Ω. –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 24—á'; sleep 86400; done"]

  # Knowledge OS REST API (–ø–æ—Ä—Ç 8002) ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –≤ interaction_logs (Singularity 9.0)
  knowledge_rest:
    build:
      context: ..
      dockerfile: infrastructure/docker/agents/Dockerfile
    container_name: knowledge_rest
    restart: unless-stopped
    ports:
      - "8002:8002"
    networks:
      - atra-network
    environment:
      PYTHONPATH: /app/knowledge_os/app
      DATABASE_URL: postgresql://admin:secret@knowledge_postgres:5432/knowledge_os
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      MLX_API_URL: http://host.docker.internal:11435
      MAC_LLM_URL: http://host.docker.internal:11435
      SERVER_LLM_URL: http://host.docker.internal:11434
    volumes:
      - ../knowledge_os:/app/knowledge_os
    working_dir: /app/knowledge_os/app
    command: ["python", "-u", "rest_api.py"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      db:
        condition: service_healthy

  # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä: –≤—Å—ë –≤—Ä–µ–º—è —Å–ª—É—à–∞–µ—Ç –∑–∞–¥–∞—á–∏ (–≤–∞—Ä–∏–∞–Ω—Ç A ‚Äî –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å --continuous)
  knowledge_os_orchestrator:
    build:
      context: ..
      dockerfile: infrastructure/docker/agents/Dockerfile
    container_name: knowledge_os_orchestrator
    restart: unless-stopped
    networks:
      - atra-network
    environment:
      PYTHONPATH: /app/knowledge_os/app
      DATABASE_URL: postgresql://admin:secret@knowledge_postgres:5432/knowledge_os
      REDIS_URL: redis://redis:6379
      # Phase 1.6: batch_group –¥–ª—è –∑–∞–¥–∞—á –æ–¥–Ω–æ–≥–æ domain (low/medium)
      BATCH_SMALL_TASKS_ENABLED: "true"
    volumes:
      - ../knowledge_os:/app/knowledge_os
    working_dir: /app/knowledge_os/app
    command: ["python", "enhanced_orchestrator.py", "--continuous", "--interval", "60", "--quick-poll", "30"]

  # Streamlit –¥–∞—à–±–æ—Ä–¥ –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏ (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –æ–±—Ä–∞–∑–µ, –∫–æ–¥ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è)
  corporation-dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile.deps
    container_name: corporation-dashboard
    restart: unless-stopped
    networks:
      - atra-network
    ports:
      - "8501:8501"
    environment:
      # –ï—Å–ª–∏ –¥–∞—à–±–æ—Ä–¥ –≤ Docker, –∞ PostgreSQL –Ω–∞ —Ö–æ—Å—Ç–µ: postgresql://admin:secret@host.docker.internal:5432/knowledge_os
      DATABASE_URL: ${DATABASE_URL:-postgresql://admin:secret@knowledge_postgres:5432/knowledge_os}
      # –ß—Ç–æ–±—ã singularity_9_ab_tester –∏ evaluator –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
      PYTHONPATH: /app/project/knowledge_os/app
    volumes:
      - ..:/app/project:ro
    working_dir: /app/project/knowledge_os/dashboard
    command: ["python", "-m", "streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0", "--server.headless=true"]

volumes:
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º atra_knowledge_postgres_data (85 —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, 26k —É–∑–ª–æ–≤) ‚Äî –¥–∞–Ω–Ω—ã–µ atra/atra-web-ide
  # –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø—É—Å—Ç–∞—è –ë–î: –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ postgres_data: {} –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  postgres_data:
    external: true
    name: atra_knowledge_postgres_data
  redis_data:
  prometheus_data:
  grafana_data:
  elasticsearch_data:
